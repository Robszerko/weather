<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Időjárás Monitor - Nyíregyháza</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <style>
        :root {
            /* Színpaletta Alapok */
            --accent-interactive-night: #00BFFF;
            --text-primary-night: #EAEAEA;
            --text-secondary-night: #A0B0C0;
            --bg-widget-night: rgba(15, 23, 42, 0.88);
            --border-widget-night: rgba(56, 189, 248, 0.2);

            --accent-interactive-day: #007AFF;
            --text-primary-day: #111827;
            --text-secondary-day: #4B5563;
            --bg-widget-day: linear-gradient(160deg, rgba(240, 248, 255, 0.92) 0%, rgba(225, 238, 252, 0.90) 100%);
            --border-widget-day: rgba(0, 122, 255, 0.18);

            /* Hőmérsékletfüggő színek */
            --hot: #EF4444;
            --warm: #F97316;
            --mild: #22C55E;
            --cool: #3B82F6;
            --cold: #6366F1;
            --current-temp-bg-color: var(--mild);

            /* 12 FÁZISÚ CIKLUS DEFINÍCIÓJA */
            --sky-color-top-night: #0B1120;
            --sky-color-bottom-night: #020617;
            --sky-color-top-early-dawn: #020617;
            --sky-color-bottom-early-dawn: #0f172a;
            --sky-color-top-blue-hour-dawn: #0f172a;
            --sky-color-bottom-blue-hour-dawn: #1e3a8a;
            --sky-color-top-dawn: #1e293b;
            --sky-color-bottom-dawn: #f97316;
            --sky-color-top-sunrise: #fef3c7;
            --sky-color-bottom-sunrise: #fb923c;
            --sky-color-top-golden-hour-rise: #fde68a;
            --sky-color-bottom-golden-hour-rise: #fca5a5;
            --sky-color-top-day: #7DD3FC;
            --sky-color-bottom-day: #C4EFFF;
            --sky-color-top-golden-hour-set: #fbbf24;
            --sky-color-bottom-golden-hour-set: #f87171;
            --sky-color-top-sunset: #f97316;
            --sky-color-bottom-sunset: #dc2626;
            --sky-color-top-dusk: #0369a1;
            --sky-color-bottom-dusk: #4c1d95;
            --sky-color-top-blue-hour-dusk: #1e3a8a;
            --sky-color-bottom-blue-hour-dusk: #312e81;
            --sky-color-top-late-dusk: #111827;
            --sky-color-bottom-late-dusk: #0c0a09;

            /* Aktuális Téma (kezdetben éjszakai) */
            --current-sky-color-top: var(--sky-color-top-night);
            --current-sky-color-bottom: var(--sky-color-bottom-night);
            --current-text-color: var(--text-primary-night);
            --current-text-muted-color: var(--text-secondary-night);
            --current-icon-color: var(--accent-interactive-night);
            --current-widget-bg: var(--bg-widget-night);
            --current-widget-border: var(--border-widget-night);
            --current-container-border-color: var(--border-widget-night);
        }

        .is-hidden { display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; }

        body { font-family: 'Inter', sans-serif; font-weight: 500; background-color: #020617; min-height: 100vh; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; position: relative; overflow-x: hidden; transition: background-color 1.5s ease-in-out; }

        body[data-theme="day"] { --current-sky-color-top: var(--sky-color-top-day); --current-sky-color-bottom: var(--sky-color-bottom-day); --current-text-color: var(--text-primary-day); --current-text-muted-color: var(--text-secondary-day); --current-icon-color: var(--accent-interactive-day); --current-widget-bg: var(--bg-widget-day); --current-widget-border: var(--border-widget-day); --current-container-border-color: rgba(203, 213, 225, 0.55); }
        body[data-theme="dawn"] { --current-sky-color-top: var(--sky-color-top-dawn); --current-sky-color-bottom: var(--sky-color-bottom-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #f59e0b; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(245, 158, 11, 0.3); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        body[data-theme="dusk"] { --current-sky-color-top: var(--sky-color-top-dusk); --current-sky-color-bottom: var(--sky-color-bottom-dusk); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #f472b6; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(236, 72, 153, 0.3); --current-container-border-color: rgba(71, 85, 105, 0.5); }

        body[data-theme="early_dawn"] { --current-sky-color-top: var(--sky-color-top-early-dawn); --current-sky-color-bottom: var(--sky-color-bottom-early-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: #94a3b8; --current-icon-color: #60a5fa; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(96, 165, 250, 0.2); --current-container-border-color: rgba(51, 65, 85, 0.5); }
        body[data-theme="blue_hour_dawn"] { --current-sky-color-top: var(--sky-color-top-blue-hour-dawn); --current-sky-color-bottom: var(--sky-color-bottom-blue-hour-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #93c5fd; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(147, 197, 253, 0.2); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        body[data-theme="sunrise"] { --current-sky-color-top: var(--sky-color-top-sunrise); --current-sky-color-bottom: var(--sky-color-bottom-sunrise); --current-text-color: #422006; --current-text-muted-color: #7c2d12; --current-icon-color: #f97316; --current-widget-bg: linear-gradient(160deg, rgba(254, 243, 199, 0.92) 0%, rgba(253, 186, 116, 0.90) 100%); --current-widget-border: rgba(249, 115, 22, 0.25); --current-container-border-color: rgba(124, 45, 18, 0.4); }
        body[data-theme="golden_hour_rise"] { --current-sky-color-top: var(--sky-color-top-golden-hour-rise); --current-sky-color-bottom: var(--sky-color-bottom-golden-hour-rise); --current-text-color: #44403c; --current-text-muted-color: #78716c; --current-icon-color: #f59e0b; --current-widget-bg: linear-gradient(160deg, rgba(254, 249, 231, 0.92) 0%, rgba(253, 224, 224, 0.90) 100%); --current-widget-border: rgba(245, 158, 11, 0.2); --current-container-border-color: rgba(168, 162, 158, 0.5); }
        body[data-theme="golden_hour_set"] { --current-sky-color-top: var(--sky-color-top-golden-hour-set); --current-sky-color-bottom: var(--sky-color-bottom-golden-hour-set); --current-text-color: #44403c; --current-text-muted-color: #78716c; --current-icon-color: #ea580c; --current-widget-bg: linear-gradient(160deg, rgba(254, 235, 202, 0.92) 0%, rgba(254, 202, 202, 0.90) 100%); --current-widget-border: rgba(249, 115, 22, 0.2); --current-container-border-color: rgba(168, 162, 158, 0.5); }
        body[data-theme="sunset"] { --current-sky-color-top: var(--sky-color-top-sunset); --current-sky-color-bottom: var(--sky-color-bottom-sunset); --current-text-color: #fef2f2; --current-text-muted-color: #fecaca; --current-icon-color: #ef4444; --current-widget-bg: linear-gradient(160deg, rgba(127, 29, 29, 0.9) 0%, rgba(76, 29, 29, 0.92) 100%); --current-widget-border: rgba(239, 68, 68, 0.25); --current-container-border-color: rgba(159, 18, 57, 0.4); }
        body[data-theme="blue_hour_dusk"] { --current-sky-color-top: var(--sky-color-top-blue-hour-dusk); --current-sky-color-bottom: var(--sky-color-bottom-blue-hour-dusk); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #a78bfa; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(167, 139, 250, 0.2); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        body[data-theme="late_dusk"] { --current-sky-color-top: var(--sky-color-top-late-dusk); --current-sky-color-bottom: var(--sky-color-bottom-late-dusk); --current-text-color: #d1d5db; --current-text-muted-color: #9ca3af; --current-icon-color: #818cf8; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(99, 102, 241, 0.2); --current-container-border-color: rgba(55, 65, 81, 0.5); }

        .sky-gradient-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, var(--current-sky-color-top), var(--current-sky-color-bottom)); transition: background 2s ease-in-out; z-index: -1; }

        .weather-widget { border-radius: 18px; padding: 22px 24px; width: 100%; max-width: 800px; box-sizing: border-box; margin: 0 auto; position: relative; z-index: 10; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 5px 18px rgba(0,0,0,0.12), 0 2px 7px rgba(0,0,0,0.18); backdrop-filter: blur(20px) saturate(140%); -webkit-backdrop-filter: blur(20px) saturate(140%); transition: all 0.6s ease-in-out; }
        #weather-display { position: relative; z-index: 1; display: flex; flex-direction: column; }

        .widget-header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid var(--current-container-border-color); padding-bottom: 12px; transition: border-color 0.6s; }

        .header-container { display: inline-block; background-color: rgba(0, 0, 0, 0.1); padding: 8px 24px; border-radius: 12px; margin-bottom: 4px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); transition: all 0.6s; }
        .location-title { font-size: 22px; font-weight: 800; color: var(--current-text-color); line-height: 1.1; letter-spacing: -0.5px; }
        .station-subtitle { font-size: 13px; font-weight: 500; color: var(--current-text-muted-color); line-height: 1.2; margin-top: 2px; }

        .timestamp-container { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .timestamp { font-size: 12.5px; font-weight: 500; color: var(--current-text-muted-color); transition: color 0.6s; }

        .info-tooltip-container { position: relative; cursor: help; color: var(--current-text-muted-color); line-height: 1; }
        .info-tooltip-container .fa-info-circle { transition: color 0.3s; }
        .info-tooltip-container:hover .fa-info-circle { color: var(--current-icon-color); }
        .info-tooltip-content {
            visibility: hidden; opacity: 0;
            position: absolute;
            top: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            width: max-content;
            max-width: 320px;
            background-color: #f9fafb;
            color: #1f2937;
            text-align: left;
            border-radius: 8px;
            padding: 12px 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 12px;
            line-height: 1.6;
            z-index: 1000;
        }
        .info-tooltip-content::after { content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: transparent transparent #f9fafb transparent; }
        .info-tooltip-container:hover .info-tooltip-content { visibility: visible; opacity: 1; }
        .info-tooltip-content strong { display: block; margin-bottom: 4px; color: #000; font-weight: 700; }
        .info-tooltip-content p, .info-tooltip-content ul { margin: 0 0 10px 0; padding-left: 0; }
        .info-tooltip-content ul { list-style-position: inside; padding-left: 4px; }
        .info-tooltip-content li { margin-bottom: 2px; }
        .info-tooltip-content p:last-child { margin-bottom: 0; }

        .station-status-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; text-align: center; margin-bottom: 0; padding: 5px 0 10px 0; border-bottom: 1px solid var(--current-container-border-color); transition: border-color 0.6s; }
        .station-selector { flex: 1; }
        .station-selector label { cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--current-text-color); font-weight: 500; transition: color 0.6s; }
        .station-selector input[type="radio"] { margin: 0 0 4px 0; accent-color: var(--current-icon-color); }
        .station-selector.disabled label { opacity: 0.55; cursor: not-allowed; }
        .station-name { font-size: 12px; font-weight: 600; line-height: 1; }
        .station-status-text { color: var(--current-text-muted-color); font-weight: 400; font-size: 10px; line-height: 1; transition: color 0.6s; }
        
        /* === VÁLTOZTATÁS KEZDETE === */
        .top-glance-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 4px;
        }
        .glance-temp-container { flex-basis: 50%; display: flex; justify-content: flex-start; }
        .glance-rain-container { flex-basis: 50%; display: flex; justify-content: flex-end; }
        
        .temperature {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            background-color: rgba(0, 0, 0, 0.15);
            padding: 8px 16px;
            border-radius: 12px;
            display: inline-flex;
            align-items: baseline;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.25);
            transition: all 0.6s;
        }
        
        #temperature-value {
            display: inline-block;
            transform-style: preserve-3d;
            color: var(--current-text-color);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .temperature-symbol {
            font-size: 0.5em;
            vertical-align: super;
            margin-left: 4px;
            opacity: 0.85;
            color: var(--current-text-muted-color);
        }

        .discreet-rain-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        #discreet-rain-gauge {
            width: 40px;
            height: 40px;
        }

        #discreet-rain-gauge .rain-gauge-bg {
            fill: none;
            stroke: var(--current-text-muted-color);
            stroke-width: 4px;
            stroke-opacity: 0.4;
            transition: stroke 0.5s ease, stroke-opacity 0.5s ease;
        }
        #discreet-rain-gauge.has-rained-today .rain-gauge-bg {
            stroke: var(--accent-interactive-night);
            stroke-opacity: 0.8;
        }
        
        .discreet-rain-text { text-align: center; }
        #discreet-rain-visual-value { font-size: 12px; font-weight: 700; color: var(--current-text-color); }
        #discreet-rain-visual-value-unit { font-size: 0.7em; opacity: 0.8; margin-left: 2px; font-weight: 500; }
        #discreet-rain-visual-label { display: none; } /* Rejtett, mert a tooltip megmondja */

        .widget-core-data { gap: 8px; margin-bottom: 8px; }
        .temperature-section { order: 2; width: 100%; margin-top: 0; }
        .temperature-and-gauge-wrapper { display: none; } /* Elrejtve a régi helyéről */
        .rain-info-section, .sun-info-section, .moon-info-section, .night-sky-info-section { order: 1; width: 100%; max-width: 100%; padding-top: 0; }
        .additional-core-info { margin-top: 0; }
        .secondary-info-bar { gap: 8px 14px; }
        /* === VÁLTOZTATÁS VÉGE === */

        .precipitation-forecast-info {
            text-align: center;
            font-size: 13px;
            color: var(--current-text-muted-color);
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.08);
            border: 1px solid var(--current-container-border-color);
            transition: all 0.6s;
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
            margin: 12px auto 0 auto;
        }
        .precipitation-forecast-info strong {
            color: var(--current-text-color);
            font-weight: 600;
        }

        .sun-info-section, .moon-info-section, .rain-info-section, .night-sky-info-section { flex: 1; display: flex; align-items: center; justify-content: center; gap: 20px; min-height: 110px; }

        .sun-text-details, .moon-text-details, .rain-text-details, .night-sky-text-details {
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            flex-grow: 1;
            min-width: 0;
            flex-basis: 130px;
        }

        #iss-info .night-sky-text-details {
            min-width: 250px;
            flex-basis: 250px;
        }

        .sun-detail-item, .moon-detail-item, .rain-detail-item, .night-sky-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 6px 8px;
            border-radius: 8px;
            border-bottom: none;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: rgba(0, 0, 0, 0.08);
        }

        .sun-detail-item:hover, .moon-detail-item:hover, .rain-detail-item:hover, .night-sky-detail-item:hover {
            background-color: rgba(255, 255, 255, 0.07);
            transform: translateY(-2px) scale(1.02);
        }

        .sun-detail-label, .moon-detail-label, .rain-detail-label, .night-sky-detail-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 11px;
            color: var(--current-text-muted-color);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: color 0.6s;
            flex-shrink: 0;
        }

        .sun-detail-label i, .moon-detail-label i, .rain-detail-label i, .night-sky-detail-label i {
            width: 13px;
            text-align: center;
            font-size: 1em;
            color: var(--current-icon-color);
            opacity: 0.7;
            transition: color 0.6s, opacity 0.6s;
        }

        .sun-detail-value, .moon-detail-value, .rain-detail-value, .night-sky-detail-value {
            font-weight: 700;
            font-size: 14px;
            color: var(--current-text-color);
            transition: color 0.6s;
            display: flex;
            align-items: center;
            text-align: right;
            flex-grow: 1;
            justify-content: flex-end;
            white-space: normal;
            word-break: break-word;
            line-height: 1.25;
        }
        
        .night-sky-detail-value.long-text {
            font-size: 10.5px;
            white-space: normal;
            line-height: 1.3;
            text-align: left;
            justify-content: flex-start;
        }

        .sun-trend-text, .moon-trend-text { font-size: 0.75em; font-weight: 500; opacity: 0.7; margin-left: 4px; }
        .path-refresh-btn { font-size: 0.75em; margin-left: 6px; cursor: pointer; opacity: 0.6; transition: opacity 0.3s, color 0.3s, transform 0.3s; }
        .path-refresh-btn:hover { opacity: 1; color: var(--current-icon-color); }
        .path-refresh-btn.is-refreshing { transform: rotate(360deg); transition: transform 0.8s; }

        .sun-path-visual, .moon-path-visual {
            width: 150px; height: 85px; position: relative;
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        .sun-path-svg, .moon-path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible; }

        .sun-path-arc-main, .moon-path-arc-main {
            fill: none;
            stroke-width: 2.5px;
            stroke-linecap: round;
        }
        .sun-path-arc-bg, .moon-path-arc-bg {
            fill: none;
            stroke-width: 1.5px;
            stroke-linecap: round;
            stroke: var(--current-text-muted-color);
            stroke-dasharray: 3 3;
            opacity: 0.25;
        }
        .sun-path-horizon, .moon-path-horizon {
            position: absolute; bottom: 10px; left: 0;
            width: 100%; height: 1px;
            background-color: var(--current-text-muted-color);
            opacity: 0.35;
        }
        .sun-path-now-marker, .moon-path-now-marker {
            position: absolute; bottom: 6px;
            width: 3px;
            height: 8px;
            border-radius: 1.5px;
            transform: translateX(-50%);
            transition: left 1s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.9;
        }

        #sun-path-icon {
            position: absolute;
            top: 0; left: 0;
            width: 20px;
            height: 20px;
            background-color: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 10px 3px gold,
                        0 0 18px 6px rgba(255, 215, 0, 0.45),
                        inset 0 0 4px rgba(255, 255, 220, 0.6);
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            pointer-events: auto;
            cursor: help;
            font-size: 0;
            color: transparent;
        }
        .sun-path-arc-main {
            stroke: gold;
            opacity: 0.85;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sun-path-now-marker {
            background-color: gold;
        }

        #moon-path-icon {
            position: absolute;
            top: 0; left: 0;
            width: 18px;
            height: 18px;
            font-size: 18px;
            color: #E8EAF6;
            text-shadow: 0 0 7px rgba(200, 200, 255, 0.6),
                         0 0 13px rgba(150, 150, 220, 0.4);
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.6s ease-in-out;
            z-index: 10;
            pointer-events: auto;
            cursor: help;
        }
        .moon-path-arc-main {
            stroke: #A0B0C0;
            opacity: 0.8;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .moon-path-now-marker {
            background-color: #A0B0C0;
        }

        .sun-path-label, .moon-path-label {
            position: absolute; bottom: -16px;
            font-size: 9.5px;
            font-weight: 600;
            color: var(--current-text-muted-color);
            opacity: 0.75;
            line-height: 1.3;
        }
        .sun-path-label.sunrise-label, .moon-path-label.moonrise-label { left: 0; text-align: left; }
        .sun-path-label.sunset-label, .moon-path-label.moonset-label { right: 0; text-align: right;}
        .sun-path-time, .moon-path-time {
            font-weight: 700;
            color: var(--current-text-color);
            opacity: 0.9;
        }

        .rain-visual { width: 130px; height: 120px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-shrink: 0; overflow: hidden; }
        #main-rain-visual { clip-path: url(#raindrop-clip-main); }

        .rain-gauge-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .rain-gauge-bg, .rain-gauge-value { fill: none; stroke-width: 10; stroke-linecap: round; stroke-linejoin: round; transform-origin: center center; }
        #main-rain-visual .rain-gauge-bg, #main-rain-visual .rain-gauge-value { transform: scale(0.85) translate(8px, 8px); }
        #main-rain-visual .rain-gauge-bg { stroke: var(--current-text-muted-color); opacity: 0.2; transition: stroke 0.6s, stroke-opacity 0.6s; }
        .rain-gauge-value { stroke: var(--accent-interactive-night); transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

        .rain-visual-center { position: absolute; text-align: center; color: var(--current-text-color); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px;}
        #main-rain-visual .rain-visual-center { transform: translateY(5px); }

        #rain-visual-icon { font-size: 28px; opacity: 0.8; }
        #rain-visual-total { font-size: 17px; font-weight: 700; }
        #rain-visual-total-unit { font-size: 11px; font-weight: 500; opacity: 0.7; margin-left: 2px; }
        .rain-visual-label { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); opacity: 0.8; }

        @keyframes streak-animation { 0% { transform: translateY(-110%); opacity: 0; } 10% { transform: translateY(110%); opacity: 0.7; } 11% { opacity: 0; } 100% { opacity: 0; } }
        .rain-visual.is-raining-actively .rain-streak { display: block; animation: streak-animation 60s linear infinite; }

        .night-sky-visual { text-align: center; }
        .night-sky-visual i { font-size: 48px; margin-bottom: 8px; color: var(--current-text-muted-color); transition: color 0.6s; }
        #planet-info .night-sky-visual i.fa-ring { color: #E3D4A8; text-shadow: 0 0 10px #E3D4A8; }
        #planet-info .night-sky-visual i.fa-circle { text-shadow: 0 0 10px #E27B58; color: #E27B58; }
        #planet-info .night-sky-visual i.fa-globe-europe { color: #d8b89d; text-shadow: 0 0 10px #d8b89d; }
        #iss-info .night-sky-visual i.fa-satellite { color: #B0B0B0; text-shadow: 0 0 8px #FFFFFF;}

        #constellation-svg-container { width: 100px; height: 80px; margin: 0 auto; }
        #constellation-svg-container svg { width: 100%; height: 100%; }
        #constellation-svg-container .star { fill: var(--text-secondary-night); }
        #constellation-svg-container .star.bright { fill: #ffffff; }
        #constellation-svg-container .const-line { stroke: var(--text-secondary-night); stroke-width: 1px; opacity: 0.5; }

        .weather-details-grid {
            margin-top: 12px;
            background-color: rgba(0,0,0,0.08);
            border: 1px solid var(--current-container-border-color);
            border-radius: 12px;
            padding: 12px 14px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 14px;
            row-gap: 6px;
            transition: all 0.6s;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13.5px;
            padding: 2px 0;
        }

        .detail-item .label {
            font-weight: 600;
            color: var(--current-text-color);
            margin-right: 4px;
            display: flex;
            align-items: center;
            transition: color 0.6s;
            white-space: nowrap;
        }
        .detail-item .label i {
            margin-right: 5px;
            width: 12px;
            font-size: 0.85em;
            text-align: center;
            opacity: 0.8;
            color: var(--current-icon-color);
            transition: color 0.6s;
        }
        .detail-item .value {
            color: var(--current-text-muted-color);
            font-weight: 500;
            transition: color 0.6s;
            display: flex;
            align-items: center;
            text-align: right;
            flex-shrink: 0;
            margin-left: 3px;
        }

        .pressure-trend-icon { margin-left: 4px; font-weight: 700; }
        .uv-description-text { margin-left: 4px; font-size: 0.88em; font-style: italic; }

        .forecast-title { width: 100%; max-width: 800px; font-size: 16px; font-weight: 700; color: var(--current-text-color); margin-top: 24px; margin-bottom: 12px; text-align: center; transition: color 0.6s; }
        
        .hourly-forecast-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 6px; padding: 4px; box-sizing: border-box; margin: 0 auto; }
        .hourly-forecast-card { display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 14px; border-radius: 12px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--current-text-color); transition: all 0.6s; }
        .hourly-primary-info { display: flex; align-items: center; gap: 20px; flex-grow: 1; }
        .hourly-time { font-size: 15px; font-weight: 700; min-width: 50px; text-align: left; }
        .hourly-icon-and-condition { display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 85px; }
        .hourly-icon { font-size: 28px; color: var(--current-icon-color); transition: color 0.6s; }
        .hourly-condition-text { font-size: 12px; font-weight: 500; color: var(--current-text-muted-color); white-space: nowrap; text-align: center; }
        .hourly-temp { font-size: 20px; font-weight: 700; }
        .hourly-secondary-details { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; font-size: 12.5px; color: var(--current-text-muted-color); flex-shrink: 0; }
        .hourly-detail-row { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .hourly-detail-row i { width: 13px; text-align: center; opacity: 0.8; }
        
        .forecast-container { 
            width: 100%; 
            max-width: 800px;
            padding-bottom: 12px; 
            display: grid; 
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 0 auto;
        }
        .forecast-day-card { 
            display: flex; 
            flex-direction: column; 
            padding: 12px;
            border-radius: 14px; 
            background: var(--current-widget-bg); 
            border: 1px solid var(--current-widget-border); 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
            color: var(--current-text-color); 
            transition: all 0.6s; 
        }
        .forecast-header { 
            text-align: center; 
            margin-bottom: 8px; 
        }
        .forecast-day-name { 
            font-size: 16px;
            font-weight: 700; 
        }
        .forecast-date { 
            font-size: 12px;
            font-weight: 500; 
            color: var(--current-text-muted-color); 
        }
        .forecast-temps { 
            font-size: 20px;
            font-weight: 700; 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 8px 0; 
            border-top: 1px solid var(--current-container-border-color); 
            border-bottom: 1px solid var(--current-container-border-color); 
            margin: 8px 0; 
            transition: border-color 0.6s; 
        }
        .forecast-temp-min { 
            color: var(--current-text-muted-color); 
            font-weight: 500; 
        }
        .forecast-part { 
            margin-top: 8px; 
        }
        .forecast-part:first-of-type { 
            padding-bottom: 8px; 
            border-bottom: 1px solid var(--current-container-border-color); 
            transition: border-color 0.6s; 
        }
        .forecast-part-header { 
            display: flex; 
            align-items: center; 
            font-size: 14px;
            font-weight: 700; 
            margin-bottom: 6px; 
        }
        .forecast-part-header i { 
            margin-right: 6px; 
            opacity: 0.8; 
            color: var(--current-icon-color); 
            transition: color 0.6s; 
        }
        .forecast-part-details { 
            font-size: 12.5px;
            color: var(--current-text-muted-color); 
            line-height: 1.5; 
            text-align: left; 
        }
        .forecast-part-details p { 
            margin: 2px 0; 
        }

        .detail-item, .info-bar-item { perspective: 600px; }
        .detail-item .value, .info-bar-item span { perspective: 400px; }

        #temperature-value, #main-heat-index-value, #main-wind-speed-value, #main-wind-gust-value, #dewpoint-value, #humidity-value, #pressure-value, #visibility-value, #solar-radiation-value, #uv-index-value {
            display: inline-block;
            transition: transform 0.6s cubic-bezier(0.45, 0, 0.55, 1);
            transform-style: preserve-3d;
            will-change: transform;
        }

        #temperature-value.is-flipping, #main-heat-index-value.is-flipping, #main-wind-speed-value.is-flipping, #main-wind-gust-value.is-flipping, #dewpoint-value.is-flipping, #humidity-value.is-flipping, #pressure-value.is-flipping, #visibility-value.is-flipping, #solar-radiation-value.is-flipping, #uv-index-value.is-flipping {
            transform: rotateX(90deg);
        }

        @media (min-width: 1000px) {
            .weather-widget {
                max-width: 960px;
            }
            .widget-core-data {
                flex-direction: row;
                align-items: flex-start;
                gap: 24px;
            }
            .rain-info-section, .sun-info-section, .moon-info-section, .night-sky-info-section {
                order: 1;
                flex: 1 1 45%;
            }
            .temperature-section {
                order: 2;
                flex: 1 1 55%;
                margin-top: 0;
            }
        }

        @media (max-width: 999px) {
            .temperature-section {
                margin-top: 12px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .weather-widget {
                padding: 18px;
            }

            .widget-core-data {
                flex-direction: column;
                align-items: center;
            }

            .sun-info-section, .moon-info-section, .rain-info-section, .night-sky-info-section {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .sun-text-details, .moon-text-details, .rain-text-details, .night-sky-text-details {
                width: 100%;
                max-width: 320px;
                text-align: center;
            }
             .sun-detail-item, .moon-detail-item, .rain-detail-item, .night-sky-detail-item {
                justify-content: space-between;
             }
            #iss-info .night-sky-text-details {
                 min-width: unset;
                 flex-basis: auto;
            }
            .night-sky-detail-value.long-text {
                text-align: right;
                justify-content: flex-end;
            }

            .weather-details-grid {
                grid-template-columns: 1fr;
                row-gap: 8px;
            }
            .forecast-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .weather-widget {
                padding: 15px;
            }
            .location-title {
                font-size: 20px;
            }
            .station-subtitle {
                font-size: 12px;
            }
            .header-container {
                padding: 6px 18px;
            }
            
            .temperature-and-gauge-wrapper {
                gap: 15px;
                justify-content: center;
            }
            .temperature {
                font-size: 48px;
                padding: 10px 18px 10px 14px;
            }
            
            .hourly-forecast-card {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .hourly-primary-info {
                justify-content: space-around;
            }
            .hourly-secondary-details {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px 12px;
                border-top: 1px solid var(--current-container-border-color);
                padding-top: 8px;
            }
        }
    </style>
</head>
<body data-theme="night">

    <div class="sky-gradient-overlay"></div>

    <div class="weather-widget">
        <div id="widget-background-image"></div>
        <div id="weather-display"></div>
    </div>

    <h3 class="forecast-title is-hidden" id="hourly-forecast-title">A következő órákban várható időjárás</h3>

    <div class="hourly-forecast-container" id="hourly-forecast-container"></div>

    <h3 class="forecast-title is-hidden" id="forecast-title">8 napos előrejelzés</h3>
    <div class="forecast-container" id="forecast-container"></div>

    <script>
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
        const REFRESH_INTERVAL_PWS = 30 * 1000;
        const REFRESH_INTERVAL_WIND = 15 * 1000;
        const REFRESH_INTERVAL_GENERAL_CONDITIONS = 5 * 60 * 1000;
        const REFRESH_INTERVAL_OPEN_METEO_RAIN = 60 * 60 * 1000;
        const REFRESH_INTERVAL_FORECAST = 6 * 60 * 60 * 1000;
        const SKY_COLOR_UPDATE_INTERVAL = 1 * 60 * 1000;
        const NYIREGYHAZA_COORDS = { lat: 47.9550, lon: 21.7160 };

        const ENABLE_ISS_TRACKING = true;
        const N2YO_API_KEY = '589P8Q-SDRYX8-L842ZD-5Z9L';
        const OBSERVER_ALTITUDE = 120;
        const ISS_NORAD_ID = 25544;
        const REFRESH_INTERVAL_ISS = 2 * 60 * 60 * 1000;

        const STATIONS = {
            HONVED: { id: 'INYREG37', name: 'Nyíregyháza Honvéd utcai állomás', displayName: 'Honvéd u.', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure'], isOnline: false, data: null },
            NYIREGYHAZI_UT: { id: 'INYREG26', name: 'Nyíregyháza Nyíregyházi úti állomás', displayName: 'Nyíregyházi út', provides: ['precip', 'temp'], isOnline: false, data: null },
            KOSSUTH: { id: 'INYREG42', name: 'Nyíregyháza Kossuth út 50 állomás', displayName: 'Kossuth út 50', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure', 'precip'], isOnline: false, data: null }
        };
        let activeDisplayStationKey = 'HONVED';

        let lastApiCallTimes = { generalConditions: 0, openMeteoRain: 0, forecast: 0, hourlyForecast: 0, issPasses: 0 };
        let cachedData = {
            displayPws: null,
            generalConditions: { skyCoverPhrase: null, pressureAltimeter: null, visibility: null, sunriseTimeLocal: null, sunsetTimeLocal: null, dayOrNight: null, pressureTendencyCode: null, uvDescription: null },
            expectedRainToday_gauge: null,
            forecastDays: [],
            hourlyForecast: [],
            sunCalc: null,
            issPasses: [],
            nightSkyObject: null
        };
        let isWeatherDisplayInitialized = false;

        let hasRainBeenDetectedToday = false;
        let currentDay = new Date().getDate();

        let weatherDisplayEl, forecastContainerEl, forecastTitleEl, hourlyForecastContainerEl, hourlyForecastTitleEl;
        const NO_DATA_STRING = 'N/A';
        const PRECIP_THRESHOLD = 30;

        // Globális (modul szintű) változók a cache-elt DOM elemeknek
        let el_stationSubtitleText, el_timestampText, el_temperatureValue, el_temperatureContainer,
            el_rainInfoSection, el_mainRainVisual, el_sunInfoSection, el_moonInfoSection, el_nightSkyInfoSection,
            el_discreetRainGauge, el_gridSunriseItem, el_gridSunsetItem, el_gridMoonriseItem, el_gridMoonsetItem,
            el_mainRainGaugeValue, el_mainRainVisualTotal, el_rainCurrentlyRainingValue, el_rainIntensityValue, el_rainExpectedTodayValue, el_nextPrecipItem, el_nextPrecipValue,
            el_discreetRainVisualValueNode, el_discreetRainVisualValue,
            el_sunPathIcon, el_sunPathArcMain, el_sunPathNowMarker, el_sunInfoAltitude, el_sunInfoAltitudeNode, el_sunInfoTrend, el_sunInfoNoon, el_sunInfoRemaining, el_sunPathSunriseTime, el_sunPathSunsetTime, el_sunPathRefreshBtn,
            el_moonPathIcon, el_moonPathArcMain, el_moonPathNowMarker, el_moonriseTimeLabel, el_moonsetTimeLabel, el_moonInfoAltitude, el_moonInfoAltitudeNode, el_moonInfoTrend, el_moonInfoPhasename, el_moonInfoIllumination, el_moonPathRefreshBtn,
            el_issInfo, el_planetInfo, el_constellationInfo,
            el_issVisualIcon, el_issNextPassTime, el_issMaxElevation, el_issDuration, el_issBrightness, el_issPathDetails,
            el_nightSkyVisualIcon, el_nightSkyObjectName, el_nightSkyObjectStatus, el_nightSkyObjectDetails, el_nightSkyAstroDarknessItemPlanet, el_nightSkyAstroDarknessPlanet,
            el_constellationSvgContainer, el_constellationName, el_constellationDetails, el_constellationAstroDarknessItemConst, el_constellationAstroDarknessConst,
            el_heatIndexItem, el_mainHeatIndexValue, el_windSpeedItem, el_mainWindDirArrow, el_mainWindDirText, el_mainWindValueContainer, el_mainWindSpeedValue,
            el_windGustItem, el_mainWindGustValue,
            el_dewpointValue, el_humidityValue, el_pressureValue, el_pressureTrendIcon, el_visibilityValue, el_solarRadiationValue, el_uvIndexValue, el_uvDescription,
            el_detailsSunriseValue, el_detailsSunsetValue, el_moonriseValue, el_moonsetValue,
            el_precipitationForecastBar, el_nextPrecipitationInfoText;


        function formatValue(value, unit = '', precision = 1, notAvailableString = NO_DATA_STRING) { if (value === null || typeof value === 'undefined' || (typeof value === 'number' && isNaN(value)) ) return notAvailableString; if (typeof value === 'number') { return `${value.toFixed(precision)}${unit}`; } return `${value}${unit}`; }
        function formatTime(dateOrIsoString, includeSeconds = false) { if (!dateOrIsoString) return NO_DATA_STRING; try { const date = dateOrIsoString instanceof Date ? dateOrIsoString : new Date(dateOrIsoString); if (isNaN(date.getTime())) return NO_DATA_STRING; const options = { hour: '2-digit', minute: '2-digit' }; if(includeSeconds) options.second = '2-digit'; return date.toLocaleTimeString('hu-HU', options); } catch (e) { return NO_DATA_STRING; } }

        function degreesToCompass(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["északi", "észak-északkeleti", "északkeleti", "kelet-északkeleti", "keleti", "kelet-délkeleti", "délkeleti", "dél-délkeleti", "déli", "dél-délnyugati", "délnyugati", "nyugat-délnyugati", "nyugati", "nyugat-északnyugati", "északnyugati", "észak-északnyugati"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function degreesToCompassAbbreviated(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["É", "ÉÉK", "ÉK", "KÉK", "K", "KDK", "DK", "DDK", "D", "DDNY", "DNY", "NYDNY", "NY", "NYÉNY", "ÉNY", "ÉÉNY"]; return directions[Math.round(degrees / 22.5) % 16]; }

        function updateThemeAndSky(currentTime, sunriseTimeIso, sunsetTimeIso) {
            const fallbackTheme = (new Date().getHours() >= 7 && new Date().getHours() < 18) ? 'day' : 'night';
            let theme = fallbackTheme;

            if (sunriseTimeIso && sunsetTimeIso) {
                try {
                    const nowMs = currentTime.getTime();
                    const sunriseDate = new Date(sunriseTimeIso);
                    const sunsetDate = new Date(sunsetTimeIso);

                    if (isNaN(sunriseDate.getTime()) || isNaN(sunsetDate.getTime())) {
                        throw new Error("Invalid sunrise/sunset date");
                    }

                    const EARLY_DAWN_DURATION = 30 * 60 * 1000;
                    const BLUE_HOUR_DAWN_DURATION = 30 * 60 * 1000;
                    const DAWN_DURATION = 25 * 60 * 1000;
                    const SUNRISE_EVENT_DURATION = 15 * 60 * 1000;
                    const GOLDEN_HOUR_RISE_DURATION = 45 * 60 * 1000;

                    const GOLDEN_HOUR_SET_DURATION = 45 * 60 * 1000;
                    const SUNSET_EVENT_DURATION = 15 * 60 * 1000;
                    const DUSK_DURATION = 25 * 60 * 1000;
                    const BLUE_HOUR_DUSK_DURATION = 30 * 60 * 1000;
                    const LATE_DUSK_DURATION = 30 * 60 * 1000;

                    const sunriseMs = sunriseDate.getTime();
                    const sunsetMs = sunsetDate.getTime();

                    const earlyDawnStart = sunriseMs - DAWN_DURATION - BLUE_HOUR_DAWN_DURATION - EARLY_DAWN_DURATION;
                    const blueHourDawnStart = sunriseMs - DAWN_DURATION - BLUE_HOUR_DAWN_DURATION;
                    const dawnStart = sunriseMs - DAWN_DURATION;
                    const sunriseEnd = sunriseMs + SUNRISE_EVENT_DURATION;
                    const goldenHourRiseEnd = sunriseEnd + GOLDEN_HOUR_RISE_DURATION;

                    const goldenHourSetStart = sunsetMs - GOLDEN_HOUR_SET_DURATION;
                    const sunsetEnd = sunsetMs + SUNSET_EVENT_DURATION;
                    const duskEnd = sunsetEnd + DUSK_DURATION;
                    const blueHourDuskEnd = duskEnd + BLUE_HOUR_DUSK_DURATION;
                    const lateDuskEnd = blueHourDuskEnd + LATE_DUSK_DURATION;

                    if (nowMs >= earlyDawnStart && nowMs < blueHourDawnStart) { theme = 'early_dawn'; }
                    else if (nowMs >= blueHourDawnStart && nowMs < dawnStart) { theme = 'blue_hour_dawn'; }
                    else if (nowMs >= dawnStart && nowMs < sunriseMs) { theme = 'dawn'; }
                    else if (nowMs >= sunriseMs && nowMs < sunriseEnd) { theme = 'sunrise'; }
                    else if (nowMs >= sunriseEnd && nowMs < goldenHourRiseEnd) { theme = 'golden_hour_rise'; }
                    else if (nowMs >= goldenHourRiseEnd && nowMs < goldenHourSetStart) { theme = 'day'; }
                    else if (nowMs >= goldenHourSetStart && nowMs < sunsetMs) { theme = 'golden_hour_set'; }
                    else if (nowMs >= sunsetMs && nowMs < sunsetEnd) { theme = 'sunset'; }
                    else if (nowMs >= sunsetEnd && nowMs < duskEnd) { theme = 'dusk'; }
                    else if (nowMs >= duskEnd && nowMs < blueHourDuskEnd) { theme = 'blue_hour_dusk'; }
                    else if (nowMs >= blueHourDuskEnd && nowMs < lateDuskEnd) { theme = 'late_dusk'; }
                    else { theme = 'night'; }

                } catch (e) {
                    console.warn("Theme calculation failed, using fallback:", e.message);
                    theme = fallbackTheme;
                }
            }

            if (document.body.dataset.theme !== theme) {
                document.body.dataset.theme = theme;
            }
        }

        function getComprehensiveMoonData(lat, lon) {
            const now = new Date();
            const moonPos = SunCalc.getMoonPosition(now, lat, lon);
            const isActuallyUp = moonPos.altitude > 0;

            const days = [
                new Date(new Date().setDate(now.getDate() - 1)),
                now,
                new Date(new Date().setDate(now.getDate() + 1))
            ];

            let events = [];
            days.forEach(day => {
                const moonTimes = SunCalc.getMoonTimes(day, lat, lon, true);
                if (moonTimes.rise && !isNaN(moonTimes.rise.getTime())) {
                    events.push({ time: moonTimes.rise, type: 'rise' });
                }
                if (moonTimes.set && !isNaN(moonTimes.set.getTime())) {
                    events.push({ time: moonTimes.set, type: 'set' });
                }
            });

            if (events.length === 0) {
                return { isUp: isActuallyUp, pathRise: null, pathSet: null, nextRise: null, nextSet: null };
            }

            events.sort((a, b) => a.time - b.time);

            let pathRise = null;
            let pathSet = null;

            if (isActuallyUp) {
                const lastRiseEvent = events.filter(e => e.type === 'rise' && e.time < now).pop();
                if (lastRiseEvent) {
                    pathRise = lastRiseEvent.time;
                    pathSet = events.find(e => e.type === 'set' && e.time > pathRise)?.time || null;
                }
            }

            const nextRise = events.find(e => e.type === 'rise' && e.time > now)?.time || null;
            const nextSet = events.find(e => e.type === 'set' && e.time > now)?.time || null;

            return {
                isUp: isActuallyUp,
                pathRise: pathRise,
                pathSet: pathSet,
                nextRise: nextRise,
                nextSet: nextSet
            };
        }

        async function fetchAdvancedSunCalcData(lat, lon) {
            const now = new Date();
            const sunTimesToday = SunCalc.getTimes(now, lat, lon);

            const sunriseDate = sunTimesToday.sunrise;
            const sunsetDate = sunTimesToday.sunset;
            const solarNoonDate = sunTimesToday.solarNoon;

            const sunPos = SunCalc.getPosition(now, lat, lon);
            const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000);
            const pastSunPos = SunCalc.getPosition(tenMinutesAgo, lat, lon);
            let sunTrend = sunPos.altitude > 0 ? (sunPos.altitude > pastSunPos.altitude ? 'Emelkedik' : 'Süllyed') : null;

            let sunStatus = '';
            if (sunriseDate && sunsetDate && !isNaN(sunriseDate.getTime()) && !isNaN(sunsetDate.getTime())) {
                if (now < sunriseDate) { sunStatus = 'Napkelte előtt'; }
                else if (now >= sunriseDate && now < solarNoonDate) { sunStatus = 'Dél felé tart'; }
                else if (now >= solarNoonDate && now < sunsetDate) { sunStatus = 'Dél után'; }
                else { sunStatus = 'Lenyugodott'; }
            }

            let remainingDaylightText = 'N/A';
            if (sunriseDate && sunsetDate && !isNaN(sunriseDate.getTime()) && !isNaN(sunsetDate.getTime())) {
                if (now > sunriseDate && now < sunsetDate) {
                    const diffMs = sunsetDate.getTime() - now.getTime();
                    const hours = Math.floor(diffMs / 3600000);
                    const minutes = Math.floor((diffMs % 3600000) / 60000);
                    remainingDaylightText = `Még ${hours} óra ${minutes} perc`;
                } else if (now <= sunriseDate) {
                    remainingDaylightText = `Napkelte ${formatTime(sunriseDate)}-kor`;
                } else {
                    remainingDaylightText = 'A nap már lenyugodott';
                }
            }

            const moonPos = SunCalc.getMoonPosition(now, lat, lon);
            const pastMoonPos = SunCalc.getMoonPosition(tenMinutesAgo, lat, lon);
            const moonIllumination = SunCalc.getMoonIllumination(now);

            const comprehensiveMoonData = getComprehensiveMoonData(lat, lon);

            let moonTrend = moonPos.altitude > 0 ? (moonPos.altitude > pastMoonPos.altitude ? 'Emelkedik' : 'Süllyed') : null;
            let moonStatus = comprehensiveMoonData.isUp ? 'Égen van' : 'Horizont alatt';

            let phaseName = 'N/A';
            const phase = moonIllumination.phase;
            if (phase >= 0 && phase < 0.03) phaseName = 'Újhold';
            else if (phase >= 0.03 && phase < 0.22) phaseName = 'Növekvő sarló';
            else if (phase >= 0.22 && phase < 0.28) phaseName = 'Első negyed';
            else if (phase >= 0.28 && phase < 0.47) phaseName = 'Növekvő hold';
            else if (phase >= 0.47 && phase < 0.53) phaseName = 'Telihold';
            else if (phase >= 0.53 && phase < 0.72) phaseName = 'Fogyó hold';
            else if (phase >= 0.72 && phase < 0.78) phaseName = 'Utolsó negyed';
            else if (phase >= 0.78 && phase < 0.97) phaseName = 'Fogyó sarló';
            else if (phase >= 0.97 && phase <= 1) phaseName = 'Újholdhoz közeli';

            return {
                sunrise: formatTime(sunriseDate),
                sunset: formatTime(sunsetDate),
                solarNoon: formatTime(solarNoonDate),
                sunriseDateForPath: sunriseDate,
                sunsetDateForPath: sunsetDate,

                sunAltitude: sunPos.altitude * 180 / Math.PI, sunTrend: sunTrend, sunStatus: sunStatus, remainingDaylight: remainingDaylightText,

                isUp: comprehensiveMoonData.isUp,
                moonrise: formatTime(comprehensiveMoonData.nextRise),
                moonset: formatTime(comprehensiveMoonData.nextSet),
                moonRiseDateForPath: comprehensiveMoonData.pathRise,
                moonSetDateForPath: comprehensiveMoonData.pathSet,

                moonAltitude: moonPos.altitude * 180 / Math.PI, moonTrend: moonTrend, moonStatus: moonStatus,
                phaseValue: (moonIllumination.fraction * 100), phaseName: phaseName, moonDistance: moonPos.distance,
                astronomicalTwilightStart: sunTimesToday.night,
                astronomicalTwilightEnd: sunTimesToday.nightEnd,
            };
        }

        function getNightSkyInfo(date, sunCalcData) {
            const month = date.getMonth() + 1;
            const hour = date.getHours();
            let primaryObject = null;
            let secondaryInfo = null;

            if (month >= 5 && month <= 9) {
                if (hour >= 22 || hour <= 1) {
                    primaryObject = { type: 'planet', name: 'Szaturnusz', icon: 'fas fa-ring', status: 'Késő este DDK-D felé keresd', details: 'Gyűrűi távcsővel láthatók. Sárgás fényű.' };
                } else if (hour >= 1 && hour <= 4) {
                    primaryObject = { type: 'planet', name: 'Jupiter', icon: 'fas fa-globe-europe', status: 'Hajnalban KDK-DK égbolton ragyog', details: 'Az égbolt egyik legfényesebb objektuma.'};
                }
                if (!primaryObject && (hour >= 21 && hour <= 3)) {
                     secondaryInfo = { type: 'constellation', name: 'Nyári Háromszög', details: 'A Vega (Lant), Deneb (Hattyú) és Altair (Sas) csillagok alkotják, magasan látható.' };
                }
            } else if (month >= 10 && month <= 12) {
                 if (hour >= 19 && hour <= 23) {
                    primaryObject = { type: 'planet', name: 'Jupiter', icon: 'fas fa-globe-europe', status: 'Este feltűnően látszik K-DK irányban', details: 'Fényes, uralkodó jelenség az esti égen.' };
                } else if (hour >= 21 && hour <= 2) {
                    if (!primaryObject) primaryObject = { type: 'planet', name: 'Szaturnusz', icon: 'fas fa-ring', status: 'Este, éjfél körül DNY felé keresd', details: 'Halványabb a Jupiternél.' };
                }
                 if (!primaryObject && (hour >= 20 || hour <= 2)) {
                    secondaryInfo = { type: 'constellation', name: 'Pegazus és Androméda', details: 'Keressük a Pegazus nagy négyszögét és az Androméda-galaxist (fényszennyezésmentes helyen).' };
                 }
            } else if (month >= 1 && month <= 4) {
                if (hour >= 19 && hour <= 22) {
                } else if (hour >= 4 && hour <= 6) {
                     primaryObject = { type: 'planet', name: 'Vénusz', icon: 'far fa-circle', status: 'Hajnalcsillagként ragyog K-DK-en', details: 'Rendkívül fényes, nem lehet eltéveszteni.'};
                }
                 if (!primaryObject && (hour >= 20 || hour <= 5)) {
                    secondaryInfo = { type: 'constellation', name: 'Orion', details: 'A téli égbolt meghatározó csillagképe, az Orion-köddel és fényes csillagaival (Betelgeuse, Rigel).' };
                 }
            }

            if (!primaryObject) {
                 primaryObject = {
                    type: 'constellation',
                    name: 'Hattyú (Cygnus)',
                    svg: `<svg viewBox="0 0 100 80"><line class="const-line" x1="50" y1="5" x2="50" y2="75"/><line class="const-line" x1="20" y1="45" x2="80" y2="45"/><circle class="star bright" cx="50" cy="5" r="3"></circle><circle class="star" cx="50" cy="75" r="2.5"></circle><circle class="star" cx="20" cy="45" r="2"></circle><circle class="star" cx="80" cy="45" r="2"></circle><circle class="star" cx="50" cy="45" r="2.5"></circle></svg>`,
                    details: 'Az Északi Keresztként is ismert, nyáron magasan látható.'
                };
            }

            if (sunCalcData && sunCalcData.astronomicalTwilightStart && sunCalcData.astronomicalTwilightEnd) {
                 const nowMs = date.getTime();
                 const astroNightStartObj = new Date(sunCalcData.astronomicalTwilightStart);
                 const astroNightEndObj = new Date(sunCalcData.astronomicalTwilightEnd);

                 if (!isNaN(astroNightStartObj.getTime()) && !isNaN(astroNightEndObj.getTime())) {
                    if (nowMs > astroNightStartObj.getTime() || nowMs < astroNightEndObj.getTime()) {
                        primaryObject.astroDarkness = `Csill. sötét: ${formatTime(astroNightStartObj)} - ${formatTime(astroNightEndObj)}`;
                    }
                 }
            }
            return { primary: primaryObject, secondary: secondaryInfo };
        }

        async function fetchIssPasses(apiKey, lat, lon, alt, noradId, days = 3, minElevation = 15) {
            if (!ENABLE_ISS_TRACKING || apiKey === 'YOUR_N2YO_API_KEY' || !apiKey) {
                console.warn("ISS követés nincs engedélyezve vagy API kulcs hiányzik/érvénytelen.");
                cachedData.issPasses = [];
                return [];
            }

            const url = `https://api.n2yo.com/rest/v1/satellite/visualpasses/${noradId}/${lat}/${lon}/${alt}/${days}/${minElevation}/&apiKey=${apiKey}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 401) {
                         console.error(`ISS API Hiba: Helytelen API kulcs vagy jogosultsági probléma (status: ${response.status}). Ellenőrizd a kulcsot!`);
                    } else {
                        console.error(`ISS API Hiba: ${response.status} - ${response.statusText}`);
                    }
                    throw new Error(`ISS API Hiba: ${response.status}`);
                }
                const data = await response.json();

                if (data && data.info && data.info.passescount > 0 && data.passes) {
                    const now = new Date().getTime() / 1000;
                    const validPasses = data.passes
                        .filter(pass => pass.startUTC > now && pass.maxEl >= minElevation)
                        .map(pass => ({
                            startAz: pass.startAz,
                            startAzCompass: pass.startAzCompass,
                            startEl: pass.startEl,
                            startUTC: new Date(pass.startUTC * 1000),
                            maxAz: pass.maxAz,
                            maxAzCompass: pass.maxAzCompass,
                            maxEl: pass.maxEl,
                            maxUTC: new Date(pass.maxUTC * 1000),
                            endAz: pass.endAz,
                            endAzCompass: pass.endAzCompass,
                            endEl: pass.endEl,
                            endUTC: new Date(pass.endUTC * 1000),
                            mag: pass.mag,
                            duration: pass.duration
                        }))
                        .sort((a, b) => a.startUTC - b.startUTC);

                    console.log(`Sikeres ISS áthaladás lekérés: ${validPasses.length} db érvényes áthaladás található.`);
                    return validPasses;
                } else if (data && data.info && data.info.passescount === 0) {
                    console.log("Nincs várható ISS áthaladás a következő napokban a megadott kritériumokkal.");
                    return [];
                }
                console.warn("Hiányos vagy váratlan ISS API válasz:", data);
                return [];
            } catch (error) {
                cachedData.issPasses = [];
                return [];
            }
        }


        function updatePathVisuals(startTime, endTime, elements) {
            const { iconEl, mainArcEl, nowMarkerEl } = elements;
            if (!startTime || !endTime || isNaN(startTime.getTime()) || isNaN(endTime.getTime()) || !iconEl || !mainArcEl || !nowMarkerEl) {
                if(mainArcEl && mainArcEl.getTotalLength) mainArcEl.style.strokeDashoffset = mainArcEl.getTotalLength();
                if(iconEl) iconEl.classList.add('is-hidden');
                if(nowMarkerEl) nowMarkerEl.classList.add('is-hidden');
                return;
            }
            iconEl.classList.remove('is-hidden');
            nowMarkerEl.classList.remove('is-hidden');

            const now = new Date();
            const totalTimeInSky = endTime.getTime() - startTime.getTime();

            let percentageOfPath = 0;
            if (totalTimeInSky > 0) {
                const elapsedTime = now.getTime() - startTime.getTime();
                percentageOfPath = Math.max(0, Math.min(1, elapsedTime / totalTimeInSky));
            }

            const arcLength = mainArcEl.getTotalLength();
            if (arcLength === 0) {
                setTimeout(() => updatePathVisuals(startTime, endTime, elements), 50);
                return;
            }

            const offset = arcLength * (1 - percentageOfPath);
            mainArcEl.style.strokeDasharray = arcLength;
            mainArcEl.style.strokeDashoffset = offset;

            const angle = Math.PI * (1 - percentageOfPath);
            const arcRadius = 65;
            const centerX = 75;
            const centerY = 75;

            const svgX = centerX + arcRadius * Math.cos(angle);
            const svgY = centerY - arcRadius * Math.sin(angle);

            iconEl.style.transform = `translate(${svgX}px, ${svgY}px) translate(-50%, -50%)`;
            nowMarkerEl.style.left = `${svgX}px`;
        }

        function updatePrecipitationVisuals(precipRate, precipTotal, elements) {
            const { gaugeValueEl, totalValueEl } = elements;
            if (!gaugeValueEl || !totalValueEl) return;

            const MAX_INTENSITY = 10;
            const percentage = Math.min(1, (precipRate || 0) / MAX_INTENSITY);

            const length = gaugeValueEl.getTotalLength();
            if (length === 0) {
                setTimeout(() => updatePrecipitationVisuals(precipRate, precipTotal, elements), 50);
                return;
            }

            const offset = length * (1 - percentage);
            gaugeValueEl.style.strokeDasharray = length;
            gaugeValueEl.style.strokeDashoffset = offset;

            totalValueEl.textContent = formatValue(precipTotal, '', 2);
        }

        async function fetchPwsStationData(stationKey) {
            const stationConfig = STATIONS[stationKey];
            const url = `https://api.weather.com/v2/pws/observations/current?apiKey=${weatherComApiKey}&stationId=${stationConfig.id}&numericPrecision=decimal&format=json&units=m`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`PWS API Hiba: ${response.status}`);
                const data = await response.json();
                if (!data.observations || data.observations.length === 0) throw new Error(`Nincs PWS adat.`);
                stationConfig.isOnline = true;
                stationConfig.data = data.observations[0];
                updateStationStatusUI(stationKey, 'online');
            } catch (error) {
                stationConfig.isOnline = false;
                updateStationStatusUI(stationKey, 'offline');
                console.warn(`PWS adatlekérési hiba (${stationConfig.id}): ${error.message}`);
                throw error;
            }
        }

        async function fetchGeneralConditionsData(lat, lon) { const lang = 'hu-HU'; const url = `https://api.weather.com/v3/wx/observations/current?geocode=${lat},${lon}&language=${lang}&format=json&apiKey=${weatherComApiKey}&units=m`; const response = await fetch(url); if (!response.ok) { throw new Error(`API hiba (Ált. időjárás): ${response.status}`); } const data = await response.json(); lastApiCallTimes.generalConditions = Date.now(); return { skyCoverPhrase: data.cloudCoverPhrase || data.wxPhraseLong || null, pressureAltimeter: data.pressureAltimeter ?? data.pressureMeanSeaLevel, visibility: data.visibility, dayOrNight: data.dayOrNight, pressureTendencyCode: data.pressureTendencyCode ?? (data.pressureChange !== null && typeof data.pressureChange !== 'undefined' ? (data.pressureChange > 0 ? 0 : (data.pressureChange < 0 ? 1 : 2)) : null), uvDescription: data.uvDescription || null }; }
        async function fetchOpenMeteoExpectedRain_gauge(lat, lon) { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=precipitation_sum&timezone=auto&forecast_days=1`; const response = await fetch(url); if (!response.ok) { throw new Error(`Open-Meteo API hiba: ${response.status}`); } const data = await response.json(); lastApiCallTimes.openMeteoRain = Date.now(); if (data?.daily?.precipitation_sum?.[0] !== undefined) { return data.daily.precipitation_sum[0]; } else { throw new Error('Hiányos várható csapadék adat (Open-Meteo).'); } }
        async function fetchDailyForecastData(lat, lon) {
            const url = `https://api.weather.com/v3/wx/forecast/daily/10day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
            try {
                const response = await fetch(url); if (!response.ok) throw new Error(`Napi előrejelzés API Hiba: ${response.status}`); const data = await response.json(); if (!data || !data.dayOfWeek) { throw new Error('Hiányos napi előrejelzési adatok.'); } lastApiCallTimes.forecast = Date.now();
                const forecastDays = [];
                for(let i = 0; i <= 7; i++) {
                    if (!data.dayOfWeek?.[i]) break;
                    const dayData = {
                        dayName: data.dayOfWeek?.[i], date: data.validTimeLocal?.[i], tempMax: data.temperatureMax?.[i], tempMin: data.temperatureMin?.[i],
                        dayPart: data.daypart?.[0] ? { phrase: data.daypart[0].wxPhraseLong?.[i*2], precipChance: data.daypart[0].precipChance?.[i*2], windSpeed: data.daypart[0].windSpeed?.[i*2], windDir: data.daypart[0].windDirection?.[i*2], uvIndex: data.daypart[0].uvIndex?.[i*2], uvDescription: data.daypart[0].uvDescription?.[i*2] } : null,
                        nightPart: data.daypart?.[0] ? { phrase: data.daypart[0].wxPhraseLong?.[i*2+1], precipChance: data.daypart[0].precipChance?.[i*2+1], windSpeed: data.daypart[0].windSpeed?.[i*2+1], windDir: data.daypart[0].windDirection?.[i*2+1] } : null
                    };
                    forecastDays.push(dayData);
                }
                return {
                    forecastDays: forecastDays,
                    sunriseTimeLocal: data.sunriseTimeLocal?.[0],
                    sunsetTimeLocal: data.sunsetTimeLocal?.[0],
                };
            } catch (error) { console.warn(`Napi előrejelzés hiba: ${error.message}`); throw error; }
        }

        async function fetchHourlyForecastData(lat, lon) {
            const url = `https://api.weather.com/v3/wx/forecast/hourly/2day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
            try {
                const response = await fetch(url); if (!response.ok) throw new Error(`Órás előrejelzés API hiba: ${response.status}`); const data = await response.json(); if (!data || !data.validTimeLocal) { throw new Error('Hiányos órás előrejelzési adatok.'); }
                lastApiCallTimes.hourlyForecast = Date.now();

                const hourlyForecasts = []; const now = new Date();
                let startIndex = data.validTimeLocal.findIndex(timeStr => new Date(timeStr) > now);
                if (startIndex === -1) {
                    startIndex = data.validTimeLocal.length > 0 ? data.validTimeLocal.length -1 : 0;
                } else if (startIndex > 0) {
                     const prevTime = new Date(data.validTimeLocal[startIndex-1]);
                     if (now.getTime() - prevTime.getTime() < 30 * 60 * 1000) {
                        startIndex--;
                     }
                }

                for (let i = startIndex; i < startIndex + 48 && i < data.validTimeLocal.length; i++) {
                    hourlyForecasts.push({ time: data.validTimeLocal[i], temp: data.temperature[i], iconCode: data.iconCode[i], precipChance: data.precipChance[i], dayOrNight: data.dayOrNight[i], windSpeed: data.windSpeed[i], windDirection: data.windDirection[i], humidity: data.relativeHumidity[i], uvIndex: data.uvIndex[i], wxPhraseShort: data.wxPhraseShort[i] });
                }
                return hourlyForecasts;
            } catch (error) { console.warn(`Órás előrejelzés hiba: ${error.message}`); throw error; }
        }

        function findNextPrecipitationEvent(hourlyData) {
            if (!hourlyData || hourlyData.length === 0) return null;
            const stormKeywords = ['vihar', 'zivatar']; const rainKeywords = ['eső', 'zápor']; const snowKeywords = ['hó', 'havazás', 'hózápor'];
            for (const hour of hourlyData) {
                if (new Date(hour.time) < new Date()) continue;

                if (hour.precipChance >= PRECIP_THRESHOLD) {
                    const phrase = (hour.wxPhraseShort || '').toLowerCase(); let type = 'Csapadék';
                    if (stormKeywords.some(keyword => phrase.includes(keyword))) { type = 'Vihar'; } else if (rainKeywords.some(keyword => phrase.includes(keyword))) { type = 'Eső'; } else if (snowKeywords.some(keyword => phrase.includes(keyword))) { type = 'Hó'; }
                    return { time: hour.time, chance: hour.precipChance, type: type };
                }
            } return null;
        }

        function initializeWeatherDisplayDOM() {
            const tooltipContent = `<strong>Hogyan működöm?</strong><p>Ezt az időjárási panelt Robi készitette mesterséges intelligencia (AI) segitségével, valós idejű és előrejelzett adatok megjelenitesére Nyiregyháza területéről.</p><strong>Adatforrások:</strong><ul><li>Valós idejű adatok: Weather.com PWS API (Honvéd u., Kossuth út 50, Nyíregyházi út magán időjárás-állomások).</li><li>Csillagászati adatok: SunCalc.js könyvtár a pontos nap- és hold-ciklusokhoz.</li><li>ISS Áthaladások: N2YO.com API (ha engedélyezve)</li><li>Előrejelzés & Ált. adatok: Weather.com & Open-Meteo API-k kombinációja.</li></ul><strong>Frissítési idők:</strong><ul><li>Mérőállomás adatok: ${REFRESH_INTERVAL_PWS / 1000} másodpercenként (szél: ${REFRESH_INTERVAL_WIND / 1000} mp)</li><li>Órás előrejelzés: Minden óra kb. 0., 20. és 40. percében</li><li>ISS adatok: kb. ${REFRESH_INTERVAL_ISS / (60*60*1000)} óránként</li><li>Általános állapot & Előrejelzések: Pár percenként / óránként</li></ul><p>A felület témája (hajnal, nappal, szürkület, éjjel) a napkelte és napnyugta idejéhez igazodik dinamikusan.</p>`;
            const mainRaindropPath = `M50,85 C20,85 15,55 50,15 C85,55 80,85 50,85`;
            const discreetRaindropPath = `M50,85 C25,85 20,55 50,15 C80,55 75,85 50,85`;

            weatherDisplayEl.innerHTML = `<div class="widget-header">
                <div class="header-container">
                    <div class="location-title" id="location-title-text">Nyíregyháza</div>
                    <div class="station-subtitle" id="station-subtitle-text">Állomás kiválasztása...</div>
                </div>
                <div class="timestamp-container">
                    <span class="timestamp" id="timestamp-text">Megfigyelés: --:--:--</span>
                    <div class="info-tooltip-container"><i class="fas fa-info-circle"></i><div class="info-tooltip-content">${tooltipContent}</div></div>
                </div>
            </div>
            
            <div class="top-glance-container">
                <div class="glance-temp-container">
                    <div class="temperature" id="temperature-container"><span id="temperature-value">--</span><span class="temperature-symbol">°C</span></div>
                </div>
                <div class="glance-rain-container">
                    <div class="discreet-rain-container" title="Napi csapadékösszeg">
                        <div id="discreet-rain-gauge" class="rain-visual">
                            <svg class="rain-gauge-svg" viewBox="0 0 100 100">
                                <path class="rain-gauge-bg" d="${discreetRaindropPath}"></path>
                            </svg>
                        </div>
                        <div class="discreet-rain-text">
                            <div id="discreet-rain-visual-value">--<span id="discreet-rain-visual-value-unit">mm</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="station-status-container">
                <div class="station-selector" id="honved-selector-container">
                    <label for="station-select-honved">
                        <input type="radio" name="station-select" id="station-select-honved" value="HONVED">
                        <span class="station-name">${STATIONS.HONVED.displayName}</span>
                        <span id="honved-status-text" class="station-status-text"></span>
                    </label>
                </div>
                <div class="station-selector" id="nyiregyhazi-ut-selector-container">
                     <label for="station-select-nyiregyhazi-ut">
                        <input type="radio" name="station-select" id="station-select-nyiregyhazi-ut" value="NYIREGYHAZI_UT">
                        <span class="station-name">${STATIONS.NYIREGYHAZI_UT.displayName}</span>
                        <span id="nyiregyhazi-ut-status-text" class="station-status-text"></span>
                    </label>
                </div>
                <div class="station-selector" id="kossuth-selector-container">
                    <label for="station-select-kossuth">
                        <input type="radio" name="station-select" id="station-select-kossuth" value="KOSSUTH">
                        <span class="station-name">${STATIONS.KOSSUTH.displayName}</span>
                        <span id="kossuth-status-text" class="station-status-text"></span>
                    </label>
                </div>
            </div>

            <div class="widget-core-data">
                <div class="sun-info-section is-hidden" id="sun-info-section"><div class="sun-path-visual"><svg class="sun-path-svg" viewBox="0 0 150 85" preserveAspectRatio="none"><path class="sun-path-arc-bg" d="M 10 75 A 65 65 0 0 1 140 75"></path><path id="sun-path-arc-main" class="sun-path-arc-main" d="M 10 75 A 65 65 0 0 1 140 75"></path></svg><div class="sun-path-horizon"></div><div class="sun-path-now-marker" id="sun-path-now-marker"></div><i id="sun-path-icon"></i><div class="sun-path-label sunrise-label">Napkelte<div id="sun-path-sunrise-time" class="sun-path-time">--:--</div></div><div class="sun-path-label sunset-label">Napnyugta<div id="sun-path-sunset-time" class="sun-path-time">--:--</div></div></div><div class="sun-text-details"><div class="sun-detail-item"><span class="sun-detail-label"><i class="fas fa-ruler-vertical"></i>Magasság</span><span id="sun-info-altitude" class="sun-detail-value">--°<span id="sun-info-trend" class="sun-trend-text"></span><i id="sun-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Pozíció frissítése"></i></span></div><div class="sun-detail-item"><span class="sun-detail-label"><i class="fas fa-clock"></i>Déli nap</span><span id="sun-info-noon" class="sun-detail-value">--:--</span></div><div class="sun-detail-item"><span class="sun-detail-label"><i class="fas fa-hourglass-half"></i>Nap útja</span><span id="sun-info-remaining" class="sun-detail-value">--</span></div></div></div>
                <div class="moon-info-section is-hidden" id="moon-info-section"><div class="moon-path-visual"><svg class="moon-path-svg" viewBox="0 0 150 85" preserveAspectRatio="none"><path class="moon-path-arc-bg" d="M 10 75 A 65 65 0 0 1 140 75"></path><path id="moon-path-arc-main" class="moon-path-arc-main" d="M 10 75 A 65 65 0 0 1 140 75"></path></svg><div class="moon-path-horizon"></div><div class="moon-path-now-marker" id="moon-path-now-marker"></div><i class="fas fa-moon" id="moon-path-icon"></i><div class="moon-path-label moonrise-label">Holdkelte<div id="moonrise-time-label" class="moon-path-time">--:--</div></div><div class="moon-path-label moonset-label">Holdnyugta<div id="moonset-time-label" class="moon-path-time">--:--</div></div></div><div class="moon-text-details"><div class="moon-detail-item"><span class="moon-detail-label"><i class="fas fa-ruler-vertical"></i>Magasság</span><span id="moon-info-altitude" class="sun-detail-value">--°<span id="moon-info-trend" class="sun-trend-text"></span><i id="moon-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Pozíció frissítése"></i></span></div><div class="moon-detail-item"><span class="moon-detail-label"><i class="fas fa-circle-half-stroke"></i>Fázis</span><span id="moon-info-phasename" class="moon-detail-value">--</span></div><div class="moon-detail-item"><span class="moon-detail-label"><i class="fas fa-lightbulb"></i>Megvilágítás</span><span id="moon-info-illumination" class="moon-detail-value">--%</span></div></div></div>
                <div class="rain-info-section is-hidden" id="rain-info-section"><div class="rain-visual" id="main-rain-visual"><div class="rain-visual-center"><i id="rain-visual-icon" class="fas fa-cloud-showers-heavy"></i><div><span id="rain-visual-total">--</span><span id="rain-visual-total-unit">mm</span></div><div class="rain-visual-label">esett ma eddig</div></div><div class="rain-streak"></div><svg class="rain-gauge-svg" viewBox="0 0 100 100"><defs><clipPath id="raindrop-clip-main"><path d="${mainRaindropPath}"></path></clipPath></defs><path class="rain-gauge-bg" d="${mainRaindropPath}"></path><path id="rain-gauge-value" class="rain-gauge-value" d="${mainRaindropPath}"></path></svg></div><div class="rain-text-details"><div class="rain-detail-item"><span class="rain-detail-label"><i class="fas fa-cloud-rain"></i>Most esik</span><span class="rain-detail-value" id="rain-currently-raining-value"></span></div><div class="rain-detail-item"><span class="rain-detail-label"><i class="fas fa-tachometer-alt"></i>Intenzitás</span><span class="rain-detail-value" id="rain-intensity-value"></span></div><div class="rain-detail-item"><span class="rain-detail-label"><i class="fas fa-bullseye"></i>Várható</span><span class="rain-detail-value" id="rain-expected-today-value"></span></div><div class="rain-detail-item is-hidden" id="next-precip-item"><span class="rain-detail-label"><i class="fas fa-forward"></i>Következő</span><span class="rain-detail-value" id="next-precip-value"></span></div></div></div>
                <div class="night-sky-info-section is-hidden" id="night-sky-info-section">
                    <div id="iss-info" class="is-hidden" style="display: flex; align-items: center; gap: 20px;">
                        <div class="night-sky-visual"><i id="iss-visual-icon" class="fas fa-satellite"></i></div>
                        <div class="night-sky-text-details">
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-rocket"></i>Objektum</span><span class="night-sky-detail-value">Nemzetközi Űrállomás</span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-stopwatch"></i>Következő</span><span class="night-sky-detail-value" id="iss-next-pass-time">--:--</span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-sort-amount-up-alt"></i>Max. magasság</span><span class="night-sky-detail-value" id="iss-max-elevation">--°</span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="far fa-lightbulb"></i>Fényesség</span><span class="night-sky-detail-value" id="iss-brightness">-- mag</span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-hourglass-half"></i>Láthatóság</span><span class="night-sky-detail-value" id="iss-duration">-- perc</span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-route"></i>Útvonal</span><span class="night-sky-detail-value long-text" id="iss-path-details">--</span></div>
                        </div>
                    </div>
                    <div id="planet-info" class="is-hidden" style="display: flex; align-items: center; gap: 20px;">
                        <div class="night-sky-visual"><i id="night-sky-visual-icon" class=""></i></div>
                        <div class="night-sky-text-details">
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-satellite-dish"></i>Objektum</span><span class="night-sky-detail-value" id="night-sky-object-name"></span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-eye"></i></span><span class="night-sky-detail-value long-text" id="night-sky-object-status"></span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-info-circle"></i></span><span class="night-sky-detail-value long-text" id="night-sky-object-details"></span></div>
                            <div class="night-sky-detail-item is-hidden" id="night-sky-astro-darkness-item-planet"><span class="night-sky-detail-label"><i class="far fa-moon"></i>Sötétség</span><span class="night-sky-detail-value long-text" id="night-sky-astro-darkness-planet"></span></div>
                        </div>
                    </div>
                    <div id="constellation-info" class="is-hidden" style="display: flex; align-items: center; gap: 20px;">
                        <div id="constellation-svg-container" style="flex-shrink: 0;"></div>
                        <div class="night-sky-text-details">
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-star"></i>Csillagkép</span><span class="night-sky-detail-value" id="constellation-name"></span></div>
                            <div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-info-circle"></i></span><span class="night-sky-detail-value long-text" id="constellation-details"></span></div>
                            <div class="night-sky-detail-item is-hidden" id="constellation-astro-darkness-item-const"><span class="night-sky-detail-label"><i class="far fa-moon"></i>Sötétség</span><span class="night-sky-detail-value long-text" id="constellation-astro-darkness-const"></span></div>
                        </div>
                    </div>
                </div>

                <div class="temperature-section">
                    <div class="additional-core-info">
                        <div class="secondary-info-bar">
                            <div class="info-bar-item is-hidden" id="heat-index-item"><div class="info-bar-label">Hőérzet</div><div class="info-bar-value"><span id="main-heat-index-value"></span></div></div>
                            <div class="info-bar-item is-hidden" id="wind-speed-item"><div class="info-bar-label">Szél</div><div class="info-bar-value" id="main-wind-value-container" title=""><i id="main-wind-dir-arrow" class="fas fa-location-arrow"></i><span id="main-wind-dir-text"></span><span id="main-wind-speed-value"></span></div></div>
                            <div class="info-bar-item is-hidden" id="wind-gust-item"><div class="info-bar-label">Széllökés</div><div class="info-bar-value"><span id="main-wind-gust-value"></span></div></div>
                        </div>
                    </div>
                    <div class="precipitation-forecast-info is-hidden" id="precipitation-forecast-bar">
                        <span id="next-precipitation-info-text">Csapadék előrejelzés betöltése...</span>
                    </div>
                </div>
            </div>
            <div class="weather-details-grid"><div class="detail-item"><span class="label"><i class="fas fa-tint"></i>Harmatpont:</span><span class="value" id="dewpoint-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-percentage"></i>Páratartalom:</span><span class="value" id="humidity-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-ruler-combined"></i>Légnyomás:</span><span class="value"><span id="pressure-value"></span><span class="pressure-trend-icon" id="pressure-trend-icon"></span></span></div><div class="detail-item"><span class="label"><i class="fas fa-eye"></i>Látótávolság:</span><span class="value" id="visibility-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-sun"></i>Napsugárzás:</span><span class="value" id="solar-radiation-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-umbrella-beach"></i>UV Index:</span><span class="value"><span id="uv-index-value"></span><span class="uv-description-text" id="uv-description"></span></span></div><div class="detail-item" id="grid-sunrise-item"><span class="label"><i class="fas fa-sun"></i>Napkelte:</span><span class="value" id="details-sunrise-value"></span></div><div class="detail-item" id="grid-sunset-item"><span class="label"><i class="fas fa-sun"></i>Napnyugta:</span><span class="value" id="details-sunset-value"></span></div><div class="detail-item" id="grid-moonrise-item"><span class="label"><i class="fas fa-moon"></i>Holdkelte:</span><span class="value" id="moonrise-value"></span></div><div class="detail-item" id="grid-moonset-item"><span class="label"><i class="fas fa-moon"></i>Holdnyugta:</span><span class="value" id="moonset-value"></span></div></div>`;

            // DOM elemek cache-elése
            el_stationSubtitleText = document.getElementById('station-subtitle-text');
            el_timestampText = document.getElementById('timestamp-text');
            el_temperatureValue = document.getElementById('temperature-value');
            el_temperatureContainer = document.getElementById('temperature-container');
            el_rainInfoSection = document.getElementById('rain-info-section');
            el_mainRainVisual = document.getElementById('main-rain-visual');
            el_sunInfoSection = document.getElementById('sun-info-section');
            el_moonInfoSection = document.getElementById('moon-info-section');
            el_nightSkyInfoSection = document.getElementById('night-sky-info-section');
            el_discreetRainGauge = document.getElementById('discreet-rain-gauge');
            el_gridSunriseItem = document.getElementById('grid-sunrise-item');
            el_gridSunsetItem = document.getElementById('grid-sunset-item');
            el_gridMoonriseItem = document.getElementById('grid-moonrise-item');
            el_gridMoonsetItem = document.getElementById('grid-moonset-item');
            el_mainRainGaugeValue = document.getElementById('rain-gauge-value');
            el_mainRainVisualTotal = document.getElementById('rain-visual-total');
            el_rainCurrentlyRainingValue = document.getElementById('rain-currently-raining-value');
            el_rainIntensityValue = document.getElementById('rain-intensity-value');
            el_rainExpectedTodayValue = document.getElementById('rain-expected-today-value');
            el_nextPrecipItem = document.getElementById('next-precip-item');
            el_nextPrecipValue = document.getElementById('next-precip-value');
            el_discreetRainVisualValue = document.getElementById('discreet-rain-visual-value');
            if (el_discreetRainVisualValue) el_discreetRainVisualValueNode = el_discreetRainVisualValue.childNodes[0];


            el_sunPathIcon = document.getElementById('sun-path-icon');
            el_sunPathArcMain = document.getElementById('sun-path-arc-main');
            el_sunPathNowMarker = document.getElementById('sun-path-now-marker');
            el_sunInfoAltitude = document.getElementById('sun-info-altitude');
            if (el_sunInfoAltitude) el_sunInfoAltitudeNode = el_sunInfoAltitude.childNodes[0];
            el_sunInfoTrend = document.getElementById('sun-info-trend');
            el_sunInfoNoon = document.getElementById('sun-info-noon');
            el_sunInfoRemaining = document.getElementById('sun-info-remaining');
            el_sunPathSunriseTime = document.getElementById('sun-path-sunrise-time');
            el_sunPathSunsetTime = document.getElementById('sun-path-sunset-time');
            el_sunPathRefreshBtn = document.getElementById('sun-path-refresh-btn');

            el_moonPathIcon = document.getElementById('moon-path-icon');
            el_moonPathArcMain = document.getElementById('moon-path-arc-main');
            el_moonPathNowMarker = document.getElementById('moon-path-now-marker');
            el_moonriseTimeLabel = document.getElementById('moonrise-time-label');
            el_moonsetTimeLabel = document.getElementById('moonset-time-label');
            el_moonInfoAltitude = document.getElementById('moon-info-altitude');
            if (el_moonInfoAltitude) el_moonInfoAltitudeNode = el_moonInfoAltitude.childNodes[0];
            el_moonInfoTrend = document.getElementById('moon-info-trend');
            el_moonInfoPhasename = document.getElementById('moon-info-phasename');
            el_moonInfoIllumination = document.getElementById('moon-info-illumination');
            el_moonPathRefreshBtn = document.getElementById('moon-path-refresh-btn');

            el_issInfo = document.getElementById('iss-info');
            el_planetInfo = document.getElementById('planet-info');
            el_constellationInfo = document.getElementById('constellation-info');
            el_issVisualIcon = document.getElementById('iss-visual-icon');
            el_issNextPassTime = document.getElementById('iss-next-pass-time');
            el_issMaxElevation = document.getElementById('iss-max-elevation');
            el_issDuration = document.getElementById('iss-duration');
            el_issBrightness = document.getElementById('iss-brightness');
            el_issPathDetails = document.getElementById('iss-path-details');
            el_nightSkyVisualIcon = document.getElementById('night-sky-visual-icon');
            el_nightSkyObjectName = document.getElementById('night-sky-object-name');
            el_nightSkyObjectStatus = document.getElementById('night-sky-object-status');
            el_nightSkyObjectDetails = document.getElementById('night-sky-object-details');
            el_nightSkyAstroDarknessItemPlanet = document.getElementById('night-sky-astro-darkness-item-planet');
            el_nightSkyAstroDarknessPlanet = document.getElementById('night-sky-astro-darkness-planet');
            el_constellationSvgContainer = document.getElementById('constellation-svg-container');
            el_constellationName = document.getElementById('constellation-name');
            el_constellationDetails = document.getElementById('constellation-details');
            el_constellationAstroDarknessItemConst = document.getElementById('constellation-astro-darkness-item-const');
            el_constellationAstroDarknessConst = document.getElementById('constellation-astro-darkness-const');

            el_heatIndexItem = document.getElementById('heat-index-item');
            el_mainHeatIndexValue = document.getElementById('main-heat-index-value');
            el_windSpeedItem = document.getElementById('wind-speed-item');
            el_mainWindDirArrow = document.getElementById('main-wind-dir-arrow');
            el_mainWindDirText = document.getElementById('main-wind-dir-text');
            el_mainWindValueContainer = document.getElementById('main-wind-value-container');
            el_mainWindSpeedValue = document.getElementById('main-wind-speed-value');
            el_windGustItem = document.getElementById('wind-gust-item');
            el_mainWindGustValue = document.getElementById('main-wind-gust-value');

            el_dewpointValue = document.getElementById('dewpoint-value');
            el_humidityValue = document.getElementById('humidity-value');
            el_pressureValue = document.getElementById('pressure-value');
            el_pressureTrendIcon = document.getElementById('pressure-trend-icon');
            el_visibilityValue = document.getElementById('visibility-value');
            el_solarRadiationValue = document.getElementById('solar-radiation-value');
            el_uvIndexValue = document.getElementById('uv-index-value');
            el_uvDescription = document.getElementById('uv-description');
            el_detailsSunriseValue = document.getElementById('details-sunrise-value');
            el_detailsSunsetValue = document.getElementById('details-sunset-value');
            el_moonriseValue = document.getElementById('moonrise-value');
            el_moonsetValue = document.getElementById('moonset-value');

            el_precipitationForecastBar = document.getElementById('precipitation-forecast-bar');
            el_nextPrecipitationInfoText = document.getElementById('next-precipitation-info-text');

            addStationChangeListeners();
            isWeatherDisplayInitialized = true;
        }

        function updateStationStatusUI(stationKey, status = 'unknown') {
            const stationConfig = STATIONS[stationKey];
            if (!stationConfig) return;

            const lowerCaseKey = stationKey.toLowerCase().replace(/_/g, '-');
            const textEl = document.getElementById(`${lowerCaseKey}-status-text`);
            const radioEl = document.getElementById(`station-select-${lowerCaseKey}`);
            const selectorContainerEl = document.getElementById(`${lowerCaseKey}-selector-container`);

            if (!textEl || !radioEl || !selectorContainerEl) return;

            if (status === 'online') {
                textEl.textContent = 'üzemel';
            } else if (status === 'offline') {
                textEl.textContent = 'nem üzemel';
            } else {
                textEl.textContent = 'állapot ?';
            }

            radioEl.checked = (stationKey === activeDisplayStationKey);
            radioEl.disabled = !stationConfig.isOnline;
            selectorContainerEl.classList.toggle('disabled', !stationConfig.isOnline);
        }

        function addStationChangeListeners() { document.querySelectorAll('input[name="station-select"]').forEach(radio => radio.addEventListener('change', handleStationChange)); }
        function handleStationChange(event) {
            const selectedStationKey = event.target.value; if (STATIONS[selectedStationKey].isOnline && selectedStationKey !== activeDisplayStationKey) { activeDisplayStationKey = selectedStationKey; compileAndRenderDisplayData(); } else if (!STATIONS[selectedStationKey].isOnline) { event.target.checked = false; document.querySelector(`input[value="${activeDisplayStationKey}"]`).checked = true; }
        }

        function compileAndRenderDisplayData() {
            const activeStationConfig = STATIONS[activeDisplayStationKey];
            const displayStationData = activeStationConfig.data;
            if (!displayStationData) {
                console.warn("Nincs megjeleníthető adat az aktív állomáshoz.");
                 if (weatherDisplayEl) weatherDisplayEl.innerHTML = `<div class="loading" style="padding: 20px; text-align: center; color: var(--current-text-color);">⚠️ Az aktív állomás (${activeDisplayStationKey}) adatai nem érhetők el.</div>`;
                return;
            }

            cachedData.displayPws = { ...displayStationData.metric, ...displayStationData };

            let precipStationData = null;

            if (STATIONS.NYIREGYHAZI_UT.isOnline && STATIONS.NYIREGYHAZI_UT.provides.includes('precip')) {
                precipStationData = STATIONS.NYIREGYHAZI_UT.data;
            } else if (STATIONS.KOSSUTH.isOnline && STATIONS.KOSSUTH.provides.includes('precip')) {
                 precipStationData = STATIONS.KOSSUTH.data;
            } else if (activeStationConfig.provides.includes('precip')) {
                precipStationData = displayStationData;
            }

            cachedData.displayPws.precipTotal = precipStationData?.metric?.precipTotal;
            cachedData.displayPws.precipRate = precipStationData?.metric?.precipRate;

            renderWeatherData(); renderHourlyForecastData(); renderForecastData();
        }

        function updateAnimatedValue(element, newValue) {
            if (!element) return;
            if (element.textContent.trim() !== newValue.trim()) {
                if (!element.classList.contains('is-flipping')) {
                    element.classList.add('is-flipping');
                    setTimeout(() => {
                        element.textContent = newValue;
                        element.classList.remove('is-flipping');
                    }, 300);
                }
            }
        }

        function renderPrecipitationForecastInfo() {
            if (!el_precipitationForecastBar || !el_nextPrecipitationInfoText) return;

            const nextEvent = findNextPrecipitationEvent(cachedData.hourlyForecast);

            if (nextEvent) {
                el_nextPrecipitationInfoText.innerHTML = `Várható ${nextEvent.type.toLowerCase()}: <strong>${formatTime(nextEvent.time)}</strong> (${formatValue(nextEvent.chance, '%', 0)})`;
                el_precipitationForecastBar.classList.remove('is-hidden');
            } else if (cachedData.hourlyForecast && cachedData.hourlyForecast.length > 0) {
                el_nextPrecipitationInfoText.textContent = "A következő 48 órában nem várható jelentős csapadék.";
                el_precipitationForecastBar.classList.remove('is-hidden');
            } else {
                 el_precipitationForecastBar.classList.add('is-hidden');
                 el_nextPrecipitationInfoText.textContent = "Csapadék előrejelzés jelenleg nem elérhető.";
            }
        }

        function renderWeatherData() {
            const obs = cachedData.displayPws;
            const general = cachedData.generalConditions;
            const sunCalcData = cachedData.sunCalc;
            if (!obs || !general || !sunCalcData) return;

            if (obs.precipTotal > 0.1) {
                hasRainBeenDetectedToday = true;
            }

            if (el_stationSubtitleText) el_stationSubtitleText.textContent = `állomás: ${STATIONS[activeDisplayStationKey].displayName}`;
            updateAnimatedValue(el_timestampText, `Megfigyelés: ${formatTime(obs.obsTimeLocal, true)}`);
            updateAnimatedValue(el_temperatureValue, formatValue(obs.temp, '', 1, '--'));
            
            if (el_temperatureContainer) {
                //el_temperatureContainer.style.setProperty('--current-temp-bg-color', getTemperatureColorVar(obs.temp));
            }
            
            if (el_discreetRainGauge) {
                el_discreetRainGauge.classList.toggle('has-rained-today', hasRainBeenDetectedToday);
            }
            const discreetRainValue = obs.precipTotal !== null && typeof obs.precipTotal !== 'undefined' ? formatValue(obs.precipTotal, '', 1) : '--';
            if (el_discreetRainVisualValueNode) {
                el_discreetRainVisualValueNode.nodeValue = discreetRainValue;
            }

            const isRainingNow = obs.precipRate > 0;
            const isDayTime = sunCalcData.sunAltitude > -0.83;
            const isMoonUp = sunCalcData.isUp;

            if (el_rainInfoSection) el_rainInfoSection.classList.add('is-hidden');
            if (el_sunInfoSection) el_sunInfoSection.classList.add('is-hidden');
            if (el_moonInfoSection) el_moonInfoSection.classList.add('is-hidden');
            if (el_nightSkyInfoSection) el_nightSkyInfoSection.classList.add('is-hidden');
            if (el_mainRainVisual) el_mainRainVisual.classList.remove('is-raining-actively');

            if (el_issInfo) el_issInfo.classList.add('is-hidden');
            if (el_planetInfo) el_planetInfo.classList.add('is-hidden');
            if (el_constellationInfo) el_constellationInfo.classList.add('is-hidden');

            if (isRainingNow) {
                if (el_rainInfoSection) el_rainInfoSection.classList.remove('is-hidden');
                if (el_mainRainVisual) el_mainRainVisual.classList.add('is-raining-actively');
                updatePrecipitationVisuals(obs.precipRate, obs.precipTotal, { gaugeValueEl: el_mainRainGaugeValue, totalValueEl: el_mainRainVisualTotal });
                if (el_rainCurrentlyRainingValue) el_rainCurrentlyRainingValue.textContent = "Igen";
                if (el_rainIntensityValue) el_rainIntensityValue.textContent = formatValue(obs.precipRate, ' mm/h', 2);
                if (el_rainExpectedTodayValue) el_rainExpectedTodayValue.textContent = formatValue(cachedData.expectedRainToday_gauge, ' mm', 1);

                const nextEventInRainSection = findNextPrecipitationEvent(cachedData.hourlyForecast);
                if (nextEventInRainSection && el_nextPrecipItem && el_nextPrecipValue) {
                    el_nextPrecipValue.textContent = `${nextEventInRainSection.type} ~${formatTime(nextEventInRainSection.time)} (${formatValue(nextEventInRainSection.chance, '%', 0)})`;
                    el_nextPrecipItem.classList.remove('is-hidden');
                } else if (el_nextPrecipItem) {
                    el_nextPrecipItem.classList.add('is-hidden');
                }
            } else {
                if (isDayTime) {
                    if (el_sunInfoSection) el_sunInfoSection.classList.remove('is-hidden');
                } else if (isMoonUp) {
                    if (el_moonInfoSection) el_moonInfoSection.classList.remove('is-hidden');
                } else {
                    if (el_nightSkyInfoSection) el_nightSkyInfoSection.classList.remove('is-hidden');
                }
            }

            const sunPathElements = { iconEl: el_sunPathIcon, mainArcEl: el_sunPathArcMain, nowMarkerEl: el_sunPathNowMarker };
            updatePathVisuals(sunCalcData.sunriseDateForPath, sunCalcData.sunsetDateForPath, sunPathElements);
            if (el_sunInfoAltitudeNode) el_sunInfoAltitudeNode.nodeValue = formatValue(sunCalcData.sunAltitude, '°', 1) + ' ';
            if (el_sunInfoTrend) el_sunInfoTrend.textContent = `(${sunCalcData.sunTrend || sunCalcData.sunStatus})`;
            if (el_sunInfoNoon) el_sunInfoNoon.textContent = sunCalcData.solarNoon;
            if (el_sunInfoRemaining) el_sunInfoRemaining.textContent = sunCalcData.remainingDaylight;
            if (el_sunPathSunriseTime) el_sunPathSunriseTime.textContent = sunCalcData.sunrise;
            if (el_sunPathSunsetTime) el_sunPathSunsetTime.textContent = sunCalcData.sunset;
            if (el_sunPathRefreshBtn) el_sunPathRefreshBtn.onclick = () => { el_sunPathRefreshBtn.classList.add('is-refreshing'); updatePathVisuals(sunCalcData.sunriseDateForPath, sunCalcData.sunsetDateForPath, sunPathElements); setTimeout(() => el_sunPathRefreshBtn.classList.remove('is-refreshing'), 800); };

            const moonPathElements = { iconEl: el_moonPathIcon, mainArcEl: el_moonPathArcMain, nowMarkerEl: el_moonPathNowMarker };
            updatePathVisuals(sunCalcData.moonRiseDateForPath, sunCalcData.moonSetDateForPath, moonPathElements);
            if (el_moonriseTimeLabel) el_moonriseTimeLabel.textContent = formatTime(sunCalcData.moonRiseDateForPath);
            if (el_moonsetTimeLabel) el_moonsetTimeLabel.textContent = formatTime(sunCalcData.moonSetDateForPath);
            if (el_moonInfoAltitudeNode) el_moonInfoAltitudeNode.nodeValue = formatValue(sunCalcData.moonAltitude, '°', 1) + ' ';
            if (el_moonInfoTrend) el_moonInfoTrend.textContent = `(${sunCalcData.moonTrend || sunCalcData.moonStatus})`;
            if (el_moonInfoPhasename) el_moonInfoPhasename.textContent = sunCalcData.phaseName || NO_DATA_STRING;
            if (el_moonInfoIllumination) el_moonInfoIllumination.textContent = formatValue(sunCalcData.phaseValue, '%', 1);
            if (el_moonPathIcon && sunCalcData && typeof sunCalcData.phaseValue === 'number') {
                const minOpacity = 0.3;
                const maxOpacity = 1.0;
                el_moonPathIcon.style.opacity = (minOpacity + (sunCalcData.phaseValue / 100) * (maxOpacity - minOpacity)).toFixed(2);
            }
            if (el_moonPathRefreshBtn) el_moonPathRefreshBtn.onclick = () => { el_moonPathRefreshBtn.classList.add('is-refreshing'); updatePathVisuals(sunCalcData.moonRiseDateForPath, sunCalcData.moonSetDateForPath, moonPathElements); setTimeout(() => el_moonPathRefreshBtn.classList.remove('is-refreshing'), 800); };
            
            let nightContentRendered = false;
            if (!isDayTime && !isMoonUp) {
                if (ENABLE_ISS_TRACKING && cachedData.issPasses && cachedData.issPasses.length > 0 && el_issInfo) {
                    const nextPass = cachedData.issPasses[0];
                    if (nextPass.startUTC > new Date()) {
                        if(el_issVisualIcon) el_issVisualIcon.className = 'fas fa-satellite';
                        if(el_issNextPassTime) el_issNextPassTime.textContent = `${formatTime(nextPass.startUTC)} - ${formatTime(nextPass.endUTC)}`;
                        if(el_issMaxElevation) el_issMaxElevation.textContent = `${formatValue(nextPass.maxEl, '°', 0)}`;
                        if(el_issDuration) el_issDuration.textContent = `${Math.round(nextPass.duration / 60)} perc`;
                        if(el_issBrightness) el_issBrightness.textContent = `${formatValue(nextPass.mag, ' mag')}`;
                        if(el_issPathDetails) el_issPathDetails.textContent = `Indul: ${nextPass.startAzCompass} (${formatValue(nextPass.startEl, '°',0)}), Max: ${nextPass.maxAzCompass} (${formatValue(nextPass.maxEl, '°',0)}), Vége: ${nextPass.endAzCompass} (${formatValue(nextPass.endEl, '°',0)})`;
                        el_issInfo.classList.remove('is-hidden');
                        nightContentRendered = true;
                    }
                }
                const nightSkyData = cachedData.nightSkyObject;
                if (nightSkyData && nightSkyData.primary && !nightContentRendered) {
                    const primary = nightSkyData.primary;
                    if (primary.type === 'planet' && el_planetInfo) {
                        el_planetInfo.classList.remove('is-hidden');
                        if(el_nightSkyVisualIcon) el_nightSkyVisualIcon.className = primary.icon;
                        if(el_nightSkyObjectName) el_nightSkyObjectName.textContent = primary.name;
                        if(el_nightSkyObjectStatus) el_nightSkyObjectStatus.textContent = primary.status;
                        if(el_nightSkyObjectDetails) el_nightSkyObjectDetails.textContent = primary.details || '';
                        if(primary.astroDarkness && el_nightSkyAstroDarknessPlanet && el_nightSkyAstroDarknessItemPlanet) {
                            el_nightSkyAstroDarknessPlanet.textContent = primary.astroDarkness;
                            el_nightSkyAstroDarknessItemPlanet.classList.remove('is-hidden');
                        } else if (el_nightSkyAstroDarknessItemPlanet) {
                             el_nightSkyAstroDarknessItemPlanet.classList.add('is-hidden');
                        }
                        nightContentRendered = true;
                    } else if (primary.type === 'constellation' && el_constellationInfo) {
                        el_constellationInfo.classList.remove('is-hidden');
                        if(el_constellationSvgContainer) el_constellationSvgContainer.innerHTML = primary.svg || '';
                        if(el_constellationName) el_constellationName.textContent = primary.name;
                        if(el_constellationDetails) el_constellationDetails.textContent = primary.details || '';
                        if(primary.astroDarkness && el_constellationAstroDarknessConst && el_constellationAstroDarknessItemConst) {
                            el_constellationAstroDarknessConst.textContent = primary.astroDarkness;
                            el_constellationAstroDarknessItemConst.classList.remove('is-hidden');
                        } else if (el_constellationAstroDarknessItemConst) {
                             el_constellationAstroDarknessItemConst.classList.add('is-hidden');
                        }
                        nightContentRendered = true;
                    }
                }
                if (!nightContentRendered && el_constellationInfo && !el_nightSkyInfoSection.classList.contains('is-hidden')) {
                     el_constellationInfo.classList.remove('is-hidden');
                     if(el_constellationSvgContainer) el_constellationSvgContainer.innerHTML = `<svg viewBox="0 0 100 80"><line class="const-line" x1="50" y1="5" x2="50" y2="75"/><line class="const-line" x1="20" y1="45" x2="80" y2="45"/><circle class="star bright" cx="50" cy="5" r="3"></circle><circle class="star" cx="50" cy="75" r="2.5"></circle><circle class="star" cx="20" cy="45" r="2"></circle><circle class="star" cx="80" cy="45" r="2"></circle><circle class="star" cx="50" cy="45" r="2.5"></circle></svg>`;
                     if(el_constellationName) el_constellationName.textContent = "Hattyú (Cygnus)";
                     if(el_constellationDetails) el_constellationDetails.textContent = "Keressük az Északi Keresztet!";
                     if (el_constellationAstroDarknessItemConst) el_constellationAstroDarknessItemConst.classList.add('is-hidden');
                }
            }


            if(el_gridSunriseItem) el_gridSunriseItem.classList.toggle('is-hidden', !el_sunInfoSection.classList.contains('is-hidden'));
            if(el_gridSunsetItem) el_gridSunsetItem.classList.toggle('is-hidden', !el_sunInfoSection.classList.contains('is-hidden'));
            if(el_gridMoonriseItem) el_gridMoonriseItem.classList.toggle('is-hidden', !el_moonInfoSection.classList.contains('is-hidden'));
            if(el_gridMoonsetItem) el_gridMoonsetItem.classList.toggle('is-hidden', !el_moonInfoSection.classList.contains('is-hidden'));

            if (obs.heatIndex != null && el_heatIndexItem) {
                el_heatIndexItem.classList.remove('is-hidden');
                if(el_mainHeatIndexValue) el_mainHeatIndexValue.textContent = formatValue(obs.heatIndex, '°C', 1);
            } else if (el_heatIndexItem) {
                el_heatIndexItem.classList.add('is-hidden');
            }

            if (obs.windSpeed != null && obs.windSpeed >= 0 && el_windSpeedItem) {
                 el_windSpeedItem.classList.remove('is-hidden');
                 if(el_mainWindDirArrow) el_mainWindDirArrow.style.transform = `rotate(${obs.winddir || 0}deg)`;
                 if(el_mainWindDirText) el_mainWindDirText.textContent = degreesToCompassAbbreviated(obs.winddir);
                 if(el_mainWindValueContainer) el_mainWindValueContainer.title = degreesToCompass(obs.winddir);
                 if(el_mainWindSpeedValue) el_mainWindSpeedValue.textContent = formatValue(obs.windSpeed, ' km/h', 1);
            } else if (el_windSpeedItem){
                 el_windSpeedItem.classList.add('is-hidden');
            }

            if (obs.windGust > 0 && el_windGustItem) {
                 el_windGustItem.classList.remove('is-hidden');
                 if(el_mainWindGustValue) el_mainWindGustValue.textContent = formatValue(obs.windGust, ' km/h', 1);
            } else if (el_windGustItem) {
                 el_windGustItem.classList.add('is-hidden');
            }

            updateAnimatedValue(el_dewpointValue, formatValue(obs.dewpt, '°C'));
            updateAnimatedValue(el_humidityValue, formatValue(obs.humidity, '%', 0));
            updateAnimatedValue(el_pressureValue, formatValue(general.pressureAltimeter || obs.pressure, ' hPa'));

            const trendCode = general.pressureTendencyCode; let trendSymbol = ''; if (trendCode === 0) trendSymbol = '↑'; else if (trendCode === 1) trendSymbol = '↓'; else if (trendCode === 2) trendSymbol = '→';
            if(el_pressureTrendIcon) el_pressureTrendIcon.textContent = trendSymbol;

            updateAnimatedValue(el_visibilityValue, formatValue(general.visibility, ' km'));
            updateAnimatedValue(el_solarRadiationValue, formatValue(obs.solarRadiation, ' W/m²', 0));
            updateAnimatedValue(el_uvIndexValue, formatValue(obs.uv, '', 1));

            if(el_uvDescription) el_uvDescription.textContent = general.uvDescription ? `(${general.uvDescription})` : '';
            if(el_detailsSunriseValue) el_detailsSunriseValue.textContent = sunCalcData.sunrise;
            if(el_detailsSunsetValue) el_detailsSunsetValue.textContent = sunCalcData.sunset;
            if(el_moonriseValue) el_moonriseValue.textContent = sunCalcData.moonrise || '--';
            if(el_moonsetValue) el_moonsetValue.textContent = sunCalcData.moonset || '--';

            renderPrecipitationForecastInfo();
        }

        function getTemperatureColorVar(temp) { if (temp === null) return 'var(--mild)'; if (temp >= 35) return 'var(--hot)'; if (temp >= 25) return 'var(--warm)'; if (temp >= 10) return 'var(--mild)'; if (temp >= 0) return 'var(--cool)'; return 'var(--cold)'; }

        function mapTwcIconToFontAwesome(iconCode, dayOrNight) {
            const isDay = dayOrNight === 'D'; const iconMap = { 32: 'fas fa-sun', 36: 'fas fa-sun', 31: 'fas fa-moon', 33: 'fas fa-moon', 34: isDay ? 'fas fa-sun' : 'fas fa-cloud-moon', 29: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 30: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 27: 'fas fa-cloud', 28: 'fas fa-cloud', 26: 'fas fa-cloud', 11: 'fas fa-cloud-showers-heavy', 12: 'fas fa-cloud-showers-heavy', 40: 'fas fa-cloud-showers-heavy', 39: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 45: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 3: 'fas fa-cloud-bolt', 4: 'fas fa-cloud-bolt', 37: 'fas fa-cloud-bolt', 38: 'fas fa-cloud-bolt', 47: 'fas fa-cloud-bolt', 5: 'fas fa-snowflake', 6: 'fas fa-snowflake', 7: 'fas fa-snowflake', 8: 'fas fa-snowflake', 10: 'fas fa-cloud-sleet', 18: 'fas fa-smog', 13: 'fas fa-snowflake', 14: 'fas fa-snowflake', 15: 'fas fa-snowflake', 16: 'fas fa-snowflake', 41: 'fas fa-snowflake', 42: 'fas fa-snowflake', 43: 'fas fa-snowflake', 46: 'fas fa-snowflake', 9: 'fas fa-cloud-rain', 19: 'fas fa-smog', 20: 'fas fa-smog', 21: 'fas fa-smog', 22: 'fas fa-smog', 23: 'fas fa-wind', 24: 'fas fa-wind' };
            return iconMap[iconCode] || 'fas fa-question-circle';
        }

        function mapIconCodeToHungarianText(iconCode, dayOrNight) {
            const isDay = dayOrNight === 'D';
            const textMap = {
                32: 'Napos', 36: 'Napos', 31: 'Tiszta ég', 33: 'Tiszta ég', 34: isDay ? 'Részben napos' : 'Részben felhős', 29: isDay ? 'Részben napos' : 'Részben felhős', 30: isDay ? 'Részben napos' : 'Részben felhős', 27: 'Felhős', 28: 'Felhős', 26: 'Borult', 11: 'Zápor', 12: 'Zápor', 40: 'Zápor', 39: isDay ? 'Zápor' : 'Éjjeli zápor', 45: isDay ? 'Zápor' : 'Éjjeli zápor', 3: 'Zivatar', 4: 'Zivatar', 37: 'Zivatar', 38: 'Zivatar', 47: 'Zivatar', 5: 'Havas eső', 6: 'Ónos eső', 7: 'Havas eső', 8: 'Ónos eső', 10: 'Ónos eső', 18: 'Havas eső', 13: 'Hózápor', 14: 'Hózápor', 15: 'Hófúvás', 16: 'Havazás', 41: 'Havazás', 42: 'Havazás', 43: 'Hófúvás', 46: 'Hózápor', 9: 'Eső', 19: 'Párás', 20: 'Ködös', 21: 'Párás', 22: 'Füstös', 23: 'Szeles', 24: 'Szeles'
            };
            return textMap[iconCode] || 'Ismeretlen';
        }

        function renderHourlyForecastData() {
            const hourlyDataFull = cachedData.hourlyForecast;
            if (!hourlyDataFull || hourlyDataFull.length === 0) {
                if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.add('is-hidden');
                if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.add('is-hidden');
                return;
            }

            const hourlyDataToDisplay = hourlyDataFull.slice(0, 12);

            let forecastHTML = '';
            hourlyDataToDisplay.forEach(hour => {
                let conditionText = hour.wxPhraseShort || mapIconCodeToHungarianText(hour.iconCode, hour.dayOrNight);

                forecastHTML += `
                <div class="hourly-forecast-card">
                    <div class="hourly-primary-info">
                        <div class="hourly-time">${formatTime(hour.time)}</div>
                        <div class="hourly-icon-and-condition">
                            <i class="hourly-icon ${mapTwcIconToFontAwesome(hour.iconCode, hour.dayOrNight)}"></i>
                            <div class="hourly-condition-text">${conditionText}</div>
                        </div>
                        <div class="hourly-temp">${formatValue(hour.temp, '°', 0, '--')}</div>
                    </div>
                    <div class="hourly-secondary-details">
                        <div class="hourly-detail-row">
                            <i class="fas fa-tint"></i>
                            <span>Csapadék: ${formatValue(hour.precipChance, '%', 0, '--')}</span>
                        </div>
                        <div class="hourly-detail-row">
                            <i class="fas fa-wind"></i>
                            <span title="${degreesToCompass(hour.windDirection)}">Szél: ${degreesToCompassAbbreviated(hour.windDirection)} ${formatValue(hour.windSpeed, ' km/h', 0)}</span>
                        </div>
                        <div class="hourly-detail-row">
                            <i class="fas fa-hand-holding-water"></i>
                            <span>Pára: ${formatValue(hour.humidity, '%', 0)}</span>
                        </div>
                         <div class="hourly-detail-row">
                            <i class="fas fa-sun"></i>
                            <span>UV: ${formatValue(hour.uvIndex, '', 0, '0')}</span>
                        </div>
                    </div>
                </div>`;
            });

            if(hourlyForecastContainerEl) hourlyForecastContainerEl.innerHTML = forecastHTML;
            if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.remove('is-hidden');
            if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.remove('is-hidden');
        }

        function formatForecastDate(isoDateString) { if (!isoDateString) return ''; try { const date = new Date(isoDateString); return `${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`; } catch (e) { return ''; } }

        function renderForecastData() {
            const forecastDays = cachedData.forecastDays;
            if (!forecastDays || forecastDays.length === 0) {
                if (forecastContainerEl) forecastContainerEl.classList.add('is-hidden');
                if (forecastTitleEl) forecastTitleEl.classList.add('is-hidden');
                return;
            }
            let forecastHTML = '';
            forecastDays.forEach(day => {
                if (!day.dayName || day.tempMax == null || day.tempMin == null) return;
                forecastHTML += `<div class="forecast-day-card">
                    <div class="forecast-header"><div class="forecast-day-name">${day.dayName}</div><div class="forecast-date">${formatForecastDate(day.date)}</div></div>
                    <div class="forecast-temps">
                        <span class="forecast-temp-max">${formatValue(day.tempMax, '°', 0, '--')}</span>
                        <span class="forecast-temp-min">${formatValue(day.tempMin, '°', 0, '--')}</span>
                    </div>`;
                if (day.dayPart) { 
                    forecastHTML += `<div class="forecast-part">
                        <div class="forecast-part-header"><i class="fas fa-sun"></i>Nappal</div>
                        <div class="forecast-part-details">
                            <p>${day.dayPart.phrase || NO_DATA_STRING}</p>
                            <p>Csapadék: ${formatValue(day.dayPart.precipChance, '%', 0)}</p>
                            <p>Szél: ${degreesToCompass(day.dayPart.windDir)} ${formatValue(day.dayPart.windSpeed, ' km/h', 0)}</p>
                            <p>UV Index: ${formatValue(day.dayPart.uvIndex, '', 0)} (${day.dayPart.uvDescription || 'N/A'})</p>
                        </div>
                    </div>`; 
                }
                if (day.nightPart) { 
                    forecastHTML += `<div class="forecast-part">
                        <div class="forecast-part-header"><i class="fas fa-moon"></i>Éjjel</div>
                        <div class="forecast-part-details">
                            <p>${day.nightPart.phrase || NO_DATA_STRING}</p>
                            <p>Csapadék: ${formatValue(day.nightPart.precipChance, '%', 0)}</p>
                            <p>Szél: ${degreesToCompass(day.nightPart.windDir)} ${formatValue(day.nightPart.windSpeed, ' km/h', 0)}</p>
                        </div>
                    </div>`; 
                }
                forecastHTML += `</div>`;
            });
            if (forecastHTML.trim() === '') {
                if (forecastContainerEl) forecastContainerEl.classList.add('is-hidden');
                if (forecastTitleEl) forecastTitleEl.classList.add('is-hidden');
            } 
            else {
                if (forecastContainerEl) forecastContainerEl.innerHTML = forecastHTML;
                if (forecastContainerEl) forecastContainerEl.classList.remove('is-hidden');
                if (forecastTitleEl) forecastTitleEl.classList.remove('is-hidden');
            }
        }

        async function fetchAllDataAndUpdateDisplay(isInitialLoad = false) {
            const now = Date.now();
            await Promise.allSettled(Object.keys(STATIONS).map(key => fetchPwsStationData(key)));

            if (!STATIONS[activeDisplayStationKey].isOnline) {
                const onlineStations = Object.keys(STATIONS).filter(k => STATIONS[k].isOnline);
                if(onlineStations.length > 0) activeDisplayStationKey = onlineStations[0];
            }

            const independentPromises = [];

            if (isInitialLoad || now - lastApiCallTimes.generalConditions > REFRESH_INTERVAL_GENERAL_CONDITIONS) {
                independentPromises.push(fetchGeneralConditionsData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) Object.assign(cachedData.generalConditions, data); }).catch(e => console.warn("Ált. kondíciók lekérési hiba:", e.message)));
            }
            if (isInitialLoad || now - lastApiCallTimes.openMeteoRain > REFRESH_INTERVAL_OPEN_METEO_RAIN) {
                independentPromises.push(fetchOpenMeteoExpectedRain_gauge(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { cachedData.expectedRainToday_gauge = data; }).catch(e => console.warn("OpenMeteo csapadék lekérési hiba:", e.message)));
            }
            if (isInitialLoad || now - lastApiCallTimes.forecast > REFRESH_INTERVAL_FORECAST) {
                independentPromises.push(fetchDailyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) {
                    cachedData.forecastDays = data.forecastDays;
                    Object.assign(cachedData.generalConditions, {
                        sunriseTimeLocal: data.sunriseTimeLocal || cachedData.generalConditions.sunriseTimeLocal,
                        sunsetTimeLocal: data.sunsetTimeLocal || cachedData.generalConditions.sunsetTimeLocal,
                    });
                } }).catch(e => console.warn("Napi előrejelzés hiba:", e.message)));
            }
            if (isInitialLoad && cachedData.hourlyForecast.length === 0) {
                 independentPromises.push(fetchHourlyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => {
                    if (data) cachedData.hourlyForecast = data;
                    renderHourlyForecastData();
                 }).catch(e => console.warn("Kezdeti órás előrejelzés lekérési hiba:", e.message)));
            }

            if (ENABLE_ISS_TRACKING && (isInitialLoad || now - (lastApiCallTimes.issPasses || 0) > REFRESH_INTERVAL_ISS)) {
                independentPromises.push(
                    fetchIssPasses(N2YO_API_KEY, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon, OBSERVER_ALTITUDE, ISS_NORAD_ID, 3, 15)
                    .then(passes => {
                        cachedData.issPasses = passes;
                        lastApiCallTimes.issPasses = Date.now();
                    })
                    .catch(e => console.error("Hiba az ISS adatok feldolgozásakor a fő ciklusban:", e))
                );
            }

            await Promise.allSettled(independentPromises);

            try {
                const sunCalcResult = await fetchAdvancedSunCalcData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
                cachedData.sunCalc = sunCalcResult;
                if (sunCalcResult.sunriseDateForPath) cachedData.generalConditions.sunriseTimeLocal = sunCalcResult.sunriseDateForPath.toISOString();
                if (sunCalcResult.sunsetDateForPath) cachedData.generalConditions.sunsetTimeLocal = sunCalcResult.sunsetDateForPath.toISOString();
            } catch (e) {
                console.error("SunCalc hiba:", e);
                cachedData.sunCalc = null;
            }

            cachedData.nightSkyObject = getNightSkyInfo(new Date(), cachedData.sunCalc);


            updateThemeAndSky(new Date(), cachedData.generalConditions.sunriseTimeLocal, cachedData.generalConditions.sunsetTimeLocal);
            const anyStationOnline = Object.values(STATIONS).some(s => s.isOnline);

            if (anyStationOnline && STATIONS[activeDisplayStationKey].data && cachedData.generalConditions && cachedData.generalConditions.skyCoverPhrase !== undefined && cachedData.sunCalc) {
                compileAndRenderDisplayData();
            } else {
                let errorMessage = "⚠️ ";
                if (!anyStationOnline) {
                    errorMessage += "Egyik mérőállomás sem elérhető. ";
                } else if (!STATIONS[activeDisplayStationKey].data) {
                    errorMessage += `Az aktív állomás (${STATIONS[activeDisplayStationKey].displayName}) adatai jelenleg nem töltődtek be. `;
                }
                if (!cachedData.generalConditions || cachedData.generalConditions.skyCoverPhrase === undefined) {
                    errorMessage += "Az általános időjárási adatok nem elérhetők. ";
                }
                if (!cachedData.sunCalc) {
                    errorMessage += "A nap- és holdadatok nem elérhetők. ";
                }
                errorMessage += "Kérjük, próbálja később, vagy válasszon másik állomást.";

                if (weatherDisplayEl) {
                     weatherDisplayEl.innerHTML = `<div class="loading" style="padding: 20px; text-align: center; color: var(--current-text-color);">${errorMessage}</div>`;
                }
                if (hourlyForecastContainerEl) hourlyForecastContainerEl.classList.add('is-hidden');
                if (hourlyForecastTitleEl) hourlyForecastTitleEl.classList.add('is-hidden');
                if (forecastContainerEl) forecastContainerEl.classList.add('is-hidden');
                if (forecastTitleEl) forecastTitleEl.classList.add('is-hidden');
            }
        }

        async function fetchAndRefreshWindData() {
            const stationKey = activeDisplayStationKey;
            if (!STATIONS[stationKey] || !STATIONS[stationKey].isOnline) return;

            try {
                await fetchPwsStationData(stationKey);
                const newPwsData = STATIONS[stationKey].data;

                if (newPwsData && cachedData.displayPws) {
                    cachedData.displayPws.winddir = newPwsData.winddir;
                    cachedData.displayPws.windSpeed = newPwsData.metric.windSpeed;
                    cachedData.displayPws.windGust = newPwsData.metric.windGust;
                    cachedData.displayPws.obsTimeLocal = newPwsData.obsTimeLocal;
                    renderWeatherData();
                }
            } catch (error) {
                // Hiba már naplózva
            }
        }

        function scheduleHourlyForecastUpdate() {
            const now = new Date();
            const currentMinutes = now.getMinutes();
            const currentSeconds = now.getSeconds();

            let targetMinute;
            if (currentMinutes < 18) {
                targetMinute = 20;
            } else if (currentMinutes < 38) {
                targetMinute = 40;
            } else {
                targetMinute = 60;
            }

            const randomDelayMinutes = Math.floor(Math.random() * 3);
            let minutesToWait = targetMinute - currentMinutes;
            if (minutesToWait <= 0) {
                minutesToWait += (targetMinute === 60 ? 60 : 20) ;
            }
             minutesToWait = (minutesToWait -1 + randomDelayMinutes);
             if (minutesToWait < 0) minutesToWait = 0;

            const secondsToWait = (minutesToWait === 0 && currentMinutes >= targetMinute - randomDelayMinutes) ? 0 : (60 - currentSeconds);
            const delayInMs = (minutesToWait * 60 + secondsToWait) * 1000;

            console.log(`Következő órás előrejelzés frissítés ütemezve kb. ${Math.round(delayInMs / 60000)} perc múlva. (Cél: ${targetMinute % 60}, Jelenlegi: ${currentMinutes})`);

            setTimeout(async () => {
                console.log(`Időzített órás előrejelzés frissítése: ${new Date().toLocaleTimeString()}`);
                try {
                    const data = await fetchHourlyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
                    if (data) {
                        cachedData.hourlyForecast = data;
                        renderHourlyForecastData();
                        renderPrecipitationForecastInfo();
                    }
                } catch (e) {
                    console.warn("Az időzített órás előrejelzés frissítése sikertelen:", e);
                }

                scheduleHourlyForecastUpdate();
            }, delayInMs > 0 ? delayInMs : 60 * 1000);
        }

        function initApp() {
            weatherDisplayEl = document.getElementById('weather-display');
            forecastContainerEl = document.getElementById('forecast-container');
            forecastTitleEl = document.getElementById('forecast-title');
            hourlyForecastContainerEl = document.getElementById('hourly-forecast-container');
            hourlyForecastTitleEl = document.getElementById('hourly-forecast-title');

            initializeWeatherDisplayDOM();

            fetchAllDataAndUpdateDisplay(true).finally(() => {
                console.log("Az időzített frissítések elindulnak.");

                scheduleHourlyForecastUpdate();

                setInterval(() => fetchAllDataAndUpdateDisplay(false), REFRESH_INTERVAL_PWS);

                setInterval(fetchAndRefreshWindData, REFRESH_INTERVAL_WIND);

                setInterval(() => {
                    if (cachedData.generalConditions && cachedData.generalConditions.sunriseTimeLocal && cachedData.generalConditions.sunsetTimeLocal) {
                        updateThemeAndSky(new Date(), cachedData.generalConditions.sunriseTimeLocal, cachedData.generalConditions.sunsetTimeLocal)
                    }
                }, SKY_COLOR_UPDATE_INTERVAL);

                setInterval(() => {
                    const newDay = new Date().getDate();
                    if (newDay !== currentDay) {
                        console.log("Éjfél, a nap újraindult! A csapadékjelző visszaállítva.");
                        currentDay = newDay;
                        hasRainBeenDetectedToday = false;
                        fetchOpenMeteoExpectedRain_gauge(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon)
                            .then(data => { cachedData.expectedRainToday_gauge = data; })
                            .catch(e => console.warn("Éjféli OpenMeteo csapadék lekérési hiba:", e.message))
                            .finally(() => {
                                if (cachedData.displayPws) {
                                    renderWeatherData();
                                }
                            });
                        if (ENABLE_ISS_TRACKING) {
                            fetchIssPasses(N2YO_API_KEY, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon, OBSERVER_ALTITUDE, ISS_NORAD_ID, 3, 15)
                            .then(passes => {
                                cachedData.issPasses = passes;
                                lastApiCallTimes.issPasses = Date.now();
                                if (cachedData.displayPws) {
                                    renderWeatherData();
                                }
                            })
                            .catch(e => console.error("Éjféli ISS adatfrissítési hiba:", e));
                        }
                    }
                }, 30 * 1000);

            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
