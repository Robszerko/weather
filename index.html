<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Időjárás Monitor - Nyíregyháza</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <style>
        :root {
            --bg-widget-night: rgba(28, 39, 58, 0.85);
            --border-widget-night: rgba(56, 189, 248, 0.35);
            --bg-widget-day: linear-gradient(160deg, rgba(240, 248, 255, 0.7) 0%, rgba(225, 238, 252, 0.65) 100%);
            --border-widget-day: rgba(0, 122, 255, 0.2);
            --accent-interactive-night: #00BFFF;
            --text-primary-night: #EAEAEA;
            --text-secondary-night: #BCCCDC;
            --accent-interactive-day: #007AFF;
            --text-primary-day: #111827;
            --text-secondary-day: #374151;
            --cloud-base-color: #f5f5f5;
            --cloud-shadow-color: #d8d8d8;
            --hot: #EF4444; --warm: #F97316; --mild: #22C55E; --cool: #3B82F6; --cold: #6366F1;
            --wind-calm: #93C5FD; --wind-light: #3B82F6; --wind-moderate: #22C55E; --wind-strong: #F97316; --wind-gale: #EF4444; --wind-storm: #be123c;
            --current-wind-color: var(--wind-calm);
            --current-widget-bg: var(--bg-widget-night);
            --current-widget-border: var(--border-widget-night);
            --current-container-border-color: var(--border-widget-night);
            --current-text-color: var(--text-primary-night);
            --current-text-muted-color: var(--text-secondary-night);
            --current-icon-color: var(--accent-interactive-night);
            --precip-rain-color: #3b82f6;
            --precip-snow-color: #a5f3fc;
            --risk-very-low: #22c55e; --risk-low: #a3e635; --risk-moderate: #facc15; --risk-high: #f97316; --risk-very-high: #ef4444;
        }
        
        #sky-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; 
            background: linear-gradient(to bottom, #0B1120, #020617); 
            transition: background 1s ease-out; 
        }
        #sky-glow {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,224,0.1) 0%, transparent 40%);
            opacity: 0;
            transition: opacity 1.5s ease;
        }
        #stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; opacity: 0; z-index: 2; transition: opacity 3s ease-in-out; }
        .star { position: absolute; background-color: white; border-radius: 50%; }
        
        #haze-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 30%; z-index: 4; background: linear-gradient(to top, rgba(180, 190, 200, 0.2), transparent); opacity: 0; transition: opacity 2s ease-in-out; pointer-events: none; }

        #clouds-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; opacity: 0; transition: opacity 3s ease-in-out; pointer-events: none; }
        
        .cloud-group { position: absolute; will-change: transform; filter: none; transition: filter 0.5s ease-out; }
        .cloud-group .puff { position: absolute; width: 1px; height: 1px; background-color: transparent; border-radius: 50%; transition: box-shadow 1s linear; }

        #precipitation-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 20; pointer-events: none; opacity: 0; transition: opacity 1s ease; }
        
        .raindrop { position: absolute; width: 1.5px; height: 12px; background-color: rgba(200,210,225,0.6); transform: rotate(15deg); }
        .snowflake { position: absolute; color: rgba(220, 230, 240, 0.8); font-size: 1.2em; }
        
        #lightning-flash { position: absolute; top:0; left: 0; width: 100%; height: 100%; z-index: 100; background-color: #ffffff; opacity: 0; pointer-events: none; }
        .flash { animation: flash-anim 0.4s ease-out; }
        @keyframes flash-anim { 0%, 100% { opacity: 0; } 50% { opacity: 0.3; } }

        .is-hidden { display: none !important; }
        body { font-family: 'Inter', sans-serif; font-weight: 500; background-color: #020617; min-height: 100vh; margin: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; text-align: center; padding: 5vh 20px; box-sizing: border-box; position: relative; overflow-x: hidden; }
        .weather-widget { border-radius: 18px; padding: 22px 24px; width: 100%; max-width: 800px; box-sizing: border-box; margin: 0 auto; position: relative; z-index: 30; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 5px 18px rgba(0,0,0,0.12), 0 2px 7px rgba(0,0,0,0.18); backdrop-filter: blur(20px) saturate(120%); -webkit-backdrop-filter: blur(20px) saturate(120%); transition: all 0.6s ease-in-out; }
        #weather-display { position: relative; z-index: 1; display: flex; flex-direction: column; }
        .widget-header { text-align: center; margin-bottom: 10px; padding-bottom: 12px; }
        .header-container { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .location-title { font-size: 22px; font-weight: 800; color: var(--current-text-color); line-height: 1.1; letter-spacing: -0.5px; }
        .timestamp-container { display: flex; flex-direction: column; align-items: center; gap: 4px; margin-top: 10px;}
        .timestamp { font-size: 12.5px; font-weight: 500; color: var(--current-text-muted-color); transition: color 0.6s; }
        .attribution-line { font-size: 11px; color: var(--current-text-muted-color); opacity: 0.8; line-height: 1.4; margin-top: 8px; }
        .station-status-container { display: flex; justify-content: center; align-items: center; gap: 6px; background-color: rgba(0,0,0,0.2); border-radius: 10px; padding: 5px; margin: 10px auto 0 auto; max-width: max-content; flex-wrap: wrap;}
        .station-selector { display: flex; align-items: center; }
        .station-selector input[type="radio"] { display: none; }
        .station-selector label { cursor: pointer; padding: 6px 14px; border-radius: 8px; transition: all 0.3s; font-size: 12px; font-weight: 600; color: var(--current-text-muted-color); display: flex; align-items: center; gap: 6px; }
        .station-selector input[type="radio"]:checked + label { background-color: var(--current-icon-color); color: #fff; box-shadow: 0 2px 8px -2px var(--current-icon-color); }
        .station-selector.disabled label { opacity: 0.4; cursor: not-allowed; }
        .station-status-indicator { width: 8px; height: 8px; border-radius: 50%; transition: background-color: 0.5s; }
        .station-status-indicator.online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .station-status-indicator.offline { background-color: #ef4444; }

        .current-conditions-card { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; background-color: rgba(0,0,0,0.1); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 16px; margin: 20px 0 16px 0; }
        .conditions-section { display: flex; flex-direction: column; }
        .section-title { font-size: 13px; font-weight: 700; color: var(--current-text-color); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; }
        
        .temp-display-card { border-radius: 10px; padding: 16px; background-size: 200% 200%; transition: background 0.8s ease-out, border-color 0.8s ease-out; display: flex; flex-direction: column; align-items: center; justify-content: center; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .temp-primary-display { text-align: center; margin-bottom: 8px; }
        .current-temp-value { font-size: 56px; font-weight: 800; line-height: 1; color: var(--current-text-color); }
        .current-temp-value span:last-child { font-weight: 600; font-size: 0.5em; vertical-align: super; margin-left: 2px; }
        .temp-feels-like-container { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--current-text-muted-color); background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 6px 12px; margin: 8px auto 24px auto; }
        .temp-feels-like-container i { color: var(--current-icon-color); }
        .temp-feels-like-container strong { color: var(--current-text-color); font-weight: 700; }
        .daily-temp-range-visualizer { width: 100%; max-width: 280px; margin: 0 auto; }
        .daily-temp-range-visualizer h4 { margin: 0 0 8px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--current-text-muted-color); }
        .range-bar-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .range-label { font-size: 14px; font-weight: 700; color: var(--current-text-color); text-align: center; flex-shrink: 0; width: 70px; line-height: 1.2; }
        .range-label .time-label { display: block; font-size: 0.7em; font-weight: 500; color: var(--current-text-muted-color); white-space: normal; }
        .range-bar-container { position: relative; flex-grow: 1; height: 8px; }
        .range-bar-bg { width: 100%; height: 100%; border-radius: 4px; background: linear-gradient(to right, var(--cold), var(--cool), var(--mild), var(--warm), var(--hot)); }
        #current-temp-marker { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 1.5em; text-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: left 0.8s ease-out; }
        .range-disclaimer { font-size: 10px; font-style: italic; color: var(--current-text-muted-color); margin-top: 8px; }
        .conditions-section:first-child { border-right: 1px solid var(--current-container-border-color); padding-right: 16px; }
        
        .info-tooltip-container { position: relative; display: inline-flex; align-items: center; justify-content: center; }
        .info-tooltip-trigger { font-size: 10px; font-weight: 600; color: var(--current-icon-color); border: 1px solid var(--current-icon-color); border-radius: 50%; width: 12px; height: 12px; display: flex; justify-content: center; align-items: center; cursor: help; margin-left: 4px; }
        .info-tooltip-content { visibility: hidden; opacity: 0; width: 220px; background-color: var(--bg-widget-night); color: var(--text-primary-night); text-align: left; padding: 10px; border-radius: 8px; border: 1px solid var(--border-widget-night); position: absolute; z-index: 100; bottom: 150%; left: 50%; transform: translateX(-50%); transition: opacity 0.3s, visibility 0.3s; pointer-events: none; font-size: 11px; line-height: 1.5; }
        .info-tooltip-container:hover .info-tooltip-content { visibility: visible; opacity: 1; }
        .pod-label-group { display: flex; align-items: center; justify-content: center; }
        
        .wind-info-card { display: flex; flex-direction: column; gap: 12px; }
        .wind-main-display-centered { display: flex; flex-direction: column; align-items: center; gap: 16px; }
        .wind-compass-container { position: relative; width: 100px; height: 100px; margin: 0 auto; }
        .wind-compass-rose { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 1px solid var(--current-container-border-color); background-color: rgba(0,0,0,0.1); }
        .wind-compass-rose::before, .wind-compass-rose::after { content: ''; position: absolute; background-color: rgba(from var(--current-text-muted-color) r g b / 0.3); }
        .wind-compass-rose::before { width: 1px; height: 90%; top: 5%; left: 50%; transform: translateX(-50%); }
        .wind-compass-rose::after { height: 1px; width: 90%; left: 5%; top: 50%; transform: translateY(-50%); }
        .wind-compass-label { position: absolute; font-size: 10px; font-weight: 700; color: var(--current-text-muted-color); }
        .wind-compass-label.N { top: 2px; left: 50%; transform: translateX(-50%); } .wind-compass-label.E { right: 4px; top: 50%; transform: translateY(-50%); } .wind-compass-label.S { bottom: 2px; left: 50%; transform: translateX(-50%); } .wind-compass-label.W { left: 4px; top: 50%; transform: translateY(-50%); } .wind-compass-label.intercardinal { font-size: 9px; opacity: 0.7; } .wind-compass-label.NE { top: 10%; right: 10%; } .wind-compass-label.SE { bottom: 10%; right: 10%; } .wind-compass-label.SW { bottom: 10%; left: 10%; } .wind-compass-label.NW { top: 10%; left: 10%; }
        #wind-compass-arrow { position: absolute; top: 50%; left: 50%; font-size: 32px; transform-origin: 50% 50%; transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1), color 0.6s; color: var(--current-wind-color); text-shadow: 0 0 8px rgba(0,0,0,0.5); }
        .wind-data-container { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .wind-speed-main-value { font-size: 36px; font-weight: 800; line-height: 1; color: var(--current-wind-color); transition: color 0.6s; }
        .wind-speed-main-value span:last-child { font-size: 0.5em; font-weight: 500; color: var(--current-text-muted-color); margin-left: 2px; }
        .wind-direction-text, .wind-gust-text { font-size: 12px; font-weight: 500; color: var(--current-text-muted-color); }
        .wind-direction-text strong, .wind-gust-text strong { font-weight: 700; color: var(--current-text-color); }
        .beaufort-scale-visualizer { margin-top: 8px; width: 100%; max-width: 250px; align-self: center; } .beaufort-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--current-text-muted-color); margin-bottom: 6px; } .beaufort-scale-container { display: flex; gap: 2px; width: 100%; height: 10px; } .beaufort-bar { flex-grow: 1; background-color: rgba(0,0,0,0.2); border-radius: 2px; transition: background-color 0.5s; } .beaufort-bar.active { background-color: var(--current-wind-color); }
        .wind-detailed-stats { width: 100%; background-color: rgba(0,0,0,0.15); border-radius: 8px; padding: 8px 12px; margin-top: 12px; box-sizing: border-box; } .wind-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; } .wind-stats-item { display: flex; justify-content: space-between; font-size: 11.5px; } .wind-stats-item .label { font-weight: 500; color: var(--current-text-muted-color); } .wind-stats-item .value { font-weight: 700; color: var(--current-text-color); }
        .wind-legend-container { width: 100%; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--current-container-border-color); } 
        .wind-legend-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--current-text-muted-color); margin-bottom: 5px; } 
        .wind-legend-bar-container { position: relative; width: 100%; height: 10px; margin-bottom: 4px; }
        .wind-legend-bar { width: 100%; height: 100%; border-radius: 5px; background: linear-gradient(to right, var(--wind-calm), var(--wind-light), var(--wind-moderate), var(--wind-strong), var(--wind-gale), var(--wind-storm)); } 
        #wind-speed-marker { position: absolute; top: -10px; left: 0%; color: #fff; font-size: 1.5em; text-shadow: 0 1px 3px rgba(0,0,0,0.5); transform: translateX(-50%); transition: left 0.8s ease-out; }
        .wind-legend-labels { display: flex; justify-content: space-between; font-size: 10px; font-weight: 600; color: var(--current-text-muted-color); margin-top: 4px; padding: 0 5px; }

        .pws-details-container { background-color: transparent; border: none; padding: 0; margin-top: 20px; }
        .pws-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .detail-pod { background-color: rgba(0,0,0,0.15); border-radius: 12px; padding: 8px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; text-align: center; transition: all 0.3s ease; }
        .detail-pod:hover { transform: translateY(-3px); background-color: rgba(0,0,0,0.25); }
        .pod-icon-container { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 6px; transition: background-color 0.5s; }
        .pod-icon-container i { color: #fff; font-size: 14px; }
        .pod-data { display: flex; flex-direction: column; align-items: center; }
        .pod-data .value { font-size: 15px; font-weight: 700; color: var(--current-text-color); line-height: 1.2; }
        .pod-data .label { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); line-height: 1.1; }
        .pressure-trend-icon { font-size: 0.8em; margin-left: 2px; }
        #detail-pod-humidity .pod-icon-container { background-color: #3b82f6; }
        #detail-pod-pressure .pod-icon-container { background-color: #8b5cf6; }
        #detail-pod-sun .pod-icon-container { background-color: #f59e0b; }
        #detail-pod-moon .pod-icon-container { background-color: #64748b; }
        #detail-pod-visibility .pod-icon-container { background-color: #06b6d4; }
        #detail-pod-dewpoint .pod-icon-container { background-color: #14b8a6; }
        #detail-pod-windchill .pod-icon-container { background-color: #60a5fa; }
        #detail-pod-windrun .pod-icon-container { background-color: #2dd4bf; }
        #detail-pod-cloudbase .pod-icon-container { background-color: #94a3b8; }
        #detail-pod-abshumidity .pod-icon-container { background-color: #38bdf8; }
        #detail-pod-diurnalrange .pod-icon-container { background-color: #f472b6; }
        #detail-pod-altitude .pod-icon-container { background-color: #16a34a; }
        #detail-pod-daylength .pod-icon-container { background-color: #facc15; }
        #detail-pod-vaporpressure .pod-icon-container { background-color: #a78bfa; }

        .risk-assessment-container { padding: 12px 14px; }
        .risk-assessment-content { display: flex; flex-direction: column; align-items: center; gap: 10px; background-color: rgba(0,0,0,0.15); border-radius: 12px; padding: 16px; }
        .risk-level-text { font-size: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; transition: color 0.5s ease; }
        .risk-bar-container { width: 100%; max-width: 250px; height: 10px; background-color: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; }
        .risk-bar-fill { width: 0%; height: 100%; border-radius: 5px; transition: width 0.8s ease-out, background-color 0.5s ease; }


        .precipitation-forecast-section { background-color: rgba(0,0,0,0.08); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 12px 14px; margin-bottom: 20px; }
        .precip-summary-text { font-size: 13px; font-weight: 600; padding: 8px 12px; border-radius: 8px; background-color: rgba(0,0,0,0.15); margin-bottom: 12px; text-align: center; color: var(--current-text-color); }
        .precip-forecast-list { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .precip-forecast-item { display: grid; grid-template-columns: 45px 50px 1fr 30px; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid rgba(from var(--current-container-border-color) r g b / 0.15); }
        .precip-forecast-item:last-child { border-bottom: none; } .precip-forecast-item.first-hour { background-color: rgba(0,0,0,0.1); margin: -4px -8px; padding: 8px; border-radius: 6px; border-bottom: none; } .forecast-time { font-size: 13px; font-weight: 700; color: var(--current-text-color); text-align: center; } .chance-visualizer { position: relative; width: 40px; height: 40px; } .chance-visualizer svg { transform: rotate(-90deg); width: 100%; height: 100%; } .chance-visualizer circle { fill: transparent; stroke-width: 4px; } .chance-visualizer .bg-circle { stroke: rgba(0,0,0,0.2); } .chance-visualizer .progress-circle { stroke: var(--current-icon-color); transition: stroke-dashoffset 0.6s ease-out; } .chance-percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 700; color: var(--current-text-color); } .intensity-details { display: flex; flex-direction: column; gap: 4px; text-align: left; } .forecast-bar-container { position: relative; height: 6px; background-color: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; } .forecast-bar-fill { height: 100%; background-color: var(--precip-rain-color); border-radius: 3px; transition: width 0.6s ease-out; } .precip-forecast-item.is-snow .forecast-bar-fill { background-color: var(--precip-snow-color); } .intensity-text { font-size: 11px; font-weight: 600; color: var(--current-text-muted-color); } .forecast-type-icon { font-size: 16px; text-align: center; color: var(--precip-rain-color); } .precip-forecast-item.is-snow .forecast-type-icon { color: var(--precip-snow-color); }

        .precip-summary-card { display: flex; flex-direction: column; gap: 0; background: linear-gradient(170deg, rgba(0,0,0,0.1), rgba(0,0,0,0.18)); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 0; margin-bottom: 20px; transition: all 0.5s ease; overflow: hidden; }
        .precip-card-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 16px; border-bottom: 1px solid rgba(from var(--current-container-border-color) r g b / 0.4); background-color: rgba(0,0,0,0.1); }
        .precip-header-title-group { display: flex; align-items: center; gap: 12px; }
        .precip-header-icon i { font-size: 22px; color: var(--current-icon-color); transition: color 0.5s ease; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .precip-header-title { font-size: 16px; font-weight: 800; color: var(--current-text-color); margin: 0; letter-spacing: 0.5px; }
        .precip-card-content { padding: 12px 16px; width: 100%; box-sizing: border-box; }
        .precip-station-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .precip-station-card { background-color: rgba(0,0,0,0.15); border: 1px solid var(--current-container-border-color); border-radius: 10px; padding: 8px; display: flex; flex-direction: column; gap: 6px; transition: all 0.4s ease; }
        .precip-station-card.is-raining-now { border-color: rgba(from var(--current-icon-color) r g b / 0.6); box-shadow: 0 0 12px -3px rgba(from var(--current-icon-color) r g b / 0.4); }
        .station-card-header { display: flex; justify-content: space-between; align-items: center; } .station-card-name { font-weight: 700; font-size: 13px; color: var(--current-text-color); } .station-card-status-icon { width: 8px; height: 8px; border-radius: 50%; background-color: var(--current-icon-color); box-shadow: 0 0 8px var(--current-icon-color); }
        .station-card-main { text-align: center; } .station-card-total-label { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); } .station-card-total-value { font-size: 24px; font-weight: 800; color: var(--current-text-color); line-height: 1.1; } .station-card-total-value span { font-size: 0.6em; font-weight: 600; color: var(--current-text-muted-color); margin-left: 2px; }
        .station-card-footer-info { font-size: 11px; text-align: center; font-weight: 600; color: var(--current-text-muted-color); border-top: 1px solid var(--current-container-border-color); padding-top: 5px; min-height: 14px; } .station-card-footer-info.live-intensity { color: var(--current-text-color); font-style: italic; }
        .precip-explanation-container { display: flex; flex-direction: column; align-items: flex-start; text-align: left; gap: 10px; padding: 12px 4px; } .explanation-title { font-size: 15px; font-weight: 700; color: var(--current-text-color); margin: 0; width: 100%; text-align: center; padding-bottom: 8px; border-bottom: 1px solid rgba(from var(--current-container-border-color) r g b / 0.3); } .explanation-subtitle { font-size: 13px; font-weight: 600; color: var(--current-text-color); margin: 5px 0 -5px 0; } .explanation-text { font-size: 12.5px; line-height: 1.6; color: var(--current-text-muted-color); margin: 0; } .explanation-text strong { color: var(--current-text-color); font-weight: 600; }
        .precip-card-footer { padding: 8px 16px 12px 16px; border-top: 1px solid rgba(from var(--current-container-border-color) r g b / 0.3); text-align: center; } .station-tooltip-container { position: relative; display: inline-block; } .station-list-trigger { font-size: 12px; font-weight: 600; color: var(--current-icon-color); border-bottom: 1px dashed var(--current-icon-color); cursor: help; padding: 4px; } .station-tooltip-content { visibility: hidden; opacity: 0; width: 280px; background-color: var(--bg-widget-night); color: var(--text-primary-night); padding: 10px; border-radius: 8px; border: 1px solid var(--border-widget-night); position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%); transition: opacity 0.3s, visibility 0.3s; pointer-events: none; font-size: 12px; line-height: 1.5; } .station-tooltip-container:hover .station-tooltip-content { visibility: visible; opacity: 1; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; } .section-timestamp { font-size: 11px; font-weight: 500; color: var(--current-text-muted-color); }
        .flippable-value { display: inline-block; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; } .flippable-value.is-flipping { transform: rotateX(90deg) scale(0.5); }
        .forecast-title { width: 100%; max-width: 800px; font-size: 16px; font-weight: 700; color: var(--current-text-color); margin-top: 24px; margin-bottom: 12px; text-align: center; transition: color 0.6s; display: flex; justify-content: space-between; align-items: center; }
        .hourly-forecast-container { width: 100%; max-width: 800px; display: grid; grid-template-columns: 1fr; gap: 8px; padding: 4px; box-sizing: border-box; margin: 0 auto; }
        .hourly-forecast-card { display: flex; flex-direction: column; align-items: stretch; gap: 6px; padding: 8px; border-radius: 12px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--current-text-color); transition: all 0.6s; } .hourly-primary-info { display: flex; flex-direction: row; align-items: center; justify-content: space-around; gap: 6px; } .hourly-time { font-size: 12px; font-weight: 700; flex-shrink: 0; } .hourly-icon-and-condition { display: flex; flex-direction: column; align-items: center; gap: 2px; } .hourly-icon { font-size: 20px; color: var(--current-icon-color); } .hourly-condition-text { font-size: 9.5px; font-weight: 500; color: var(--current-text-muted-color); white-space: nowrap; text-align: center; } .hourly-temp { font-size: 16px; font-weight: 700; flex-shrink: 0; } .hourly-secondary-details { display: flex; flex-direction: column; align-items: stretch; gap: 3px; font-size: 10px; border-top: 1px solid var(--current-container-border-color); padding-top: 5px; margin-top: 3px; } .hourly-detail-row { display: flex; justify-content: space-between; align-items: center; } .hourly-detail-row span { display: flex; align-items: center; gap: 5px; } .hourly-detail-row i { width: 12px; text-align: center; opacity: 0.7; }
        
        @media (min-width: 420px) { .hourly-forecast-container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 640px) { .hourly-forecast-container { grid-template-columns: repeat(3, 1fr); } .precip-forecast-item { grid-template-columns: 50px 60px 1fr 40px; gap: 12px; } .pws-details-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .precip-station-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); } .pws-details-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1000px) { .hourly-forecast-container { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 768px) { .current-conditions-card { grid-template-columns: 1fr; gap: 0; } .conditions-section:first-child { border-right: none; padding-right: 0; padding-bottom: 16px; border-bottom: 1px solid var(--current-container-border-color); } }
        @media (max-width: 480px) { .current-temp-value { font-size: 48px; } .wind-main-display { grid-template-columns: 80px 1fr; } .wind-compass-container { width: 80px; height: 80px; } #wind-compass-arrow { font-size: 28px; } .pws-details-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div id="sky-container"><div id="sky-glow"></div><div id="stars-container"></div><div id="haze-container"></div><div id="clouds-container"></div><div id="precipitation-container"></div><div id="lightning-flash"></div></div>
    <div class="weather-widget"><div id="weather-display"></div></div>
    <h3 class="forecast-title is-hidden" id="hourly-forecast-title"><span>A következő órákban várható időjárás</span><span class="section-timestamp" id="hourly-forecast-timestamp"></span></h3>
    <div class="hourly-forecast-container" id="hourly-forecast-container"></div>
    <script>
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525'; const REFRESH_INTERVAL_PWS = 30 * 1000; const REFRESH_INTERVAL_FORECAST = 60 * 60 * 1000; const NYIREGYHAZA_COORDS = { lat: 47.9550, lon: 21.7160 };
        
        const STATIONS = { 
            NYIREGYHAZI_UT: { id: 'INYREG26', name: 'Nyíregyházi út', displayName: 'Nyíregyházi út', coords: NYIREGYHAZA_COORDS, provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, 
            KOSSUTH: { id: 'INYREG42', name: 'Nyíregyháza Kossuth út 50', displayName: 'Kossuth út 50', displayNameShort: 'Kossuth út', coords: NYIREGYHAZA_COORDS, provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure', 'precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            KERT_UTCA: { id: 'INYREG37', name: 'Nyíregyháza Kert utca', displayName: 'Kert u.', coords: NYIREGYHAZA_COORDS, provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, 
            SOSTOHEGY: { id: 'INYREG20', name: 'Sóstóhegy (Állatpark)', displayName: 'Sóstóhegy', displayNameShort: 'Sóstóhegy', coords: { lat: 48.00, lon: 21.72 }, provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, 
            BORBANYA: { id: 'INYREG30', name: 'Borbánya', displayName: 'Borbánya', displayNameShort: 'Borbánya', coords: { lat: 47.92, lon: 21.74 }, provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, 
            OROS_DERUS: { id: 'INYREG35', name: 'Oros Derűs utca', displayName: 'Oros', displayNameShort: 'Oros', coords: { lat: 47.93, lon: 21.79 }, provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, 
            NAGYHALASZ: { id: 'INAGYH4', name: 'Nagyhalász', displayName: 'Nagyhalász', displayNameShort: 'Nagyhalász', coords: { lat: 48.118, lon: 21.759 }, provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, 
            SZAKOLY: { id: 'ISZAKO1', name: 'Szakoly', displayName: 'Szakoly', displayNameShort: 'Szakoly', coords: { lat: 47.818, lon: 21.984 }, provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null },
            KEMECSE: { id: 'IKEMEC1', name: 'Kemecse', displayName: 'Kemecse', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            RAMOCSAHAZA: { id: 'IRAMOC1', name: 'Ramocsaháza', displayName: 'Ramocsaháza', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            SENYO: { id: 'ISNY1', name: 'Sényő', displayName: 'Sényő', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            NYIRADONY: { id: 'INYRAD1', name: 'Nyíradony', displayName: 'Nyíradony', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            NYIRBOGAT: { id: 'INYRBO3', name: 'Nyírbogát', displayName: 'Nyírbogát', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            NAPKOR: { id: 'INAPKO1', name: 'Napkor', displayName: 'Napkor', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            GAVAVENCSELLO: { id: 'IGVAVE1', name: 'Gávavencsellő', displayName: 'Gávavencsellő', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            PATROHA: { id: 'IPTROH1', name: 'Pátroha', displayName: 'Pátroha', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            AJAK: { id: 'IAJAK4', name: 'Ajak', displayName: 'Ajak', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            KISVARDA: { id: 'IKISVR2', name: 'Kisvárda', displayName: 'Kisvárda', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            VASAROSNAMENY: { id: 'IVSROS2', name: 'Vásárosnamény', displayName: 'Vásárosnamény', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            FEHERGYARMAT: { id: 'IFEHRG1', name: 'Fehérgyarmat', displayName: 'Fehérgyarmat', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            PORCSALMA: { id: 'IPORCS2', name: 'Porcsalma', displayName: 'Porcsalma', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            CSENGER: { id: 'ICSENG10', name: 'Csenger', displayName: 'Csenger', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
            MATESZALKA: { id: 'IMTSZALK4', name: 'Mátészalka', displayName: 'Mátészalka', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, 
        };
        let activeDisplayStationKey = 'NYIREGYHAZI_UT'; 
        let cachedData = { displayPws: null, generalConditions: {}, sunCalc: null, sunTimes: null };
        let forecastCache = {};
        let isWeatherDisplayInitialized = false; 
        let weatherDisplayEl, hourlyForecastContainerEl, hourlyForecastTitleEl; 
        let skyContainerEl, skyGlowEl, starsContainerEl, cloudsContainerEl, precipitationContainerEl, hazeContainerEl, lightningFlashEl; 
        let currentSkyState = { cloudAmount: 0, precipRate: 0, isThundering: false, isFoggy: false, isSnowing: false, windSpeed: 0 }; 
        const NO_DATA_STRING = 'N/A'; 
        const SNOW_ICON_CODES = [5, 6, 7, 8, 10, 13, 14, 15, 16, 41, 42, 43, 46];
        
        let rainDetectedToday = false;
        let lastCheckedDay = new Date().getDate();

        const CURIOSITY_EXPLANATIONS = {
            risk: "Ez az index a helyi, valós idejű adatokból (hőmérséklet, harmatpont, légnyomás) számol egy kockázati értéket a következő 30-90 percre. Nem egy hivatalos előrejelzés, hanem egy 'légköri feszültség' mutató, ami jelzi, ha a feltételek ideálissá válnak a csapadék kialakulásához."
        };
        
        function formatValue(value, unit = '', precision = 1, notAvailableString = NO_DATA_STRING) { if (value === null || typeof value === 'undefined' || (typeof value === 'number' && isNaN(value)) ) return notAvailableString; if (typeof value === 'number') { return `${value.toFixed(precision)}${unit}`; } return `${value}${unit}`; }
        function formatTime(dateOrIsoString, options = {}) { const { includeSeconds = false, prefix = '' } = options; if (!dateOrIsoString) return 'N/A'; try { const date = new Date(dateOrIsoString); if (isNaN(date.getTime())) return 'N/A'; const timeOptions = { hour: '2-digit', minute: '2-digit' }; if (includeSeconds) timeOptions.second = '2-digit'; const timeString = date.toLocaleTimeString('hu-HU', timeOptions); return prefix ? `${prefix} ${timeString}` : timeString; } catch (e) { return 'N/A'; } }
        function formatHourOnly(dateOrIsoString) { if (!dateOrIsoString) return '--h'; try { const date = new Date(dateOrIsoString); if (isNaN(date.getTime())) return '--h'; return date.toLocaleTimeString('hu-HU', { hour: '2-digit' }) + 'h'; } catch (e) { return '--h'; } }
        
        function getPrecipIntensityDescription(rate) { if (rate == null || rate <= 0) return 'Nincs'; if (rate > 0 && rate <= 0.2) return 'Pár csepp'; if (rate > 0.2 && rate <= 0.5) return 'Szitálás'; if (rate > 0.5 && rate <= 1.0) return 'Enyhe eső'; if (rate > 1.0 && rate <= 4.0) return 'Mérsékelt eső'; if (rate > 4.0 && rate <= 10.0) return 'Intenzív eső'; if (rate > 10.0 && rate <= 25.0) return 'Zápor'; return 'Felhőszakadás'; }
        function degreesToCompass(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["északi", "észak-északkeleti", "északkeleti", "kelet-északkeleti", "keleti", "kelet-délkeleti", "délkeleti", "dél-délkeleti", "déli", "dél-délnyugati", "délnyugati", "nyugat-délnyugati", "nyugati", "nyugat-északnyugati", "északnyugati", "észak-északnyugati"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function degreesToCompassAbbreviated(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["É", "ÉÉK", "ÉK", "KÉK", "K", "KDK", "DK", "DDK", "D", "DDNY", "DNY", "NYDNY", "NY", "NYÉNY", "ÉNY", "ÉÉNY"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function getBeaufort(speed) { if (speed === null || typeof speed === 'undefined') return { num: 0, desc: 'Szélcsend' }; if (speed < 1) return { num: 0, desc: 'Szélcsend' }; if (speed <= 5) return { num: 1, desc: 'Gyenge szellő' }; if (speed <= 11) return { num: 2, desc: 'Enyhe szellő' }; if (speed <= 19) return { num: 3, desc: 'Gyenge szél' }; if (speed <= 28) return { num: 4, desc: 'Mérsékelt szél' }; if (speed <= 38) return { num: 5, desc: 'Élénk szél' }; if (speed <= 49) return { num: 6, desc: 'Erős szél' }; if (speed <= 61) return { num: 7, desc: 'Viharos szél' }; if (speed <= 74) return { num: 8, desc: 'Vihar' }; if (speed <= 88) return { num: 9, desc: 'Szélvihar' }; if (speed <= 102) return { num: 10, desc: 'Heves vihar' }; if (speed <= 117) return { num: 11, desc: 'Orkán' }; return { num: 12, desc: 'Orkán' }; }
        function getWindColor(speed) { if (speed == null) return 'var(--wind-calm)'; if (speed <= 5) return 'var(--wind-calm)'; if (speed <= 19) return 'var(--wind-light)'; if (speed <= 38) return 'var(--wind-moderate)'; if (speed <= 61) return 'var(--wind-strong)'; if (speed <= 88) return 'var(--wind-gale)'; return 'var(--wind-storm)'; }
        function getSolarRadiationColor(w_m2) { if (w_m2 === null || typeof w_m2 === 'undefined' || w_m2 < 50) return 'var(--cool)'; if (w_m2 < 250) return 'var(--mild)'; if (w_m2 < 500) return 'var(--warm)'; return 'var(--hot)'; }
        function getUVColor(uv) { if (uv === null || typeof uv === 'undefined') return 'var(--cool)'; if (uv <= 2) return 'var(--mild)'; if (uv <= 5) return 'var(--warm)'; if (uv <= 7) return '#F97316'; if (uv <= 10) return 'var(--hot)'; return '#A134A1'; }
        
        function getTempGradient(temp) { const tempColors = [ { t: -10, color1: '#4338ca', color2: '#6366f1' }, { t: 0,   color1: '#6366f1', color2: '#3b82f6' }, { t: 10,  color1: '#3b82f6', color2: '#22c55e' }, { t: 20,  color1: '#22c55e', color2: '#facc15' }, { t: 28,  color1: '#facc15', color2: '#f97316' }, { t: 35,  color1: '#f97316', color2: '#ef4444' } ]; if (temp <= tempColors[0].t) return `linear-gradient(145deg, ${tempColors[0].color1}, ${tempColors[0].color2})`; if (temp >= tempColors[tempColors.length - 1].t) return `linear-gradient(145deg, ${tempColors[tempColors.length - 1].color1}, ${tempColors[tempColors.length - 1].color2})`; for (let i = 0; i < tempColors.length - 1; i++) { const lower = tempColors[i]; const upper = tempColors[i + 1]; if (temp > lower.t && temp <= upper.t) { const factor = (temp - lower.t) / (upper.t - lower.t); const interpolate = (c1, c2) => { const r = Math.round(parseInt(c1.slice(1, 3), 16) * (1 - factor) + parseInt(c2.slice(1, 3), 16) * factor); const g = Math.round(parseInt(c1.slice(3, 5), 16) * (1 - factor) + parseInt(c2.slice(3, 5), 16) * factor); const b = Math.round(parseInt(c1.slice(5, 7), 16) * (1 - factor) + parseInt(c2.slice(5, 7), 16) * factor); return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`; }; const color1 = interpolate(lower.color1, upper.color1); const color2 = interpolate(lower.color2, upper.color2); return `linear-gradient(145deg, ${color1}, ${color2})`; } } return 'linear-gradient(145deg, #6b7280, #9ca3af)'; }
        function getTempColor(temp) { if (temp === null || typeof temp === 'undefined') return 'var(--mild)'; if (temp <= 5) return 'var(--cold)'; if (temp <= 12) return 'var(--cool)'; if (temp <= 22) return 'var(--mild)'; if (temp <= 28) return 'var(--warm)'; return 'var(--hot)'; }

        function mapIconCodeToHungarianText(iconCode, dayOrNight) { const isDay = dayOrNight === 'D'; const textMap = { 32: 'Napos', 36: 'Napos', 31: 'Tiszta ég', 33: 'Tiszta ég', 34: isDay ? 'Részben napos' : 'Részben felhős', 29: isDay ? 'Részben napos' : 'Részben felhős', 30: isDay ? 'Részben napos' : 'Részben felhős', 27: 'Felhős', 28: 'Felhős', 26: 'Borult', 11: 'Zápor', 12: 'Zápor', 40: 'Zápor', 39: isDay ? 'Zápor' : 'Éjjeli zápor', 45: isDay ? 'Zápor' : 'Éjjeli zápor', 3: 'Zivatar', 4: 'Zivatar', 37: 'Zivatar', 38: 'Zivatar', 47: 'Zivatar', 5: 'Havas eső', 6: 'Ónos eső', 7: 'Havas eső', 8: 'Ónos eső', 10: 'Ónos eső', 18: 'Havas eső', 13: 'Hózápor', 14: 'Hózápor', 15: 'Hófúvás', 16: 'Havazás', 41: 'Havazás', 42: 'Havazás', 43: 'Hófúvás', 46: 'Hózápor', 9: 'Eső', 19: 'Párás', 20: 'Ködös', 21: 'Párás', 22: 'Füstös', 23: 'Szeles', 24: 'Szeles' }; return textMap[iconCode] || 'Ismeretlen'; }
        function mapTwcIconToFontAwesome(iconCode, dayOrNight) { const isDay = dayOrNight === 'D'; const iconMap = { 32:'fas fa-sun',36:'fas fa-sun',31:'fas fa-moon',33:'fas fa-moon',34:isDay ?'fas fa-cloud-sun':'fas fa-cloud-moon',29:isDay ?'fas fa-cloud-sun':'fas fa-cloud-moon',30:isDay ?'fas fa-cloud-sun':'fas fa-cloud-moon',27:'fas fa-cloud',28:'fas fa-cloud',26:'fas fa-cloud',11:'fas fa-cloud-showers-heavy',12:'fas fa-cloud-showers-heavy',40:'fas fa-cloud-showers-heavy',39:isDay ?'fas fa-cloud-sun-rain':'fas fa-cloud-moon-rain',45:isDay ?'fas fa-cloud-sun-rain':'fas fa-cloud-moon-rain',3:'fas fa-cloud-bolt',4:'fas fa-cloud-bolt',37:'fas fa-cloud-bolt',38:'fas fa-cloud-bolt',47:'fas fa-cloud-bolt',5:'fas fa-snowflake',6:'fas fa-snowflake',7:'fas fa-snowflake',8:'fas fa-snowflake',10:'fas fa-cloud-sleet',18:'fas fa-smog',13:'fas fa-snowflake',14:'fas fa-snowflake',15:'fas fa-snowflake',16:'fas fa-snowflake',41:'fas fa-snowflake',42:'fas fa-snowflake',43:'fas fa-snowflake',46:'fas fa-snowflake',9:'fas fa-cloud-rain',19:'fas fa-smog',20:'fas fa-smog',21:'fas fa-smog',22:'fas fa-smog',23:'fas fa-wind',24:'fas fa-wind' }; return iconMap[iconCode] || 'fas fa-question-circle'; }
        
        const SKY_THEME_MAP = { nightEnd: { top: '#020617', bottom: '#1f2937', stars: 0.8 }, nauticalDawn: { top: '#1e3a8a', bottom: '#4c1d95', stars: 0.5 }, dawn: { top: '#4c6cb3', bottom: '#f59e0b', stars: 0.2 }, sunrise: { top: '#87ceeb', bottom: '#ffb47c', stars: 0 }, goldenHour: { top: '#60a5fa', bottom: '#fcd34d', stars: 0 }, solarNoon: { top: '#38bdf8', bottom: '#a7ddf5', stars: 0 }, goldenHourEnd: { top: '#3b82f6', bottom: '#fb923c', stars: 0 }, sunset: { top: '#f59e0b', bottom: '#be123c', stars: 0.2 }, dusk: { top: '#4f46e5', bottom: '#1e1b4b', stars: 0.5 }, nauticalDusk: { top: '#1e1b4b', bottom: '#111827', stars: 0.8 }, night: { top: '#02040f', bottom: '#01020a', stars: 1.0 }, };
        const phaseOrder = ['nightEnd', 'nauticalDawn', 'dawn', 'sunrise', 'goldenHour', 'solarNoon', 'goldenHourEnd', 'sunset', 'dusk', 'nauticalDusk', 'night'];
        function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
        function interpolateColor(color1, color2, factor) { factor = Math.max(0, Math.min(1, factor)); let result = { r: 0, g: 0, b: 0 }; result.r = Math.round(color1.r + factor * (color2.r - color1.r)); result.g = Math.round(color1.g + factor * (color2.g - color1.g)); result.b = Math.round(color1.b + factor * (color2.b - color1.b)); return result; }
        
        function updateDynamicSkyAndEffects() { if (!cachedData.sunTimes) return; const now = new Date(); const nowMs = now.getTime(); let todayTimes = cachedData.sunTimes; let yesterdayTimes = SunCalc.getTimes(new Date(nowMs - 24 * 60 * 60 * 1000), NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); let tomorrowTimes = SunCalc.getTimes(new Date(nowMs + 24 * 60 * 60 * 1000), NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); let currentPhaseName = phaseOrder[phaseOrder.length - 1]; let currentPhaseTime = yesterdayTimes[currentPhaseName].getTime(); for (let i = 0; i < phaseOrder.length; i++) { const phaseName = phaseOrder[i]; if (todayTimes[phaseName].getTime() <= nowMs) { currentPhaseName = phaseName; currentPhaseTime = todayTimes[phaseName].getTime(); } else { break; } } const currentPhaseIndex = phaseOrder.indexOf(currentPhaseName); const nextPhaseIndex = (currentPhaseIndex + 1) % phaseOrder.length; const nextPhaseName = phaseOrder[nextPhaseIndex]; let nextPhaseTime = todayTimes[nextPhaseName].getTime(); if (nextPhaseTime < currentPhaseTime) { nextPhaseTime = tomorrowTimes[nextPhaseName].getTime(); } const totalDuration = nextPhaseTime - currentPhaseTime; const elapsed = nowMs - currentPhaseTime; const progress = totalDuration > 0 ? Math.max(0, Math.min(1, elapsed / totalDuration)) : 0; const theme1 = SKY_THEME_MAP[currentPhaseName]; const theme2 = SKY_THEME_MAP[nextPhaseName]; const topRgb = interpolateColor(hexToRgb(theme1.top), hexToRgb(theme2.top), progress); const bottomRgb = interpolateColor(hexToRgb(theme1.bottom), hexToRgb(theme2.bottom), progress); skyContainerEl.style.background = `linear-gradient(to bottom, rgb(${topRgb.r},${topRgb.g},${topRgb.b}), rgb(${bottomRgb.r},${bottomRgb.g},${bottomRgb.b}))`; const starsOpacity = theme1.stars + progress * (theme2.stars - theme1.stars); starsContainerEl.style.opacity = (starsOpacity * (1 - currentSkyState.cloudAmount / 20)).toFixed(2); const sunPos = SunCalc.getPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); const altitudeDeg = sunPos.altitude * 180 / Math.PI; const cloudDay = { base: {r:245, g:245, b:245}, shadow: {r:210, g:210, b:220} }; const cloudGolden = { base: {r:255, g:230, b:200}, shadow: {r:240, g:180, b:130} }; const cloudSunset = { base: {r:255, g:180, b:150}, shadow: {r:210, g:120, b:100} }; const cloudBlueHour = { base: {r:120, g:130, b:160}, shadow: {r:80, g:90, b:120} }; const cloudNight = { base: {r:45, g:55, b:70}, shadow: {r:30, g:40, b:55} }; const cloudStorm = { base: {r:100, g:110, b:125}, shadow: {r:60, g:70, b:85} }; let currentBase, currentShadow; if (currentSkyState.isThundering) { currentBase = cloudStorm.base; currentShadow = cloudStorm.shadow; } else { if (altitudeDeg > 15) { currentBase = cloudDay.base; currentShadow = cloudDay.shadow; } else if (altitudeDeg > 0) { const factor = altitudeDeg / 15; currentBase = interpolateColor(cloudGolden.base, cloudDay.base, factor); currentShadow = interpolateColor(cloudGolden.shadow, cloudDay.shadow, factor); } else if (altitudeDeg > -6) { const factor = (altitudeDeg + 6) / 6; currentBase = interpolateColor(cloudSunset.base, cloudGolden.base, factor); currentShadow = interpolateColor(cloudSunset.shadow, cloudGolden.shadow, factor); } else if (altitudeDeg > -12) { const factor = (altitudeDeg + 12) / 6; currentBase = interpolateColor(cloudBlueHour.base, cloudSunset.base, factor); currentShadow = interpolateColor(cloudBlueHour.shadow, cloudSunset.shadow, factor); } else if (altitudeDeg > -18) { const factor = (altitudeDeg + 18) / 6; currentBase = interpolateColor(cloudNight.base, cloudBlueHour.base, factor); currentShadow = interpolateColor(cloudNight.shadow, cloudBlueHour.shadow, factor); } else { currentBase = cloudNight.base; currentShadow = cloudNight.shadow; } } document.documentElement.style.setProperty('--cloud-base-color', `rgb(${currentBase.r},${currentBase.g},${currentBase.b})`); document.documentElement.style.setProperty('--cloud-shadow-color', `rgb(${currentShadow.r},${currentShadow.g},${currentShadow.b})`); const verticalMultiplier = window.innerHeight < 550 ? 70 : 85; let celestialBodyX = 50, celestialBodyY = 50, celestialBodyVisible = false; if (sunPos.altitude > -0.1) { const x = 50 + Math.cos(sunPos.azimuth + Math.PI/2) * 50; const y = verticalMultiplier - Math.sin(sunPos.altitude) * verticalMultiplier; celestialBodyX = x; celestialBodyY = y; celestialBodyVisible = true; } skyGlowEl.style.background = `radial-gradient(circle at ${celestialBodyX}vw ${celestialBodyY}vh, rgba(255,255,224,0.08) 0%, transparent 35%)`; skyGlowEl.style.opacity = celestialBodyVisible ? 1 : 0; }
        let lightningTimeout = null;
        function updateBackgroundWeatherEffects() { const desiredCloudCount = Math.floor(currentSkyState.cloudAmount * (window.innerWidth < 768 ? 0.6 : 1)); if (cloudsContainerEl.children.length !== desiredCloudCount) { cloudsContainerEl.innerHTML = ''; for (let i = 0; i < desiredCloudCount; i++) { const cloudGroup = document.createElement('div'); const type = `type${Math.floor(Math.random() * 4) + 1}`; cloudGroup.className = `cloud-group ${type}`; cloudGroup.style.top = `${Math.random() * 40}%`; cloudGroup.style.left = `${Math.random() * 100 - 10}%`; const puffCount = { type1: 4, type2: 4, type3: 3, type4: 3 }[type] || 2; for (let j = 1; j <= puffCount; j++) { const puff = document.createElement('div'); puff.className = `puff puff-${j}`; cloudGroup.appendChild(puff); } cloudsContainerEl.appendChild(cloudGroup); } } cloudsContainerEl.style.opacity = desiredCloudCount > 0 ? '1' : '0'; const isRaining = currentSkyState.precipRate > 0; const desiredPrecipCount = isRaining ? Math.floor((currentSkyState.precipRate * 50 + 10) * (window.innerWidth < 768 ? 0.5 : 1)) : 0; if (isRaining && precipitationContainerEl.children.length !== desiredPrecipCount) { precipitationContainerEl.innerHTML = ''; const precipType = currentSkyState.isSnowing ? 'snowflake' : 'raindrop'; const icon = currentSkyState.isSnowing ? 'fas fa-snowflake' : ''; for (let i = 0; i < desiredPrecipCount; i++) { const particle = document.createElement('div'); particle.className = `${precipType} ${icon}`; particle.style.left = `${Math.random() * 100}vw`; particle.style.top = `${Math.random() * 100}vh`; if (currentSkyState.isSnowing) { particle.style.fontSize = `${Math.random() * 0.5 + 0.8}em`; } precipitationContainerEl.appendChild(particle); } } precipitationContainerEl.style.opacity = isRaining ? 1 : 0; hazeContainerEl.style.opacity = currentSkyState.isFoggy ? '1' : '0'; if (currentSkyState.isThundering && !lightningTimeout) { const flash = () => { lightningFlashEl.classList.add('flash'); setTimeout(() => lightningFlashEl.classList.remove('flash'), 500); lightningTimeout = setTimeout(flash, Math.random() * 8000 + 4000); }; lightningTimeout = setTimeout(flash, Math.random() * 5000 + 1000); } else if (!currentSkyState.isThundering && lightningTimeout) { clearTimeout(lightningTimeout); lightningTimeout = null; } }
        function createStars() { starsContainerEl.innerHTML = ''; const starCount = window.innerWidth < 768 ? 80 : 200; for (let i = 0; i < starCount; i++) { const star = document.createElement('div'); star.classList.add('star'); const size = Math.random() * 2 + 1; star.style.width = `${size}px`; star.style.height = `${size}px`; star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`; star.style.opacity = Math.random() * 0.6 + 0.2; starsContainerEl.appendChild(star); } }
        function animateSky() { updateDynamicSkyAndEffects(); requestAnimationFrame(animateSky); }
        async function fetchAdvancedSunCalcData(lat, lon) { const now = new Date(); const today = new Date(now); today.setHours(0, 0, 0, 0); const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1); const dayAfter = new Date(tomorrow); dayAfter.setDate(tomorrow.getDate() + 1); cachedData.sunTimes = SunCalc.getTimes(now, lat, lon); let moonrise = SunCalc.getMoonTimes(now, lat, lon, true).rise; if (!moonrise || moonrise < now) { moonrise = SunCalc.getMoonTimes(tomorrow, lat, lon, true).rise || SunCalc.getMoonTimes(dayAfter, lat, lon, true).rise; } let moonset = SunCalc.getMoonTimes(now, lat, lon, true).set; if (!moonset || moonset < now) { moonset = SunCalc.getMoonTimes(tomorrow, lat, lon, true).set || SunCalc.getMoonTimes(dayAfter, lat, lon, true).set; } return { sunrise: cachedData.sunTimes.sunrise, sunset: cachedData.sunTimes.sunset, moonrise: moonrise, moonset: moonset, }; }
        async function fetchPwsStationData(stationKey) { const stationConfig = STATIONS[stationKey]; const url = `https://api.weather.com/v2/pws/observations/current?apiKey=${weatherComApiKey}&stationId=${stationConfig.id}&numericPrecision=decimal&format=json&units=m`; try { const response = await fetch(url); if (!response.ok) throw new Error(`PWS API Hiba`); const data = await response.json(); if (!data.observations || data.observations.length === 0) throw new Error(`Nincs PWS adat.`); const observation = data.observations[0]; stationConfig.isOnline = true; stationConfig.data = observation; if (observation.metric.precipRate > 0) { stationConfig.lastRainTimestamp = new Date(observation.obsTimeLocal).getTime(); } } catch (error) { stationConfig.isOnline = false; } finally { if(isWeatherDisplayInitialized) updateStationStatusUI(stationKey); } }
        async function fetchGeneralConditionsData(lat, lon) { const lang = 'hu-HU'; const url = `https://api.weather.com/v3/wx/observations/current?geocode=${lat},${lon}&language=${lang}&format=json&apiKey=${weatherComApiKey}&units=m`; const response = await fetch(url); if (!response.ok) { throw new Error(`API hiba`); } const data = await response.json(); return { temperature: data.temperature, temperatureFeelsLike: data.temperatureFeelsLike ?? data.temperature, temperatureMax24Hour: data.temperatureMax24Hour, temperatureMin24Hour: data.temperatureMin24Hour, relativeHumidity: data.relativeHumidity, windSpeed: data.windSpeed, windDirection: data.windDirection, dewpoint: data.temperatureDewPoint, wxPhraseLong: data.wxPhraseLong || null, pressureAltimeter: data.pressureAltimeter ?? data.pressureMeanSeaLevel, visibility: data.visibility, dayOrNight: data.dayOrNight, pressureTendencyCode: data.pressureTendencyCode ?? (data.pressureChange !== null && typeof data.pressureChange !== 'undefined' ? (data.pressureChange > 0 ? 0 : (data.pressureChange < 0 ? 1 : 2)) : null), uvDescription: data.uvDescription || null, uvIndex: data.uvIndex, iconCode: data.iconCode }; }
        async function fetchHourlyForecastData(lat, lon) { const url = `https://api.weather.com/v3/wx/forecast/hourly/3day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`; try { const response = await fetch(url); if (!response.ok) throw new Error(`API hiba`); const data = await response.json(); if (!data || !data.validTimeLocal || !Array.isArray(data.validTimeLocal)) { throw new Error('Hiányos vagy érvénytelen előrejelzési adat.'); } const hourlyForecasts = []; const nowMs = new Date().getTime(); let startIndex = data.validTimeLocal.map(timeStr => new Date(timeStr).getTime()).findLastIndex(timeMs => timeMs <= nowMs); if (startIndex === -1) { startIndex = 0; } const forecastLimit = Math.min(startIndex + 48, data.validTimeLocal.length); for (let i = startIndex; i < forecastLimit; i++) { hourlyForecasts.push({ time: data.validTimeLocal[i], temp: data.temperature[i], iconCode: data.iconCode[i], precipChance: data.precipChance[i], qpf: data.qpf[i], dayOrNight: data.dayOrNight[i], windSpeed: data.windSpeed[i], windDirection: data.windDirection[i], humidity: data.relativeHumidity[i], wxPhraseShort: data.wxPhraseShort[i] }); } return hourlyForecasts; } catch (error) { throw error; } }
        
        function updateTheme(isNight) {
            const root = document.documentElement;
            if (isNight) {
                root.style.setProperty('--current-widget-bg', 'var(--bg-widget-night)');
                root.style.setProperty('--current-widget-border', 'var(--border-widget-night)');
                root.style.setProperty('--current-container-border-color', 'var(--border-widget-night)');
                root.style.setProperty('--current-text-color', 'var(--text-primary-night)');
                root.style.setProperty('--current-text-muted-color', 'var(--text-secondary-night)');
                root.style.setProperty('--current-icon-color', 'var(--accent-interactive-night)');
            } else {
                root.style.setProperty('--current-widget-bg', 'var(--bg-widget-day)');
                root.style.setProperty('--current-widget-border', 'var(--border-widget-day)');
                root.style.setProperty('--current-container-border-color', 'var(--border-widget-day)');
                root.style.setProperty('--current-text-color', 'var(--text-primary-day)');
                root.style.setProperty('--current-text-muted-color', 'var(--text-secondary-day)');
                root.style.setProperty('--current-icon-color', 'var(--accent-interactive-day)');
            }
        }

        async function fetchAllDataAndUpdateDisplay(isInitialLoad = false) { 
            if (!isWeatherDisplayInitialized) initializeWeatherDisplayDOM(); 
            
            const currentDay = new Date().getDate();
            if (currentDay !== lastCheckedDay) {
                rainDetectedToday = false;
                lastCheckedDay = currentDay;
            }

            await Promise.allSettled(Object.keys(STATIONS).map(key => fetchPwsStationData(key))); 
            
            const stationCoords = STATIONS[activeDisplayStationKey].coords;
            const generalPromise = fetchGeneralConditionsData(stationCoords.lat, stationCoords.lon).then(data => { 
                if (data) cachedData.generalConditions = data; 
            }).catch(e => console.error("General conditions fetch failed:", e));
            
            const sunPromise = fetchAdvancedSunCalcData(stationCoords.lat, stationCoords.lon).then(data => { 
                cachedData.sunCalc = data; 
            });

            const forecastPromise = fetchAndDisplayForecastsForStation(activeDisplayStationKey);

            await Promise.allSettled([generalPromise, sunPromise, forecastPromise]); 
            
            const primaryStations = ['NYIREGYHAZI_UT', 'KOSSUTH', 'KERT_UTCA', 'SOSTOHEGY', 'BORBANYA', 'OROS_DERUS', 'NAGYHALASZ', 'SZAKOLY']; 
            const activeStationIsOnline = STATIONS[activeDisplayStationKey] && STATIONS[activeDisplayStationKey].isOnline; 
            
            if (activeStationIsOnline) { 
                const activeStation = STATIONS[activeDisplayStationKey]; 
                cachedData.displayPws = { ...activeStation.data.metric, ...activeStation.data }; 
            } else { 
                const onlinePrimaryStations = primaryStations.filter(k => STATIONS[k].isOnline); 
                if (onlinePrimaryStations.length > 0) { 
                    activeDisplayStationKey = onlinePrimaryStations[0]; 
                    const activeStation = STATIONS[activeDisplayStationKey]; 
                    cachedData.displayPws = { ...activeStation.data.metric, ...activeStation.data };
                    await fetchAndDisplayForecastsForStation(activeDisplayStationKey);
                } else { 
                    const general = cachedData.generalConditions; 
                    if (general && Object.keys(general).length > 0) { 
                        cachedData.displayPws = { temp: general.temperature, heatIndex: general.temperatureFeelsLike, windChill: general.temperatureFeelsLike, windSpeed: general.windSpeed, winddir: general.windDirection, windGust: null, dewpt: general.dewpoint, humidity: general.relativeHumidity, pressure: general.pressureAltimeter, solarRadiation: null, uv: general.uvIndex }; 
                    } else { 
                        cachedData.displayPws = {}; 
                    } 
                } 
            } 
            
            const maxPrecipRate = Math.max(0, ...Object.values(STATIONS).map(s => (s.isOnline && s.data) ? s.data.metric.precipRate : 0)); 
            currentSkyState.precipRate = maxPrecipRate; 
            const general = cachedData.generalConditions; 
            if (general && general.dayOrNight) {
                updateTheme(general.dayOrNight === 'N');
            }
            if (general && general.iconCode) { 
                const icon = general.iconCode; 
                if ([31, 32, 33, 36].includes(icon)) currentSkyState.cloudAmount = 0; 
                else if ([34, 29, 30].includes(icon)) currentSkyState.cloudAmount = 5; 
                else if ([27, 28].includes(icon)) currentSkyState.cloudAmount = 10; 
                else if ([26].includes(icon)) currentSkyState.cloudAmount = 15; 
                else currentSkyState.cloudAmount = 8; 
                currentSkyState.isThundering = [3, 4, 37, 38, 47].includes(icon); 
                currentSkyState.isFoggy = [19, 20, 21, 22].includes(icon); 
                currentSkyState.isSnowing = SNOW_ICON_CODES.includes(icon); 
            } 
            currentSkyState.windSpeed = general.windSpeed || 0; 
            updateBackgroundWeatherEffects(); 
            Object.keys(STATIONS).forEach(key => updateStationStatusUI(key)); 
            compileAndRenderDisplayData(); 
        }
        
        function initializeWeatherDisplayDOM() {
            const displayableStations = ['NYIREGYHAZI_UT', 'KOSSUTH', 'KERT_UTCA', 'SOSTOHEGY', 'BORBANYA', 'OROS_DERUS', 'NAGYHALASZ', 'SZAKOLY'];
            
            weatherDisplayEl.innerHTML = `
                <div class="widget-header">
                    <div class="header-container"><div class="location-title" id="location-title-text">Nyíregyháza és környéke</div></div>
                    <div class="timestamp-container">
                        <span class="timestamp" id="main-timestamp">--:--:--</span>
                        <div class="attribution-line">Az időjárás monitort Robi készítette © Copyright by: Robi</div>
                    </div>
                </div>
                <div class="station-status-container">${displayableStations.map(key => `<div class="station-selector" id="${key.toLowerCase()}-selector-container"><input type="radio" name="station-select" id="station-select-${key.toLowerCase()}" value="${key}"><label for="station-select-${key.toLowerCase()}"><span class="station-status-indicator" id="status-indicator-${key}"></span> ${STATIONS[key].displayNameShort || STATIONS[key].displayName}</label></div>`).join('')}</div>
                <div class="current-conditions-card">
                    <div class="conditions-section">
                        <div id="temp-display-card" class="temp-display-card">
                            <h4 class="section-title">Hőmérséklet</h4>
                            <div class="temp-primary-display"><div class="current-temp-value"><span id="current-temp-span" class="flippable-value">--</span><span>°C</span></div></div>
                            <div class="temp-feels-like-container"><i class="fas fa-user"></i><span>Hőérzet: <strong id="feels-like-temp">--°</strong></span></div>
                             <div class="daily-temp-range-visualizer">
                                <h4>Napi Hőmérséklet</h4>
                                <div class="range-bar-wrapper">
                                    <div id="min-temp-label" class="range-label">--°<span class="time-label"></span></div>
                                    <div class="range-bar-container">
                                        <div class="range-bar-bg"></div>
                                        <div id="current-temp-marker">
                                            <i class="fas fa-caret-down"></i>
                                        </div>
                                    </div>
                                    <div id="max-temp-label" class="range-label">--°<span class="time-label"></span></div>
                                </div>
                                <div class="range-disclaimer">*A jelzett időpontok az előrejelzés alapján becsültek és bármelyik frissítéssel változhatnak!</div>
                            </div>
                        </div>
                    </div>
                    <div class="conditions-section">
                        <h4 class="section-title">Szél Adatok</h4>
                        <div class="wind-info-card">
                            <div class="wind-main-display-centered">
                                <div class="wind-compass-container"><div class="wind-compass-rose"><div class="wind-compass-label N">É</div><div class="wind-compass-label E">K</div><div class="wind-compass-label S">D</div><div class="wind-compass-label W">NY</div><div class="wind-compass-label intercardinal NE">ÉK</div><div class="wind-compass-label intercardinal SE">DK</div><div class="wind-compass-label intercardinal SW">DNY</div><div class="wind-compass-label intercardinal NW">ÉNY</div></div><i class="fas fa-location-arrow" id="wind-compass-arrow"></i></div>
                                <div class="wind-data-container"><div class="wind-speed-main-value"><span id="wind-speed-value-span" class="flippable-value">--</span><span>km/h</span></div><div class="wind-direction-text">Irány: <strong id="wind-direction-full">--</strong></div><div class="wind-gust-text">Lökés: <strong id="wind-gust-value">-- km/h</strong></div></div>
                            </div>
                            <div class="beaufort-scale-visualizer"><div class="beaufort-title">Beaufort Skála</div><div class="beaufort-scale-container" id="beaufort-scale-container">${Array.from({ length: 12 }).map(() => `<div class="beaufort-bar"></div>`).join('')}</div></div>
                            <div class="wind-detailed-stats"><div class="wind-stats-grid"><div class="wind-stats-item"><span class="label">Fokozat:</span><span class="value" id="beaufort-grade">--</span></div><div class="wind-stats-item"><span class="label">Besorolás:</span><span class="value" id="beaufort-desc">--</span></div></div></div>
                            <div class="wind-legend-container">
                                <div class="wind-legend-title">Szélerősség (km/h)</div>
                                <div class="wind-legend-bar-container">
                                    <div class="wind-legend-bar"></div>
                                    <i class="fas fa-caret-down" id="wind-speed-marker"></i>
                                </div>
                                <div class="wind-legend-labels"><span>0</span><span>20</span><span>40</span><span>60</span><span>80+</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pws-details-container">
                    <div class="section-header"><div class="section-title">Részletes adatok</div><span class="section-timestamp" id="pws-timestamp"></span></div>
                    <div class="pws-details-grid" id="pws-details-grid">
                        ${['humidity', 'pressure', 'dewpoint', 'solar', 'uv', 'windchill', 'sun', 'moon', 'visibility', 'windrun'].map(key => `
                            <div class="detail-pod" id="detail-pod-${key}">
                                <div class="pod-icon-container"><i id="detail-icon-${key}"></i></div>
                                <div class="pod-data">
                                    <span class="value" id="detail-value-${key}">--</span>
                                    <span class="label" id="detail-label-${key}">--</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                 <div id="secondary-panel-container">
                    <div class="pws-details-container is-hidden" id="risk-assessment-container">
                        <div class="section-header">
                            <div class="section-title" style="display:flex; align-items:center; gap: 5px;">
                                Közeli Csapadékkockázat
                                <div class="info-tooltip-container">
                                    <div class="info-tooltip-trigger">?</div>
                                    <div class="info-tooltip-content">${CURIOSITY_EXPLANATIONS.risk}</div>
                                </div>
                            </div>
                            <span class="section-timestamp" id="risk-timestamp"></span>
                        </div>
                        <div class="risk-assessment-content">
                            <div id="risk-level-text" class="risk-level-text">--</div>
                            <div class="risk-bar-container">
                                <div id="risk-bar-fill" class="risk-bar-fill"></div>
                            </div>
                        </div>
                    </div>
                    <div class="precip-summary-card is-hidden" id="precip-summary-card"></div>
                </div>
                <div class="precipitation-forecast-section">
                    <div class="section-header"><div style="display: flex; align-items: center; gap: 8px;"><div class="section-title" style="margin-bottom: 0;">Órás csapadék előrejelzés</div></div><span class="section-timestamp" id="precip-forecast-timestamp"></span></div>
                    <div class="precip-summary-text" id="precip-summary-text">--</div>
                    <div class="precip-forecast-list">${Array.from({ length: 7 }).map((_, i) => `<div class="precip-forecast-item" id="precip-item-${i}"><div class="forecast-time" id="precip-time-${i}">--:--</div><div class="chance-visualizer"><svg viewBox="0 0 36 36"><circle class="bg-circle" cx="18" cy="18" r="16"></circle><circle class="progress-circle" id="precip-progress-${i}" cx="18" cy="18" r="16" stroke-dasharray="100 100" stroke-dashoffset="100"></circle></svg><div class="chance-percentage" id="precip-chance-${i}">--%</div></div><div class="intensity-details"><div class="forecast-bar-container"><div class="forecast-bar-fill" id="precip-bar-fill-${i}"></div></div><div class="intensity-text" id="precip-intensity-${i}">--</div></div><div class="forecast-type-icon"><i id="precip-icon-${i}" class="fas fa-tint"></i></div></div>`).join('')}</div>
                </div>`;
            addStationChangeListeners(); isWeatherDisplayInitialized = true;
        }
        function updateStationStatusUI(stationKey) { const stationConfig = STATIONS[stationKey]; if (!stationConfig) return; const statusIndicatorEl = document.getElementById(`status-indicator-${stationKey}`); if(statusIndicatorEl) { statusIndicatorEl.classList.remove('online', 'offline'); statusIndicatorEl.classList.add(stationConfig.isOnline ? 'online' : 'offline'); } const selectorContainer = document.getElementById(`${stationKey.toLowerCase()}-selector-container`); if(selectorContainer) { selectorContainer.classList.toggle('disabled', !stationConfig.isOnline); } const radioEl = document.getElementById(`station-select-${stationKey.toLowerCase()}`); if(radioEl) { radioEl.checked = (stationKey === activeDisplayStationKey); } }
        
        async function handleStationChange(event) { 
            const selectedStationKey = event.target.value; 
            if (STATIONS[selectedStationKey].isOnline && selectedStationKey !== activeDisplayStationKey) { 
                activeDisplayStationKey = selectedStationKey; 
                const activeStation = STATIONS[activeDisplayStationKey]; 
                if (activeStation && activeStation.data) { 
                    cachedData.displayPws = { ...activeStation.data.metric, ...activeStation.data }; 
                }
                document.getElementById('location-title-text').textContent = activeStation.name;

                try {
                    const newGeneralData = await fetchGeneralConditionsData(activeStation.coords.lat, activeStation.coords.lon);
                    if (newGeneralData) {
                        cachedData.generalConditions = newGeneralData;
                    }
                } catch (e) {
                    console.error(`Failed to fetch general conditions for ${selectedStationKey}`, e);
                }

                await fetchAndDisplayForecastsForStation(selectedStationKey);
                compileAndRenderDisplayData(); 
            } else if (!STATIONS[selectedStationKey].isOnline) { 
                event.target.checked = false; 
                const previouslyActiveRadio = document.querySelector(`input[value="${activeDisplayStationKey}"]`); 
                if (previouslyActiveRadio) { previouslyActiveRadio.checked = true; } 
            } 
        }

        function addStationChangeListeners() { document.querySelectorAll('input[name="station-select"]').forEach(radio => radio.addEventListener('change', handleStationChange)); }
        function compileAndRenderDisplayData() { if (!cachedData.displayPws || Object.keys(cachedData.displayPws).length === 0) return; renderWeatherData(); renderPrecipitationForecast(); renderHourlyForecastData(); }
        function updateAnimatedValue(element, newValue) { if (!element) return; const currentValue = element.textContent.trim(); const newFormattedValue = newValue.toString().trim(); if (currentValue !== newFormattedValue) { if (!element.classList.contains('is-flipping')) { element.classList.add('is-flipping'); setTimeout(() => { element.textContent = newFormattedValue; element.classList.remove('is-flipping'); }, 200); } } }
        function updateBeaufortVisualizer(speed) { const beaufortData = getBeaufort(speed); const color = getWindColor(speed); document.documentElement.style.setProperty('--current-wind-color', color); const bars = document.querySelectorAll('#beaufort-scale-container .beaufort-bar'); bars.forEach((bar, index) => { bar.classList.toggle('active', index < beaufortData.num); }); document.getElementById('beaufort-grade').textContent = `${beaufortData.num}. fokozat`; document.getElementById('beaufort-desc').textContent = beaufortData.desc; }

        function calculatePrecipRiskIndex(temp, dewpoint, pressureTendency, humidity, vaporPressure) {
            let score = 0;
            if (temp === null || dewpoint === null) return 0;
            
            const spread = temp - dewpoint;
            if (spread < 2) score += 3;
            else if (spread < 4) score += 1;

            if (pressureTendency === 1) score += 2; // Falling
            if (pressureTendency === 0) score -= 1; // Rising

            if (humidity > 90) score += 2;
            else if (humidity > 80) score += 1;

            if (vaporPressure > 12) score += 1;

            return Math.max(0, score);
        }

        function getRiskLevelDetails(score) {
            if (score <= 1) return { text: 'Nagyon Alacsony', color: 'var(--risk-very-low)', level: 1 };
            if (score <= 3) return { text: 'Alacsony', color: 'var(--risk-low)', level: 2 };
            if (score <= 5) return { text: 'Mérsékelt', color: 'var(--risk-moderate)', level: 3 };
            if (score <= 7) return { text: 'Magas', color: 'var(--risk-high)', level: 4 };
            return { text: 'Nagyon Magas', color: 'var(--risk-very-high)', level: 5 };
        }

        function renderWeatherData() {
            const obs = cachedData.displayPws; const general = cachedData.generalConditions; const sunCalcData = cachedData.sunCalc; if (!general || !obs || !sunCalcData) return;
            const now = new Date(); document.getElementById('main-timestamp').textContent = `Utolsó frissítés: ${formatTime(now, { includeSeconds: true })}`; document.getElementById('pws-timestamp').textContent = `Frissítve: ${formatTime(now, { includeSeconds: true })}`;
            
            const currentTemp = obs.temp; 
            const feelsLikeTemp = general.temperatureFeelsLike;
            updateAnimatedValue(document.getElementById('current-temp-span'), formatValue(currentTemp, '', 1)); 
            document.getElementById('feels-like-temp').textContent = `${formatValue(feelsLikeTemp, '°', 1)}`; 
            const tempCard = document.getElementById('temp-display-card'); 
            if (tempCard) { tempCard.style.backgroundImage = getTempGradient(currentTemp); }

            const activeForecast = forecastCache[activeDisplayStationKey] || {};
            const todayMetrics = activeForecast.todayMetrics;
            const tomorrowMetrics = activeForecast.tomorrowMetrics;
            
            let displayData = { minTemp: null, minTime: null, maxTemp: null, maxTime: null, dayLabel: 'Ma' };

            if (todayMetrics && todayMetrics.minTime && todayMetrics.maxTime) {
                const switchoverHour = 17;
                const todayMinTime = new Date(todayMetrics.minTime);
                const todayMaxTime = new Date(todayMetrics.maxTime);
                
                const useTomorrowData = now.getHours() >= switchoverHour && now > todayMinTime && now > todayMaxTime && tomorrowMetrics;

                if (useTomorrowData) {
                    displayData = { ...tomorrowMetrics, dayLabel: 'Holnap' };
                } else {
                    displayData = { ...todayMetrics, dayLabel: 'Ma' };
                }
            }

            const { minTemp, minTime, maxTemp, maxTime, dayLabel } = displayData;

            const minTempLabel = document.getElementById('min-temp-label');
            const maxTempLabel = document.getElementById('max-temp-label');

            if (minTemp !== null && minTime !== null) {
                const minTimeObj = new Date(minTime);
                const hasMinPassed = now > minTimeObj && dayLabel === 'Ma';
                const minVerb = hasMinPassed ? 'volt' : 'várható';
                const minDayPrefix = (dayLabel === 'Ma' && hasMinPassed) ? '' : dayLabel + ' ';
                const minText = `A minimum ${minDayPrefix}${formatTime(minTimeObj)}-kor ${minVerb}`;
                minTempLabel.innerHTML = `${formatValue(minTemp, '°', 0)}<span class="time-label">${minText}</span>`;
            } else {
                 minTempLabel.innerHTML = `${NO_DATA_STRING}°<span class="time-label"></span>`;
            }

            if (maxTemp !== null && maxTime !== null) {
                const maxTimeObj = new Date(maxTime);
                const hasMaxPassed = now > maxTimeObj && dayLabel === 'Ma';
                const maxVerb = hasMaxPassed ? 'volt' : 'várható';
                const maxDayPrefix = (dayLabel === 'Ma' && hasMaxPassed) ? '' : dayLabel + ' ';
                const maxText = `A maximum ${maxDayPrefix}${formatTime(maxTimeObj)}-kor ${maxVerb}`;
                maxTempLabel.innerHTML = `${formatValue(maxTemp, '°', 0)}<span class="time-label">${maxText}</span>`;
            } else {
                maxTempLabel.innerHTML = `${NO_DATA_STRING}°<span class="time-label"></span>`;
            }

            if (minTemp !== null && maxTemp !== null) {
                const range = maxTemp - minTemp;
                const marker = document.getElementById('current-temp-marker');
                if (range > 0 && marker) {
                    const currentPosPercent = Math.max(0, Math.min(100, ((currentTemp - minTemp) / range) * 100));
                    marker.style.left = `${currentPosPercent}%`;
                } else if(marker) { 
                    marker.style.left = '50%';
                }
            }
            
            const windSpeed = obs.windSpeed ?? general.windSpeed; 
            const windGust = obs.windGust; 
            const windDir = obs.winddir ?? general.windDirection; 
            const windChill = obs.windChill; 
            const windArrow = document.getElementById('wind-compass-arrow'); 
            if (windDir !== null) { 
                windArrow.style.transform = `translate(-50%, -50%) rotate(${windDir - 45}deg)`; 
            }
            
            updateAnimatedValue(document.getElementById('wind-speed-value-span'), formatValue(windSpeed, '', 1));
            document.getElementById('wind-gust-value').textContent = formatValue(windGust, ' km/h', 0); 
            document.getElementById('wind-direction-full').textContent = degreesToCompass(windDir); 
            updateBeaufortVisualizer(windSpeed);

            const windSpeedMarker = document.getElementById('wind-speed-marker');
            if (windSpeedMarker) {
                const maxWindForScale = 100;
                const windPercent = Math.max(0, Math.min(100, (windSpeed / maxWindForScale) * 100));
                windSpeedMarker.style.left = `${windPercent}%`;
            }

            const pressureTrendCode = general.pressureTendencyCode; 
            let trendSymbol = ''; 
            if (pressureTrendCode === 0) trendSymbol = '↑'; 
            else if (pressureTrendCode === 1) trendSymbol = '↓'; 
            else if (pressureTrendCode === 2) trendSymbol = '→';
            
            const humidity = obs.humidity ?? general.relativeHumidity; 
            document.getElementById('detail-icon-humidity').className = 'fas fa-tint'; 
            document.getElementById('detail-value-humidity').textContent = formatValue(humidity, '%', 0); 
            document.getElementById('detail-label-humidity').textContent = 'Pára';
            
            const pressure = obs.pressure ?? general.pressureAltimeter; 
            document.getElementById('detail-icon-pressure').className = 'fas fa-tachometer-alt'; 
            document.getElementById('detail-value-pressure').innerHTML = `${formatValue(pressure, ' hPa', 1)}<span class="pressure-trend-icon">${trendSymbol}</span>`; 
            document.getElementById('detail-label-pressure').textContent = 'Légnyomás';
            
            const solarRadiation = obs.solarRadiation; 
            document.getElementById('detail-icon-solar').className = 'fas fa-sun'; 
            document.getElementById('detail-value-solar').textContent = formatValue(solarRadiation, ' W/m²', 0); 
            document.getElementById('detail-label-solar').textContent = 'Napsugárzás'; 
            document.querySelector('#detail-pod-solar .pod-icon-container').style.backgroundColor = getSolarRadiationColor(solarRadiation);
            
            const uv = obs.uv ?? general.uvIndex; 
            document.getElementById('detail-icon-uv').className = 'fas fa-shield-sun'; 
            document.getElementById('detail-value-uv').textContent = formatValue(uv, '', 1); 
            document.getElementById('detail-label-uv').textContent = 'UV Index'; 
            document.querySelector('#detail-pod-uv .pod-icon-container').style.backgroundColor = getUVColor(uv);
            
            document.getElementById('detail-icon-sun').className = 'fas fa-sunrise'; 
            document.getElementById('detail-value-sun').textContent = `${formatTime(sunCalcData.sunrise)} / ${formatTime(sunCalcData.sunset)}`; 
            document.getElementById('detail-label-sun').textContent = 'Napkelte / Nyugta';
            
            document.getElementById('detail-icon-moon').className = 'far fa-moon'; 
            document.getElementById('detail-value-moon').textContent = `${formatTime(sunCalcData.moonrise)} / ${formatTime(sunCalcData.moonset)}`; 
            document.getElementById('detail-label-moon').textContent = 'Holdkelte / Nyugta';
            
            document.getElementById('detail-icon-visibility').className = 'fas fa-eye'; 
            document.getElementById('detail-value-visibility').textContent = formatValue(general.visibility, ' km', 1); 
            document.getElementById('detail-label-visibility').textContent = 'Látótávolság';
            
            const dewpoint = obs.dewpt ?? general.dewpoint; 
            document.getElementById('detail-icon-dewpoint').className = 'fas fa-droplet'; 
            document.getElementById('detail-value-dewpoint').textContent = formatValue(dewpoint, '°', 1); 
            document.getElementById('detail-label-dewpoint').textContent = 'Harmatpont';
            
            document.getElementById('detail-icon-windchill').className = 'fas fa-temperature-empty'; 
            document.getElementById('detail-value-windchill').textContent = formatValue(windChill, '°', 1); 
            document.getElementById('detail-label-windchill').textContent = 'Szélhűtés';
            
            const windRun = (windSpeed !== null && typeof windSpeed !== 'undefined') ? windSpeed * 24 : null;
            document.getElementById('detail-icon-windrun').className = 'fas fa-route';
            document.getElementById('detail-value-windrun').textContent = formatValue(windRun, ' km', 0);
            document.getElementById('detail-label-windrun').textContent = 'Napi Szélút';
            
            const vaporPressure = (dewpoint !== null) ? 6.112 * Math.exp((17.67 * dewpoint) / (dewpoint + 243.5)) : null;
            const riskScore = calculatePrecipRiskIndex(currentTemp, dewpoint, pressureTrendCode, humidity, vaporPressure);
            const riskDetails = getRiskLevelDetails(riskScore);

            const riskLevelTextEl = document.getElementById('risk-level-text');
            const riskBarFillEl = document.getElementById('risk-bar-fill');
            riskLevelTextEl.textContent = riskDetails.text;
            riskLevelTextEl.style.color = riskDetails.color;
            riskBarFillEl.style.backgroundColor = riskDetails.color;
            riskBarFillEl.style.width = `${(riskDetails.level / 5) * 100}%`;
            document.getElementById('risk-timestamp').textContent = `Frissítve: ${formatTime(now, { includeSeconds: true })}`;
            
            const precipCardEl = document.getElementById('precip-summary-card'); 
            const riskEl = document.getElementById('risk-assessment-container');
            const precipStations = Object.values(STATIONS).filter(s => s.isOnline && s.provides.includes('precip') && s.data); 
            const stationsWithRainToday = precipStations.filter(s => s.data.metric.precipTotal > 0); 
            
            if (stationsWithRainToday.length > 0) {
                rainDetectedToday = true;
            }

            if(rainDetectedToday) {
                precipCardEl.classList.remove('is-hidden');
                riskEl.classList.add('is-hidden');
                let mainContentHTML = '';
                if (stationsWithRainToday.length === 0) { 
                    mainContentHTML = `<div class="precip-explanation-container"><p class="explanation-text">A mai nap folyamán már észleltünk csapadékot a hálózatban. Jelenleg egy állomás sem jelez esőt.</p></div>`; 
                } else { 
                    mainContentHTML = `<div class="precip-station-grid">${stationsWithRainToday.sort((a, b) => (b.data.metric.precipTotal - a.data.metric.precipTotal)).map(station => { const isRainingNow = station.data.metric.precipRate > 0; const cardClass = isRainingNow ? 'precip-station-card is-raining-now' : 'precip-station-card'; const displayName = station.displayNameShort || station.displayName; let footerInfoHTML = ''; if (isRainingNow) { footerInfoHTML = `<div class="station-card-footer-info live-intensity">Most: ${getPrecipIntensityDescription(station.data.metric.precipRate)}</div>`; } else if (station.lastRainTimestamp) { footerInfoHTML = `<div class="station-card-footer-info">Utoljára: ${formatTime(station.lastRainTimestamp)}</div>`; } else { footerInfoHTML = `<div class="station-card-footer-info">Jelenleg nem esik</div>`; } return `<div class="${cardClass}"><div class="station-card-header"><span class="station-card-name">${displayName}</span> ${isRainingNow ? '<div class="station-card-status-icon"></div>' : ''}</div><div class="station-card-main"><div class="station-card-total-label">Ma eddig</div><div class="station-card-total-value">${formatValue(station.data.metric.precipTotal, '', 1)}<span>mm</span></div></div>${footerInfoHTML}</div>`; }).join('')}</div>`; 
                } 
                const allMonitoredNames = Object.values(STATIONS).filter(s => s.provides.includes('precip')).map(s => s.displayName).join(', '); const tooltipHTML = `<div class="station-tooltip-container"><span class="station-list-trigger">Figyelt állomások listája</span><div class="station-tooltip-content">${allMonitoredNames}</div></div>`; let footerHTML = `<div class="precip-card-footer">${tooltipHTML}</div>`; 
                precipCardEl.innerHTML = `<div class="precip-card-header"><div class="precip-header-title-group"><div class="precip-header-icon"><i class="fas fa-satellite-dish"></i></div><h4 class="precip-header-title">CsapadékRadar</h4></div><span class="section-timestamp" id="radar-timestamp"></span></div><div class="precip-card-content">${mainContentHTML}</div>${footerHTML}`; 
                document.getElementById('radar-timestamp').textContent = `Frissítve: ${formatTime(now, { includeSeconds: true })}`;
            } else {
                precipCardEl.classList.add('is-hidden');
                riskEl.classList.remove('is-hidden');
            }
        }

        function renderPrecipitationForecast() {
            const hourlyDataFull = forecastCache[activeDisplayStationKey]?.hourly || [];
            const summaryEl = document.getElementById('precip-summary-text'); 
            if (hourlyDataFull.length === 0 || !summaryEl) return;
            const firstPrecipHour = hourlyDataFull.slice(0, 12).find(h => h.precipChance >= 30);
            if (firstPrecipHour) { summaryEl.textContent = `Csapadék leghamarabb ${formatTime(firstPrecipHour.time, {prefix: 'kb.'})} körül lehetséges.`; } 
            else { summaryEl.textContent = "A következő órákban nem várható számottevő csapadék."; }
            const forecastLiveTimestampEl = document.getElementById('precip-forecast-timestamp'); 
            const lastFetchTime = forecastCache[activeDisplayStationKey]?.lastFetch || 0;
            if (forecastLiveTimestampEl && lastFetchTime > 0) { 
                forecastLiveTimestampEl.textContent = `Frissítve: ${formatTime(new Date(lastFetchTime))}`; 
            }
            for (let i = 0; i < 7; i++) {
                const itemEl = document.getElementById(`precip-item-${i}`); const timeEl = document.getElementById(`precip-time-${i}`); const progressCircle = document.getElementById(`precip-progress-${i}`); const chanceEl = document.getElementById(`precip-chance-${i}`); const barFillEl = document.getElementById(`precip-bar-fill-${i}`); const intensityEl = document.getElementById(`precip-intensity-${i}`); const iconEl = document.getElementById(`precip-icon-${i}`);
                if(i === 0) itemEl.classList.add('first-hour'); else itemEl.classList.remove('first-hour');
                if (timeEl && progressCircle && chanceEl && barFillEl && intensityEl && iconEl) {
                    const hourData = hourlyDataFull[i];
                    if (hourData) {
                        const chance = hourData.precipChance || 0; const amount = hourData.qpf || 0; const isSnow = SNOW_ICON_CODES.includes(hourData.iconCode);
                        timeEl.textContent = formatHourOnly(hourData.time); chanceEl.textContent = `${chance}%`;
                        const radius = progressCircle.r.baseVal.value; const circumference = 2 * Math.PI * radius; progressCircle.style.strokeDasharray = `${circumference} ${circumference}`; progressCircle.style.strokeDashoffset = circumference - (chance / 100) * circumference;
                        barFillEl.style.width = `${Math.min(100, (amount / 3.0) * 100)}%`;
                        const intensityText = getPrecipIntensityDescription(amount);
                        if (amount > 0) { intensityEl.textContent = `${intensityText} (${formatValue(amount, 'mm', 1)})`; } 
                        else { intensityEl.textContent = "Nem várható"; }
                        itemEl.classList.toggle('is-snow', isSnow); iconEl.className = isSnow ? 'fas fa-snowflake' : 'fas fa-tint';
                    }
                }
            }
        }

        function renderHourlyForecastData() { 
            const hourlyDataFull = forecastCache[activeDisplayStationKey]?.hourly || [];
            if (hourlyDataFull.length === 0 || !hourlyForecastContainerEl) { 
                if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.add('is-hidden'); 
                if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.add('is-hidden'); 
                return; 
            } 
            const forecastLiveTimestampEl = document.getElementById('hourly-forecast-timestamp'); 
            const lastFetchTime = forecastCache[activeDisplayStationKey]?.lastFetch || 0;
            if (forecastLiveTimestampEl && lastFetchTime > 0) { 
                forecastLiveTimestampEl.textContent = `Frissítve: ${formatTime(new Date(lastFetchTime))}`; 
            } 
            const nowMs = new Date().getTime(); 
            let startIndex = hourlyDataFull.findIndex(hour => new Date(hour.time).getTime() > nowMs); 
            if (startIndex === -1) startIndex = 0;
            const forecastsToShow = hourlyDataFull.slice(startIndex, startIndex + 12); 
            let forecastHTML = ''; 
            forecastsToShow.forEach(hour => { let conditionText = hour.wxPhraseShort || mapIconCodeToHungarianText(hour.iconCode, hour.dayOrNight); forecastHTML += `<div class="hourly-forecast-card"><div class="hourly-primary-info"><div class="hourly-time">${formatTime(hour.time)}</div><div class="hourly-icon-and-condition"><i class="hourly-icon ${mapTwcIconToFontAwesome(hour.iconCode, hour.dayOrNight)}"></i><div class="hourly-condition-text">${conditionText}</div></div><div class="hourly-temp">${formatValue(hour.temp, '°', 0, '--')}</div></div><div class="hourly-secondary-details"><div class="hourly-detail-row"><span><i class="fas fa-tint"></i> Csapadék</span><strong>${formatValue(hour.precipChance, '%', 0, '--')}</strong></div><div class="hourly-detail-row"><span><i class="fas fa-wind"></i> Szél</span><strong title="${degreesToCompass(hour.windDirection)}">${degreesToCompassAbbreviated(hour.windDirection)} ${formatValue(hour.windSpeed, 'km/h', 0)}</strong></div><div class="hourly-detail-row"><span><i class="fas fa-hand-holding-water"></i> Pára</span><strong>${formatValue(hour.humidity, '%', 0)}</strong></div></div></div>`; }); 
            if(hourlyForecastContainerEl) hourlyForecastContainerEl.innerHTML = forecastHTML; 
            if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.remove('is-hidden'); 
            if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.remove('is-hidden'); 
        }
        
        function calculateForecastMetricsForDay(targetDate, hourlyData) {
            if (!hourlyData || hourlyData.length < 1) return { minTemp: null, minTime: null, maxTemp: null, maxTime: null };
            const targetDayStart = new Date(targetDate); targetDayStart.setHours(0, 0, 0, 0);
            const targetDayEnd = new Date(targetDate); targetDayEnd.setHours(23, 59, 59, 999);
            const relevantForecasts = hourlyData.filter(h => { const hourTime = new Date(h.time); return hourTime >= targetDayStart && hourTime <= targetDayEnd; });
            if (relevantForecasts.length === 0) return { minTemp: null, minTime: null, maxTemp: null, maxTime: null };
            let minForecast = relevantForecasts[0]; let maxForecast = relevantForecasts[0];
            for (const forecast of relevantForecasts) { 
                if (forecast.temp < minForecast.temp) minForecast = forecast;
                if (forecast.temp > maxForecast.temp) maxForecast = forecast;
            }
            return { minTemp: minForecast.temp, minTime: minForecast.time, maxTemp: maxForecast.temp, maxTime: maxForecast.time };
        }

        async function fetchAndDisplayForecastsForStation(stationKey) {
            const now = Date.now();
            const stationCache = forecastCache[stationKey];
            const coords = STATIONS[stationKey].coords;

            if (stationCache && (now - stationCache.lastFetch) < REFRESH_INTERVAL_FORECAST) {
                return;
            }
            
            try {
                const hourlyData = await fetchHourlyForecastData(coords.lat, coords.lon);
                if (hourlyData) {
                    const todayMetrics = calculateForecastMetricsForDay(new Date(), hourlyData);
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowMetrics = calculateForecastMetricsForDay(tomorrow, hourlyData);

                    forecastCache[stationKey] = {
                        hourly: hourlyData,
                        todayMetrics: todayMetrics,
                        tomorrowMetrics: tomorrowMetrics,
                        lastFetch: now
                    };
                }
            } catch (e) {
                console.error(`Failed to fetch forecast for ${stationKey}`, e);
            }
        }

        function startMasterLoop() { 
            fetchAllDataAndUpdateDisplay(true); 
            setInterval(() => fetchAllDataAndUpdateDisplay(), REFRESH_INTERVAL_PWS); 
        }
        
        function initApp() {
            weatherDisplayEl = document.getElementById('weather-display'); 
            hourlyForecastContainerEl = document.getElementById('hourly-forecast-container'); 
            hourlyForecastTitleEl = document.getElementById('hourly-forecast-title');
            skyContainerEl = document.getElementById('sky-container'); 
            skyGlowEl = document.getElementById('sky-glow'); 
            starsContainerEl = document.getElementById('stars-container'); 
            cloudsContainerEl = document.getElementById('clouds-container'); 
            precipitationContainerEl = document.getElementById('precipitation-container'); 
            hazeContainerEl = document.getElementById('haze-container'); 
            lightningFlashEl = document.getElementById('lightning-flash');
            createStars(); 
            startMasterLoop(); 
            requestAnimationFrame(animateSky);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
