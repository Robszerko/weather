<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Időjárás Monitor - Nyíregyháza</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <style>
        :root {
            /* Színpaletta Alapok */
            --accent-interactive-night: #00BFFF; 
            --text-primary-night: #EAEAEA;
            --text-secondary-night: #A0B0C0;
            --bg-widget-night: rgba(15, 23, 42, 0.88); 
            --border-widget-night: rgba(56, 189, 248, 0.2); 

            --accent-interactive-day: #007AFF;
            --text-primary-day: #111827; 
            --text-secondary-day: #4B5563;
            --bg-widget-day: linear-gradient(160deg, rgba(240, 248, 255, 0.92) 0%, rgba(225, 238, 252, 0.90) 100%);
            --border-widget-day: rgba(0, 122, 255, 0.18);

            /* Hőmérsékletfüggő színek */
            --hot: #EF4444;
            --warm: #F97316;
            --mild: #22C55E;
            --cool: #3B82F6;
            --cold: #6366F1;
            --current-temp-bg-color: var(--mild);

            /* 12 FÁZISÚ CIKLUS DEFINÍCIÓJA */
            --sky-color-top-night: #0B1120;
            --sky-color-bottom-night: #020617;
            --sky-color-top-early-dawn: #020617;
            --sky-color-bottom-early-dawn: #0f172a;
            --sky-color-top-blue-hour-dawn: #0f172a;
            --sky-color-bottom-blue-hour-dawn: #1e3a8a;
            --sky-color-top-dawn: #1e293b; 
            --sky-color-bottom-dawn: #f97316;
            --sky-color-top-sunrise: #fef3c7;
            --sky-color-bottom-sunrise: #fb923c;
            --sky-color-top-golden-hour-rise: #fde68a;
            --sky-color-bottom-golden-hour-rise: #fca5a5;
            --sky-color-top-day: #7DD3FC;
            --sky-color-bottom-day: #C4EFFF;
            --sky-color-top-golden-hour-set: #fbbf24;
            --sky-color-bottom-golden-hour-set: #f87171;
            --sky-color-top-sunset: #f97316;
            --sky-color-bottom-sunset: #dc2626;
            --sky-color-top-dusk: #0369a1;
            --sky-color-bottom-dusk: #4c1d95;
            --sky-color-top-blue-hour-dusk: #1e3a8a;
            --sky-color-bottom-blue-hour-dusk: #312e81;
            --sky-color-top-late-dusk: #111827;
            --sky-color-bottom-late-dusk: #0c0a09;
            
            /* Aktuális Téma (kezdetben éjszakai) */
            --current-sky-color-top: var(--sky-color-top-night);
            --current-sky-color-bottom: var(--sky-color-bottom-night);
            --current-text-color: var(--text-primary-night);
            --current-text-muted-color: var(--text-secondary-night);
            --current-icon-color: var(--accent-interactive-night);
            --current-widget-bg: var(--bg-widget-night);
            --current-widget-border: var(--border-widget-night);
            --current-container-border-color: var(--border-widget-night);
        }

        .is-hidden { display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; }

        body { font-family: 'Inter', sans-serif; font-weight: 500; background-color: #020617; min-height: 100vh; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; position: relative; overflow-x: hidden; transition: background-color 1.5s ease-in-out; }
        
        body[data-theme="day"] { --current-sky-color-top: var(--sky-color-top-day); --current-sky-color-bottom: var(--sky-color-bottom-day); --current-text-color: var(--text-primary-day); --current-text-muted-color: var(--text-secondary-day); --current-icon-color: var(--accent-interactive-day); --current-widget-bg: var(--bg-widget-day); --current-widget-border: var(--border-widget-day); --current-container-border-color: rgba(203, 213, 225, 0.55); }
        body[data-theme="dawn"] { --current-sky-color-top: var(--sky-color-top-dawn); --current-sky-color-bottom: var(--sky-color-bottom-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #f59e0b; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(245, 158, 11, 0.3); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        body[data-theme="dusk"] { --current-sky-color-top: var(--sky-color-top-dusk); --current-sky-color-bottom: var(--sky-color-bottom-dusk); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #f472b6; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(236, 72, 153, 0.3); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        
        body[data-theme="early_dawn"] { --current-sky-color-top: var(--sky-color-top-early-dawn); --current-sky-color-bottom: var(--sky-color-bottom-early-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: #94a3b8; --current-icon-color: #60a5fa; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(96, 165, 250, 0.2); --current-container-border-color: rgba(51, 65, 85, 0.5); }
        body[data-theme="blue_hour_dawn"] { --current-sky-color-top: var(--sky-color-top-blue-hour-dawn); --current-sky-color-bottom: var(--sky-color-bottom-blue-hour-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #93c5fd; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(147, 197, 253, 0.2); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        body[data-theme="sunrise"] { --current-sky-color-top: var(--sky-color-top-sunrise); --current-sky-color-bottom: var(--sky-color-bottom-sunrise); --current-text-color: #422006; --current-text-muted-color: #7c2d12; --current-icon-color: #f97316; --current-widget-bg: linear-gradient(160deg, rgba(254, 243, 199, 0.92) 0%, rgba(253, 186, 116, 0.90) 100%); --current-widget-border: rgba(249, 115, 22, 0.25); --current-container-border-color: rgba(124, 45, 18, 0.4); }
        body[data-theme="golden_hour_rise"] { --current-sky-color-top: var(--sky-color-top-golden-hour-rise); --current-sky-color-bottom: var(--sky-color-bottom-golden-hour-rise); --current-text-color: #44403c; --current-text-muted-color: #78716c; --current-icon-color: #f59e0b; --current-widget-bg: linear-gradient(160deg, rgba(254, 249, 231, 0.92) 0%, rgba(253, 224, 224, 0.90) 100%); --current-widget-border: rgba(245, 158, 11, 0.2); --current-container-border-color: rgba(168, 162, 158, 0.5); }
        body[data-theme="golden_hour_set"] { --current-sky-color-top: var(--sky-color-top-golden-hour-set); --current-sky-color-bottom: var(--sky-color-bottom-golden-hour-set); --current-text-color: #44403c; --current-text-muted-color: #78716c; --current-icon-color: #ea580c; --current-widget-bg: linear-gradient(160deg, rgba(254, 235, 202, 0.92) 0%, rgba(254, 202, 202, 0.90) 100%); --current-widget-border: rgba(249, 115, 22, 0.2); --current-container-border-color: rgba(168, 162, 158, 0.5); }
        body[data-theme="sunset"] { --current-sky-color-top: var(--sky-color-top-sunset); --current-sky-color-bottom: var(--sky-color-bottom-sunset); --current-text-color: #fef2f2; --current-text-muted-color: #fecaca; --current-icon-color: #ef4444; --current-widget-bg: linear-gradient(160deg, rgba(127, 29, 29, 0.9) 0%, rgba(76, 29, 29, 0.92) 100%); --current-widget-border: rgba(239, 68, 68, 0.25); --current-container-border-color: rgba(159, 18, 57, 0.4); }
        body[data-theme="blue_hour_dusk"] { --current-sky-color-top: var(--sky-color-top-blue-hour-dusk); --current-sky-color-bottom: var(--sky-color-bottom-blue-hour-dusk); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #a78bfa; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(167, 139, 250, 0.2); --current-container-border-color: rgba(71, 85, 105, 0.5); }
        body[data-theme="late_dusk"] { --current-sky-color-top: var(--sky-color-top-late-dusk); --current-sky-color-bottom: var(--sky-color-bottom-late-dusk); --current-text-color: #d1d5db; --current-text-muted-color: #9ca3af; --current-icon-color: #818cf8; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(99, 102, 241, 0.2); --current-container-border-color: rgba(55, 65, 81, 0.5); }

        .sky-gradient-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, var(--current-sky-color-top), var(--current-sky-color-bottom)); transition: background 2s ease-in-out; z-index: -1; }

        .weather-widget { border-radius: 18px; padding: 22px 24px; width: 100%; max-width: 480px; box-sizing: border-box; margin: 0; position: relative; z-index: 10; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 5px 18px rgba(0,0,0,0.12), 0 2px 7px rgba(0,0,0,0.18); backdrop-filter: blur(20px) saturate(140%); -webkit-backdrop-filter: blur(20px) saturate(140%); transition: all 0.6s ease-in-out; }
        #weather-display { position: relative; z-index: 1; display: flex; flex-direction: column; }
        
        .widget-header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid var(--current-container-border-color); padding-bottom: 12px; transition: border-color 0.6s; }
        .location-and-station { font-size: 21px; font-weight: 700; margin-bottom: 3px; color: var(--current-text-color); line-height: 1.25; transition: color 0.6s; }
        
        .timestamp-container { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .timestamp { font-size: 12.5px; font-weight: 500; color: var(--current-text-muted-color); transition: color 0.6s; } 
        
        .info-tooltip-container { position: relative; cursor: help; color: var(--current-text-muted-color); line-height: 1; }
        .info-tooltip-container .fa-info-circle { transition: color 0.3s; }
        .info-tooltip-container:hover .fa-info-circle { color: var(--current-icon-color); }
        .info-tooltip-content { visibility: hidden; opacity: 0; position: absolute; top: calc(100% + 10px); left: 50%; transform: translateX(-50%); width: max-content; max-width: 320px; background-color: #f9fafb; color: #1f2937; text-align: left; border-radius: 8px; padding: 12px 15px; z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: opacity 0.3s, visibility 0.3s; font-size: 12px; line-height: 1.6; }
        .info-tooltip-content::after { content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: transparent transparent #f9fafb transparent; }
        .info-tooltip-container:hover .info-tooltip-content { visibility: visible; opacity: 1; }
        .info-tooltip-content strong { display: block; margin-bottom: 4px; color: #000; font-weight: 700; }
        .info-tooltip-content p, .info-tooltip-content ul { margin: 0 0 10px 0; padding-left: 0; }
        .info-tooltip-content ul { list-style-position: inside; padding-left: 4px; }
        .info-tooltip-content li { margin-bottom: 2px; }
        .info-tooltip-content p:last-child { margin-bottom: 0; }

        .station-status-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; text-align: center; margin-bottom: 12px; padding-top: 5px; padding-bottom: 10px; border-bottom: 1px solid var(--current-container-border-color); transition: border-color 0.6s; }
        .station-selector { flex: 1; }
        .station-selector label { cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--current-text-color); font-weight: 500; transition: color 0.6s; }
        .station-selector input[type="radio"] { margin: 0 0 4px 0; accent-color: var(--current-icon-color); }
        .station-selector.disabled label { opacity: 0.55; cursor: not-allowed; }
        .station-name { font-size: 12px; font-weight: 600; line-height: 1; }
        .station-status-text { color: var(--current-text-muted-color); font-weight: 400; font-size: 10px; line-height: 1; transition: color 0.6s; }

        .widget-core-data { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 12px; }
        .temperature-section { order: 2; display: flex; flex-direction: column; align-items: center; padding-top: 0; }
        .rain-info-section, .sun-info-section, .moon-info-section { order: 1; width: 100%; max-width: 100%; }

        .temperature { font-size: 58px; font-weight: 700; line-height: 1; background-color: var(--current-temp-bg-color); padding: 8px 12px; border-radius: 8px; display: inline-flex; align-items: baseline; box-shadow: 0 2px 4px rgba(0,0,0,0.15); perspective: 800px; transition: background-color 0.6s; }
        #temperature-value { display: inline-block; transform-style: preserve-3d; background: linear-gradient(180deg, var(--current-sky-color-top), var(--current-sky-color-bottom)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: none; }
        .temperature-symbol { font-size: 0.55em; vertical-align: super; margin-left: 2px; opacity: 0.95; background: linear-gradient(180deg, var(--current-sky-color-top), var(--current-sky-color-bottom)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: none; }

        .current-condition-phrase { font-size: 18px; font-weight: 600; color: var(--current-text-muted-color); margin-top: 12px; line-height: 1.4; min-height: 25px; transition: color 0.6s; }
        .additional-core-info { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 12px; width: 100%; }
        .additional-info-item { display: flex; justify-content: center; align-items: center; font-size: 14px; color: var(--current-text-muted-color); width: 100%; line-height: 1.4; min-height: 22px; transition: color 0.6s; }
        .additional-info-item .additional-info-label { font-weight: 600; margin-right: 6px; }
        .additional-info-item .additional-info-value { font-weight: 700; color: var(--current-text-color); display: flex; align-items: center; transition: color 0.6s; }
        #main-wind-arrow-icon { display: inline-block; transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1); margin: 0 5px; }
        
        .sun-info-section, .moon-info-section, .rain-info-section { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 65px;
            padding-top: 10px; 
            min-height: 110px;
        }
        .sun-text-details, .moon-text-details, .rain-text-details { text-align: left; display: flex; flex-direction: column; gap: 5px; font-size: 12px; flex-shrink: 1; }
        .sun-detail-item, .moon-detail-item, .rain-detail-item { display: flex; flex-direction: column; }
        .sun-detail-label, .moon-detail-label, .rain-detail-label { font-weight: 600; color: var(--current-text-color); opacity: 0.85; margin-bottom: 1.5px; transition: color 0.6s; }
        .sun-detail-value, .moon-detail-value, .rain-detail-value { font-weight: 500; color: var(--current-text-muted-color); transition: color 0.6s; display: flex; align-items: center; }
        .sun-trend-text, .moon-trend-text { font-size: 0.8em; font-weight: 500; opacity: 0.7; margin-left: 4px; }
        .path-refresh-btn { font-size: 0.8em; margin-left: 8px; cursor: pointer; opacity: 0.6; transition: opacity 0.3s, color 0.3s, transform 0.3s; }
        .path-refresh-btn:hover { opacity: 1; color: var(--current-icon-color); }
        .path-refresh-btn.is-refreshing { transform: rotate(360deg); transition: transform 0.8s; }

        .sun-path-visual, .moon-path-visual {
            width: 150px; height: 85px; position: relative; display: flex; justify-content: center; align-items: flex-end; margin-bottom: 10px; flex-shrink: 0;
        }
        .sun-path-svg, .moon-path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible; }
        .sun-path-arc-bg, .sun-path-arc-main, .moon-path-arc-bg, .moon-path-arc-main { fill: none; stroke-width: 2.5px; stroke-linecap: round; }
        .sun-path-arc-bg, .moon-path-arc-bg { stroke: var(--current-text-muted-color); opacity: 0.35; stroke-dasharray: 4 4; }
        .sun-path-horizon, .moon-path-horizon { position: absolute; bottom: 10px; left: 0; width: 100%; height: 1px; background-color: var(--current-text-muted-color); opacity: 0.35; }
        .sun-path-now-marker, .moon-path-now-marker { position: absolute; bottom: 6px; width: 2px; height: 8px; border-radius: 1px; transform: translateX(-50%); transition: left 1s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.9; }
        .sun-path-label, .moon-path-label { position: absolute; bottom: -16px; font-size: 10px; font-weight: 600; color: var(--current-text-muted-color); opacity: 0.8; line-height: 1.3; }
        .sun-path-label.sunrise-label, .moon-path-label.moonrise-label { left: 0; }
        .sun-path-label.sunset-label, .moon-path-label.moonset-label { right: 0; }
        .moon-path-time { font-weight: 700; color: var(--current-text-color); opacity: 0.95; }
        
        .sun-path-arc-main { stroke: var(--current-icon-color); opacity: 0.9; transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1); }
        #sun-path-icon { position: absolute; top: 0; left: 0; width: 20px; height: 20px; font-size: 20px; color: #FFD700; text-shadow: 0 0 8px #FFC107; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; pointer-events: auto; cursor: help; }
        .sun-path-now-marker { background-color: var(--current-icon-color); }
        
        .moon-path-arc-main { stroke: #A0B0C0; opacity: 0.9; transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1); }
        #moon-path-icon { position: absolute; top: 0; left: 0; width: 18px; height: 18px; font-size: 18px; color: #E0E7FF; text-shadow: 0 0 10px rgba(224, 231, 255, 0.7); transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; pointer-events: auto; cursor: help; }
        .moon-path-now-marker { background-color: #A0B0C0; }

        .rain-visual { width: 130px; height: 120px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-shrink: 0; }
        .rain-gauge-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .rain-gauge-bg, .rain-gauge-value { fill: none; stroke-width: 10; stroke-linecap: round; }
        .rain-gauge-bg { stroke: var(--current-text-muted-color); opacity: 0.2; }
        .rain-gauge-value { stroke: var(--accent-interactive-night); transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .rain-visual-center { position: absolute; text-align: center; color: var(--current-text-color); }
        #rain-visual-icon { font-size: 28px; opacity: 0.8; margin-bottom: 2px; }
        #rain-visual-total { font-size: 17px; font-weight: 700; }
        #rain-visual-total-unit { font-size: 11px; font-weight: 500; opacity: 0.7; margin-left: 2px; }
        .rain-visual-label { margin-top: 3px; font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); opacity: 0.8; }

        .weather-details-grid { margin-top: 0; border-top: 1px solid var(--current-container-border-color); padding-top: 14px; display: grid; grid-template-columns: 1fr 1fr; gap: 3px 16px; transition: border-color 0.6s; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 5px 0; }
        .detail-item .label { font-weight: 600; color: var(--current-text-color); margin-right: 6px; display: flex; align-items: center; transition: color 0.6s; }
        .detail-item .label i { margin-right: 7px; width: 14px; font-size: 0.95em; text-align: center; opacity: 0.8; color: var(--current-icon-color); transition: color 0.6s; }
        .detail-item .value { color: var(--current-text-muted-color); font-weight: 500; transition: color 0.6s; display: flex; align-items: center; }
        
        .pressure-trend-icon { margin-left: 4px; font-weight: 700; }
        .uv-description-text { margin-left: 4px; font-size: 0.88em; font-style: italic; }

        .forecast-title { width: 100%; max-width: 480px; font-size: 16px; font-weight: 700; color: var(--current-text-color); margin-top: 24px; margin-bottom: 12px; text-align: center; transition: color 0.6s; }
        
        .hourly-forecast-container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 8px; padding: 4px; box-sizing: border-box; }
        .hourly-forecast-card { display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px; border-radius: 12px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--current-text-color); transition: all 0.6s; }
        .hourly-primary-info { display: flex; align-items: center; gap: 16px; flex-grow: 1; }
        .hourly-time { font-size: 13px; font-weight: 700; min-width: 45px; text-align: left; }
        .hourly-icon-and-condition { display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 80px; }
        .hourly-icon { font-size: 24px; color: var(--current-icon-color); transition: color 0.6s; }
        .hourly-condition-text { font-size: 11px; font-weight: 500; color: var(--current-text-muted-color); white-space: nowrap; text-align: center; }
        .hourly-temp { font-size: 18px; font-weight: 700; }
        .hourly-secondary-details { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; font-size: 11px; color: var(--current-text-muted-color); flex-shrink: 0; }
        .hourly-detail-row { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .hourly-detail-row i { width: 12px; text-align: center; opacity: 0.8; }
        .hourly-detail-row .detail-separator { display: inline-block; width: 1px; height: 10px; background-color: var(--current-container-border-color); margin: 0 4px; }

        .forecast-container { width: 100%; max-width: 480px; padding-bottom: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .forecast-day-card { display: flex; flex-direction: column; padding: 12px; border-radius: 14px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 3px 10px rgba(0,0,0,0.1); color: var(--current-text-color); transition: all 0.6s; }
        .forecast-header { text-align: center; margin-bottom: 8px; }
        .forecast-day-name { font-size: 14px; font-weight: 700; }
        .forecast-date { font-size: 11px; font-weight: 500; color: var(--current-text-muted-color); }
        .forecast-temps { font-size: 18px; font-weight: 700; display: flex; justify-content: center; gap: 8px; padding: 8px 0; border-top: 1px solid var(--current-container-border-color); border-bottom: 1px solid var(--current-container-border-color); margin: 8px 0; transition: border-color 0.6s; }
        .forecast-temp-min { color: var(--current-text-muted-color); font-weight: 500; }
        .forecast-part { margin-top: 8px; }
        .forecast-part:first-of-type { padding-bottom: 8px; border-bottom: 1px solid var(--current-container-border-color); transition: border-color 0.6s; }
        .forecast-part-header { display: flex; align-items: center; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
        .forecast-part-header i { margin-right: 6px; opacity: 0.8; color: var(--current-icon-color); transition: color 0.6s; }
        .forecast-part-details { font-size: 11.5px; color: var(--current-text-muted-color); line-height: 1.5; text-align: left; }
        .forecast-part-details p { margin: 2px 0; }

        .detail-item, .additional-info-item { perspective: 600px; }
        .detail-item .value { perspective: 400px; }

        #temperature-value, #main-heat-index-value, #main-wind-speed-value, #main-wind-gust-value, #dewpoint-value, #humidity-value, #pressure-value, #visibility-value, #solar-radiation-value, #uv-index-value {
            display: inline-block;
            transition: transform 0.6s cubic-bezier(0.45, 0, 0.55, 1);
            transform-style: preserve-3d;
            will-change: transform;
        }

        #temperature-value.is-flipping, #main-heat-index-value.is-flipping, #main-wind-speed-value.is-flipping, #main-wind-gust-value.is-flipping, #dewpoint-value.is-flipping, #humidity-value.is-flipping, #pressure-value.is-flipping, #visibility-value.is-flipping, #solar-radiation-value.is-flipping, #uv-index-value.is-flipping {
            transform: rotateX(90deg);
        }
    </style>
</head>
<body data-theme="night">

    <div class="sky-gradient-overlay"></div>

    <div class="weather-widget">
        <div id="widget-background-image"></div>
        <div id="weather-display"></div>
    </div>

    <h3 class="forecast-title is-hidden" id="hourly-forecast-title">Következő órák</h3>
    <div class="hourly-forecast-container" id="hourly-forecast-container"></div>

    <h3 class="forecast-title is-hidden" id="forecast-title">8 napos előrejelzés</h3>
    <div class="forecast-container" id="forecast-container"></div>

    <script>
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
        const REFRESH_INTERVAL_PWS = 30 * 1000;
        const REFRESH_INTERVAL_WIND = 15 * 1000;
        const REFRESH_INTERVAL_GENERAL_CONDITIONS = 5 * 60 * 1000;
        const REFRESH_INTERVAL_OPEN_METEO_RAIN = 60 * 60 * 1000;
        const REFRESH_INTERVAL_FORECAST = 6 * 60 * 60 * 1000;
        const SKY_COLOR_UPDATE_INTERVAL = 1 * 60 * 1000;
        const NYIREGYHAZA_COORDS = { lat: 47.9550, lon: 21.7160 };

        const STATIONS = { 
            HONVED: { id: 'INYREG37', name: 'Nyíregyháza Honvéd utcai állomás', displayName: 'Honvéd u.', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure'], isOnline: false, data: null }, 
            KOSSUTH: { id: 'INYREG42', name: 'Nyíregyháza Kossuth úti állomás', displayName: 'Kossuth út', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure', 'precip'], isOnline: false, data: null },
            NYIREGYHAZI_UT: { id: 'INYREG26', name: 'Nyíregyháza Nyíregyházi úti állomás', displayName: 'Nyíregyházi út', provides: ['precip', 'temp'], isOnline: false, data: null } 
        };
        let activeDisplayStationKey = 'HONVED'; 
        
        let lastApiCallTimes = { generalConditions: 0, openMeteoRain: 0, forecast: 0, hourlyForecast: 0 };
        let cachedData = { 
            displayPws: null, 
            generalConditions: { skyCoverPhrase: null, pressureAltimeter: null, visibility: null, sunriseTimeLocal: null, sunsetTimeLocal: null, dayOrNight: null, pressureTendencyCode: null, uvDescription: null }, 
            expectedRainToday_gauge: null,
            forecastDays: [],
            hourlyForecast: [],
            sunCalc: null
        };
        let isWeatherDisplayInitialized = false;

        // VÁLTOZÓK A NAPI LOGIKÁHOZ
        let hasRainBeenDetectedToday = false;
        let currentDay = new Date().getDate();

        let weatherDisplayEl, forecastContainerEl, forecastTitleEl, hourlyForecastContainerEl, hourlyForecastTitleEl;
        const NO_DATA_STRING = 'N/A';
        const PRECIP_THRESHOLD = 30;

        function formatValue(value, unit = '', precision = 1, notAvailableString = NO_DATA_STRING) { if (value === null || typeof value === 'undefined' || (typeof value === 'number' && isNaN(value)) ) return notAvailableString; if (typeof value === 'number') { return `${value.toFixed(precision)}${unit}`; } return `${value}${unit}`; }
        function formatTime(dateOrIsoString, includeSeconds = false) { if (!dateOrIsoString) return NO_DATA_STRING; try { const date = dateOrIsoString instanceof Date ? dateOrIsoString : new Date(dateOrIsoString); if (isNaN(date.getTime())) return NO_DATA_STRING; const options = { hour: '2-digit', minute: '2-digit' }; if(includeSeconds) options.second = '2-digit'; return date.toLocaleTimeString('hu-HU', options); } catch (e) { return NO_DATA_STRING; } }
        
        function degreesToCompass(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["északi", "észak-északkeleti", "északkeleti", "kelet-északkeleti", "keleti", "kelet-délkeleti", "délkeleti", "dél-délkeleti", "déli", "dél-délnyugati", "délnyugati", "nyugat-délnyugati", "nyugati", "nyugat-északnyugati", "északnyugati", "észak-északnyugati"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function degreesToCompassAbbreviated(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["É", "ÉÉK", "ÉK", "KÉK", "K", "KDK", "DK", "DDK", "D", "DDNY", "DNY", "NYDNY", "NY", "NYÉNY", "ÉNY", "ÉÉNY"]; return directions[Math.round(degrees / 22.5) % 16]; }

        function updateThemeAndSky(currentTime, sunriseTimeIso, sunsetTimeIso) {
            const fallbackTheme = (new Date().getHours() >= 7 && new Date().getHours() < 18) ? 'day' : 'night';
            let theme = fallbackTheme;

            if (sunriseTimeIso && sunsetTimeIso) {
                try {
                    const nowMs = currentTime.getTime();
                    const sunriseDate = new Date(sunriseTimeIso);
                    const sunsetDate = new Date(sunsetTimeIso);

                    if (isNaN(sunriseDate.getTime()) || isNaN(sunsetDate.getTime())) {
                        throw new Error("Invalid sunrise/sunset date");
                    }
                    
                    const EARLY_DAWN_DURATION = 30 * 60 * 1000;
                    const BLUE_HOUR_DAWN_DURATION = 30 * 60 * 1000;
                    const DAWN_DURATION = 25 * 60 * 1000;
                    const SUNRISE_EVENT_DURATION = 15 * 60 * 1000;
                    const GOLDEN_HOUR_RISE_DURATION = 45 * 60 * 1000;
                    
                    const GOLDEN_HOUR_SET_DURATION = 45 * 60 * 1000;
                    const SUNSET_EVENT_DURATION = 15 * 60 * 1000;
                    const DUSK_DURATION = 25 * 60 * 1000;
                    const BLUE_HOUR_DUSK_DURATION = 30 * 60 * 1000;
                    const LATE_DUSK_DURATION = 30 * 60 * 1000;

                    const sunriseMs = sunriseDate.getTime();
                    const sunsetMs = sunsetDate.getTime();

                    const earlyDawnStart = sunriseMs - DAWN_DURATION - BLUE_HOUR_DAWN_DURATION - EARLY_DAWN_DURATION;
                    const blueHourDawnStart = sunriseMs - DAWN_DURATION - BLUE_HOUR_DAWN_DURATION;
                    const dawnStart = sunriseMs - DAWN_DURATION;
                    const sunriseEnd = sunriseMs + SUNRISE_EVENT_DURATION;
                    const goldenHourRiseEnd = sunriseEnd + GOLDEN_HOUR_RISE_DURATION;
                    
                    const goldenHourSetStart = sunsetMs - GOLDEN_HOUR_SET_DURATION;
                    const sunsetEnd = sunsetMs + SUNSET_EVENT_DURATION;
                    const duskEnd = sunsetEnd + DUSK_DURATION;
                    const blueHourDuskEnd = duskEnd + BLUE_HOUR_DUSK_DURATION;
                    const lateDuskEnd = blueHourDuskEnd + LATE_DUSK_DURATION;
                    
                    if (nowMs >= earlyDawnStart && nowMs < blueHourDawnStart) { theme = 'early_dawn'; } 
                    else if (nowMs >= blueHourDawnStart && nowMs < dawnStart) { theme = 'blue_hour_dawn'; } 
                    else if (nowMs >= dawnStart && nowMs < sunriseMs) { theme = 'dawn'; } 
                    else if (nowMs >= sunriseMs && nowMs < sunriseEnd) { theme = 'sunrise'; } 
                    else if (nowMs >= sunriseEnd && nowMs < goldenHourRiseEnd) { theme = 'golden_hour_rise'; } 
                    else if (nowMs >= goldenHourRiseEnd && nowMs < goldenHourSetStart) { theme = 'day'; } 
                    else if (nowMs >= goldenHourSetStart && nowMs < sunsetMs) { theme = 'golden_hour_set'; } 
                    else if (nowMs >= sunsetMs && nowMs < sunsetEnd) { theme = 'sunset'; } 
                    else if (nowMs >= sunsetEnd && nowMs < duskEnd) { theme = 'dusk'; } 
                    else if (nowMs >= duskEnd && nowMs < blueHourDuskEnd) { theme = 'blue_hour_dusk'; } 
                    else if (nowMs >= blueHourDuskEnd && nowMs < lateDuskEnd) { theme = 'late_dusk'; } 
                    else { theme = 'night'; }

                } catch (e) {
                    console.warn("Theme calculation failed, using fallback:", e.message);
                    theme = fallbackTheme;
                }
            }
            
            if (document.body.dataset.theme !== theme) {
                document.body.dataset.theme = theme;
            }
        }
        
        function getComprehensiveMoonData(lat, lon) {
            const now = new Date();
            const days = [
                new Date(new Date().setDate(now.getDate() - 1)),
                now,
                new Date(new Date().setDate(now.getDate() + 1))
            ];

            let events = [];
            days.forEach(day => {
                const moonTimes = SunCalc.getMoonTimes(day, lat, lon, true);
                if (moonTimes.rise && !isNaN(moonTimes.rise.getTime())) {
                    events.push({ time: moonTimes.rise, type: 'rise' });
                }
                if (moonTimes.set && !isNaN(moonTimes.set.getTime())) {
                    events.push({ time: moonTimes.set, type: 'set' });
                }
            });

            if (events.length === 0) {
                const moonPos = SunCalc.getMoonPosition(now, lat, lon);
                const isUp = moonPos.altitude > 0;
                return { isUp: isUp, pathRise: null, pathSet: null, nextRise: null, nextSet: null };
            }

            events.sort((a, b) => a.time - b.time);

            const lastEvent = events.filter(e => e.time < now).pop();

            let isUp = false;
            let pathRise = null;
            let pathSet = null;

            if (lastEvent) {
                if (lastEvent.type === 'rise') {
                    isUp = true;
                    pathRise = lastEvent.time;
                    pathSet = events.find(e => e.type === 'set' && e.time > pathRise)?.time || null;
                }
            }

            const nextRise = events.find(e => e.type === 'rise' && e.time > now)?.time || null;
            const nextSet = events.find(e => e.type === 'set' && e.time > now)?.time || null;
            
            return {
                isUp: isUp,
                pathRise: pathRise,
                pathSet: pathSet,
                nextRise: nextRise,
                nextSet: nextSet
            };
        }

        async function fetchAdvancedSunCalcData(lat, lon) {
            const now = new Date();
            const sunTimesToday = SunCalc.getTimes(now, lat, lon);

            const sunriseDate = sunTimesToday.sunrise;
            const sunsetDate = sunTimesToday.sunset;
            const solarNoonDate = sunTimesToday.solarNoon;

            const sunPos = SunCalc.getPosition(now, lat, lon);
            const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000);
            const pastSunPos = SunCalc.getPosition(tenMinutesAgo, lat, lon);
            let sunTrend = sunPos.altitude > 0 ? (sunPos.altitude > pastSunPos.altitude ? 'Emelkedik' : 'Süllyed') : null;
            
            let sunStatus = '';
            if (sunriseDate && sunsetDate && !isNaN(sunriseDate.getTime()) && !isNaN(sunsetDate.getTime())) {
                if (now < sunriseDate) { sunStatus = 'Napkelte előtt'; } 
                else if (now >= sunriseDate && now < solarNoonDate) { sunStatus = 'Dél felé tart'; } 
                else if (now >= solarNoonDate && now < sunsetDate) { sunStatus = 'Dél után'; } 
                else { sunStatus = 'Lenyugodott'; }
            }
            
            let remainingDaylightText = 'N/A';
            if (sunriseDate && sunsetDate && !isNaN(sunriseDate.getTime()) && !isNaN(sunsetDate.getTime())) {
                if (now > sunriseDate && now < sunsetDate) {
                    const diffMs = sunsetDate.getTime() - now.getTime();
                    const hours = Math.floor(diffMs / 3600000);
                    const minutes = Math.floor((diffMs % 3600000) / 60000);
                    remainingDaylightText = `Még ${hours} óra ${minutes} perc`;
                } else if (now <= sunriseDate) {
                    remainingDaylightText = `Napkelte ${formatTime(sunriseDate)}-kor`;
                } else {
                    remainingDaylightText = 'A nap már lenyugodott';
                }
            }
            
            const moonPos = SunCalc.getMoonPosition(now, lat, lon);
            const pastMoonPos = SunCalc.getMoonPosition(tenMinutesAgo, lat, lon);
            const moonIllumination = SunCalc.getMoonIllumination(now);
            
            const comprehensiveMoonData = getComprehensiveMoonData(lat, lon);
            
            let moonTrend = moonPos.altitude > 0 ? (moonPos.altitude > pastMoonPos.altitude ? 'Emelkedik' : 'Süllyed') : null;
            let moonStatus = comprehensiveMoonData.isUp ? 'Égen van' : 'Horizont alatt';

            let phaseName = 'N/A'; 
            const phase = moonIllumination.phase; 
            if (phase >= 0 && phase < 0.03) phaseName = 'Újhold';
            else if (phase >= 0.03 && phase < 0.22) phaseName = 'Növekvő sarló'; 
            else if (phase >= 0.22 && phase < 0.28) phaseName = 'Első negyed'; 
            else if (phase >= 0.28 && phase < 0.47) phaseName = 'Növekvő hold'; 
            else if (phase >= 0.47 && phase < 0.53) phaseName = 'Telihold'; 
            else if (phase >= 0.53 && phase < 0.72) phaseName = 'Fogyó hold'; 
            else if (phase >= 0.72 && phase < 0.78) phaseName = 'Utolsó negyed'; 
            else if (phase >= 0.78 && phase < 0.97) phaseName = 'Fogyó sarló';
            else if (phase >= 0.97 && phase <= 1) phaseName = 'Újholdhoz közeli';

            return {
                sunrise: formatTime(sunriseDate),
                sunset: formatTime(sunsetDate),
                solarNoon: formatTime(solarNoonDate),
                sunriseDateForPath: sunriseDate,
                sunsetDateForPath: sunsetDate,
                
                sunAltitude: sunPos.altitude * 180 / Math.PI, sunTrend: sunTrend, sunStatus: sunStatus, remainingDaylight: remainingDaylightText,
                
                isUp: comprehensiveMoonData.isUp,
                moonrise: formatTime(comprehensiveMoonData.nextRise), 
                moonset: formatTime(comprehensiveMoonData.nextSet),
                moonRiseDateForPath: comprehensiveMoonData.pathRise,
                moonSetDateForPath: comprehensiveMoonData.pathSet,
                
                moonAltitude: moonPos.altitude * 180 / Math.PI, moonTrend: moonTrend, moonStatus: moonStatus,
                phaseValue: (moonIllumination.fraction * 100), phaseName: phaseName, moonDistance: moonPos.distance,
            };
        }
        
        function updatePathVisuals(startTime, endTime, elements) {
            const { iconEl, mainArcEl, nowMarkerEl } = elements;
            if (!startTime || !endTime || isNaN(startTime.getTime()) || isNaN(endTime.getTime()) || !iconEl || !mainArcEl || !nowMarkerEl) {
                if(mainArcEl && mainArcEl.getTotalLength) mainArcEl.style.strokeDashoffset = mainArcEl.getTotalLength();
                if(iconEl) iconEl.classList.add('is-hidden');
                if(nowMarkerEl) nowMarkerEl.classList.add('is-hidden');
                return;
            }
            iconEl.classList.remove('is-hidden');
            nowMarkerEl.classList.remove('is-hidden');

            const now = new Date();
            const totalTimeInSky = endTime.getTime() - startTime.getTime();
            
            let percentageOfPath = 0;
            if (totalTimeInSky > 0) {
                const elapsedTime = now.getTime() - startTime.getTime();
                percentageOfPath = Math.max(0, Math.min(1, elapsedTime / totalTimeInSky));
            }

            const arcLength = mainArcEl.getTotalLength();
            if (arcLength === 0) {
                setTimeout(() => updatePathVisuals(startTime, endTime, elements), 50);
                return;
            }

            const offset = arcLength * (1 - percentageOfPath);
            mainArcEl.style.strokeDasharray = arcLength;
            mainArcEl.style.strokeDashoffset = offset;
            
            const angle = Math.PI * (1 - percentageOfPath); 
            const arcRadius = 65; 
            const centerX = 75;
            const centerY = 75;

            const svgX = centerX + arcRadius * Math.cos(angle);
            const svgY = centerY - arcRadius * Math.sin(angle);

            iconEl.style.transform = `translate(${svgX}px, ${svgY}px) translate(-50%, -50%)`;
            nowMarkerEl.style.left = `${svgX}px`;
        }

        function updatePrecipitationVisuals(precipRate, precipTotal, elements) {
            const { gaugeValueEl, totalValueEl } = elements;
            if (!gaugeValueEl || !totalValueEl) return;
            
            const MAX_INTENSITY = 10;
            const percentage = Math.min(1, (precipRate || 0) / MAX_INTENSITY);
            
            const radius = gaugeValueEl.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            
            const offset = circumference * (1 - percentage);
            gaugeValueEl.style.strokeDasharray = circumference;
            gaugeValueEl.style.strokeDashoffset = offset;
            
            totalValueEl.textContent = formatValue(precipTotal, '', 2);
        }

        async function fetchPwsStationData(stationKey) { 
            const stationConfig = STATIONS[stationKey];
            const url = `https://api.weather.com/v2/pws/observations/current?apiKey=${weatherComApiKey}&stationId=${stationConfig.id}&numericPrecision=decimal&format=json&units=m`; 
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`PWS API Hiba: ${response.status}`);
                const data = await response.json();
                if (!data.observations || data.observations.length === 0) throw new Error(`Nincs PWS adat.`);
                stationConfig.isOnline = true;
                stationConfig.data = data.observations[0];
                updateStationStatusUI(stationKey, 'online');
            } catch (error) {
                stationConfig.isOnline = false;
                updateStationStatusUI(stationKey, 'offline');
                throw error;
            }
        }

        async function fetchGeneralConditionsData(lat, lon) { const lang = 'hu-HU'; const url = `https://api.weather.com/v3/wx/observations/current?geocode=${lat},${lon}&language=${lang}&format=json&apiKey=${weatherComApiKey}&units=m`; const response = await fetch(url); if (!response.ok) { throw new Error(`API hiba (Ált. időjárás): ${response.status}`); } const data = await response.json(); lastApiCallTimes.generalConditions = Date.now(); return { skyCoverPhrase: data.cloudCoverPhrase || data.wxPhraseLong || null, pressureAltimeter: data.pressureAltimeter ?? data.pressureMeanSeaLevel, visibility: data.visibility, dayOrNight: data.dayOrNight, pressureTendencyCode: data.pressureTendencyCode ?? (data.pressureChange !== null && typeof data.pressureChange !== 'undefined' ? (data.pressureChange > 0 ? 0 : (data.pressureChange < 0 ? 1 : 2)) : null), uvDescription: data.uvDescription || null }; }
        async function fetchOpenMeteoExpectedRain_gauge(lat, lon) { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=precipitation_sum&timezone=auto&forecast_days=1`; const response = await fetch(url); if (!response.ok) { throw new Error(`Open-Meteo API hiba: ${response.status}`); } const data = await response.json(); lastApiCallTimes.openMeteoRain = Date.now(); if (data?.daily?.precipitation_sum?.[0] !== undefined) { return data.daily.precipitation_sum[0]; } else { throw new Error('Hiányos várható csapadék adat (Open-Meteo).'); } }
        async function fetchDailyForecastData(lat, lon) {
            const url = `https://api.weather.com/v3/wx/forecast/daily/10day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
            try {
                const response = await fetch(url); if (!response.ok) throw new Error(`Napi előrejelzés API Hiba: ${response.status}`); const data = await response.json(); if (!data || !data.dayOfWeek) { throw new Error('Hiányos napi előrejelzési adatok.'); } lastApiCallTimes.forecast = Date.now();
                const forecastDays = []; 
                for(let i = 0; i <= 7; i++) {
                    const dayData = {
                        dayName: data.dayOfWeek?.[i], date: data.validTimeLocal?.[i], tempMax: data.temperatureMax?.[i], tempMin: data.temperatureMin?.[i],
                        dayPart: data.daypart?.[0] ? { phrase: data.daypart[0].wxPhraseLong?.[i*2], precipChance: data.daypart[0].precipChance?.[i*2], windSpeed: data.daypart[0].windSpeed?.[i*2], windDir: data.daypart[0].windDirection?.[i*2], uvIndex: data.daypart[0].uvIndex?.[i*2], uvDescription: data.daypart[0].uvDescription?.[i*2] } : null,
                        nightPart: data.daypart?.[0] ? { phrase: data.daypart[0].wxPhraseLong?.[i*2+1], precipChance: data.daypart[0].precipChance?.[i*2+1], windSpeed: data.daypart[0].windSpeed?.[i*2+1], windDir: data.daypart[0].windDirection?.[i*2+1] } : null
                    };
                    forecastDays.push(dayData);
                }
                return { 
                    forecastDays: forecastDays, 
                    sunriseTimeLocal: data.sunriseTimeLocal?.[0], 
                    sunsetTimeLocal: data.sunsetTimeLocal?.[0],
                };
            } catch (error) { console.warn(`Napi előrejelzés hiba: ${error.message}`); throw error; }
        }
        async function fetchHourlyForecastData(lat, lon) {
            const url = `https://api.weather.com/v3/wx/forecast/hourly/2day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
            try {
                const response = await fetch(url); if (!response.ok) throw new Error(`Órás előrejelzés API hiba: ${response.status}`); const data = await response.json(); if (!data || !data.validTimeLocal) { throw new Error('Hiányos órás előrejelzési adatok.'); } lastApiCallTimes.hourlyForecast = Date.now();
                const hourlyForecasts = []; const now = new Date(); const startIndex = data.validTimeLocal.findIndex(timeStr => new Date(timeStr) > now);
                if (startIndex === -1) return [];
                for (let i = startIndex; i < startIndex + 12 && i < data.validTimeLocal.length; i++) { 
                    hourlyForecasts.push({ time: data.validTimeLocal[i], temp: data.temperature[i], iconCode: data.iconCode[i], precipChance: data.precipChance[i], dayOrNight: data.dayOrNight[i], windSpeed: data.windSpeed[i], windDirection: data.windDirection[i], humidity: data.relativeHumidity[i], uvIndex: data.uvIndex[i], wxPhraseShort: data.wxPhraseShort[i] }); 
                } 
                return hourlyForecasts;
            } catch (error) { console.warn(`Órás előrejelzés hiba: ${error.message}`); throw error; }
        }
        
        function findNextPrecipitationEvent(hourlyData) {
            if (!hourlyData || hourlyData.length === 0) return null;
            const stormKeywords = ['vihar', 'zivatar']; const rainKeywords = ['eső', 'zápor']; const snowKeywords = ['hó', 'havazás', 'hózápor'];
            for (const hour of hourlyData) {
                if (hour.precipChance >= PRECIP_THRESHOLD) {
                    const phrase = (hour.wxPhraseShort || '').toLowerCase(); let type = 'Csapadék';
                    if (stormKeywords.some(keyword => phrase.includes(keyword))) { type = 'Vihar'; } else if (rainKeywords.some(keyword => phrase.includes(keyword))) { type = 'Eső'; } else if (snowKeywords.some(keyword => phrase.includes(keyword))) { type = 'Hó'; }
                    return { time: hour.time, chance: hour.precipChance, type: type };
                }
            } return null;
        }
        
        function initializeWeatherDisplayDOM() {
            const tooltipContent = `<strong>Hogyan működöm?</strong><p>Ezt az időjárási panelt Robi készitette mesterséges intelligencia (AI) segitségével, valós idejű és előrejelzett adatok megjelenitesére Nyiregyháza területéről.</p><strong>Adatforrások:</strong><ul><li>Valós idejű adatok: Weather.com PWS API (Honvéd u., Kossuth út, Nyíregyházi út magán időjárás-állomások).</li><li>Csillagászati adatok: SunCalc.js könyvtár a pontos nap- és hold-ciklusokhoz.</li><li>Előrejelzés & Ált. adatok: Weather.com & Open-Meteo API-k kombinációja.</li></ul><strong>Frissítési idők:</strong><ul><li>Mérőállomás adatok: ${REFRESH_INTERVAL_PWS / 1000} másodpercenként (szél: ${REFRESH_INTERVAL_WIND / 1000} mp)</li><li>Órás előrejelzés: Minden óra 0., 20. és 40. percében</li><li>Általános állapot & Előrejelzések: Pár percenként / óránként</li></ul><p>A felület témája (hajnal, nappal, szürkület, éjjel) a napkelte és napnyugta idejéhez igazodik dinamikusan.</p>`;
            weatherDisplayEl.innerHTML = `<div class="widget-header"><div class="location-and-station" id="location-and-station-text"></div><div class="timestamp-container"><span class="timestamp" id="timestamp-text">Megfigyelés: --:--:--</span><div class="info-tooltip-container"><i class="fas fa-info-circle"></i><div class="info-tooltip-content">${tooltipContent}</div></div></div></div>
            <div class="station-status-container">
                <div class="station-selector" id="honved-selector-container">
                    <label for="station-select-honved">
                        <input type="radio" name="station-select" id="station-select-honved" value="HONVED">
                        <span class="station-name">${STATIONS.HONVED.displayName}</span>
                        <span id="honved-status-text" class="station-status-text"></span>
                    </label>
                </div>
                <div class="station-selector" id="kossuth-selector-container">
                    <label for="station-select-kossuth">
                        <input type="radio" name="station-select" id="station-select-kossuth" value="KOSSUTH">
                        <span class="station-name">${STATIONS.KOSSUTH.displayName}</span>
                        <span id="kossuth-status-text" class="station-status-text"></span>
                    </label>
                </div>
                <div class="station-selector" id="nyiregyhazi-ut-selector-container">
                     <label for="station-select-nyiregyhazi-ut">
                        <input type="radio" name="station-select" id="station-select-nyiregyhazi-ut" value="NYIREGYHAZI_UT">
                        <span class="station-name">${STATIONS.NYIREGYHAZI_UT.displayName}</span>
                        <span id="nyiregyhazi-ut-status-text" class="station-status-text"></span>
                    </label>
                </div>
            </div>
            <div class="widget-core-data">
            <div class="sun-info-section is-hidden" id="sun-info-section"><div class="sun-path-visual"><svg class="sun-path-svg" viewBox="0 0 150 85" preserveAspectRatio="none"><path class="sun-path-arc-bg" d="M 10 75 A 65 65 0 0 1 140 75"></path><path id="sun-path-arc-main" class="sun-path-arc-main" d="M 10 75 A 65 65 0 0 1 140 75"></path></svg><div class="sun-path-horizon"></div><div class="sun-path-now-marker" id="sun-path-now-marker"></div><i class="fas fa-sun" id="sun-path-icon"></i><div class="sun-path-label sunrise-label">Napkelte</div><div class="sun-path-label sunset-label">Napnyugta</div></div><div class="sun-text-details"><div class="sun-detail-item"><span class="sun-detail-label">Nap magassága:</span><span id="sun-info-altitude" class="sun-detail-value">--°<span id="sun-info-trend" class="sun-trend-text"></span><i id="sun-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Pozíció frissítése"></i></span></div><div class="sun-detail-item"><span class="sun-detail-label">Déli napállás:</span><span id="sun-info-noon" class="sun-detail-value">--:--</span></div><div class="sun-detail-item"><span class="sun-detail-label">Nap útja:</span><span id="sun-info-remaining" class="sun-detail-value">--</span></div></div></div>
            <div class="moon-info-section is-hidden" id="moon-info-section"><div class="moon-path-visual"><svg class="moon-path-svg" viewBox="0 0 150 85" preserveAspectRatio="none"><path class="moon-path-arc-bg" d="M 10 75 A 65 65 0 0 1 140 75"></path><path id="moon-path-arc-main" class="moon-path-arc-main" d="M 10 75 A 65 65 0 0 1 140 75"></path></svg><div class="moon-path-horizon"></div><div class="moon-path-now-marker" id="moon-path-now-marker"></div><i class="fas fa-moon" id="moon-path-icon"></i><div class="moon-path-label moonrise-label">Holdkelte<div id="moonrise-time-label" class="moon-path-time">--:--</div></div><div class="moon-path-label moonset-label">Holdnyugta<div id="moonset-time-label" class="moon-path-time">--:--</div></div></div><div class="moon-text-details"><div class="moon-detail-item"><span class="moon-detail-label">Hold magassága:</span><span id="moon-info-altitude" class="moon-detail-value">--°<span id="moon-info-trend" class="sun-trend-text"></span><i id="moon-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Pozíció frissítése"></i></span></div><div class="moon-detail-item"><span class="moon-detail-label">Fázis:</span><span id="moon-info-phasename" class="moon-detail-value">--</span></div><div class="moon-detail-item"><span class="moon-detail-label">Megvilágítás:</span><span id="moon-info-illumination" class="moon-detail-value">--%</span></div></div></div>
            <div class="rain-info-section is-hidden" id="rain-info-section"><div class="rain-visual"><div class="rain-visual-center"><i id="rain-visual-icon" class="fas fa-cloud-showers-heavy"></i><div id="rain-visual-total">--</div><div id="rain-visual-total-unit">mm</div><div class="rain-visual-label">esett ma</div></div><svg class="rain-gauge-svg" viewBox="0 0 100 100"><circle class="rain-gauge-bg" cx="50" cy="50" r="45"></circle><circle id="rain-gauge-value" class="rain-gauge-value" cx="50" cy="50" r="45"></circle></svg></div><div class="rain-text-details"><div class="rain-detail-item"><span class="rain-detail-label">Most esik:</span><span class="rain-detail-value" id="rain-currently-raining-value"></span></div><div class="rain-detail-item"><span class="rain-detail-label">Intenzitás:</span><span class="rain-detail-value" id="rain-intensity-value"></span></div><div class="rain-detail-item"><span class="rain-detail-label">Előrejelzett:</span><span class="rain-detail-value" id="rain-expected-today-value"></span></div><div class="rain-detail-item is-hidden" id="next-precip-item"><span class="rain-detail-label">Következő:</span><span class="rain-detail-value" id="next-precip-value"></span></div></div></div>
            <div class="temperature-section"><div class="temperature" id="temperature-container"><span id="temperature-value">--</span><span class="temperature-symbol">°C</span></div><div class="current-condition-phrase" id="current-condition-phrase-text"></div><div class="additional-core-info"><div class="additional-info-item is-hidden" id="main-heat-index-item"><span class="additional-info-label">Hőérzet:</span><span class="additional-info-value" id="main-heat-index-value"></span></div><div class="additional-info-item is-hidden" id="main-wind-info-item"><span class="additional-info-label">Szél:</span><span class="additional-info-value"><span id="main-wind-dir-text-value"></span><i class="fas fa-location-arrow" id="main-wind-arrow-icon"></i><span id="main-wind-speed-value"></span></span></div><div class="additional-info-item is-hidden" id="main-wind-gust-info-item"><span class="additional-info-label">Széllökés:</span><span class="additional-info-value" id="main-wind-gust-value"></span></div></div></div></div><div class="weather-details-grid"><div class="detail-item"><span class="label"><i class="fas fa-tint"></i>Harmatpont:</span><span class="value" id="dewpoint-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-percentage"></i>Páratartalom:</span><span class="value" id="humidity-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-ruler-combined"></i>Légnyomás:</span><span class="value"><span id="pressure-value"></span><span class="pressure-trend-icon" id="pressure-trend-icon"></span></span></div><div class="detail-item"><span class="label"><i class="fas fa-eye"></i>Látótávolság:</span><span class="value" id="visibility-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-sun"></i>Napsugárzás:</span><span class="value" id="solar-radiation-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-umbrella-beach"></i>UV Index:</span><span class="value"><span id="uv-index-value"></span><span class="uv-description-text" id="uv-description"></span></span></div><div class="detail-item"><span class="label"><i class="fas fa-sun"></i>Napkelte:</span><span class="value" id="details-sunrise-value"></span></div><div class="detail-item"><span class="label"><i class="fas fa-sun"></i>Napnyugta:</span><span class="value" id="details-sunset-value"></span></div><div class="detail-item" id="grid-moonrise-item"><span class="label"><i class="fas fa-moon"></i>Holdkelte:</span><span class="value" id="moonrise-value"></span></div><div class="detail-item" id="grid-moonset-item"><span class="label"><i class="fas fa-moon"></i>Holdnyugta:</span><span class="value" id="moonset-value"></span></div></div>`;
            addStationChangeListeners();
            isWeatherDisplayInitialized = true; 
        }
        
        function updateStationStatusUI(stationKey, status = 'unknown') {
            const stationConfig = STATIONS[stationKey];
            if (!stationConfig) return;

            const lowerCaseKey = stationKey.toLowerCase().replace(/_/g, '-');
            const textEl = document.getElementById(`${lowerCaseKey}-status-text`);
            const radioEl = document.getElementById(`station-select-${lowerCaseKey}`);
            const selectorContainerEl = document.getElementById(`${lowerCaseKey}-selector-container`);

            if (!textEl || !radioEl || !selectorContainerEl) return;

            if (status === 'online') {
                textEl.textContent = 'üzemel';
            } else if (status === 'offline') {
                textEl.textContent = 'nem üzemel';
            } else {
                textEl.textContent = 'állapot ?';
            }

            radioEl.checked = (stationKey === activeDisplayStationKey);
            radioEl.disabled = !stationConfig.isOnline;
            selectorContainerEl.classList.toggle('disabled', !stationConfig.isOnline);
        }

        function addStationChangeListeners() { document.querySelectorAll('input[name="station-select"]').forEach(radio => radio.addEventListener('change', handleStationChange)); }
        function handleStationChange(event) {
            const selectedStationKey = event.target.value; if (STATIONS[selectedStationKey].isOnline && selectedStationKey !== activeDisplayStationKey) { activeDisplayStationKey = selectedStationKey; compileAndRenderDisplayData(); } else if (!STATIONS[selectedStationKey].isOnline) { event.target.checked = false; document.querySelector(`input[value="${activeDisplayStationKey}"]`).checked = true; }
        }

        function compileAndRenderDisplayData() {
            const activeStationConfig = STATIONS[activeDisplayStationKey];
            const displayStationData = activeStationConfig.data;
            if (!displayStationData) return;

            cachedData.displayPws = { ...displayStationData.metric, ...displayStationData }; 
            
            let precipStationData = null;
            if(STATIONS.KOSSUTH.isOnline && STATIONS.KOSSUTH.provides.includes('precip')) {
                 precipStationData = STATIONS.KOSSUTH.data;
            } else if (STATIONS.NYIREGYHAZI_UT.isOnline && STATIONS.NYIREGYHAZI_UT.provides.includes('precip')) {
                precipStationData = STATIONS.NYIREGYHAZI_UT.data;
            } else if (activeStationConfig.provides.includes('precip')) {
                precipStationData = displayStationData;
            }

            cachedData.displayPws.precipTotal = precipStationData?.metric?.precipTotal;
            cachedData.displayPws.precipRate = precipStationData?.metric?.precipRate;

            renderWeatherData(); renderHourlyForecastData(); renderForecastData();
        }
        
        function updateAnimatedValue(element, newValue) {
            if (!element) return;
            if (element.textContent.trim() !== newValue.trim()) {
                if (!element.classList.contains('is-flipping')) {
                    element.classList.add('is-flipping');
                    setTimeout(() => {
                        element.textContent = newValue;
                        element.classList.remove('is-flipping');
                    }, 300);
                }
            }
        }
        
        function renderWeatherData() {
            const obs = cachedData.displayPws; 
            const general = cachedData.generalConditions; 
            const sunCalcData = cachedData.sunCalc;
            if (!obs || !general || !sunCalcData) return;

            const el = (id) => document.getElementById(id);
            
            if (obs.precipTotal > 0.1) {
                hasRainBeenDetectedToday = true;
            }

            el('location-and-station-text').textContent = `Nyíregyháza ${STATIONS[activeDisplayStationKey].name.replace("Nyíregyháza ", "")}`;
            updateAnimatedValue(el('timestamp-text'), `Megfigyelés: ${formatTime(obs.obsTimeLocal, true)}`);
            updateAnimatedValue(el('temperature-value'), formatValue(obs.temp, '', 1, '--'));
            el('temperature-container').style.setProperty('--current-temp-bg-color', getTemperatureColorVar(obs.temp));
            
            let currentPhrase = general.skyCoverPhrase || obs.wxPhraseShort || 'Nincs leírás';
            if (obs.precipRate > 0 && obs.wxPhraseShort) { currentPhrase = obs.wxPhraseShort; }
            el('current-condition-phrase-text').textContent = currentPhrase;
            
            const rainInfoSection = el('rain-info-section'); 
            const sunInfoSection = el('sun-info-section');
            const moonInfoSection = el('moon-info-section');
            const gridMoonriseItem = el('grid-moonrise-item'); 
            const gridMoonsetItem = el('grid-moonset-item');

            const isDayTime = sunCalcData.sunAltitude > -0.83;
            const isMoonUp = sunCalcData.isUp;

            let showRainPanel = false, showSunPanel = false, showMoonPanel = false;

            if (hasRainBeenDetectedToday) {
                showRainPanel = true;
            } else if (isDayTime) {
                showSunPanel = true;
            } else if (isMoonUp) {
                showMoonPanel = true;
            } else { 
                showRainPanel = true;
            }
            
            rainInfoSection.classList.toggle('is-hidden', !showRainPanel);
            sunInfoSection.classList.toggle('is-hidden', !showSunPanel);
            moonInfoSection.classList.toggle('is-hidden', !showMoonPanel);
            gridMoonriseItem.classList.toggle('is-hidden', showMoonPanel);
            gridMoonsetItem.classList.toggle('is-hidden', showMoonPanel);


            if (showSunPanel) {
                const sunriseDate = sunCalcData.sunriseDateForPath;
                const sunsetDate = sunCalcData.sunsetDateForPath;
                const sunPathElements = { iconEl: el('sun-path-icon'), mainArcEl: el('sun-path-arc-main'), nowMarkerEl: el('sun-path-now-marker') };
                updatePathVisuals(sunriseDate, sunsetDate, sunPathElements);
                
                el('sun-info-altitude').childNodes[0].nodeValue = formatValue(sunCalcData.sunAltitude, '°', 1) + ' ';
                el('sun-info-trend').textContent = `(${sunCalcData.sunTrend || sunCalcData.sunStatus})`;
                el('sun-info-noon').textContent = sunCalcData.solarNoon;
                el('sun-info-remaining').textContent = sunCalcData.remainingDaylight;
                
                const refreshBtn = el('sun-path-refresh-btn');
                refreshBtn.onclick = () => {
                    refreshBtn.classList.add('is-refreshing');
                    updatePathVisuals(sunriseDate, sunsetDate, sunPathElements);
                    setTimeout(() => refreshBtn.classList.remove('is-refreshing'), 800);
                };
            } 
            else if (showMoonPanel) {
                const moonPathElements = { iconEl: el('moon-path-icon'), mainArcEl: el('moon-path-arc-main'), nowMarkerEl: el('moon-path-now-marker') };
                updatePathVisuals(sunCalcData.moonRiseDateForPath, sunCalcData.moonSetDateForPath, moonPathElements);
                
                el('moonrise-time-label').textContent = formatTime(sunCalcData.moonRiseDateForPath);
                el('moonset-time-label').textContent = formatTime(sunCalcData.moonSetDateForPath);

                el('moon-info-altitude').childNodes[0].nodeValue = formatValue(sunCalcData.moonAltitude, '°', 1) + ' ';
                el('moon-info-trend').textContent = `(${sunCalcData.moonTrend || sunCalcData.moonStatus})`;
                el('moon-info-phasename').textContent = sunCalcData.phaseName || NO_DATA_STRING;
                el('moon-info-illumination').textContent = formatValue(sunCalcData.phaseValue, '%', 1);

                const refreshBtn = el('moon-path-refresh-btn');
                refreshBtn.onclick = () => {
                    refreshBtn.classList.add('is-refreshing');
                    updatePathVisuals(sunCalcData.moonRiseDateForPath, sunCalcData.moonSetDateForPath, moonPathElements);
                    setTimeout(() => refreshBtn.classList.remove('is-refreshing'), 800);
                };
            } 
            else if(showRainPanel) { 
                updatePrecipitationVisuals(obs.precipRate, obs.precipTotal, {
                    gaugeValueEl: el('rain-gauge-value'),
                    totalValueEl: el('rain-visual-total')
                });
                el('rain-currently-raining-value').textContent = obs.precipRate > 0 ? "Igen" : "Nem";
                el('rain-intensity-value').textContent = formatValue(obs.precipRate, ' mm/h', 2);
                el('rain-expected-today-value').textContent = formatValue(cachedData.expectedRainToday_gauge, ' mm', 1);
                
                const nextPrecipItem = el('next-precip-item'); 
                const nextPrecipValue = el('next-precip-value');
                const nextEvent = findNextPrecipitationEvent(cachedData.hourlyForecast);
                if (nextEvent && nextPrecipItem) { 
                    nextPrecipValue.textContent = `${nextEvent.type} ~${formatTime(nextEvent.time)} (${formatValue(nextEvent.chance, '%', 0)})`; 
                    nextPrecipItem.classList.remove('is-hidden'); 
                } else if (nextPrecipItem) { 
                    nextPrecipItem.classList.add('is-hidden'); 
                }
            }
            
            el('main-heat-index-item').classList.toggle('is-hidden', obs.heatIndex == null);
            updateAnimatedValue(el('main-heat-index-value'), formatValue(obs.heatIndex, '°C', 1));
            
            const hasWind = obs.winddir != null || obs.windSpeed >= 0;
            el('main-wind-info-item').classList.toggle('is-hidden', !hasWind);
            if (hasWind) { 
                el('main-wind-arrow-icon').style.transform = `rotate(${obs.winddir || 0}deg)`; 
                el('main-wind-dir-text-value').textContent = degreesToCompass(obs.winddir); 
                updateAnimatedValue(el('main-wind-speed-value'), formatValue(obs.windSpeed, ' km/h', 1));
            }
            el('main-wind-gust-info-item').classList.toggle('is-hidden', !(obs.windGust > 0));
            updateAnimatedValue(el('main-wind-gust-value'), formatValue(obs.windGust, ' km/h', 1));

            updateAnimatedValue(el('dewpoint-value'), formatValue(obs.dewpt, '°C')); 
            updateAnimatedValue(el('humidity-value'), formatValue(obs.humidity, '%', 0));
            updateAnimatedValue(el('pressure-value'), formatValue(general.pressureAltimeter || obs.pressure, ' hPa'));
            
            const trendCode = general.pressureTendencyCode; let trendSymbol = ''; if (trendCode === 0) trendSymbol = '↑'; else if (trendCode === 1) trendSymbol = '↓'; else if (trendCode === 2) trendSymbol = '→'; el('pressure-trend-icon').textContent = trendSymbol;
            
            updateAnimatedValue(el('visibility-value'), formatValue(general.visibility, ' km')); 
            updateAnimatedValue(el('solar-radiation-value'), formatValue(obs.solarRadiation, ' W/m²', 0));
            updateAnimatedValue(el('uv-index-value'), formatValue(obs.uv, '', 1)); 
            
            el('uv-description').textContent = general.uvDescription ? `(${general.uvDescription})` : '';
            el('details-sunrise-value').textContent = sunCalcData.sunrise; 
            el('details-sunset-value').textContent = sunCalcData.sunset;
            el('moonrise-value').textContent = sunCalcData.moonrise || '--'; 
            el('moonset-value').textContent = sunCalcData.moonset || '--';
        }

        function getTemperatureColorVar(temp) { if (temp === null) return 'var(--mild)'; if (temp >= 35) return 'var(--hot)'; if (temp >= 25) return 'var(--warm)'; if (temp >= 10) return 'var(--mild)'; if (temp >= 0) return 'var(--cool)'; return 'var(--cold)'; }
        
        function mapTwcIconToFontAwesome(iconCode, dayOrNight) {
            const isDay = dayOrNight === 'D'; const iconMap = { 32: 'fas fa-sun', 36: 'fas fa-sun', 31: 'fas fa-moon', 33: 'fas fa-moon', 34: isDay ? 'fas fa-sun' : 'fas fa-cloud-moon', 29: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 30: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 27: 'fas fa-cloud', 28: 'fas fa-cloud', 26: 'fas fa-cloud', 11: 'fas fa-cloud-showers-heavy', 12: 'fas fa-cloud-showers-heavy', 40: 'fas fa-cloud-showers-heavy', 39: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 45: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 3: 'fas fa-cloud-bolt', 4: 'fas fa-cloud-bolt', 37: 'fas fa-cloud-bolt', 38: 'fas fa-cloud-bolt', 47: 'fas fa-cloud-bolt', 5: 'fas fa-snowflake', 6: 'fas fa-snowflake', 7: 'fas fa-snowflake', 8: 'fas fa-snowflake', 10: 'fas fa-cloud-sleet', 18: 'fas fa-smog', 13: 'fas fa-snowflake', 14: 'fas fa-snowflake', 15: 'fas fa-snowflake', 16: 'fas fa-snowflake', 41: 'fas fa-snowflake', 42: 'fas fa-snowflake', 43: 'fas fa-snowflake', 46: 'fas fa-snowflake', 9: 'fas fa-cloud-rain', 19: 'fas fa-smog', 20: 'fas fa-smog', 21: 'fas fa-smog', 22: 'fas fa-smog', 23: 'fas fa-wind', 24: 'fas fa-wind' };
            return iconMap[iconCode] || 'fas fa-question-circle';
        }
        
        function mapIconCodeToHungarianText(iconCode, dayOrNight) {
            const isDay = dayOrNight === 'D';
            const textMap = {
                32: 'Napos', 36: 'Napos',
                31: 'Tiszta ég', 33: 'Tiszta ég',
                34: isDay ? 'Részben napos' : 'Részben felhős',
                29: isDay ? 'Részben napos' : 'Részben felhős',
                30: isDay ? 'Részben napos' : 'Részben felhős',
                27: 'Felhős', 28: 'Felhős',
                26: 'Borult',
                11: 'Zápor', 12: 'Zápor', 40: 'Zápor',
                39: isDay ? 'Zápor' : 'Éjjeli zápor',
                45: isDay ? 'Zápor' : 'Éjjeli zápor',
                3: 'Zivatar', 4: 'Zivatar', 37: 'Zivatar', 38: 'Zivatar', 47: 'Zivatar',
                5: 'Havas eső', 6: 'Ónos eső', 7: 'Havas eső', 8: 'Ónos eső', 10: 'Ónos eső', 18: 'Havas eső',
                13: 'Hózápor', 14: 'Hózápor', 15: 'Hófúvás', 16: 'Havazás',
                41: 'Havazás', 42: 'Havazás', 43: 'Hófúvás', 46: 'Hózápor',
                9: 'Eső',
                19: 'Párás', 20: 'Ködös', 21: 'Párás', 22: 'Füstös',
                23: 'Szeles', 24: 'Szeles'
            };
            return textMap[iconCode] || 'Ismeretlen';
        }

        function renderHourlyForecastData() {
            const hourlyData = cachedData.hourlyForecast;
            if (!hourlyData || hourlyData.length === 0) {
                hourlyForecastContainerEl.classList.add('is-hidden');
                hourlyForecastTitleEl.classList.add('is-hidden');
                return;
            }
            
            let forecastHTML = '';
            hourlyData.forEach(hour => {
                let conditionText = hour.wxPhraseShort || mapIconCodeToHungarianText(hour.iconCode, hour.dayOrNight);

                forecastHTML += `
                <div class="hourly-forecast-card">
                    <div class="hourly-primary-info">
                        <div class="hourly-time">${formatTime(hour.time)}</div>
                        <div class="hourly-icon-and-condition">
                            <i class="hourly-icon ${mapTwcIconToFontAwesome(hour.iconCode, hour.dayOrNight)}"></i>
                            <div class="hourly-condition-text">${conditionText}</div>
                        </div>
                        <div class="hourly-temp">${formatValue(hour.temp, '°', 0, '--')}</div>
                    </div>
                    <div class="hourly-secondary-details">
                        <div class="hourly-detail-row">
                            <i class="fas fa-tint"></i>
                            <span>Csapadék: ${formatValue(hour.precipChance, '%', 0, '--')}</span>
                        </div>
                        <div class="hourly-detail-row">
                            <i class="fas fa-wind"></i>
                            <span>Szél: ${degreesToCompassAbbreviated(hour.windDirection)} ${formatValue(hour.windSpeed, ' km/h', 0)}</span>
                        </div>
                        <div class="hourly-detail-row">
                            <i class="fas fa-hand-holding-water"></i>
                            <span>Pára: ${formatValue(hour.humidity, '%', 0)}</span>
                            <span class="detail-separator"></span>
                            <i class="fas fa-sun"></i>
                            <span>UV: ${formatValue(hour.uvIndex, '', 0, '0')}</span>
                        </div>
                    </div>
                </div>`;
            });

            hourlyForecastContainerEl.innerHTML = forecastHTML;
            hourlyForecastContainerEl.classList.remove('is-hidden');
            hourlyForecastTitleEl.classList.remove('is-hidden');
        }

        function formatForecastDate(isoDateString) { if (!isoDateString) return ''; try { const date = new Date(isoDateString); return `${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`; } catch (e) { return ''; } }
        
        function renderForecastData() {
            const forecastDays = cachedData.forecastDays;
            if (!forecastDays || forecastDays.length === 0) { forecastContainerEl.classList.add('is-hidden'); forecastTitleEl.classList.add('is-hidden'); return; }
            let forecastHTML = '';
            forecastDays.forEach(day => {
                if (!day.dayName || day.tempMax == null || day.tempMin == null) return;
                forecastHTML += `<div class="forecast-day-card">
                    <div class="forecast-header"><div class="forecast-day-name">${day.dayName}</div><div class="forecast-date">${formatForecastDate(day.date)}</div></div>
                    <div class="forecast-temps">
                        <span class="forecast-temp-max">${formatValue(day.tempMax, '°', 0, '--')}</span>
                        <span class="forecast-temp-min">${formatValue(day.tempMin, '°', 0, '--')}</span>
                    </div>`;
                if (day.dayPart) { 
                    forecastHTML += `<div class="forecast-part">
                        <div class="forecast-part-header"><i class="fas fa-sun"></i>Nappal</div>
                        <div class="forecast-part-details">
                            <p>${day.dayPart.phrase || NO_DATA_STRING}</p>
                            <p>Csapadék: ${formatValue(day.dayPart.precipChance, '%', 0)}</p>
                            <p>Szél: ${degreesToCompass(day.dayPart.windDir)} ${formatValue(day.dayPart.windSpeed, ' km/h', 0)}</p>
                            <p>UV Index: ${formatValue(day.dayPart.uvIndex, '', 0)} (${day.dayPart.uvDescription || 'N/A'})</p>
                        </div>
                    </div>`; 
                }
                if (day.nightPart) { 
                    forecastHTML += `<div class="forecast-part">
                        <div class="forecast-part-header"><i class="fas fa-moon"></i>Éjjel</div>
                        <div class="forecast-part-details">
                            <p>${day.nightPart.phrase || NO_DATA_STRING}</p>
                            <p>Csapadék: ${formatValue(day.nightPart.precipChance, '%', 0)}</p>
                            <p>Szél: ${degreesToCompass(day.nightPart.windDir)} ${formatValue(day.nightPart.windSpeed, ' km/h', 0)}</p>
                        </div>
                    </div>`; 
                }
                forecastHTML += `</div>`;
            });
            if (forecastHTML.trim() === '') { forecastContainerEl.classList.add('is-hidden'); forecastTitleEl.classList.add('is-hidden'); } 
            else { forecastContainerEl.innerHTML = forecastHTML; forecastContainerEl.classList.remove('is-hidden'); forecastTitleEl.classList.remove('is-hidden'); }
        }

        async function fetchAllDataAndUpdateDisplay(isInitialLoad = false) {
            const now = Date.now();
            await Promise.all(Object.keys(STATIONS).map(key => fetchPwsStationData(key).catch(e => null)));
            if (!STATIONS[activeDisplayStationKey].isOnline) {
                const onlineStations = Object.keys(STATIONS).filter(k => STATIONS[k].isOnline);
                if(onlineStations.length > 0) {
                    activeDisplayStationKey = onlineStations[0];
                }
            }

            const independentPromises = [];

            if (isInitialLoad || now - lastApiCallTimes.generalConditions > REFRESH_INTERVAL_GENERAL_CONDITIONS) { 
                independentPromises.push(fetchGeneralConditionsData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) Object.assign(cachedData.generalConditions, data); }).catch(e => console.warn(e))); 
            }
            if (isInitialLoad || now - lastApiCallTimes.openMeteoRain > REFRESH_INTERVAL_OPEN_METEO_RAIN) { 
                independentPromises.push(fetchOpenMeteoExpectedRain_gauge(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { cachedData.expectedRainToday_gauge = data; }).catch(e => console.warn(e))); 
            }
            if (isInitialLoad || now - lastApiCallTimes.forecast > REFRESH_INTERVAL_FORECAST) { 
                independentPromises.push(fetchDailyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) { 
                    cachedData.forecastDays = data.forecastDays; 
                    Object.assign(cachedData.generalConditions, { 
                        sunriseTimeLocal: data.sunriseTimeLocal, 
                        sunsetTimeLocal: data.sunsetTimeLocal,
                    }); 
                } }).catch(e => console.warn(e))); 
            }
            if (isInitialLoad) {
                 independentPromises.push(fetchHourlyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) cachedData.hourlyForecast = data; }).catch(e => console.warn(e)));
            }

            await Promise.all(independentPromises);

            try {
                const sunCalcResult = await fetchAdvancedSunCalcData(
                    NYIREGYHAZA_COORDS.lat, 
                    NYIREGYHAZA_COORDS.lon
                );
                cachedData.sunCalc = sunCalcResult;
                
                if (sunCalcResult.sunriseDateForPath) {
                    cachedData.generalConditions.sunriseTimeLocal = sunCalcResult.sunriseDateForPath.toISOString();
                }
                if (sunCalcResult.sunsetDateForPath) {
                    cachedData.generalConditions.sunsetTimeLocal = sunCalcResult.sunsetDateForPath.toISOString();
                }
            } catch (e) {
                console.error("SunCalc hiba:", e);
            }

            updateThemeAndSky(new Date(), cachedData.generalConditions.sunriseTimeLocal, cachedData.generalConditions.sunsetTimeLocal);
            const anyStationOnline = Object.values(STATIONS).some(s => s.isOnline);
            if (anyStationOnline) { 
                compileAndRenderDisplayData(); 
            } else if (!isWeatherDisplayInitialized) { 
                document.getElementById('weather-display').innerHTML = `<div class="loading">⚠️ Egyik mérőállomás sem elérhető.</div>`; 
            }
        }

        async function fetchAndRefreshWindData() {
            const stationKey = activeDisplayStationKey;
            if (!STATIONS[stationKey] || !STATIONS[stationKey].isOnline) return;

            try {
                await fetchPwsStationData(stationKey);
                const newPwsData = STATIONS[stationKey].data;

                if (newPwsData && cachedData.displayPws) {
                    cachedData.displayPws.winddir = newPwsData.winddir;
                    cachedData.displayPws.windSpeed = newPwsData.metric.windSpeed;
                    cachedData.displayPws.windGust = newPwsData.metric.windGust;
                    cachedData.displayPws.obsTimeLocal = newPwsData.obsTimeLocal; 

                    renderWeatherData();
                }
            } catch (error) {
                console.warn(`Gyorsított szél-adat lekérés sikertelen: ${error.message}`);
            }
        }

        function scheduleHourlyForecastUpdate() {
            const now = new Date();
            const currentMinutes = now.getMinutes();
            const currentSeconds = now.getSeconds();

            let targetMinute;
            if (currentMinutes < 20) {
                targetMinute = 20;
            } else if (currentMinutes < 40) {
                targetMinute = 40;
            } else {
                targetMinute = 60; 
            }

            const minutesToWait = targetMinute - currentMinutes - 1;
            const secondsToWait = 60 - currentSeconds;
            const delayInMs = (minutesToWait * 60 + secondsToWait) * 1000;

            setTimeout(async () => {
                console.log(`Időzített órás előrejelzés frissítése: ${new Date().toLocaleTimeString()}`);
                try {
                    const data = await fetchHourlyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
                    if (data) {
                        cachedData.hourlyForecast = data;
                        renderHourlyForecastData();
                    }
                } catch (e) {
                    console.warn("Az időzített órás előrejelzés frissítése sikertelen:", e);
                }
                
                scheduleHourlyForecastUpdate();
            }, delayInMs > 0 ? delayInMs : 20 * 60 * 1000); 
        }

        function initApp() {
            weatherDisplayEl = document.getElementById('weather-display');
            forecastContainerEl = document.getElementById('forecast-container');
            forecastTitleEl = document.getElementById('forecast-title');
            hourlyForecastContainerEl = document.getElementById('hourly-forecast-container');
            hourlyForecastTitleEl = document.getElementById('hourly-forecast-title');
            
            initializeWeatherDisplayDOM();
            
            fetchAllDataAndUpdateDisplay(true).finally(() => {
                
                const SAFETY_DELAY = 16000;
                
                console.log(`Protopage biztonsági késleltetés: várakozás ${SAFETY_DELAY / 1000} másodpercet a folyamatos frissítések indítása előtt.`);

                setTimeout(() => {
                    console.log("A biztonsági késleltetés lejárt. Az időzített frissítések elindulnak.");
                    
                    scheduleHourlyForecastUpdate();
                    
                    setInterval(() => fetchAllDataAndUpdateDisplay(false), REFRESH_INTERVAL_PWS);
                    
                    setInterval(fetchAndRefreshWindData, REFRESH_INTERVAL_WIND);
                    
                    setInterval(() => {
                        if (cachedData.generalConditions.sunriseTimeLocal && cachedData.generalConditions.sunsetTimeLocal) {
                            updateThemeAndSky(new Date(), cachedData.generalConditions.sunriseTimeLocal, cachedData.generalConditions.sunsetTimeLocal)
                        }
                    }, SKY_COLOR_UPDATE_INTERVAL);

                    // Időzítő az éjféli visszaállításhoz
                    setInterval(() => {
                        const newDay = new Date().getDate();
                        if (newDay !== currentDay) {
                            console.log("Éjfél, a nap újraindult! A csapadékjelző visszaállítva.");
                            currentDay = newDay;
                            hasRainBeenDetectedToday = false;
                            if (cachedData.displayPws) {
                                renderWeatherData();
                            }
                        }
                    }, 30000);

                }, SAFETY_DELAY);
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
