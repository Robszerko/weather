<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Időjárás Monitor - Nyíregyháza</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <style>
        :root {
            --bg-widget-night: rgba(15, 23, 42, 0.7);
            --border-widget-night: rgba(56, 189, 248, 0.25);
            --bg-widget-day: linear-gradient(160deg, rgba(240, 248, 255, 0.7) 0%, rgba(225, 238, 252, 0.65) 100%);
            --border-widget-day: rgba(0, 122, 255, 0.2);
            --accent-interactive-night: #00BFFF;
            --text-primary-night: #EAEAEA;
            --text-secondary-night: #BCCCDC;
            --accent-interactive-day: #007AFF;
            --text-primary-day: #111827;
            --text-secondary-day: #374151;
            --cloud-base-color: #f5f5f5;
            --cloud-shadow-color: #d8d8d8;
            --hot: #EF4444; --warm: #F97316; --mild: #22C55E; --cool: #3B82F6; --cold: #6366F1;
            --current-temp-bg-color: var(--mild);
            --wind-calm: #93C5FD; --wind-light: #3B82F6; --wind-moderate: #22C55E; --wind-strong: #F97316;
            --current-wind-color: var(--wind-calm);
            --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: var(--accent-interactive-night); --current-widget-bg: var(--bg-widget-night); --current-widget-border: var(--border-widget-night); --current-container-border-color: var(--border-widget-night);
        }
        
        #sky-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; 
            background: linear-gradient(to bottom, #0B1120, #020617); 
            transition: background 1s ease-out; 
        }
        #sky-glow {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,224,0.1) 0%, transparent 40%);
            opacity: 0;
            transition: opacity 1.5s ease;
        }
        #stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; opacity: 0; z-index: 2; transition: opacity 3s ease-in-out; }
        .star { position: absolute; background-color: white; border-radius: 50%; }
        
        #haze-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 30%; z-index: 4; background: linear-gradient(to top, rgba(180, 190, 200, 0.2), transparent); opacity: 0; transition: opacity 2s ease-in-out; pointer-events: none; }

        #clouds-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; opacity: 0; transition: opacity 3s ease-in-out; pointer-events: none; }
        
        .cloud-group { position: absolute; will-change: transform; filter: none; transition: filter 0.5s ease-out; }
        .cloud-group .puff { position: absolute; width: 1px; height: 1px; background-color: transparent; border-radius: 50%; transition: box-shadow 1s linear; }

        #precipitation-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 20; pointer-events: none; opacity: 0; transition: opacity 1s ease; }
        
        .raindrop { position: absolute; width: 1.5px; height: 12px; background-color: rgba(200,210,225,0.6); transform: rotate(15deg); }
        .snowflake { position: absolute; color: rgba(220, 230, 240, 0.8); font-size: 1.2em; }
        
        #lightning-flash { position: absolute; top:0; left: 0; width: 100%; height: 100%; z-index: 100; background-color: #ffffff; opacity: 0; pointer-events: none; }
        .flash { animation: flash-anim 0.4s ease-out; }
        @keyframes flash-anim { 0%, 100% { opacity: 0; } 50% { opacity: 0.3; } }

        .is-hidden { display: none !important; }
        body { font-family: 'Inter', sans-serif; font-weight: 500; background-color: #020617; min-height: 100vh; margin: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; text-align: center; padding: 5vh 20px; box-sizing: border-box; position: relative; overflow-x: hidden; }
        .weather-widget { border-radius: 18px; padding: 22px 24px; width: 100%; max-width: 800px; box-sizing: border-box; margin: 0 auto; position: relative; z-index: 30; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 5px 18px rgba(0,0,0,0.12), 0 2px 7px rgba(0,0,0,0.18); backdrop-filter: blur(20px) saturate(120%); -webkit-backdrop-filter: blur(20px) saturate(120%); transition: all 0.6s ease-in-out; }
        #weather-display { position: relative; z-index: 1; display: flex; flex-direction: column; }
        .widget-header { text-align: center; margin-bottom: 10px; padding-bottom: 12px; }
        .header-container { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .location-title { font-size: 22px; font-weight: 800; color: var(--current-text-color); line-height: 1.1; letter-spacing: -0.5px; }
        .timestamp-container { display: flex; flex-direction: column; align-items: center; gap: 4px; margin-top: 10px;}
        .timestamp { font-size: 12.5px; font-weight: 500; color: var(--current-text-muted-color); transition: color 0.6s; }
        .attribution-line { font-size: 11px; color: var(--current-text-muted-color); opacity: 0.8; line-height: 1.4; }
        .station-status-container { display: flex; justify-content: center; align-items: center; gap: 6px; background-color: rgba(0,0,0,0.2); border-radius: 10px; padding: 5px; margin: 10px auto 0 auto; max-width: max-content; flex-wrap: wrap;}
        .station-selector { display: flex; align-items: center; }
        .station-selector input[type="radio"] { display: none; }
        .station-selector label { cursor: pointer; padding: 6px 14px; border-radius: 8px; transition: all 0.3s; font-size: 12px; font-weight: 600; color: var(--current-text-muted-color); display: flex; align-items: center; gap: 6px; }
        .station-selector input[type="radio"]:checked + label { background-color: var(--current-icon-color); color: #fff; box-shadow: 0 2px 8px -2px var(--current-icon-color); }
        .station-selector.disabled label { opacity: 0.4; cursor: not-allowed; }
        .station-status-indicator { width: 8px; height: 8px; border-radius: 50%; transition: background-color: 0.5s; }
        .station-status-indicator.online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .station-status-indicator.offline { background-color: #ef4444; }

        .current-conditions-card { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; background-color: rgba(0,0,0,0.1); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 16px; margin: 20px 0 16px 0; }
        .conditions-section { display: flex; flex-direction: column; }
        .conditions-section:first-child { border-right: 1px solid var(--current-container-border-color); padding-right: 16px; }
        .section-title { font-size: 13px; font-weight: 700; color: var(--current-text-color); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; }
        .temp-primary-display { text-align: center; margin-bottom: 12px; }
        .current-temp-value { font-size: 52px; font-weight: 800; line-height: 1; color: var(--current-text-color); }
        .current-temp-value span:last-child { font-weight: 600; font-size: 0.5em; vertical-align: super; }
        .temp-secondary-info { display: flex; justify-content: center; gap: 12px; font-size: 12px; font-weight: 500; color: var(--current-text-muted-color); }

        /* --- ÚJ HŐMÉRSÉKLET ELŐREJELZŐ GRAFIKON --- */
        .temp-forecast-visualizer { margin-top: 15px; }
        .temp-forecast-visualizer .section-header { justify-content: center; align-items: center; gap: 8px; margin-bottom: 8px; }
        .temp-forecast-visualizer .section-header h4 { margin: 0; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--current-text-muted-color); }
        .temp-chart { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; height: 60px; }
        .chart-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 4px; }
        .chart-temp-label { font-size: 12px; font-weight: 700; color: var(--current-text-color); }
        .chart-bar-wrapper { width: 16px; height: 100%; background-color: rgba(0,0,0,0.2); border-radius: 4px; display: flex; align-items: flex-end; overflow: hidden; }
        .chart-bar-fill { width: 100%; background-color: var(--mild); border-top-left-radius: 3px; border-top-right-radius: 3px; transition: height 0.6s ease-out, background-color 0.6s ease-out; }
        .chart-hour-label { font-size: 11px; font-weight: 600; color: var(--current-text-color); }
        .info-tooltip-container { position: relative; display: inline-flex; align-items: center; justify-content: center; }
        .info-tooltip-trigger { font-size: 11px; font-weight: 600; color: var(--current-icon-color); border: 1px solid var(--current-icon-color); border-radius: 50%; width: 14px; height: 14px; display: flex; justify-content: center; align-items: center; cursor: help; }
        .info-tooltip-content { visibility: hidden; opacity: 0; width: 220px; background-color: var(--bg-widget-night); color: var(--text-primary-night); text-align: left; padding: 10px; border-radius: 8px; border: 1px solid var(--border-widget-night); position: absolute; z-index: 100; bottom: 150%; left: 50%; transform: translateX(-50%); transition: opacity 0.3s, visibility 0.3s; pointer-events: none; font-size: 11px; line-height: 1.5; }
        .info-tooltip-container:hover .info-tooltip-content { visibility: visible; opacity: 1; }
        
        .wind-display-flex-container { display: flex; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap; }
        .wind-gauge-container { flex-shrink: 0; }
        .wind-gauge { margin: 0 auto; position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; border: 1px solid var(--current-container-border-color); border-radius: 50%; }
        .wind-data-center { z-index: 2; width: 110px; height: 110px; background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .wind-speed-main { display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1; color: var(--current-wind-color); font-weight: 800; font-size: 38px; }
        .wind-speed-unit { font-size: 14px; font-weight: 500; color: var(--current-text-muted-color); margin-top: 2px; }
        .wind-details-container { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; text-align: left; flex-grow: 1; max-width: 170px; }
        .wind-direction-info { display: flex; align-items: center; gap: 8px; }
        .wind-direction-arrow { font-size: 20px; color: var(--current-wind-color); transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .wind-direction-full { font-size: 14px; font-weight: 600; text-transform: capitalize; color: var(--current-text-color); }
        .wind-detail-item { font-size: 12px; color: var(--current-text-muted-color); font-weight: 500; width: 100%; display: flex; justify-content: space-between; }
        .wind-detail-item strong { color: var(--current-text-color); font-weight: 700; }
        #wind-gust-span { margin-right: 2px; }
        .wind-legend-container { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 16px; padding: 6px; background-color: rgba(0,0,0,0.15); border-radius: 8px; width: 100%; box-sizing: border-box; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 600; color: var(--current-text-muted-color); }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; }

        .pws-details-container { background-color: rgba(0,0,0,0.08); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 12px 14px; margin-bottom: 20px; }
        .pws-details-grid { display: grid; grid-template-columns: 1fr 1fr; column-gap: 12px; row-gap: 4px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 2px 0; }
        .detail-item .label { font-weight: 600; color: var(--current-text-muted-color); display: flex; align-items: center; white-space: nowrap; }
        .detail-item .label i { margin-right: 6px; width: 12px; font-size: 0.9em; text-align: center; opacity: 0.8; color: var(--current-icon-color); }
        .detail-item .value { font-weight: 700; font-size: 12px; color: var(--current-text-color); display: flex; align-items: center; }
        .pressure-trend-icon { margin-left: 4px; }
        
        .precipitation-forecast-section { background-color: rgba(0,0,0,0.08); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 12px 14px; margin-bottom: 20px; }
        .precip-forecast-list { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .precip-forecast-item { display: grid; grid-template-columns: 45px 1fr 70px; align-items: center; gap: 12px; }
        .forecast-time { font-size: 13px; font-weight: 700; color: var(--current-text-color); text-align: left; }
        .forecast-bar-container { position: relative; height: 8px; background-color: rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; }
        .forecast-bar-fill { height: 100%; background-color: var(--current-icon-color); border-radius: 4px; transition: width 0.6s ease-out, opacity 0.6s ease-out; }
        .forecast-details { display: flex; flex-direction: column; align-items: flex-end; text-align: right; }
        .forecast-chance { font-size: 12px; font-weight: 700; color: var(--current-text-color); }
        .forecast-amount { font-size: 10.5px; font-weight: 600; color: var(--current-text-muted-color); }

        .precip-summary-card { display: flex; flex-direction: column; gap: 0; background: linear-gradient(170deg, rgba(0,0,0,0.1), rgba(0,0,0,0.18)); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 0; margin-bottom: 20px; transition: all 0.5s ease; overflow: hidden; }
        .precip-card-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 16px; border-bottom: 1px solid rgba(from var(--current-container-border-color) r g b / 0.4); background-color: rgba(0,0,0,0.1); }
        .precip-header-title-group { display: flex; align-items: center; gap: 12px; }
        .precip-header-icon i { font-size: 22px; color: var(--current-icon-color); transition: color 0.5s ease; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .precip-header-title { font-size: 16px; font-weight: 800; color: var(--current-text-color); margin: 0; letter-spacing: 0.5px; }
        .precip-card-content { padding: 12px 16px; width: 100%; box-sizing: border-box; }
        .precip-station-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .precip-station-card { background-color: rgba(0,0,0,0.15); border: 1px solid var(--current-container-border-color); border-radius: 10px; padding: 8px; display: flex; flex-direction: column; gap: 6px; transition: all 0.4s ease; }
        .precip-station-card.is-raining-now { border-color: rgba(from var(--current-icon-color) r g b / 0.6); box-shadow: 0 0 12px -3px rgba(from var(--current-icon-color) r g b / 0.4); }
        .station-card-header { display: flex; justify-content: space-between; align-items: center; }
        .station-card-name { font-weight: 700; font-size: 13px; color: var(--current-text-color); }
        .station-card-status-icon { width: 8px; height: 8px; border-radius: 50%; background-color: var(--current-icon-color); box-shadow: 0 0 8px var(--current-icon-color); }
        .station-card-main { text-align: center; }
        .station-card-total-label { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); }
        .station-card-total-value { font-size: 24px; font-weight: 800; color: var(--current-text-color); line-height: 1.1; }
        .station-card-total-value span { font-size: 0.6em; font-weight: 600; color: var(--current-text-muted-color); margin-left: 2px; }
        .station-card-footer-info { font-size: 11px; text-align: center; font-weight: 600; color: var(--current-text-muted-color); border-top: 1px solid var(--current-container-border-color); padding-top: 5px; min-height: 14px; }
        .station-card-footer-info.live-intensity { color: var(--current-text-color); font-style: italic; }
        .precip-explanation-container { display: flex; flex-direction: column; align-items: flex-start; text-align: left; gap: 10px; padding: 12px 4px; }
        .explanation-title { font-size: 15px; font-weight: 700; color: var(--current-text-color); margin: 0; width: 100%; text-align: center; padding-bottom: 8px; border-bottom: 1px solid rgba(from var(--current-container-border-color) r g b / 0.3); }
        .explanation-subtitle { font-size: 13px; font-weight: 600; color: var(--current-text-color); margin: 5px 0 -5px 0; }
        .explanation-text { font-size: 12.5px; line-height: 1.6; color: var(--current-text-muted-color); margin: 0; }
        .explanation-text strong { color: var(--current-text-color); font-weight: 600; }
        .precip-card-footer { padding: 8px 16px 12px 16px; border-top: 1px solid rgba(from var(--current-container-border-color) r g b / 0.3); text-align: center; }
        .station-tooltip-container { position: relative; display: inline-block; }
        .station-list-trigger { font-size: 12px; font-weight: 600; color: var(--current-icon-color); border-bottom: 1px dashed var(--current-icon-color); cursor: help; padding: 4px; }
        .station-tooltip-content { visibility: hidden; opacity: 0; width: 280px; background-color: var(--bg-widget-night); color: var(--text-primary-night); padding: 10px; border-radius: 8px; border: 1px solid var(--border-widget-night); position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%); transition: opacity 0.3s, visibility 0.3s; pointer-events: none; font-size: 12px; line-height: 1.5; }
        .station-tooltip-container:hover .station-tooltip-content { visibility: visible; opacity: 1; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-timestamp { font-size: 11px; font-weight: 500; color: var(--current-text-muted-color); }
        
        .flippable-value { display: inline-block; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; }
        .flippable-value.is-flipping { transform: rotateX(90deg) scale(0.5); }
        
        .forecast-title { width: 100%; max-width: 800px; font-size: 16px; font-weight: 700; color: var(--current-text-color); margin-top: 24px; margin-bottom: 12px; text-align: center; transition: color 0.6s; display: flex; justify-content: space-between; align-items: center; }
        .hourly-forecast-container { width: 100%; max-width: 800px; display: grid; grid-template-columns: 1fr; gap: 8px; padding: 4px; box-sizing: border-box; margin: 0 auto; }
        
        .hourly-forecast-card { display: flex; flex-direction: column; align-items: stretch; gap: 6px; padding: 8px; border-radius: 12px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--current-text-color); transition: all 0.6s; }
        .hourly-primary-info { display: flex; flex-direction: row; align-items: center; justify-content: space-around; gap: 6px; }
        .hourly-time { font-size: 12px; font-weight: 700; flex-shrink: 0; }
        .hourly-icon-and-condition { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .hourly-icon { font-size: 20px; color: var(--current-icon-color); }
        .hourly-condition-text { font-size: 9.5px; font-weight: 500; color: var(--current-text-muted-color); white-space: nowrap; text-align: center; }
        .hourly-temp { font-size: 16px; font-weight: 700; flex-shrink: 0; }
        .hourly-secondary-details { display: flex; flex-direction: column; align-items: stretch; gap: 3px; font-size: 10px; border-top: 1px solid var(--current-container-border-color); padding-top: 5px; margin-top: 3px; }
        .hourly-detail-row { display: flex; justify-content: space-between; align-items: center; }
        .hourly-detail-row span { display: flex; align-items: center; gap: 5px; }
        .hourly-detail-row i { width: 12px; text-align: center; opacity: 0.7; }
        
        @media (min-width: 420px) { .hourly-forecast-container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 640px) { 
            .hourly-forecast-container { grid-template-columns: repeat(3, 1fr); } 
            .pws-details-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (min-width: 768px) {
            .precip-station-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }
        @media (min-width: 1000px) { .hourly-forecast-container { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 768px) { .current-conditions-card { grid-template-columns: 1fr; gap: 0; } .conditions-section:first-child { border-right: none; padding-right: 0; padding-bottom: 16px; border-bottom: 1px solid var(--current-container-border-color); } }
        
        @media (max-width: 480px) { 
            .current-temp-value { font-size: 48px; }
            .wind-display-flex-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="sky-container">
        <div id="sky-glow"></div>
        <div id="stars-container"></div>
        <div id="haze-container"></div>
        <div id="clouds-container"></div>
        <div id="precipitation-container"></div>
        <div id="lightning-flash"></div>
    </div>
    <div class="weather-widget">
        <div id="weather-display"></div>
    </div>
    <h3 class="forecast-title is-hidden" id="hourly-forecast-title">
        <span>A következő órákban várható időjárás</span>
        <span class="section-timestamp" id="hourly-forecast-timestamp"></span>
    </h3>
    <div class="hourly-forecast-container" id="hourly-forecast-container"></div>
    <script>
        // --- Globális változók és konstansok ---
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
        const REFRESH_INTERVAL_PWS = 30 * 1000;
        const REFRESH_INTERVAL_GENERAL_CONDITIONS = 20 * 60 * 1000;
        const REFRESH_INTERVAL_FORECAST = 5 * 60 * 1000;
        const NYIREGYHAZA_COORDS = { lat: 47.9550, lon: 21.7160 };
        const STATIONS = { NYIREGYHAZI_UT: { id: 'INYREG26', name: 'Nyíregyházi út', displayName: 'Nyíregyházi út', provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, KOSSUTH: { id: 'INYREG42', name: 'Nyíregyháza Kossuth út 50', displayName: 'Kossuth út 50', displayNameShort: 'Kossuth út', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure', 'precip'], isOnline: false, data: null, lastRainTimestamp: null }, KERT_UTCA: { id: 'INYREG37', name: 'Nyíregyháza Kert utca', displayName: 'Kert u.', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, SOSTOHEGY: { id: 'INYREG20', name: 'Sóstóhegy (Állatpark)', displayName: 'Sóstóhegy', displayNameShort: 'Sóstóhegy', provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, BORBANYA: { id: 'INYREG30', name: 'Borbánya', displayName: 'Borbánya', displayNameShort: 'Borbánya', provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, OROS_DERUS: { id: 'INYREG35', name: 'Oros Derűs utca', displayName: 'Oros', displayNameShort: 'Oros', provides: ['temp', 'precip', 'wind', 'humidity', 'pressure'], isOnline: false, data: null, lastRainTimestamp: null }, KEMECSE: { id: 'IKEMEC1', name: 'Kemecse', displayName: 'Kemecse', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, NAGYHALASZ: { id: 'INAGYH4', name: 'Nagyhalász', displayName: 'Nagyhalász', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, RAMOCSAHAZA: { id: 'IRAMOC1', name: 'Ramocsaháza', displayName: 'Ramocsaháza', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, SENYO: { id: 'ISNY1', name: 'Sényő', displayName: 'Sényő', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, SZAKOLY: { id: 'ISZAKO1', name: 'Szakoly', displayName: 'Szakoly', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, NYIRADONY: { id: 'INYRAD1', name: 'Nyíradony', displayName: 'Nyíradony', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, NYIRBOGAT: { id: 'INYRBO3', name: 'Nyírbogát', displayName: 'Nyírbogát', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, NAPKOR: { id: 'INAPKO1', name: 'Napkor', displayName: 'Napkor', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, GAVAVENCSELLO: { id: 'IGVAVE1', name: 'Gávavencsellő', displayName: 'Gávavencsellő', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, PATROHA: { id: 'IPTROH1', name: 'Pátroha', displayName: 'Pátroha', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, AJAK: { id: 'IAJAK4', name: 'Ajak', displayName: 'Ajak', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, KISVARDA: { id: 'IKISVR2', name: 'Kisvárda', displayName: 'Kisvárda', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, VASAROSNAMENY: { id: 'IVSROS2', name: 'Vásárosnamény', displayName: 'Vásárosnamény', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, FEHERGYARMAT: { id: 'IFEHRG1', name: 'Fehérgyarmat', displayName: 'Fehérgyarmat', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, PORCSALMA: { id: 'IPORCS2', name: 'Porcsalma', displayName: 'Porcsalma', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, CSENGER: { id: 'ICSENG10', name: 'Csenger', displayName: 'Csenger', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, MATESZALKA: { id: 'IMTSZALK4', name: 'Mátészalka', displayName: 'Mátészalka', provides: ['precip'], isOnline: false, data: null, lastRainTimestamp: null }, };
        let activeDisplayStationKey = 'NYIREGYHAZI_UT';
        let lastApiCallTimes = { generalConditions: 0, forecast: 0, forecastSuccess: 0 };
        let cachedData = { displayPws: null, generalConditions: {}, hourlyForecast: [], sunCalc: null, sunTimes: null, dailyForecastMetrics: null };
        let isWeatherDisplayInitialized = false;
        let weatherDisplayEl, hourlyForecastContainerEl, hourlyForecastTitleEl;
        let skyContainerEl, skyGlowEl, starsContainerEl, cloudsContainerEl, precipitationContainerEl, hazeContainerEl, lightningFlashEl;
        let currentSkyState = { cloudAmount: 0, precipRate: 0, isThundering: false, isFoggy: false, isSnowing: false, windSpeed: 0 };
        const NO_DATA_STRING = 'N/A';
        
        // --- Segédfüggvények ---
        function formatValue(value, unit = '', precision = 1, notAvailableString = NO_DATA_STRING) { if (value === null || typeof value === 'undefined' || (typeof value === 'number' && isNaN(value)) ) return notAvailableString; if (typeof value === 'number') { return `${value.toFixed(precision)}${unit}`; } return `${value}${unit}`; }
        function formatTime(dateOrIsoString, includeSeconds = false) { if (!dateOrIsoString) return NO_DATA_STRING; try { const date = new Date(dateOrIsoString); if (isNaN(date.getTime())) return NO_DATA_STRING; const options = { hour: '2-digit', minute: '2-digit' }; if (includeSeconds) options.second = '2-digit'; return date.toLocaleTimeString('hu-HU', options); } catch (e) { return NO_DATA_STRING; } }
        function formatHourOnly(dateOrIsoString) { if (!dateOrIsoString) return '--h'; try { const date = new Date(dateOrIsoString); if (isNaN(date.getTime())) return '--h'; return date.toLocaleTimeString('hu-HU', { hour: '2-digit' }) + 'h'; } catch (e) { return '--h'; } }
        
        function getPrecipIntensityDescription(rate) { if (rate == null || rate <= 0) return 'Nem esik'; if (rate > 0 && rate <= 0.1) return 'Pár csepp'; if (rate > 0.1 && rate <= 0.25) return 'Szitálás'; if (rate > 0.25 && rate <= 0.5) return 'Csepereg'; if (rate > 0.5 && rate <= 1.0) return 'Enyhe eső'; if (rate > 1.0 && rate <= 4.0) return 'Gyenge eső'; if (rate > 4.0 && rate <= 10.0) return 'Mérsékelt eső'; if (rate > 10.0 && rate <= 25.0) return 'Intenzív eső'; if (rate > 25.0 && rate <= 50.0) return 'Zápor'; return 'Felhőszakadás'; }
        function degreesToCompass(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["északi", "észak-északkeleti", "északkeleti", "kelet-északkeleti", "keleti", "kelet-délkeleti", "délkeleti", "dél-délkeleti", "déli", "dél-délnyugati", "délnyugati", "nyugat-délnyugati", "nyugati", "nyugat-északnyugati", "északnyugati", "észak-északnyugati"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function degreesToCompassAbbreviated(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["É", "ÉÉK", "ÉK", "KÉK", "K", "KDK", "DK", "DDK", "D", "DDNY", "DNY", "NYDNY", "NY", "NYÉNY", "ÉNY", "ÉÉNY"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function getBeaufortDescription(speed) { if (speed === null || typeof speed === 'undefined') return 'Ismeretlen'; if (speed < 1) return 'Szélcsend'; if (speed <= 5) return 'Gyenge szellő'; if (speed <= 11) return 'Enyhe szellő'; if (speed <= 19) return 'Gyenge szél'; if (speed <= 28) return 'Mérsékelt szél'; if (speed <= 38) return 'Élénk szél'; if (speed <= 49) return 'Erős szél'; if (speed <= 61) return 'Viharos szél'; if (speed <= 74) return 'Vihar'; if (speed <= 88) return 'Szélvihar'; if (speed <= 102) return 'Heves vihar'; if (speed <= 117) return 'Orkán'; return 'Orkán'; }
        function getSolarRadiationColor(w_m2) { if (w_m2 === null || typeof w_m2 === 'undefined' || w_m2 < 50) return 'var(--cool)'; if (w_m2 < 250) return 'var(--mild)'; if (w_m2 < 500) return 'var(--warm)'; return 'var(--hot)'; }
        function getUVColor(uv) { if (uv === null || typeof uv === 'undefined') return 'var(--cool)'; if (uv <= 2) return 'var(--mild)'; if (uv <= 5) return 'var(--warm)'; if (uv <= 7) return '#F97316'; if (uv <= 10) return 'var(--hot)'; return '#A134A1'; }
        function getTempColor(temp) { if (temp === null || typeof temp === 'undefined') return 'var(--mild)'; if (temp <= 5) return 'var(--cold)'; if (temp <= 12) return 'var(--cool)'; if (temp <= 22) return 'var(--mild)'; if (temp <= 28) return 'var(--warm)'; return 'var(--hot)'; }


        function mapIconCodeToHungarianText(iconCode, dayOrNight) { const isDay = dayOrNight === 'D'; const textMap = { 32: 'Napos', 36: 'Napos', 31: 'Tiszta ég', 33: 'Tiszta ég', 34: isDay ? 'Részben napos' : 'Részben felhős', 29: isDay ? 'Részben napos' : 'Részben felhős', 30: isDay ? 'Részben napos' : 'Részben felhős', 27: 'Felhős', 28: 'Felhős', 26: 'Borult', 11: 'Zápor', 12: 'Zápor', 40: 'Zápor', 39: isDay ? 'Zápor' : 'Éjjeli zápor', 45: isDay ? 'Zápor' : 'Éjjeli zápor', 3: 'Zivatar', 4: 'Zivatar', 37: 'Zivatar', 38: 'Zivatar', 47: 'Zivatar', 5: 'Havas eső', 6: 'Ónos eső', 7: 'Havas eső', 8: 'Ónos eső', 10: 'Ónos eső', 18: 'Havas eső', 13: 'Hózápor', 14: 'Hózápor', 15: 'Hófúvás', 16: 'Havazás', 41: 'Havazás', 42: 'Havazás', 43: 'Hófúvás', 46: 'Hózápor', 9: 'Eső', 19: 'Párás', 20: 'Ködös', 21: 'Párás', 22: 'Füstös', 23: 'Szeles', 24: 'Szeles' }; return textMap[iconCode] || 'Ismeretlen'; }
        function mapTwcIconToFontAwesome(iconCode, dayOrNight) { const isDay = dayOrNight === 'D'; const iconMap = { 32:'fas fa-sun',36:'fas fa-sun',31:'fas fa-moon',33:'fas fa-moon',34:isDay ?'fas fa-cloud-sun':'fas fa-cloud-moon',29:isDay ?'fas fa-cloud-sun':'fas fa-cloud-moon',30:isDay ?'fas fa-cloud-sun':'fas fa-cloud-moon',27:'fas fa-cloud',28:'fas fa-cloud',26:'fas fa-cloud',11:'fas fa-cloud-showers-heavy',12:'fas fa-cloud-showers-heavy',40:'fas fa-cloud-showers-heavy',39:isDay ?'fas fa-cloud-sun-rain':'fas fa-cloud-moon-rain',45:isDay ?'fas fa-cloud-sun-rain':'fas fa-cloud-moon-rain',3:'fas fa-cloud-bolt',4:'fas fa-cloud-bolt',37:'fas fa-cloud-bolt',38:'fas fa-cloud-bolt',47:'fas fa-cloud-bolt',5:'fas fa-snowflake',6:'fas fa-snowflake',7:'fas fa-snowflake',8:'fas fa-snowflake',10:'fas fa-cloud-sleet',18:'fas fa-smog',13:'fas fa-snowflake',14:'fas fa-snowflake',15:'fas fa-snowflake',16:'fas fa-snowflake',41:'fas fa-snowflake',42:'fas fa-snowflake',43:'fas fa-snowflake',46:'fas fa-snowflake',9:'fas fa-cloud-rain',19:'fas fa-smog',20:'fas fa-smog',21:'fas fa-smog',22:'fas fa-smog',23:'fas fa-wind',24:'fas fa-wind' }; return iconMap[iconCode] || 'fas fa-question-circle'; }
        function getWindColorName(speed) { if (speed == null) return 'calm'; if (speed < 5) return 'calm'; if (speed < 20) return 'light'; if (speed < 40) return 'moderate'; return 'strong'; }
        
        // --- Dinamikus égbolt és effektek logikája (optimalizálva) ---
        const SKY_THEME_MAP = { nightEnd: { top: '#020617', bottom: '#1f2937', stars: 0.8 }, nauticalDawn: { top: '#1e3a8a', bottom: '#4c1d95', stars: 0.5 }, dawn: { top: '#4c6cb3', bottom: '#f59e0b', stars: 0.2 }, sunrise: { top: '#87ceeb', bottom: '#ffb47c', stars: 0 }, goldenHour: { top: '#60a5fa', bottom: '#fcd34d', stars: 0 }, solarNoon: { top: '#38bdf8', bottom: '#a7ddf5', stars: 0 }, goldenHourEnd: { top: '#3b82f6', bottom: '#fb923c', stars: 0 }, sunset: { top: '#f59e0b', bottom: '#be123c', stars: 0.2 }, dusk: { top: '#4f46e5', bottom: '#1e1b4b', stars: 0.5 }, nauticalDusk: { top: '#1e1b4b', bottom: '#111827', stars: 0.8 }, night: { top: '#02040f', bottom: '#01020a', stars: 1.0 }, };
        const phaseOrder = ['nightEnd', 'nauticalDawn', 'dawn', 'sunrise', 'goldenHour', 'solarNoon', 'goldenHourEnd', 'sunset', 'dusk', 'nauticalDusk', 'night'];
        function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
        function interpolateColor(color1, color2, factor) { factor = Math.max(0, Math.min(1, factor)); let result = { r: 0, g: 0, b: 0 }; result.r = Math.round(color1.r + factor * (color2.r - color1.r)); result.g = Math.round(color1.g + factor * (color2.g - color1.g)); result.b = Math.round(color1.b + factor * (color2.b - color1.b)); return result; }
        
        function updateDynamicSkyAndEffects() { if (!cachedData.sunTimes) return; const now = new Date(); const nowMs = now.getTime(); let todayTimes = cachedData.sunTimes; let yesterdayTimes = SunCalc.getTimes(new Date(nowMs - 24 * 60 * 60 * 1000), NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); let tomorrowTimes = SunCalc.getTimes(new Date(nowMs + 24 * 60 * 60 * 1000), NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); let currentPhaseName = phaseOrder[phaseOrder.length - 1]; let currentPhaseTime = yesterdayTimes[currentPhaseName].getTime(); for (let i = 0; i < phaseOrder.length; i++) { const phaseName = phaseOrder[i]; if (todayTimes[phaseName].getTime() <= nowMs) { currentPhaseName = phaseName; currentPhaseTime = todayTimes[phaseName].getTime(); } else { break; } } const currentPhaseIndex = phaseOrder.indexOf(currentPhaseName); const nextPhaseIndex = (currentPhaseIndex + 1) % phaseOrder.length; const nextPhaseName = phaseOrder[nextPhaseIndex]; let nextPhaseTime = todayTimes[nextPhaseName].getTime(); if (nextPhaseTime < currentPhaseTime) { nextPhaseTime = tomorrowTimes[nextPhaseName].getTime(); } const totalDuration = nextPhaseTime - currentPhaseTime; const elapsed = nowMs - currentPhaseTime; const progress = totalDuration > 0 ? Math.max(0, Math.min(1, elapsed / totalDuration)) : 0; const theme1 = SKY_THEME_MAP[currentPhaseName]; const theme2 = SKY_THEME_MAP[nextPhaseName]; const topRgb = interpolateColor(hexToRgb(theme1.top), hexToRgb(theme2.top), progress); const bottomRgb = interpolateColor(hexToRgb(theme1.bottom), hexToRgb(theme2.bottom), progress); skyContainerEl.style.background = `linear-gradient(to bottom, rgb(${topRgb.r},${topRgb.g},${topRgb.b}), rgb(${bottomRgb.r},${bottomRgb.g},${bottomRgb.b}))`; const starsOpacity = theme1.stars + progress * (theme2.stars - theme1.stars); starsContainerEl.style.opacity = (starsOpacity * (1 - currentSkyState.cloudAmount / 20)).toFixed(2); const sunPos = SunCalc.getPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); const altitudeDeg = sunPos.altitude * 180 / Math.PI; const cloudDay = { base: {r:245, g:245, b:245}, shadow: {r:210, g:210, b:220} }; const cloudGolden = { base: {r:255, g:230, b:200}, shadow: {r:240, g:180, b:130} }; const cloudSunset = { base: {r:255, g:180, b:150}, shadow: {r:210, g:120, b:100} }; const cloudBlueHour = { base: {r:120, g:130, b:160}, shadow: {r:80, g:90, b:120} }; const cloudNight = { base: {r:45, g:55, b:70}, shadow: {r:30, g:40, b:55} }; const cloudStorm = { base: {r:100, g:110, b:125}, shadow: {r:60, g:70, b:85} }; let currentBase, currentShadow; if (currentSkyState.isThundering) { currentBase = cloudStorm.base; currentShadow = cloudStorm.shadow; } else { if (altitudeDeg > 15) { currentBase = cloudDay.base; currentShadow = cloudDay.shadow; } else if (altitudeDeg > 0) { const factor = altitudeDeg / 15; currentBase = interpolateColor(cloudGolden.base, cloudDay.base, factor); currentShadow = interpolateColor(cloudGolden.shadow, cloudDay.shadow, factor); } else if (altitudeDeg > -6) { const factor = (altitudeDeg + 6) / 6; currentBase = interpolateColor(cloudSunset.base, cloudGolden.base, factor); currentShadow = interpolateColor(cloudSunset.shadow, cloudGolden.shadow, factor); } else if (altitudeDeg > -12) { const factor = (altitudeDeg + 12) / 6; currentBase = interpolateColor(cloudBlueHour.base, cloudSunset.base, factor); currentShadow = interpolateColor(cloudBlueHour.shadow, cloudSunset.shadow, factor); } else if (altitudeDeg > -18) { const factor = (altitudeDeg + 18) / 6; currentBase = interpolateColor(cloudNight.base, cloudBlueHour.base, factor); currentShadow = interpolateColor(cloudNight.shadow, cloudBlueHour.shadow, factor); } else { currentBase = cloudNight.base; currentShadow = cloudNight.shadow; } } document.documentElement.style.setProperty('--cloud-base-color', `rgb(${currentBase.r},${currentBase.g},${currentBase.b})`); document.documentElement.style.setProperty('--cloud-shadow-color', `rgb(${currentShadow.r},${currentShadow.g},${currentShadow.b})`); const verticalMultiplier = window.innerHeight < 550 ? 70 : 85; let celestialBodyX = 50, celestialBodyY = 50, celestialBodyVisible = false; if (sunPos.altitude > -0.1) { const x = 50 + Math.cos(sunPos.azimuth + Math.PI/2) * 50; const y = verticalMultiplier - Math.sin(sunPos.altitude) * verticalMultiplier; celestialBodyX = x; celestialBodyY = y; celestialBodyVisible = true; } skyGlowEl.style.background = `radial-gradient(circle at ${celestialBodyX}vw ${celestialBodyY}vh, rgba(255,255,224,0.08) 0%, transparent 35%)`; skyGlowEl.style.opacity = celestialBodyVisible ? 1 : 0; }
        let lightningTimeout = null;
        function updateBackgroundWeatherEffects() { const desiredCloudCount = Math.floor(currentSkyState.cloudAmount * (window.innerWidth < 768 ? 0.6 : 1)); if (cloudsContainerEl.children.length !== desiredCloudCount) { cloudsContainerEl.innerHTML = ''; for (let i = 0; i < desiredCloudCount; i++) { const cloudGroup = document.createElement('div'); const type = `type${Math.floor(Math.random() * 4) + 1}`; cloudGroup.className = `cloud-group ${type}`; cloudGroup.style.top = `${Math.random() * 40}%`; cloudGroup.style.left = `${Math.random() * 100 - 10}%`; const puffCount = { type1: 4, type2: 4, type3: 3, type4: 3 }[type] || 2; for (let j = 1; j <= puffCount; j++) { const puff = document.createElement('div'); puff.className = `puff puff-${j}`; cloudGroup.appendChild(puff); } cloudsContainerEl.appendChild(cloudGroup); } } cloudsContainerEl.style.opacity = desiredCloudCount > 0 ? '1' : '0'; const isRaining = currentSkyState.precipRate > 0; const desiredPrecipCount = isRaining ? Math.floor((currentSkyState.precipRate * 50 + 10) * (window.innerWidth < 768 ? 0.5 : 1)) : 0; if (isRaining && precipitationContainerEl.children.length !== desiredPrecipCount) { precipitationContainerEl.innerHTML = ''; const precipType = currentSkyState.isSnowing ? 'snowflake' : 'raindrop'; const icon = currentSkyState.isSnowing ? 'fas fa-snowflake' : ''; for (let i = 0; i < desiredPrecipCount; i++) { const particle = document.createElement('div'); particle.className = `${precipType} ${icon}`; particle.style.left = `${Math.random() * 100}vw`; particle.style.top = `${Math.random() * 100}vh`; if (currentSkyState.isSnowing) { particle.style.fontSize = `${Math.random() * 0.5 + 0.8}em`; } precipitationContainerEl.appendChild(particle); } } precipitationContainerEl.style.opacity = isRaining ? 1 : 0; hazeContainerEl.style.opacity = currentSkyState.isFoggy ? '1' : '0'; if (currentSkyState.isThundering && !lightningTimeout) { const flash = () => { lightningFlashEl.classList.add('flash'); setTimeout(() => lightningFlashEl.classList.remove('flash'), 500); lightningTimeout = setTimeout(flash, Math.random() * 8000 + 4000); }; lightningTimeout = setTimeout(flash, Math.random() * 5000 + 1000); } else if (!currentSkyState.isThundering && lightningTimeout) { clearTimeout(lightningTimeout); lightningTimeout = null; } }
        function createStars() { starsContainerEl.innerHTML = ''; const starCount = window.innerWidth < 768 ? 80 : 200; for (let i = 0; i < starCount; i++) { const star = document.createElement('div'); star.classList.add('star'); const size = Math.random() * 2 + 1; star.style.width = `${size}px`; star.style.height = `${size}px`; star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`; star.style.opacity = Math.random() * 0.6 + 0.2; starsContainerEl.appendChild(star); } }
        function animateSky() { updateDynamicSkyAndEffects(); requestAnimationFrame(animateSky); }
        
        async function fetchAdvancedSunCalcData(lat, lon) { const now = new Date(); cachedData.sunTimes = SunCalc.getTimes(now, lat, lon); const moonTimes = SunCalc.getMoonTimes(now, lat, lon, true); let nextMoonrise = moonTimes.rise; let nextMoonset = moonTimes.set; if (!nextMoonrise || nextMoonrise < now) { const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1); nextMoonrise = SunCalc.getMoonTimes(tomorrow, lat, lon, true).rise; } if (!nextMoonset || nextMoonset < now) { const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1); nextMoonset = SunCalc.getMoonTimes(tomorrow, lat, lon, true).set; } return { sunrise: formatTime(cachedData.sunTimes.sunrise), sunset: formatTime(cachedData.sunTimes.sunset), moonrise: formatTime(nextMoonrise), moonset: formatTime(nextMoonset) }; }
        async function fetchPwsStationData(stationKey) { const stationConfig = STATIONS[stationKey]; const url = `https://api.weather.com/v2/pws/observations/current?apiKey=${weatherComApiKey}&stationId=${stationConfig.id}&numericPrecision=decimal&format=json&units=m`; try { const response = await fetch(url); if (!response.ok) throw new Error(`PWS API Hiba`); const data = await response.json(); if (!data.observations || data.observations.length === 0) throw new Error(`Nincs PWS adat.`); const observation = data.observations[0]; stationConfig.isOnline = true; stationConfig.data = observation; if (observation.metric.precipRate > 0) { stationConfig.lastRainTimestamp = new Date(observation.obsTimeLocal).getTime(); } } catch (error) { stationConfig.isOnline = false; } finally { if(isWeatherDisplayInitialized) updateStationStatusUI(stationKey); } }
        async function fetchGeneralConditionsData(lat, lon) { const lang = 'hu-HU'; const url = `https://api.weather.com/v3/wx/observations/current?geocode=${lat},${lon}&language=${lang}&format=json&apiKey=${weatherComApiKey}&units=m`; const response = await fetch(url); if (!response.ok) { throw new Error(`API hiba`); } const data = await response.json(); lastApiCallTimes.generalConditions = Date.now(); return { temperature: data.temperature, temperatureFeelsLike: data.temperatureFeelsLike ?? data.temperature, temperatureMax24Hour: data.temperatureMax24Hour, temperatureMin24Hour: data.temperatureMin24Hour, relativeHumidity: data.relativeHumidity, windSpeed: data.windSpeed, windDirection: data.windDirection, dewpoint: data.temperatureDewPoint, wxPhraseLong: data.wxPhraseLong || null, pressureAltimeter: data.pressureAltimeter ?? data.pressureMeanSeaLevel, visibility: data.visibility, dayOrNight: data.dayOrNight, pressureTendencyCode: data.pressureTendencyCode ?? (data.pressureChange !== null && typeof data.pressureChange !== 'undefined' ? (data.pressureChange > 0 ? 0 : (data.pressureChange < 0 ? 1 : 2)) : null), uvDescription: data.uvDescription || null, uvIndex: data.uvIndex, iconCode: data.iconCode }; }
        async function fetchHourlyForecastData(lat, lon) { const url = `https://api.weather.com/v3/wx/forecast/hourly/3day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`; try { const response = await fetch(url); if (!response.ok) throw new Error(`API hiba`); const data = await response.json(); if (!data || !data.validTimeLocal || !Array.isArray(data.validTimeLocal)) { throw new Error('Hiányos vagy érvénytelen előrejelzési adat.'); } const hourlyForecasts = []; const nowMs = new Date().getTime(); let startIndex = data.validTimeLocal.map(timeStr => new Date(timeStr).getTime()).findLastIndex(timeMs => timeMs <= nowMs); if (startIndex === -1) { startIndex = 0; } const forecastLimit = Math.min(startIndex + 24, data.validTimeLocal.length); for (let i = startIndex; i < forecastLimit; i++) { hourlyForecasts.push({ time: data.validTimeLocal[i], temp: data.temperature[i], iconCode: data.iconCode[i], precipChance: data.precipChance[i], qpf: data.qpf[i], dayOrNight: data.dayOrNight[i], windSpeed: data.windSpeed[i], windDirection: data.windDirection[i], humidity: data.relativeHumidity[i], wxPhraseShort: data.wxPhraseShort[i] }); } return hourlyForecasts; } catch (error) { throw error; } }

        async function fetchAllDataAndUpdateDisplay(isInitialLoad = false) { const now = Date.now(); if (!isWeatherDisplayInitialized) initializeWeatherDisplayDOM(); await Promise.allSettled(Object.keys(STATIONS).map(key => fetchPwsStationData(key))); const promises = []; if (isInitialLoad || now - lastApiCallTimes.generalConditions > REFRESH_INTERVAL_GENERAL_CONDITIONS) { promises.push(fetchGeneralConditionsData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) Object.assign(cachedData.generalConditions, data); }).catch(e => console.error("General conditions fetch failed:", e))); } if (isInitialLoad || now - lastApiCallTimes.forecast > REFRESH_INTERVAL_FORECAST) { promises.push(fetchAndRefreshForecasts()); } promises.push(fetchAdvancedSunCalcData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { cachedData.sunCalc = data; })); await Promise.allSettled(promises); const primaryStations = ['NYIREGYHAZI_UT', 'KOSSUTH', 'KERT_UTCA', 'SOSTOHEGY', 'BORBANYA', 'OROS_DERUS']; const activeStationIsOnline = STATIONS[activeDisplayStationKey] && STATIONS[activeDisplayStationKey].isOnline; if (activeStationIsOnline) { const activeStation = STATIONS[activeDisplayStationKey]; cachedData.displayPws = { ...activeStation.data.metric, ...activeStation.data }; } else { const onlinePrimaryStations = primaryStations.filter(k => STATIONS[k].isOnline); if (onlinePrimaryStations.length > 0) { activeDisplayStationKey = onlinePrimaryStations[0]; const activeStation = STATIONS[activeDisplayStationKey]; cachedData.displayPws = { ...activeStation.data.metric, ...activeStation.data }; } else { const general = cachedData.generalConditions; if (general && Object.keys(general).length > 0) { cachedData.displayPws = { temp: general.temperature, heatIndex: general.temperatureFeelsLike, windChill: general.temperatureFeelsLike, windSpeed: general.windSpeed, winddir: general.windDirection, windGust: null, dewpt: general.dewpoint, humidity: general.relativeHumidity, pressure: general.pressureAltimeter, solarRadiation: null, uv: general.uvIndex }; } else { cachedData.displayPws = {}; } } } const maxPrecipRate = Math.max(0, ...Object.values(STATIONS).map(s => (s.isOnline && s.data) ? s.data.metric.precipRate : 0)); currentSkyState.precipRate = maxPrecipRate; const general = cachedData.generalConditions; if (general && general.iconCode) { const icon = general.iconCode; if ([31, 32, 33, 36].includes(icon)) currentSkyState.cloudAmount = 0; else if ([34, 29, 30].includes(icon)) currentSkyState.cloudAmount = 5; else if ([27, 28].includes(icon)) currentSkyState.cloudAmount = 10; else if ([26].includes(icon)) currentSkyState.cloudAmount = 15; else currentSkyState.cloudAmount = 8; currentSkyState.isThundering = [3, 4, 37, 38, 47].includes(icon); currentSkyState.isFoggy = [19, 20, 21, 22].includes(icon); currentSkyState.isSnowing = [5,6,7,8,10,13,14,15,16,41,42,43,46].includes(icon); } currentSkyState.windSpeed = general.windSpeed || 0; updateBackgroundWeatherEffects(); Object.keys(STATIONS).forEach(key => updateStationStatusUI(key)); compileAndRenderDisplayData(); }
        
        function initializeWeatherDisplayDOM() {
            weatherDisplayEl.innerHTML = `
                <div class="widget-header">
                    <div class="header-container"><div class="location-title" id="location-title-text">Nyíregyháza és környéke</div></div>
                    <div class="timestamp-container"><span class="timestamp" id="main-timestamp">--:--:--</span></div>
                </div>
                <div class="station-status-container">${Object.keys(STATIONS).filter(key => ['NYIREGYHAZI_UT', 'KOSSUTH', 'KERT_UTCA', 'SOSTOHEGY', 'BORBANYA', 'OROS_DERUS'].includes(key)).map(key => `<div class="station-selector" id="${key.toLowerCase()}-selector-container"><input type="radio" name="station-select" id="station-select-${key.toLowerCase()}" value="${key}"><label for="station-select-${key.toLowerCase()}"><span class="station-status-indicator" id="status-indicator-${key}"></span> ${STATIONS[key].displayNameShort || STATIONS[key].displayName}</label></div>`).join('')}</div>
                
                <div class="current-conditions-card">
                    <div class="conditions-section">
                        <h4 class="section-title">Hőmérséklet</h4>
                        <div class="temp-primary-display">
                            <div class="current-temp-value"><span id="current-temp-span" class="flippable-value">--</span><span>°C</span></div>
                            <div class="temp-secondary-info"><span id="feels-like-temp">Hőérzet: --°</span></div>
                        </div>
                        <div class="temp-forecast-visualizer">
                            <div class="section-header">
                                <h4>Órás Hőmérséklet Előrejelzés</h4>
                                <div class="info-tooltip-container">
                                    <span class="info-tooltip-trigger">i</span>
                                    <div class="info-tooltip-content">Ez a grafikon a következő 6 óra várható hőmérséklet-változását mutatja. Az oszlopok magassága a hőmérsékleti tartományon belüli relatív értéket, színük pedig a hideg/meleg skálát jelöli.</div>
                                </div>
                            </div>
                            <div class="temp-chart">
                                ${Array.from({ length: 6 }).map((_, i) => `
                                    <div class="chart-column">
                                        <div class="chart-temp-label" id="chart-temp-label-${i}">--°</div>
                                        <div class="chart-bar-wrapper">
                                            <div class="chart-bar-fill" id="chart-bar-fill-${i}"></div>
                                        </div>
                                        <div class="chart-hour-label" id="chart-hour-label-${i}">--</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="conditions-section">
                        <h4 class="section-title">Szél adatok</h4>
                        <div class="wind-display-flex-container">
                            <div class="wind-gauge-container">
                                <div class="wind-gauge" id="wind-gauge-circle">
                                    <div class="wind-data-center">
                                        <div class="wind-speed-main">
                                            <span id="wind-speed-span" class="flippable-value">--</span>
                                            <span class="wind-speed-unit">km/h</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wind-details-container">
                                <div class="wind-direction-info">
                                    <i class="fas fa-location-arrow wind-direction-arrow" id="wind-direction-arrow"></i>
                                    <span class="wind-direction-full" id="wind-direction-full">--</span>
                                </div>
                                <div class="wind-detail-item">
                                    <span>Széllökés:</span>
                                    <strong><span id="wind-gust-span" class="flippable-value">--</span> km/h</strong>
                                </div>
                                <div class="wind-detail-item">
                                    <span>Besorolás:</span>
                                    <strong id="wind-beaufort-desc">--</strong>
                                </div>
                            </div>
                        </div>
                        <div class="wind-legend-container">
                            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--wind-calm);"></span> &lt; 5</div>
                            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--wind-light);"></span> 5-20</div>
                            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--wind-moderate);"></span> 20-40</div>
                            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--wind-strong);"></span> &gt; 40 km/h</div>
                        </div>
                    </div>
                </div>

                <div class="pws-details-container">
                    <div class="section-header"><div class="section-title">Részletes adatok</div><span class="section-timestamp" id="pws-timestamp"></span></div>
                    <div class="pws-details-grid" id="pws-details-grid">
                        <div class="detail-item"><span class="label"><i class="fas fa-tint"></i>Páratartalom</span><span class="value" id="detail-humidity">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-tachometer-alt"></i>Légnyomás</span><span class="value" id="detail-pressure">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-sun"></i>Napsugárzás</span><span class="value" id="detail-solar">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-shield-sun"></i>UV Index</span><span class="value" id="detail-uv">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-sunrise"></i>Napkelte</span><span class="value" id="detail-sunrise">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-sunset"></i>Napnyugta</span><span class="value" id="detail-sunset">--</span></div>
                        <div class="detail-item"><span class="label"><i class="far fa-moon"></i>Holdkelte</span><span class="value" id="detail-moonrise">--</span></div>
                        <div class="detail-item"><span class="label"><i class="far fa-moon"></i>Holdnyugta</span><span class="value" id="detail-moonset">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-eye"></i>Látótávolság</span><span class="value" id="detail-visibility">--</span></div>
                        <div class="detail-item"><span class="label"><i class="fas fa-droplet"></i>Harmatpont</span><span class="value" id="detail-dewpoint">--</span></div>
                    </div>
                </div>

                <div class="precipitation-forecast-section">
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="section-title" style="margin-bottom: 0;">Órás csapadék előrejelzés</div>
                            <div class="info-tooltip-container">
                                <span class="info-tooltip-trigger">i</span>
                                <div class="info-tooltip-content">A sáv <strong>szélessége</strong> a várható csapadék mennyiségét jelzi, míg az <strong>élénksége</strong> (láthatósága) a csapadék esélyét mutatja. A pontos esély százalékban a sáv mellett olvasható.</div>
                            </div>
                        </div>
                        <span class="section-timestamp" id="precip-forecast-timestamp"></span>
                    </div>
                    <div class="precip-forecast-list">
                        ${Array.from({ length: 7 }).map((_, i) => `
                            <div class="precip-forecast-item">
                                <div class="forecast-time" id="precip-time-${i}">--:--</div>
                                <div class="forecast-bar-container">
                                    <div class="forecast-bar-fill" id="precip-bar-fill-${i}"></div>
                                </div>
                                <div class="forecast-details">
                                    <div class="forecast-chance" id="precip-chance-${i}">--%</div>
                                    <div class="forecast-amount" id="precip-amount-${i}">-- mm</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="precip-summary-card" id="precip-summary-card"></div>
                
                <div class="attribution-line" style="margin-top: 20px;">© Copyright by: Robi</div>`;
            addStationChangeListeners();
            isWeatherDisplayInitialized = true;
        }

        function updateStationStatusUI(stationKey) { const stationConfig = STATIONS[stationKey]; if (!stationConfig) return; const statusIndicatorEl = document.getElementById(`status-indicator-${stationKey}`); if(statusIndicatorEl) { statusIndicatorEl.classList.remove('online', 'offline'); statusIndicatorEl.classList.add(stationConfig.isOnline ? 'online' : 'offline'); } const selectorContainer = document.getElementById(`${stationKey.toLowerCase()}-selector-container`); if(selectorContainer) { selectorContainer.classList.toggle('disabled', !stationConfig.isOnline); } const radioEl = document.getElementById(`station-select-${stationKey.toLowerCase()}`); if(radioEl) { radioEl.checked = (stationKey === activeDisplayStationKey); } }
        function addStationChangeListeners() { document.querySelectorAll('input[name="station-select"]').forEach(radio => radio.addEventListener('change', handleStationChange)); }
        function handleStationChange(event) { const selectedStationKey = event.target.value; if (STATIONS[selectedStationKey].isOnline && selectedStationKey !== activeDisplayStationKey) { activeDisplayStationKey = selectedStationKey; const activeStation = STATIONS[activeDisplayStationKey]; if (activeStation && activeStation.data) { cachedData.displayPws = { ...activeStation.data.metric, ...activeStation.data }; } compileAndRenderDisplayData(); } else if (!STATIONS[selectedStationKey].isOnline) { event.target.checked = false; const previouslyActiveRadio = document.querySelector(`input[value="${activeDisplayStationKey}"]`); if (previouslyActiveRadio) { previouslyActiveRadio.checked = true; } } }
        function compileAndRenderDisplayData() { if (!cachedData.displayPws || Object.keys(cachedData.displayPws).length === 0) return; renderWeatherData(); renderPrecipitationForecast(); renderHourlyForecastData(); }
        
        function updateAnimatedValue(element, newValue) { if (!element) return; const currentValue = element.textContent.trim(); const newFormattedValue = newValue.toString().trim(); if (currentValue !== newFormattedValue) { if (!element.classList.contains('is-flipping')) { element.classList.add('is-flipping'); setTimeout(() => { element.textContent = newFormattedValue; element.classList.remove('is-flipping'); }, 200); } } }

        function renderWeatherData() {
            const obs = cachedData.displayPws;
            const general = cachedData.generalConditions;
            const sunCalcData = cachedData.sunCalc;
            if (!general || !obs || !sunCalcData) return;

            const now = new Date();
            document.getElementById('main-timestamp').textContent = `Utolsó frissítés: ${formatTime(now, true)}`;
            document.getElementById('pws-timestamp').textContent = `Frissítve: ${formatTime(now, true)}`;
            
            updateAnimatedValue(document.getElementById('current-temp-span'), formatValue(obs.temp, '', 1));
            document.getElementById('feels-like-temp').textContent = `Hőérzet: ${formatValue(general.temperatureFeelsLike, '°', 1)}`;
            
            // Hőmérséklet előrejelző mini-grafikon
            const hourlyForecast = cachedData.hourlyForecast;
            if (hourlyForecast && hourlyForecast.length > 0) {
                const nowMs = new Date().getTime();
                let startIndex = hourlyForecast.findIndex(hour => new Date(hour.time).getTime() > nowMs);
                if (startIndex === -1) startIndex = 0; // Ha nincs jövőbeli, mutassuk az utolsókat

                const nextHours = hourlyForecast.slice(startIndex, startIndex + 6);
                const temps = nextHours.map(h => h.temp).filter(t => t !== null);
                
                if (temps.length > 0) {
                    const minTemp = Math.min(...temps);
                    const maxTemp = Math.max(...temps);
                    const tempRange = maxTemp - minTemp;

                    for (let i = 0; i < 6; i++) {
                        const tempLabel = document.getElementById(`chart-temp-label-${i}`);
                        const barFill = document.getElementById(`chart-bar-fill-${i}`);
                        const hourLabel = document.getElementById(`chart-hour-label-${i}`);
                        const hourData = nextHours[i];

                        if (tempLabel && barFill && hourLabel) {
                            if (hourData) {
                                tempLabel.textContent = `${formatValue(hourData.temp, '°', 0)}`;
                                let barHeight = 10; // Minimum magasság
                                if (tempRange > 0) {
                                    barHeight = 10 + ((hourData.temp - minTemp) / tempRange) * 90;
                                }
                                barFill.style.height = `${barHeight}%`;
                                barFill.style.backgroundColor = getTempColor(hourData.temp);
                                hourLabel.textContent = formatHourOnly(hourData.time);
                            } else {
                                tempLabel.textContent = '--°';
                                barFill.style.height = `0%`;
                                hourLabel.textContent = '--';
                            }
                        }
                    }
                }
            }


            const windSpeed = obs.windSpeed ?? general.windSpeed;
            const windGust = obs.windGust;
            const windDir = obs.winddir ?? general.windDirection;
            const windArrow = document.getElementById('wind-direction-arrow');
            if (windDir !== null) { windArrow.style.transform = `rotate(${windDir - 45}deg)`; } 
            
            const windColor = `var(--wind-${getWindColorName(windSpeed)})`;
            windArrow.style.color = windColor;
            document.querySelector('.wind-speed-main').style.color = windColor;
            
            updateAnimatedValue(document.getElementById('wind-speed-span'), formatValue(windSpeed, '', 1));
            updateAnimatedValue(document.getElementById('wind-gust-span'), formatValue(windGust, '', 0));
            document.getElementById('wind-direction-full').textContent = degreesToCompass(windDir);
            document.getElementById('wind-beaufort-desc').textContent = getBeaufortDescription(windSpeed);
            
            const pressureTrendCode = general.pressureTendencyCode; let trendSymbol = ''; if (pressureTrendCode === 0) trendSymbol = '↑'; else if (pressureTrendCode === 1) trendSymbol = '↓'; else if (pressureTrendCode === 2) trendSymbol = '→';
            
            const humidity = obs.humidity ?? general.relativeHumidity;
            const pressure = obs.pressure ?? general.pressureAltimeter;
            const solarRadiation = obs.solarRadiation; 
            const uv = obs.uv ?? general.uvIndex;
            const dewpoint = obs.dewpt ?? general.dewpoint;
            
            document.getElementById('detail-humidity').textContent = formatValue(humidity, '%', 0);
            const pressureEl = document.getElementById('detail-pressure');
            pressureEl.innerHTML = `${formatValue(pressure, ' hPa', 1)}<span class="pressure-trend-icon">${trendSymbol}</span>`;
            const solarEl = document.getElementById('detail-solar');
            solarEl.textContent = formatValue(solarRadiation, ' W/m²', 0);
            solarEl.style.color = getSolarRadiationColor(solarRadiation);
            const uvEl = document.getElementById('detail-uv');
            uvEl.textContent = formatValue(uv, '', 1);
            uvEl.style.color = getUVColor(uv);
            document.getElementById('detail-sunrise').textContent = sunCalcData.sunrise;
            document.getElementById('detail-sunset').textContent = sunCalcData.sunset;
            document.getElementById('detail-moonrise').textContent = sunCalcData.moonrise;
            document.getElementById('detail-moonset').textContent = sunCalcData.moonset;
            document.getElementById('detail-visibility').textContent = formatValue(general.visibility, ' km', 1);
            document.getElementById('detail-dewpoint').textContent = formatValue(dewpoint, '°', 1);

            const precipCardEl = document.getElementById('precip-summary-card');
            if (precipCardEl) { const precipStations = Object.values(STATIONS).filter(s => s.isOnline && s.provides.includes('precip') && s.data); const stationsWithRainToday = precipStations.filter(s => s.data.metric.precipTotal > 0); let mainContentHTML = ''; const allMonitoredNames = Object.values(STATIONS).filter(s => s.provides.includes('precip')).map(s => s.displayName).join(', '); const tooltipHTML = `<div class="station-tooltip-container"><span class="station-list-trigger">Figyelt állomások listája</span><div class="station-tooltip-content">${allMonitoredNames}</div></div>`; let footerHTML = `<div class="precip-card-footer">${tooltipHTML}</div>`; if (stationsWithRainToday.length === 0) { mainContentHTML = `<div class="precip-explanation-container"><h5 class="explanation-title">Hogyan működik a Csapadékfigyelő?</h5><p class="explanation-text">Ez a modul <strong>mikro-hálózatot</strong> használ, amely Nyíregyháza környéki privát időjárás-állomások (PWS) valós idejű adatait gyűjti össze. Amikor valamelyik figyelt állomáson csapadékot észlel a rendszer, az azonnal megjelenik itt.</p></div>`; } else { mainContentHTML = `<div class="precip-station-grid">${stationsWithRainToday.sort((a, b) => (b.data.metric.precipTotal - a.data.metric.precipTotal)).map(station => { const isRainingNow = station.data.metric.precipRate > 0; const cardClass = isRainingNow ? 'precip-station-card is-raining-now' : 'precip-station-card'; const displayName = station.displayNameShort || station.displayName; let footerInfoHTML = ''; if (isRainingNow) { footerInfoHTML = `<div class="station-card-footer-info live-intensity">Most: ${getPrecipIntensityDescription(station.data.metric.precipRate)}</div>`; } else if (station.lastRainTimestamp) { footerInfoHTML = `<div class="station-card-footer-info">Utoljára: ${formatTime(station.lastRainTimestamp)}</div>`; } else { footerInfoHTML = `<div class="station-card-footer-info">Jelenleg nem esik</div>`; } return `<div class="${cardClass}"><div class="station-card-header"><span class="station-card-name">${displayName}</span> ${isRainingNow ? '<div class="station-card-status-icon"></div>' : ''}</div><div class="station-card-main"><div class="station-card-total-label">Ma eddig</div><div class="station-card-total-value">${formatValue(station.data.metric.precipTotal, '', 1)}<span>mm</span></div></div>${footerInfoHTML}</div>`; }).join('')}</div>`; } precipCardEl.innerHTML = `<div class="precip-card-header"><div class="precip-header-title-group"><div class="precip-header-icon"><i class="fas fa-satellite-dish"></i></div><h4 class="precip-header-title">CsapadékRadar</h4></div><span class="section-timestamp" id="radar-timestamp"></span></div><div class="precip-card-content">${mainContentHTML}</div>${footerHTML}`; document.getElementById('radar-timestamp').textContent = `Frissítve: ${formatTime(now, true)}`; }
        }
        function renderPrecipitationForecast() {
            const hourlyDataFull = cachedData.hourlyForecast;
            if (!hourlyDataFull) return;

            const forecastLiveTimestampEl = document.getElementById('precip-forecast-timestamp');
            if (forecastLiveTimestampEl && lastApiCallTimes.forecastSuccess > 0) {
                forecastLiveTimestampEl.textContent = `Frissítve: ${formatTime(new Date(lastApiCallTimes.forecastSuccess))}`;
            }

            for (let i = 0; i < 7; i++) {
                const timeEl = document.getElementById(`precip-time-${i}`);
                const barFillEl = document.getElementById(`precip-bar-fill-${i}`);
                const chanceEl = document.getElementById(`precip-chance-${i}`);
                const amountEl = document.getElementById(`precip-amount-${i}`);

                if (timeEl && barFillEl && chanceEl && amountEl) {
                    const hourData = hourlyDataFull[i];
                    if (hourData) {
                        const chance = hourData.precipChance || 0;
                        const amount = hourData.qpf || 0;
                        const barWidth = Math.min(100, (amount / 3.0) * 100); 
                        const barOpacity = 0.3 + (chance / 100) * 0.7; 

                        timeEl.textContent = formatHourOnly(hourData.time);
                        barFillEl.style.width = `${barWidth}%`;
                        barFillEl.style.opacity = barOpacity;
                        chanceEl.textContent = `${chance}%`;
                        amountEl.textContent = `${formatValue(amount, ' mm', 1)}`;
                    } else {
                        timeEl.textContent = '--:--';
                        barFillEl.style.width = '0%';
                        barFillEl.style.opacity = '0.15';
                        chanceEl.textContent = '--%';
                        amountEl.textContent = '-- mm';
                    }
                }
            }
        }
        function renderHourlyForecastData() { 
            const hourlyDataFull = cachedData.hourlyForecast; 
            if (!hourlyDataFull || hourlyDataFull.length === 0 || !hourlyForecastContainerEl) { 
                if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.add('is-hidden'); 
                if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.add('is-hidden'); 
                return; 
            } 
            
            const forecastLiveTimestampEl = document.getElementById('hourly-forecast-timestamp'); 
            if (forecastLiveTimestampEl && lastApiCallTimes.forecastSuccess > 0) { 
                forecastLiveTimestampEl.textContent = `Frissítve: ${formatTime(new Date(lastApiCallTimes.forecastSuccess))}`; 
            } 

            const nowMs = new Date().getTime();
            let startIndex = hourlyDataFull.findIndex(hour => new Date(hour.time).getTime() > nowMs);
            if (startIndex === -1) startIndex = 0; // Ha nincs jövőbeli adat, mutassuk az elejétől

            const forecastsToShow = hourlyDataFull.slice(startIndex, startIndex + 12);

            let forecastHTML = ''; 
            forecastsToShow.forEach(hour => { 
                let conditionText = hour.wxPhraseShort || mapIconCodeToHungarianText(hour.iconCode, hour.dayOrNight); 
                forecastHTML += `<div class="hourly-forecast-card"><div class="hourly-primary-info"><div class="hourly-time">${formatTime(hour.time)}</div><div class="hourly-icon-and-condition"><i class="hourly-icon ${mapTwcIconToFontAwesome(hour.iconCode, hour.dayOrNight)}"></i><div class="hourly-condition-text">${conditionText}</div></div><div class="hourly-temp">${formatValue(hour.temp, '°', 0, '--')}</div></div><div class="hourly-secondary-details"><div class="hourly-detail-row"><span><i class="fas fa-tint"></i> Csapadék</span><strong>${formatValue(hour.precipChance, '%', 0, '--')}</strong></div><div class="hourly-detail-row"><span><i class="fas fa-wind"></i> Szél</span><strong title="${degreesToCompass(hour.windDirection)}">${degreesToCompassAbbreviated(hour.windDirection)} ${formatValue(hour.windSpeed, 'km/h', 0)}</strong></div><div class="hourly-detail-row"><span><i class="fas fa-hand-holding-water"></i> Pára</span><strong>${formatValue(hour.humidity, '%', 0)}</strong></div></div></div>`; 
            }); 
            
            if(hourlyForecastContainerEl) hourlyForecastContainerEl.innerHTML = forecastHTML; 
            if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.remove('is-hidden'); 
            if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.remove('is-hidden'); 
        }
        
        function calculateDailyForecastMetrics() {
            const hourlyData = cachedData.hourlyForecast;
            if (!hourlyData || hourlyData.length < 1) {
                cachedData.dailyForecastMetrics = { minTemp: null, minTime: null, maxTemp: null, maxTime: null };
                return;
            }
            const relevantForecasts = hourlyData.slice(0, 24);
            if (relevantForecasts.length === 0) {
                cachedData.dailyForecastMetrics = { minTemp: null, minTime: null, maxTemp: null, maxTime: null };
                return;
            }
            let minForecast = relevantForecasts[0];
            let maxForecast = relevantForecasts[0];
            for (const forecast of relevantForecasts) {
                if (forecast.temp < minForecast.temp) { minForecast = forecast; }
                if (forecast.temp > maxForecast.temp) { maxForecast = forecast; }
            }
            cachedData.dailyForecastMetrics = { minTemp: minForecast.temp, minTime: minForecast.time, maxTemp: maxForecast.temp, maxTime: maxForecast.time };
        }

        async function fetchAndRefreshForecasts() { 
            try { 
                const data = await fetchHourlyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); 
                if (data) { 
                    cachedData.hourlyForecast = data; 
                    lastApiCallTimes.forecastSuccess = Date.now(); 
                    calculateDailyForecastMetrics();
                } 
                lastApiCallTimes.forecast = Date.now(); 
                renderPrecipitationForecast(); 
                renderHourlyForecastData(); 
            } catch (e) { /* Hiba csendes kezelése */ } 
        }

        function startMasterLoop() { fetchAllDataAndUpdateDisplay(true); setInterval(() => fetchAllDataAndUpdateDisplay(), REFRESH_INTERVAL_PWS); }
        
        function initApp() {
            weatherDisplayEl = document.getElementById('weather-display'); 
            hourlyForecastContainerEl = document.getElementById('hourly-forecast-container');
            hourlyForecastTitleEl = document.getElementById('hourly-forecast-title');
            skyContainerEl = document.getElementById('sky-container');
            skyGlowEl = document.getElementById('sky-glow');
            starsContainerEl = document.getElementById('stars-container');
            cloudsContainerEl = document.getElementById('clouds-container');
            precipitationContainerEl = document.getElementById('precipitation-container');
            hazeContainerEl = document.getElementById('haze-container');
            lightningFlashEl = document.getElementById('lightning-flash');
            createStars();
            startMasterLoop();
            requestAnimationFrame(animateSky);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
