<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Id≈ëj√°r√°s Monitor - Ny√≠regyh√°za</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <style>
        :root {
            /* Sz√≠npaletta Alapok */
            --accent-interactive-night: #00BFFF;
            --text-primary-night: #EAEAEA;
            --text-secondary-night: #A0B0C0;
            --bg-widget-night: rgba(15, 23, 42, 0.88);
            --border-widget-night: rgba(56, 189, 248, 0.2);
            
            --accent-interactive-day: #007AFF;
            --text-primary-day: #111827;
            --text-secondary-day: #4B5563;
            --bg-widget-day: linear-gradient(160deg, rgba(240, 248, 255, 0.92) 0%, rgba(225, 238, 252, 0.90) 100%);
            --border-widget-day: rgba(0, 122, 255, 0.18);
            
            /* H≈ëm√©rs√©kletf√ºgg≈ë sz√≠nek */
            --hot: #EF4444;
            --warm: #F97316;
            --mild: #22C55E;
            --cool: #3B82F6;
            --cold: #6366F1;
            --current-temp-bg-color: var(--mild);
            
            /* Leveg≈ëmin≈ës√©g sz√≠nek */
            --level-good: #22C55E;
            --level-moderate: #FBBF24;
            --level-unhealthy-sensitive: #F97316;
            --level-unhealthy: #EF4444;
            --level-very-unhealthy: #A21CAF;
            --level-hazardous: #7E22CE;
            
            /* Es≈ë √°llapot sz√≠nek */
            --raining-text-color-day: #0369a1;
            --raining-text-color-night: #93c5fd;

            /* 12 F√ÅZIS√ö CIKLUS DEFIN√çCI√ìJA */
            --sky-color-top-night: #0B1120; --sky-color-bottom-night: #020617; --sky-color-top-early-dawn: #020617; --sky-color-bottom-early-dawn: #0f172a; --sky-color-top-blue-hour-dawn: #0f172a; --sky-color-bottom-blue-hour-dawn: #1e3a8a; --sky-color-top-dawn: #1e293b; --sky-color-bottom-dawn: #f97316; --sky-color-top-sunrise: #fef3c7; --sky-color-bottom-sunrise: #fb923c; --sky-color-top-golden-hour-rise: #fde68a; --sky-color-bottom-golden-hour-rise: #fca5a5; --sky-color-top-day: #7DD3FC; --sky-color-bottom-day: #C4EFFF; --sky-color-top-golden-hour-set: #fbbf24; --sky-color-bottom-golden-hour-set: #f87171; --sky-color-top-sunset: #f97316; --sky-color-bottom-sunset: #dc2626; --sky-color-top-dusk: #0369a1; --sky-color-bottom-dusk: #4c1d95; --sky-color-top-blue-hour-dusk: #1e3a8a; --sky-color-bottom-blue-hour-dusk: #312e81; --sky-color-top-late-dusk: #111827; --sky-color-bottom-late-dusk: #0c0a09;

            /* Aktu√°lis T√©ma (kezdetben √©jszakai) */
            --current-sky-color-top: var(--sky-color-top-night); --current-sky-color-bottom: var(--sky-color-bottom-night); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: var(--accent-interactive-night); --current-widget-bg: var(--bg-widget-night); --current-widget-border: var(--border-widget-night); --current-container-border-color: var(--border-widget-night); --current-raining-text-color: var(--raining-text-color-night);
        }

        body[data-theme="day"] { --current-sky-color-top: var(--sky-color-top-day); --current-sky-color-bottom: var(--sky-color-bottom-day); --current-text-color: var(--text-primary-day); --current-text-muted-color: var(--text-secondary-day); --current-icon-color: var(--accent-interactive-day); --current-widget-bg: var(--bg-widget-day); --current-widget-border: var(--border-widget-day); --current-container-border-color: rgba(203, 213, 225, 0.55); --current-raining-text-color: var(--raining-text-color-day); }
        body[data-theme="dawn"] { --current-sky-color-top: var(--sky-color-top-dawn); --current-sky-color-bottom: var(--sky-color-bottom-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #f59e0b; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(245, 158, 11, 0.3); --current-container-border-color: rgba(71, 85, 105, 0.5); --current-raining-text-color: var(--raining-text-color-night); }
        body[data-theme="dusk"] { --current-sky-color-top: var(--sky-color-top-dusk); --current-sky-color-bottom: var(--sky-color-bottom-dusk); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #f472b6; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(236, 72, 153, 0.3); --current-container-border-color: rgba(71, 85, 105, 0.5); --current-raining-text-color: var(--raining-text-color-night); }
        body[data-theme="early_dawn"] { --current-sky-color-top: var(--sky-color-top-early-dawn); --current-sky-color-bottom: var(--sky-color-bottom-early-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: #94a3b8; --current-icon-color: #60a5fa; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(96, 165, 250, 0.2); --current-container-border-color: rgba(51, 65, 85, 0.5); --current-raining-text-color: var(--raining-text-color-night); }
        body[data-theme="blue_hour_dawn"] { --current-sky-color-top: var(--sky-color-top-blue-hour-dawn); --current-sky-color-bottom: var(--sky-color-bottom-blue-hour-dawn); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #93c5fd; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(147, 197, 253, 0.2); --current-container-border-color: rgba(71, 85, 105, 0.5); --current-raining-text-color: var(--raining-text-color-night); }
        body[data-theme="sunrise"] { --current-sky-color-top: var(--sky-color-top-sunrise); --current-sky-color-bottom: var(--sky-color-bottom-sunrise); --current-text-color: #422006; --current-text-muted-color: #7c2d12; --current-icon-color: #f97316; --current-widget-bg: linear-gradient(160deg, rgba(254, 243, 199, 0.92) 0%, rgba(253, 186, 116, 0.90) 100%); --current-widget-border: rgba(249, 115, 22, 0.25); --current-container-border-color: rgba(124, 45, 18, 0.4); --current-raining-text-color: #422006; }
        body[data-theme="golden_hour_rise"] { --current-sky-color-top: var(--sky-color-top-golden-hour-rise); --current-sky-color-bottom: var(--sky-color-bottom-golden-hour-rise); --current-text-color: #44403c; --current-text-muted-color: #78716c; --current-icon-color: #f59e0b; --current-widget-bg: linear-gradient(160deg, rgba(254, 249, 231, 0.92) 0%, rgba(253, 224, 224, 0.90) 100%); --current-widget-border: rgba(245, 158, 11, 0.2); --current-container-border-color: rgba(168, 162, 158, 0.5); --current-raining-text-color: #44403c; }
        body[data-theme="golden_hour_set"] { --current-sky-color-top: var(--sky-color-top-golden-hour-set); --current-sky-color-bottom: var(--sky-color-bottom-golden-hour-set); --current-text-color: #44403c; --current-text-muted-color: #78716c; --current-icon-color: #ea580c; --current-widget-bg: linear-gradient(160deg, rgba(254, 235, 202, 0.92) 0%, rgba(254, 202, 202, 0.90) 100%); --current-widget-border: rgba(249, 115, 22, 0.2); --current-container-border-color: rgba(168, 162, 158, 0.5); --current-raining-text-color: #44403c; }
        body[data-theme="sunset"] { --current-sky-color-top: var(--sky-color-top-sunset); --current-sky-color-bottom: var(--sky-color-bottom-sunset); --current-text-color: #fef2f2; --current-text-muted-color: #fecaca; --current-icon-color: #ef4444; --current-widget-bg: linear-gradient(160deg, rgba(127, 29, 29, 0.9) 0%, rgba(76, 29, 29, 0.92) 100%); --current-widget-border: rgba(239, 68, 68, 0.25); --current-container-border-color: rgba(159, 18, 57, 0.4); --current-raining-text-color: #fef2f2; }
        body[data-theme="blue_hour_dusk"] { --current-sky-color-top: var(--sky-color-top-blue-hour-dusk); --current-sky-color-bottom: var(--sky-color-bottom-blue-hour-dusk); --current-text-color: var(--text-primary-night); --current-text-muted-color: var(--text-secondary-night); --current-icon-color: #a78bfa; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(167, 139, 250, 0.2); --current-container-border-color: rgba(71, 85, 105, 0.5); --current-raining-text-color: var(--raining-text-color-night); }
        body[data-theme="late_dusk"] { --current-sky-color-top: var(--sky-color-top-late-dusk); --current-sky-color-bottom: var(--sky-color-bottom-late-dusk); --current-text-color: #d1d5db; --current-text-muted-color: #9ca3af; --current-icon-color: #818cf8; --current-widget-bg: var(--bg-widget-night); --current-widget-border: rgba(99, 102, 241, 0.2); --current-container-border-color: rgba(55, 65, 81, 0.5); --current-raining-text-color: var(--raining-text-color-night); }
        
        .is-hidden { display: none !important; }
        body { font-family: 'Inter', sans-serif; font-weight: 500; background-color: #020617; min-height: 100vh; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; position: relative; overflow-x: hidden; transition: background-color 1.5s ease-in-out; }
        .sky-gradient-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, var(--current-sky-color-top), var(--current-sky-color-bottom)); transition: background 2s ease-in-out; z-index: -1; }
        .weather-widget { border-radius: 18px; padding: 22px 24px; width: 100%; max-width: 800px; box-sizing: border-box; margin: 0 auto; position: relative; z-index: 10; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 5px 18px rgba(0,0,0,0.12), 0 2px 7px rgba(0,0,0,0.18); backdrop-filter: blur(20px) saturate(140%); -webkit-backdrop-filter: blur(20px) saturate(140%); transition: all 0.6s ease-in-out; }
        #weather-display { position: relative; z-index: 1; display: flex; flex-direction: column; }
        .widget-header { text-align: center; margin-bottom: 10px; padding-bottom: 8px; }
        .copyright-notice { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); text-align: center; opacity: 0.85; letter-spacing: 0.2px; margin-top: 10px; transition: color 0.6s; }
        .header-container { display: inline-block; background-color: rgba(0, 0, 0, 0.1); padding: 8px 24px; border-radius: 12px; margin-bottom: 4px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); transition: all 0.6s; }
        .location-title { font-size: 22px; font-weight: 800; color: var(--current-text-color); line-height: 1.1; letter-spacing: -0.5px; }
        .station-subtitle { font-size: 13px; font-weight: 500; color: var(--current-text-muted-color); line-height: 1.2; margin-top: 2px; }
        .timestamp-container { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .timestamp { font-size: 12.5px; font-weight: 500; color: var(--current-text-muted-color); transition: color 0.6s; }
        .info-tooltip-container { position: relative; cursor: help; color: var(--current-text-muted-color); line-height: 1; }
        .info-tooltip-container .fa-info-circle { transition: color 0.3s; }
        .info-tooltip-container:hover .fa-info-circle { color: var(--current-icon-color); }
        .info-tooltip-content { visibility: hidden; opacity: 0; position: absolute; top: calc(100% + 12px); left: 50%; transform: translateX(-50%); width: max-content; max-width: 450px; background-color: #f9fafb; color: #1f2937; text-align: left; border-radius: 8px; padding: 12px 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: opacity 0.3s, visibility 0.3s; font-size: 12px; line-height: 1.6; z-index: 1000; }
        .info-tooltip-content::after { content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: transparent transparent #f9fafb transparent; }
        .info-tooltip-container:hover .info-tooltip-content { visibility: visible; opacity: 1; }
        .info-tooltip-content strong { display: block; margin-bottom: 4px; color: #000; font-weight: 700; }
        .info-tooltip-content p, .info-tooltip-content ul { margin: 0 0 10px 0; padding-left: 0; }
        .info-tooltip-content ul { list-style-position: inside; padding-left: 4px; }
        .info-tooltip-content li { margin-bottom: 2px; }
        .info-tooltip-content p:last-child { margin-bottom: 0; }
        .station-status-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; text-align: center; padding: 10px 0; border-top: 1px solid var(--current-container-border-color); border-bottom: 1px solid var(--current-container-border-color); transition: border-color 0.6s; margin-top: 10px; }
        .station-selector { flex: 1; }
        .station-selector label { cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--current-text-color); font-weight: 500; transition: color 0.6s; }
        .station-selector input[type="radio"] { margin: 0 0 4px 0; accent-color: var(--current-icon-color); }
        .station-selector.disabled label { opacity: 0.55; cursor: not-allowed; }
        .station-name { font-size: 12px; font-weight: 600; line-height: 1; }
        .station-status-text { color: var(--current-text-muted-color); font-weight: 400; font-size: 10px; line-height: 1; transition: color 0.6s; margin-top: 2px; }
        
        .top-info-cards-container { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 16px; margin-bottom: 16px; align-items: stretch; }
        .info-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; color: var(--current-text-color); font-family: 'Inter', sans-serif; text-align: center; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); transition: all 0.6s ease; border-radius: 12px; }
        .temp-card { flex: 1 1 140px; background: linear-gradient(145deg, var(--current-temp-bg-color), color-mix(in srgb, var(--current-temp-bg-color) 70%, black)) !important; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        
        .temp-card .card-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; transition: background-color 0.5s; }
        .status-dot.fresh { background-color: #4ade80; box-shadow: 0 0 5px #4ade80; }
        .status-dot.stale { background-color: #facc15; }
        .status-dot.offline { background-color: #f87171; }
        .live-tag { font-size: 9px; background-color: rgba(255, 255, 255, 0.15); color: #e5e7eb; padding: 2px 6px; border-radius: 6px; font-weight: 700; letter-spacing: 0.5px; }
        .temp-card .card-main-value { font-size: 40px; font-weight: 800; line-height: 1; }
        .temp-trend-arrow { font-size: 0.5em; vertical-align: middle; margin-left: 2px; font-weight: 600; width: 12px; display: inline-block; }
        .precip-icon { font-size: 0.4em; vertical-align: middle; margin-left: 4px; opacity: 0.8; }

        .sensation-card { flex: 3 1 300px; padding: 12px; align-items: stretch; }
        .sensation-list { display: flex; flex-direction: column; justify-content: space-around; gap: 12px; width: 100%; height: 100%; }
        .sensation-item { display: flex; align-items: center; gap: 12px; text-align: left; }
        .sensation-item .icon { font-size: 1.2em; color: var(--current-icon-color); width: 20px; text-align: center; }
        .sensation-item .text-content { display: flex; flex-wrap: wrap; align-items: baseline; gap: 4px 8px; flex-grow: 1; }
        .sensation-item .label { font-size: 13px; font-weight: 600; color: var(--current-text-color); margin-right: 4px; }
        .sensation-item .value { font-size: 14px; font-weight: 500; color: var(--current-text-muted-color); }
        .sensation-item .description { font-size: 13px; font-weight: 700; color: var(--current-text-muted-color); }

        .sun-info-section, .moon-info-section, .night-sky-info-section, .air-quality-info-section { display: flex; align-items: flex-start; justify-content: center; gap: 20px; min-height: 180px; width: 100%; flex-wrap: wrap; margin-top: 12px; }
        .sun-text-details, .moon-text-details, .rain-text-details, .night-sky-text-details { text-align: left; display: flex; flex-direction: column; gap: 6px; font-size: 12px; flex-grow: 1; min-width: 0; flex-basis: 130px; transition: opacity 0.5s ease-in-out; }
        #iss-info .night-sky-text-details { min-width: 250px; flex-basis: 250px; }
        .sun-detail-item, .moon-detail-item, .rain-detail-item, .night-sky-detail-item { display: flex; justify-content: space-between; align-items: baseline; padding: 6px 8px; border-radius: 8px; border-bottom: none; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); background-color: rgba(0, 0, 0, 0.08); }
        
        .rain-detail-item:hover, .night-sky-detail-item:hover { background-color: rgba(255, 255, 255, 0.07); transform: translateY(-2px) scale(1.02); }
        .sun-detail-item, .moon-detail-item { transition: background-color 0.25s; }
        .sun-detail-item:hover, .moon-detail-item:hover { background-color: rgba(255, 255, 255, 0.07); transform: none; }

        .sun-detail-label, .moon-detail-label, .rain-detail-label, .night-sky-detail-label { display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 11px; color: var(--current-text-muted-color); text-transform: uppercase; letter-spacing: 0.3px; transition: color 0.6s; flex-shrink: 0; }
        .sun-detail-label i, .moon-detail-label i, .rain-detail-label i, .night-sky-detail-label i { width: 13px; text-align: center; font-size: 1em; color: var(--current-icon-color); opacity: 0.7; transition: color 0.6s, opacity 0.6s; }
        .sun-detail-value, .moon-detail-value, .rain-detail-value, .night-sky-detail-value { font-weight: 700; font-size: 14px; color: var(--current-text-color); transition: color 0.6s; display: flex; align-items: center; text-align: right; flex-grow: 1; justify-content: flex-end; white-space: normal; word-break: break-word; line-height: 1.25; }
        .night-sky-detail-value.long-text { font-size: 10.5px; white-space: normal; line-height: 1.3; text-align: left; justify-content: flex-start; }
        .sun-trend-text, .moon-trend-text { font-size: 0.75em; font-weight: 500; opacity: 0.7; margin-left: 4px; }
        .path-refresh-btn { font-size: 0.75em; margin-left: 6px; cursor: pointer; opacity: 0.6; transition: opacity 0.3s, color 0.3s, transform 0.3s; }
        .path-refresh-btn:hover { opacity: 1; color: var(--current-icon-color); }
        .path-refresh-btn.is-refreshing { transform: rotate(360deg); transition: transform 0.8s; }
        
        .regional-precip-section { margin: 20px auto 0; padding: 16px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); border-radius: 12px; width: 100%; max-width: 600px; box-sizing: border-box; }
        .regional-precip-section h3 { font-size: 15px; color: var(--current-text-color); margin-top: 0; margin-bottom: 12px; text-align: center; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .regional-precip-grid { display: flex; flex-direction: column; gap: 8px; }
        .precip-station-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: baseline; padding: 8px 12px; background-color: rgba(0,0,0,0.12); border-radius: 8px; transition: all 0.3s; border-left: 3px solid transparent; }
        .precip-station-item .station-name { font-size: 14px; font-weight: 700; color: var(--current-text-color); margin-right: 15px; }
        .precip-station-item.is-raining-highlight { background-color: rgba(from var(--current-icon-color) r g b / 0.15); border-left-color: var(--current-icon-color); box-shadow: inset 3px 0 8px -4px rgba(from var(--current-icon-color) r g b / 0.5); }
        .precip-station-item .station-data-wrapper { display: flex; align-items: baseline; gap: 12px; flex-shrink: 0; }
        .precip-station-item .station-data.intensity { font-size: 14px; font-weight: 600; color: var(--current-text-muted-color); transition: color 0.3s, text-shadow 0.3s; }
        .precip-station-item .station-data.intensity.is-raining { color: var(--current-raining-text-color); text-shadow: 0 0 5px rgba(from var(--current-raining-text-color) r g b / 0.5); }
        .precip-station-item .station-data.total { font-size: 12px; font-weight: 500; color: var(--current-text-muted-color); opacity: 0.9; }
        .precip-station-item .station-data.total strong { font-weight: 600; color: var(--current-text-color); }

        .celestial-path-visual-v2 { width: 280px; height: 165px; position: relative; display: flex; justify-content: center; align-items: center; flex-shrink: 0; transition: all 0.5s ease-in-out; }
        .celestial-path-svg-v2 { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible; transition: opacity 0.5s; }
        .path-arc-bg-v2, .path-arc-main-v2 { fill: none; stroke-linecap: round; }
        .path-arc-bg-v2 { stroke-width: 2px; stroke: var(--current-text-muted-color); stroke-dasharray: 2 4; opacity: 0.35; }
        .path-arc-main-v2 { stroke-width: 3px; }
        .path-ground-v2 { position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(to top, rgba(0,0,0,0.1), transparent); border-top: 1.5px solid var(--current-container-border-color); z-index: 5; transition: all 0.6s ease; }
        .path-label-v2 { position: absolute; bottom: 5px; font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); display: flex; flex-direction: column; align-items: center; }
        .path-label-v2.sunrise-label { left: 10px; }
        .path-label-v2.sunset-label { right: 10px; }
        .path-label-v2 .path-time-v2 { font-weight: 700; font-size: 12px; color: var(--current-text-color); }
        .celestial-body-icon-v2 { position: absolute; top: 0; left: 0; z-index: 15; pointer-events: auto; cursor: help; font-size: 0; color: transparent; will-change: transform, background-color, box-shadow, color, text-shadow; transition: background-color 0.5s, box-shadow 0.5s, color 0.5s, text-shadow 0.5s, opacity 0.5s; }
        #sun-path-icon-v2 { width: 22px; height: 22px; background-color: #FFD700; border-radius: 50%; box-shadow: 0 0 10px 3px gold, 0 0 18px 6px rgba(255, 215, 0, 0.45), inset 0 0 4px rgba(255, 255, 220, 0.6); }
        
        #moon-path-icon-v2 { width: 28px; height: 28px; font-size: 28px; line-height: 28px; text-align: center; color: #E8EAF6; text-shadow: 0 0 7px rgba(200, 200, 255, 0.6), 0 0 13px rgba(150, 150, 220, 0.4); transition: all 0.5s ease-in-out; }

        .celestial-path-visual-v2.is-event-active .celestial-path-svg-v2, .celestial-path-visual-v2.is-event-active .path-label-v2 { opacity: 0.3; pointer-events: none; }
        .celestial-path-visual-v2.is-event-active .path-ground-v2 { border-top-width: 2px; opacity: 0.8; }
        .celestial-event-container-v2 { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; z-index: 20; }
        .celestial-path-visual-v2.is-event-active .celestial-event-container-v2 { opacity: 1; pointer-events: auto; }
        .celestial-event-message-v2 { font-size: 13px; font-weight: 500; color: var(--current-text-muted-color); line-height: 1.3; }
        .celestial-event-countdown-v2 { font-size: 18px; font-weight: 700; color: var(--current-text-color); margin-top: 4px; }
        .night-sky-info-section { transition: opacity 0.4s ease-in-out; }
        .night-sky-info-section.is-fading { opacity: 0; }
        .night-sky-visual { text-align: center; }
        .night-sky-visual i { font-size: 48px; margin-bottom: 8px; color: var(--current-text-muted-color); transition: color 0.6s; }
        #planet-info .night-sky-visual i.fa-ring { color: #E3D4A8; text-shadow: 0 0 10px #E3D4A8; }
        #planet-info .night-sky-visual i.fa-circle { text-shadow: 0 0 10px #E27B58; color: #E27B58; }
        #planet-info .night-sky-visual i.fa-globe-europe { color: #d8b89d; text-shadow: 0 0 10px #d8b89d; }
        #planet-info .night-sky-visual i.fa-dot-circle { color: #a7b3c2; text-shadow: 0 0 12px #cdd8e6; }
        #planet-info .night-sky-visual i.fa-meteor { color: #facc15; text-shadow: 0 0 12px #fef08a; }
        #planet-info .night-sky-visual i.fa-star { color: #fefce8; text-shadow: 0 0 12px #fef9c3; }
        #iss-info .night-sky-visual i.fa-satellite { color: #B0B0B0; text-shadow: 0 0 8px #FFFFFF;}
        #constellation-svg-container { width: 100px; height: 80px; margin: 0 auto; }
        #constellation-svg-container svg { width: 100%; height: 100%; }
        #constellation-svg-container .star { fill: var(--text-secondary-night); }
        #constellation-svg-container .star.bright { fill: #ffffff; }
        #constellation-svg-container .const-line { stroke: var(--text-secondary-night); stroke-width: 1px; opacity: 0.5; }
        .air-quality-info-section { flex-direction: column; width: 100%; gap: 12px; }
        .air-quality-title { font-size: 15px; font-weight: 700; color: var(--current-text-color); padding-bottom: 6px; border-bottom: 1px solid var(--current-container-border-color); width: 100%; max-width: 400px; }
        .air-quality-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; width: 100%; max-width: 500px; }
        .air-quality-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background-color: rgba(0,0,0,0.12); border-radius: 10px; text-align: center; }
        .air-quality-label { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: var(--current-text-muted-color); text-transform: uppercase; }
        .air-quality-label i { font-size: 0.9em; opacity: 0.8; }
        .air-quality-value-container { display: flex; align-items: baseline; gap: 4px; }
        .air-quality-value { font-size: 16px; font-weight: 700; color: var(--current-text-color); }
        .air-quality-value-unit { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); }
        .air-quality-description { font-size: 11px; font-weight: 500; font-style: italic; }
        .air-quality-description.level-good { color: var(--level-good); }
        .air-quality-description.level-moderate { color: var(--level-moderate); }
        .air-quality-description.level-high, .air-quality-description.level-unhealthy-sensitive { color: var(--level-unhealthy-sensitive); }
        .air-quality-description.level-very-high, .air-quality-description.level-unhealthy { color: var(--level-unhealthy); }

        .weather-details-grid { margin-top: 20px; background-color: rgba(0,0,0,0.08); border: 1px solid var(--current-container-border-color); border-radius: 12px; padding: 12px 14px; display: grid; grid-template-columns: 1fr 1fr; column-gap: 14px; row-gap: 8px; transition: all 0.6s; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; font-size: 13.5px; padding: 4px 0; }
        .detail-item .label { font-weight: 600; color: var(--current-text-color); margin-right: 4px; display: flex; align-items: center; transition: color 0.6s; white-space: nowrap; }
        .detail-item .label i { margin-right: 6px; width: 14px; font-size: 0.9em; text-align: center; opacity: 0.8; color: var(--current-icon-color); transition: color 0.6s; }
        .detail-item .value { color: var(--current-text-muted-color); font-weight: 500; transition: color 0.6s; display: flex; align-items: center; text-align: right; flex-shrink: 0; margin-left: 3px; }
        .pressure-trend-icon { margin-left: 4px; font-weight: 700; }
        .uv-description-text { margin-left: 4px; font-size: 0.88em; font-style: italic; }

        .forecast-title { width: 100%; max-width: 800px; font-size: 16px; font-weight: 700; color: var(--current-text-color); margin-top: 24px; margin-bottom: 12px; text-align: center; transition: color 0.6s; }
        .hourly-forecast-container { width: 100%; max-width: 800px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 4px; box-sizing: border-box; margin: 0 auto; }
        .hourly-forecast-card { display: flex; flex-direction: column; align-items: stretch; gap: 10px; padding: 10px; border-radius: 12px; background: var(--current-widget-bg); border: 1px solid var(--current-widget-border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--current-text-color); transition: all 0.6s; }
        .hourly-primary-info { display: flex; flex-direction: row; align-items: center; justify-content: space-around; gap: 8px; }
        .hourly-time { font-size: 13px; font-weight: 700; flex-shrink: 0; }
        .hourly-icon-and-condition { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .hourly-icon { font-size: 24px; color: var(--current-icon-color); transition: color 0.6s; }
        .hourly-condition-text { font-size: 10px; font-weight: 500; color: var(--current-text-muted-color); white-space: nowrap; text-align: center; }
        .hourly-temp { font-size: 18px; font-weight: 700; flex-shrink: 0; }
        .hourly-secondary-details { display: flex; flex-direction: column; align-items: stretch; gap: 5px; font-size: 11px; border-top: 1px solid var(--current-container-border-color); padding-top: 8px; margin-top: 4px; }
        .hourly-detail-row { display: flex; justify-content: space-between; align-items: center; }
        .hourly-detail-row span { display: flex; align-items: center; gap: 5px; }
        .hourly-detail-row i { width: 12px; text-align: center; opacity: 0.7; }
        
        .flippable-value { display: inline-block; transition: transform 0.6s cubic-bezier(0.45, 0, 0.55, 1); transform-style: preserve-3d; will-change: transform; }
        .flippable-value.is-flipping { transform: rotateX(90deg); }

        /* Reszponz√≠v M√≥dos√≠t√°sok */
        @media (min-width: 640px) { .hourly-forecast-container { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1000px) { .hourly-forecast-container { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1000px) { .weather-widget { max-width: 960px; } }
        
        @media (max-width: 768px) {
            body { padding: 15px; }
            .weather-widget { padding: 18px; }
            .sun-info-section, .moon-info-section, .night-sky-info-section, .air-quality-info-section { flex-direction: column; align-items: center; gap: 15px; }
            .sun-text-details, .moon-text-details, .rain-text-details, .night-sky-text-details { width: 100%; max-width: 320px; text-align: center; }
            .sun-detail-item, .moon-detail-item, .rain-detail-item, .night-sky-detail-item { justify-content: space-between; }
            #iss-info .night-sky-text-details { min-width: unset; flex-basis: auto; }
            .night-sky-detail-value.long-text { text-align: right; justify-content: flex-end; }
            .weather-details-grid { grid-template-columns: 1fr; row-gap: 8px; }
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .weather-widget { padding: 15px; }
            .location-title { font-size: 20px; }
            .station-subtitle { font-size: 12px; }
            .header-container { padding: 6px 18px; }
            .air-quality-grid { grid-template-columns: 1fr 1fr; }
            .celestial-path-visual-v2 { width: 100%; max-width: 280px; }
            .precip-station-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .precip-station-item .station-data-wrapper { justify-content: flex-start; width: 100%; }
        }
    </style>
</head>
<body data-theme="night">

    <div class="sky-gradient-overlay"></div>

    <div class="weather-widget">
        <div id="weather-display"></div>
    </div>

    <h3 class="forecast-title is-hidden" id="hourly-forecast-title">A k√∂vetkez≈ë √≥r√°kban v√°rhat√≥ id≈ëj√°r√°s</h3>

    <div class="hourly-forecast-container" id="hourly-forecast-container"></div>

    <script>
        const weatherComApiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
        const REFRESH_INTERVAL_PWS = 30 * 1000;
        const REFRESH_INTERVAL_GENERAL_CONDITIONS = 20 * 60 * 1000;
        const REFRESH_INTERVAL_AIR_QUALITY = 30 * 60 * 1000;
        const REFRESH_INTERVAL_FORECAST = 15 * 60 * 1000;
        const SKY_COLOR_UPDATE_INTERVAL = 1 * 60 * 1000;
        const NYIREGYHAZA_COORDS = { lat: 47.9550, lon: 21.7160 };

        const ENABLE_ISS_TRACKING = true;
        const N2YO_API_KEY = '589P8Q-SDRYX8-L842ZD-5Z9L';
        const OBSERVER_ALTITUDE = 120;
        const ISS_NORAD_ID = 25544;
        const REFRESH_INTERVAL_ISS = 2 * 60 * 60 * 1000;
        const STALE_DATA_THRESHOLD_MS = 30 * 60 * 1000;

        const STATIONS = {
            NYIREGYHAZI_UT: { id: 'INYREG26', name: 'Ny√≠regyh√°za Ny√≠regyh√°zi √∫ti √°llom√°s', displayName: 'Ny√≠regyh√°zi √∫t', provides: ['precip', 'temp'], isOnline: false, data: null },
            KOSSUTH: { id: 'INYREG42', name: 'Ny√≠regyh√°za Kossuth √∫t 50 √°llom√°s', displayName: 'Kossuth √∫t 50', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure', 'precip'], isOnline: false, data: null },
            HONVED: { id: 'INYREG37', name: 'Ny√≠regyh√°za Honv√©d utcai √°llom√°s', displayName: 'Honv√©d u.', provides: ['temp', 'wind', 'humidity', 'solar', 'uv', 'pressure'], isOnline: false, data: null },
            SOSTOHEGY: { id: 'INYREG11', name: 'Ny√≠regyh√°za-S√≥st√≥hegy PWS', displayName: 'S√≥st√≥hegy', provides: ['precip', 'temp'], isOnline: false, data: null },
            ALLATPARK: { id: 'INYREG20', name: 'Ny√≠regyh√°zi √Ållatpark PWS', displayName: 'Ny√≠regyh√°zi √Ållatpark', provides: ['precip', 'temp'], isOnline: false, data: null },
            NAPKOR: { id: 'INAPKO1', name: 'Napkor PWS', displayName: 'Napkor', provides: ['precip', 'temp'], isOnline: false, data: null },
            KALLOSEMJEN: { id: 'IKLLSE3', name: 'K√°ll√≥semj√©n PWS', displayName: 'K√°ll√≥semj√©n', provides: ['precip', 'temp'], isOnline: false, data: null },
            KEMECSE: { id: 'IKEMEC1', name: 'Kemecse PWS', displayName: 'Kemecse', provides: ['precip', 'temp'], isOnline: false, data: null },
            BERKESZ: { id: 'IBERKE55', name: 'Berkesz PWS', displayName: 'Berkesz', provides: ['precip', 'temp'], isOnline: false, data: null },
            NAGYHALASZ: { id: 'INAGYH4', name: 'Nagyhal√°sz PWS', displayName: 'Nagyhal√°sz', provides: ['precip', 'temp'], isOnline: false, data: null },
            KISVARDA: { id: 'IKISVR2', name: 'Kisv√°rda PWS', displayName: 'Kisv√°rda', provides: ['precip', 'temp'], isOnline: false, data: null },
            CIGAND: { id: 'ICIGND1', name: 'Cig√°nd PWS', displayName: 'Cig√°nd', provides: ['precip', 'temp'], isOnline: false, data: null },
            SZAKOLY: { id: 'ISZAKO1', name: 'Szakoly PWS', displayName: 'Szakoly', provides: ['precip', 'temp'], isOnline: false, data: null },
            TEGLAS: { id: 'ITGLS2', name: 'T√©gl√°s PWS', displayName: 'T√©gl√°s', provides: ['precip', 'temp'], isOnline: false, data: null },
            BUJ: { id: 'IBUJ5', name: 'Buj PWS', displayName: 'Buj', provides: ['precip', 'temp'], isOnline: false, data: null },
        };
        let activeDisplayStationKey = 'NYIREGYHAZI_UT';

        let lastApiCallTimes = { generalConditions: 0, forecast: 0, issPasses: 0, airQuality: 0 };
        let cachedData = {
            displayPws: null,
            generalConditions: { skyCoverPhrase: null, pressureAltimeter: null, visibility: null, sunriseTimeLocal: null, sunsetTimeLocal: null, dayOrNight: null, pressureTendencyCode: null, uvDescription: null },
            hourlyForecast: [],
            sunCalc: null,
            issPasses: [],
            airQuality: null,
            previousTemperatures: {},
        };
        let isWeatherDisplayInitialized = false;
        let currentDay = new Date().getDate();

        let weatherDisplayEl, hourlyForecastContainerEl, hourlyForecastTitleEl;
        const NO_DATA_STRING = 'N/A';
        const NO_FRESH_DATA_STRING = 'Nincs friss adat';
        
        let animationFrameId = null;
        
        const CELESTIAL_EVENT_DURATION_MS = 10 * 60 * 1000;
        const CELESTIAL_RISE_TRANSITION_ALTITUDE = 0.6; 
        const CELESTIAL_SET_TRANSITION_ALTITUDE = -0.6;
        
        let celestialBodyStates = {
            sun: { currentState: 'UNKNOWN', previousState: 'UNKNOWN' },
            moon: { currentState: 'UNKNOWN', previousState: 'UNKNOWN' }
        };

        let masterTickCounter = 0;

        let nightSkyRotationInterval = null;
        let recentlyShownSkyObjects = new Map();
        const NIGHT_SKY_ROTATION_INTERVAL_MS = 60 * 1000;
        const NIGHT_SKY_OBJECT_COOLDOWN_MS = 10 * 60 * 1000;
        const NIGHT_SKY_OBJECTS = [
            {id:'venus_evening',type:'planet',name:'V√©nusz (Esthajnalcsillag)',icon:'far fa-circle',status:'Napnyugta ut√°n a nyugati √©gen ragyog',details:'Rendk√≠v√ºl f√©nyes, vak√≠t√≥ jelens√©g. F√°zisai t√°vcs≈ëvel megfigyelhet≈ëk.',visibilityCheck:(m,h)=>(m>=3&&m<=7)&&(h>=18&&h<=21)},
            {id:'venus_morning',type:'planet',name:'V√©nusz (Hajnalcsillag)',icon:'far fa-circle',status:'Napkelte el≈ëtt keleten t√ºnd√∂k√∂l',details:'Az √©gbolt legf√©nyesebb bolyg√≥ja a Hold ut√°n. Nem lehet elt√©veszteni.',visibilityCheck:(m,h)=>(m>=9&&m<=12||m<=2)&&(h>=4&&h<=7)},
            {id:'mars',type:'planet',name:'Mars',icon:'fas fa-circle',status:'V√∂r√∂ses f√©nypont, √©jf√©l k√∂r√ºl magasan',details:'A "v√∂r√∂s bolyg√≥" jellegzetes sz√≠n√©r≈ël k√∂nnyen azonos√≠that√≥. F√©nyess√©ge nagyban v√°ltozik.',visibilityCheck:(m,h)=>(m>=1&&m<=4||m>=10)&&(h>=20||h<=4)},
            {id:'jupiter',type:'planet',name:'Jupiter',icon:'fas fa-globe-europe',status:'F√©nyes, uralkod√≥ jelens√©g az √©gen',details:'A Naprendszer legnagyobb bolyg√≥ja. N√©gy nagy holdja (Galilei-holdak) k√©zit√°vcs≈ëvel is l√°that√≥.',visibilityCheck:(m,h)=>(m>=5&&m<=12)&&(h>=20||h<=5)},
            {id:'saturn',type:'planet',name:'Szaturnusz',icon:'fas fa-ring',status:'Ny√°ri-≈ëszi est√©ken, a d√©li √©gbolton',details:'Gy≈±r≈±i m√°r egy kisebb t√°vcs≈ëvel is gy√∂ny√∂r≈±en l√°tszanak. S√°rg√°s, nyugodt f√©ny≈±.',visibilityCheck:(m,h)=>(m>=6&&m<=11)&&(h>=21||h<=3)},
            {id:'sirius',type:'star',name:'Sz√≠riusz',icon:'fas fa-star',status:'A t√©li √©gbolt legf√©nyesebb csillaga',details:'A Nagy Kutya csillagk√©p f≈ëcsillaga. Felt≈±n≈ëen szipork√°zik, gyakran v√°ltoztatja sz√≠n√©t a l√©gk√∂ri turbulencia miatt.',visibilityCheck:(m,h)=>(m>=11||m<=4)&&(h>=20||h<=5)},
            {id:'arcturus',type:'star',name:'Arcturus',icon:'fas fa-star',status:'Tavaszi-ny√°ri est√©k narancsos csillaga',details:'Az √©szaki √©gbolt legf√©nyesebb csillaga. A G√∂nc√∂lszek√©r r√∫dj√°nak √≠v√©t k√∂vetve k√∂nnyen megtal√°lhat√≥.',visibilityCheck:(m,h)=>(m>=3&&m<=8)&&(h>=20||h<=2)},
            {id:'vega',type:'star',name:'Vega',icon:'fas fa-star',status:'A ny√°ri √©gbolt egyik cs√∫csa',details:'A Lant (Lyra) csillagk√©p legf√©nyesebb, k√©kesfeh√©r csillaga. A Ny√°ri H√°romsz√∂g egyik tagja.',visibilityCheck:(m,h)=>(m>=5&&m<=10)&&(h>=21||h<=4)},
            {id:'capella',type:'star',name:'Capella',icon:'fas fa-star',status:'A t√©li √©gbolt f√©nyes, s√°rg√°s csillaga',details:'Az Auriga (Szekeres) csillagk√©p f≈ëcsillaga. Val√≥j√°ban k√©t, egym√°shoz k√∂zeli csillagb√≥l √°ll√≥ rendszer.',visibilityCheck:(m,h)=>(m>=10||m<=4)&&(h>=19||h<=6)},
            {id:'rigel',type:'star',name:'Rigel',icon:'fas fa-star',status:'Az Orion jobb als√≥, k√©kesfeh√©r csillaga',details:'Egy rendk√≠v√ºl forr√≥ √©s f√©nyes szuper√≥ri√°s, az √©gbolt egyik legf√©nyesebb csillaga.',visibilityCheck:(m,h)=>(m>=11||m<=3)&&(h>=19||h<=5)},
            {id:'polaris',type:'star',name:'Sarkcsillag (Polaris)',icon:'fas fa-star',status:'Az √©szaki √©gi p√≥lushoz k√∂zeli csillag',details:'A Kis Medve (Ursa Minor) r√∫dj√°nak v√©g√©n tal√°lhat√≥. L√°tsz√≥lagos mozdulatlans√°ga miatt seg√≠t az √©szaki ir√°ny meghat√°roz√°s√°ban.',visibilityCheck:(m,h)=>true},
            {id:'ursa_major',type:'constellation',name:'Nagy Medve (G√∂nc√∂lszek√©r)',svg:`<svg viewBox="0 0 100 80"><path class="const-line" d="M10,60 L30,45 L50,50 L70,40 L90,20" /><path class="const-line" d="M70,40 L68,58" /><circle cx="10" cy="60" r="2.2" class="star"></circle><circle cx="30" cy="45" r="2.2" class="star"></circle><circle cx="50" cy="50" r="2.2" class="star"></circle><circle cx="70" cy="40" r="2.5" class="star bright"></circle><circle cx="90" cy="20" r="2" class="star"></circle><circle cx="68" cy="58" r="2" class="star"></circle><circle cx="48" cy="25" r="1.8" class="star"></circle></svg>`,details:'A legismertebb csillagk√©p, seg√≠t megtal√°lni a Sarkcsillagot. R√∫dja az √©gi p√≥lus fel√© mutat.',visibilityCheck:(m,h)=>true},
            {id:'cassiopeia',type:'constellation',name:'Kassziopeia',svg:`<svg viewBox="0 0 100 80"><path d="M15,50 L35,25 L55,45 L75,20 L95,40" class="const-line" fill="none"/><circle class="star" cx="15" cy="50" r="2.5"></circle><circle cx="35" cy="25" r="2.5"></circle><circle class="star bright" cx="55" cy="45" r="3"></circle><circle cx="75" cy="20" r="2.5"></circle><circle cx="95" cy="40" r="2"></circle></svg>`,details:'Jellegzetes "W" vagy "M" alak√∫ csillagk√©p a Tej√∫ton, a Nagy G√∂nc√∂llel szemben helyezkedik el.',visibilityCheck:(m,h)=>true},
            {id:'orion',type:'constellation',name:'Orion',svg:`<svg viewBox="0 0 100 80"><line class="const-line" x1="25" y1="15" x2="45" y2="40"/><line class="const-line" x1="75" y1="15" x2="55" y2="40"/><line class="const-line" x1="25" y1="65" x2="45" y2="40"/><line class="const-line" x1="75" y1="65" x2="55" y2="40"/><line class="const-line" x1="45" y1="40" x2="55" y2="40"/><circle class="star bright" cx="25" cy="15" r="3"></circle><circle class="star bright" cx="75" cy="15" r="2.5"></circle><circle class="star bright" cx="25" cy="65" r="2.8"></circle><circle class="star bright" cx="75" y1="65" r="3"></circle><circle class="star" cx="45" cy="40" r="2"></circle><circle class="star" cx="50" cy="40" r="2"></circle><circle class="star" cx="55" y2="40" r="2"></circle></svg>`,details:'A t√©li √©gbolt legl√°tv√°nyosabb csillagk√©pe, √∂v√©vel √©s f√©nyes csillagaival (Betelgeuse, Rigel).',visibilityCheck:(m,h)=>(m>=10||m<=3)&&(h>=19||h<=5)},
            {id:'cygnus',type:'constellation',name:'Hatty√∫ (Cygnus)',svg:`<svg viewBox="0 0 100 80"><path d="M50,10 L50,70" class="const-line" /><path d="M20,40 L80,40" class="const-line" /><circle cx="50" cy="10" r="3" class="star bright"></circle><circle cx="50" cy="70" r="2.5" class="star"></circle><circle cx="20" cy="40" r="2"></circle><circle cx="80" cy="40" r="2"></circle><circle cx="50" cy="40" r="2.2"></circle></svg>`,details:'M√°s n√©ven az √âszaki Kereszt. A Tej√∫t s√≠kj√°ban fekszik, tele van csillaghalmazokkal. F≈ëcsillaga a Deneb.',visibilityCheck:(m,h)=>(m>=6&&m<=11)&&(h>=20||h<=5)},
            {id:'pleiades',type:'deep_sky_object',name:'Fiasty√∫k (Pleiades)',icon:'fas fa-braille',status:'T√©len magasan az √©gen, a Bika mellett',details:'Gy√∂ny√∂r≈± ny√≠lthalmaz (M45), "Hetes" n√©ven is ismert. Szabad szemmel is l√°tv√°nyos, apr√≥ "√ºst".',visibilityCheck:(m,h)=>(m>=10||m<=4)&&(h>=19||h<=5)},
            {id:'andromeda_galaxy',type:'deep_sky_object',name:'Androm√©da-galaxis',icon:'far fa-dot-circle',status:'≈êsszel este keresd a Pegazus mellett',details:'A hozz√°nk legk√∂zelebbi nagy galaxis (M31). S√∂t√©t √©gen halv√°ny, elmos√≥dott foltk√©nt l√°tszik szabad szemmel is.',visibilityCheck:(m,h)=>(m>=8&&m<=2)&&(h>=20||h<=4)},
            {id:'orion_nebula',type:'deep_sky_object',name:'Orion-k√∂d',icon:'fas fa-atom',status:'Az Orion "kardj√°ban" tal√°lhat√≥',details:'Csillagb√∂lcs≈ë, ahol √∫j csillagok sz√ºletnek (M42). T√°vcs≈ëvel √©s s√∂t√©t √©gen m√°r l√°tv√°nyos, halv√°ny folt.',visibilityCheck:(m,h)=>(m>=11||m<=3)&&(h>=21||h<=5)},
            {id:'hercules_cluster',type:'deep_sky_object',name:'Herkules-g√∂mbhalmaz',icon:'fas fa-compact-disc',status:'Ny√°ri √©jszak√°kon, a Herkulesben',details:'Az √©szaki √©gbolt legf√©nyesebb g√∂mbhalmaza (M13). T√°vcs≈ëben t√∂bb sz√°zezer csillag alkot egy apr√≥, g√∂mb alak√∫ halmazt.',visibilityCheck:(m,h)=>(m>=5&&m<=9)&&(h>=22||h<=3)},
            {id:'perseids',type:'meteor_shower',name:'Perseid√°k meteorraj',icon:'fas fa-meteor',status:'Maximuma augusztus 12-13 k√∂r√ºl v√°rhat√≥',details:'"Szent L≈ërinc k√∂nnyeik√©nt" is ismert. Az √©v egyik legl√°tv√°nyosabb, legn√©pszer≈±bb meteorraja.',visibilityCheck:(m,h)=>m===8&&(h>=22||h<=4)},
            {id:'geminids',type:'meteor_shower',name:'Geminid√°k meteorraj',icon:'fas fa-meteor',status:'Maximuma december 13-14 k√∂r√ºl esed√©kes',details:'Az √©v egyik legakt√≠vabb √©s legmegb√≠zhat√≥bb meteorraja. Az Ikrek (Gemini) csillagk√©p a radi√°nsa.',visibilityCheck:(m,h)=>m===12&&(h>=20||h<=5)},
            {id:'milky_way_summer',type:'info',name:'A Tej√∫t ny√°ron',icon:'fas fa-water',status:'Ny√°ri est√©ken d√©li ir√°nyban a legl√°tv√°nyosabb',details:'A saj√°t galaxisunk s√≠kja. Ny√°ron a galaktikus centrum fel√© l√°tunk, ez√©rt a Tej√∫t itt a legf√©nyesebb √©s legs≈±r≈±bb.',visibilityCheck:(m,h)=>(m>=6&&m<=9)&&(h>=22||h<=3)},
        ];

        let el_stationSubtitleText, el_timestampText,
            el_sunInfoSection, el_moonInfoSection, el_nightSkyInfoSection, el_airQualityInfoSection,
            el_gridSunriseItem, el_gridSunsetItem, el_gridMoonriseItem, el_gridMoonsetItem,
            el_sunPathVisual, el_sunPathIcon, el_sunPathArcMain,
            el_sunInfoAltitude, el_sunInfoAzimuth, el_sunInfoTrend, el_sunInfoNoon, el_sunInfoRemaining, el_sunPathSunriseTime, el_sunPathSunsetTime, el_sunPathRefreshBtn,
            el_moonPathVisual, el_moonPathIcon, el_moonPathArcMain,
            el_moonriseTimeLabel, el_moonsetTimeLabel,
            el_moonInfoAltitude, el_moonInfoTrend, el_moonInfoPhasename, el_moonInfoIllumination, el_moonPathRefreshBtn,
            el_sunEventContainer, el_sunEventMessage, el_sunEventCountdown,
            el_moonEventContainer, el_moonEventMessage, el_moonEventCountdown,
            el_issInfo, el_planetInfo, el_constellationInfo,
            el_issVisualIcon, el_issNextPassTime, el_issMaxElevation, el_issDuration, el_issBrightness, el_issPathDetails,
            el_nightSkyVisualIcon, el_nightSkyObjectName, el_nightSkyObjectStatus, el_nightSkyObjectDetails, el_nightSkyAstroDarknessItemPlanet, el_nightSkyAstroDarknessPlanet,
            el_constellationSvgContainer, el_constellationName, el_constellationDetails, el_constellationAstroDarknessItemConst, el_constellationAstroDarknessConst,
            el_topTempCardValue,
            el_currentTempStatusDot, el_currentTempLiveTag, el_topTempTrendArrow, el_topTempPrecipIcon,
            el_cardHeatIndexValue, el_cardHeatIndexDesc, el_cardWindValue, el_cardWindDesc, el_cardGustValue, el_cardGustDesc,
            el_dewpointValue, el_humidityValue, el_pressureValue, el_pressureTrendIcon, el_visibilityValue, el_solarRadiationValue, el_uvIndexValue, el_uvDescription,
            el_detailsSunriseValue, el_detailsSunsetValue, el_moonriseValue, el_moonsetValue,
            el_aqiValue, el_aqiDescription, el_pm10Value, el_pm25Value, el_ozoneValue, el_ragweedPollenValue, el_grassPollenValue,
            el_ragweedPollenDescription, el_grassPollenDescription,
            el_regionalPrecipGrid;


        function formatValue(value, unit = '', precision = 1, notAvailableString = NO_DATA_STRING) { if (value === null || typeof value === 'undefined' || (typeof value === 'number' && isNaN(value)) ) return notAvailableString; if (typeof value === 'number') { return `${value.toFixed(precision)}${unit}`; } return `${value}${unit}`; }
        function formatTime(dateOrIsoString, includeSeconds = false) { if (!dateOrIsoString) return NO_DATA_STRING; try { const date = dateOrIsoString instanceof Date ? dateOrIsoString : new Date(dateOrIsoString); if (isNaN(date.getTime())) return NO_DATA_STRING; const options = { hour: '2-digit', minute: '2-digit' }; if(includeSeconds) options.second = '2-digit'; return date.toLocaleTimeString('hu-HU', options); } catch (e) { return NO_DATA_STRING; } }
        
        function getMoonPhaseIcon(phase) {
            if (phase < 0.0625) return 'üåë';
            if (phase < 0.1875) return 'üåí';
            if (phase < 0.3125) return 'üåì';
            if (phase < 0.4375) return 'üåî';
            if (phase < 0.5625) return 'üåï';
            if (phase < 0.6875) return 'üåñ';
            if (phase < 0.8125) return 'üåó';
            if (phase < 0.9375) return 'üåò';
            return 'üåë';
        }

        function getRandomItem(arr) {
            if (!arr || arr.length === 0) return '';
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function getHeatIndexDescription(heatIndex, temp, context) {
            const { isRainingInRegion, isWinter, isSpring, isSummer, isAutumn, isMorning, isLunchTime, isLateLunchTime, isAfternoon, isEvening, isNight, isNearSunrise, isNearSunset } = context;

            if (isRainingInRegion) {
                if (isSummer) return getRandomItem(['A ny√°ri z√°por kellemesen h≈±ti a leveg≈ët.', 'V√©gre egy friss√≠t≈ë es≈ë a forr√≥s√°gban! A belv√°ros is fell√©legzik.', 'Az es≈ë illata keveredik a ny√°r illat√°val. A S√≥st√≥i erd≈ë most igaz√°n h√°l√°s.', 'A Kossuth t√©ri eserny≈ëk alatt is √©rezni a frissess√©get.']);
                if (isAutumn) return getRandomItem(['Igazi ≈ëszi, befel√© fordul√≥s id≈ë.', 'Az es≈ë az ablakon kopog, j√≥ egy meleg szob√°b√≥l n√©zni.', 'Borong√≥s, es≈ës hangulat a Bujtosi t√≥ felett.', 'El≈ëker√ºlhetnek a gumicsizm√°k.']);
                if (isWinter) return getRandomItem(['√ìnos es≈ë vagy fagyott es≈ë, cs√∫sz√≥sak az utak.', 'A hideg es≈ë most nem esik j√≥l, jobb a melegben maradni.', 'Sz√ºrke, t√©li es≈ë √°ztatja a v√°rost.']);
                if (isSpring) return getRandomItem(['Tavaszi z√°por, √°ld√°s a kerteknek.', 'Az es≈ëcseppek lemoss√°k a port a vir√°gokr√≥l.', 'Az es≈ë ut√°n m√©g z√∂ldebb lesz minden a S√≥st√≥i-t√≥ k√∂r√ºl.']);
                if (isMorning) return getRandomItem(['Es≈ëvel indul a nap.', 'Az es≈ëcseppek moss√°k tiszt√°ra a reggelt.', 'A reggeli k√°v√© mell√© es≈ë is j√°r.']);
                if (isNight) return getRandomItem(['Az √©jszakai es≈ë dobol√°sa megnyugtat√≥.', 'Csendes, es≈ës √©jjel, m√©lyen alszik a v√°ros.']);
                return getRandomItem(['Az es≈ë miatt h≈±v√∂sebbnek √©rezz√ºk.', 'P√°r√°s, nedves a leveg≈ë.', 'J√≥lesik az es≈ë ut√°ni frissess√©g.']);
            }
            
            const diff = heatIndex - temp;

            if (heatIndex > 35) {
                if (isLunchTime || isAfternoon) return getRandomItem(['Vesz√©lyes h≈ës√©g, a Kossuth t√©ri sz√∂k≈ëk√∫t most aranyat √©r.', 'Extr√©m forr√≥s√°g, ker√ºld a t≈±z≈ë napot a belv√°rosban!', 'H≈ës√©griad√≥-gyan√∫s id≈ë, a S√≥st√≥i strand most a legjobb hely.', 'A beton ontja a forr√≥s√°got, keress egy l√©gkondis helyet!']);
                if (isEvening) return getRandomItem(['F√ºlledt, tr√≥pusi este. M√©g a S√≥st√≥i t√≥ vize sem h≈±s√≠t.', 'A lak√°s sem h≈±l le, neh√©z √©jszaka lesz.', 'M√©g napnyugta ut√°n is tikkaszt√≥ a meleg.']);
                if (isNight) return getRandomItem(['Neh√©z aludni ebben a melegben.', 'Tr√≥pusi √©jszaka, √°ll a leveg≈ë a v√°ros felett.', 'M√©g √©jjel sem friss√ºl fel a leveg≈ë.']);
                return getRandomItem(['Brut√°lis meleg, rengeteg folyad√©kot igy√°l!', 'Nagyon er≈ës a h≈ës√©g√©rzet, ne tart√≥zkodj a napon!']);
            }
            if (heatIndex > 30) {
                if (isMorning) return getRandomItem(['M√°r reggel is er≈ës a meleg, a nap hamar erej√©re kapott.', 'Hamar beindult a h≈ës√©g, ir√°ny a strand!', 'Egy h≈±s√≠t≈ë zuhany az Aquariusban most csod√°kat tenne.']);
                if (isLunchTime || isLateLunchTime) return getRandomItem(['Igazi k√°nikula, a legjobb egy h≈±s teraszon eb√©delni.', 'Er≈ësen meleg, izzaszt√≥ id≈ë. Ne felejts el inni!', 'Az aszfalt szinte olvad a h≈ës√©gben a belv√°rosban.']);
                if (isAfternoon) return getRandomItem(['D√©lut√°ni szieszta id≈ë a h≈ës√©gben.', 'Keress egy f√°t a Bujtosi t√≥ partj√°n az √°rny√©k√©rt!', 'Forr√≥ d√©lut√°n, a fagylalt most k√∂telez≈ë.']);
                if (isEvening) return getRandomItem(['Forr√≥ ny√°ri este, ide√°lis egy k√∂nny≈± vacsor√°hoz a szabadban.', 'Meleg, f√ºlledt id≈ë. A zen√©l≈ë sz√∂k≈ëk√∫t f√©nyeiben is meleg van.', 'A nap lement, de a meleg maradt.']);
                if (isNight) return getRandomItem(['Meleg, f√ºlledt √©jszaka.', 'Neh√©z lesz takar√≥val aludni.', '√Åll a leveg≈ë, √©s m√©g meleg is.']);
                return getRandomItem(['Intenz√≠v, nyomaszt√≥ meleg.', 'S√≥st√≥ Zoo √°llatai is az √°rny√©kot keresik.']);
            }
            if (heatIndex > 25) {
                if (isMorning) return getRandomItem(['Kellemes reggeli meleg, t√∂k√©letes egy k√°v√©hoz a Kossuth t√©ren.', 'Ide√°lis id≈ë a reggeli teend≈ëkh√∂z.', 'P√≥l√≥ban indulhat a nap, ir√°ny a piac!']);
                if (isLunchTime) return getRandomItem(['T√∂k√©letes id≈ë egy k√∂nny≈± eb√©dhez egy teraszon.', 'Eb√©did≈ëben kellemes a leveg≈ë.', 'Igazi ny√°r, √©lvezd ki a naps√ºt√©st!']);
                if (isLateLunchTime) return getRandomItem(['Remek id≈ë egy k√©s≈ëi eb√©dhez vagy egy fagyiz√°shoz.', 'Kellemes a d√©lut√°n, m√©g nem t√∫l forr√≥.']);
                if (isAfternoon) return getRandomItem(['Igazi kir√°ndul√≥id≈ë a S√≥st√≥i M√∫zeumfaluban.', 'Kellemes d√©lut√°ni kikapcsol√≥d√°s a t√≥parton.', 'Fagyi√©rt ki√°lt√≥ d√©lut√°n a belv√°rosban.']);
                if (isEvening) return getRandomItem(['Pomp√°s ny√°resti hangulat, j√≥ egyet s√©t√°lni a belv√°rosban.', 'J√≥lesik kint √ºlni vacsora ut√°n.', 'Ide√°lis egy esti s√©t√°hoz a S√≥st√≥i t√≥ k√∂r√ºl.']);
                return getRandomItem(['Kellemesen meleg, igazi ny√°r.', 'T√∂k√©letes id≈ë egy √°llatkerti s√©t√°hoz.']);
            }
            if (heatIndex > 15) {
                if (isNearSunrise) return getRandomItem(['A napfelkelte m√©g h≈±v√∂s, de √≠g√©retes.', 'Cs√≠p≈ës a hajnal a Bujtosi t√≥ felett.']);
                if (isDay && isSpring) return getRandomItem(['Kellemesen friss, tavaszi leveg≈ë.', 'Egy v√©kony pul√≥ver pont j√≥ egy belv√°rosi s√©t√°hoz.', 'Vir√°gba borul a v√°ros, energi√°val t√∂lt fel ez az id≈ë.']);
                if (isDay && isAutumn) return getRandomItem(['Kellemes ≈ëszi nap, a S√≥st√≥i erd≈ë sz√≠nei csod√°sak.', 'Pont j√≥ egy kir√°ndul√°shoz a k√∂rny√©ken.', '√âlvezd ki a naps√ºt√©st, am√≠g lehet.']);
                if (isNearSunset) return getRandomItem(['Napnyugt√°val gyorsan h≈±l a leveg≈ë.', 'Kezd est√©re fordulni az id≈ë a Kossuth t√©r felett.']);
                if (isEvening) return getRandomItem(['Kezd h≈±v√∂sre fordulni az este.', 'J√≥lesik beh√∫z√≥dni a meleg szob√°ba egy j√≥ film el√©.', '√ârdemes bez√°rni az ablakot √©jszak√°ra.']);
                return getRandomItem(['Enyhe, kellemes id≈ë.', 'Pont j√≥ egy v√°rosn√©z√©shez.']);
            }
             if (heatIndex > 5) {
                if (isMorning) return getRandomItem(['H≈±v√∂s reggel, elk√©l a s√°l √©s a kab√°t.', 'Cs√≠p≈ës a reggeli leveg≈ë.', 'Egy forr√≥ tea vagy k√°v√© most aranyat √©r.']);
                if (isDay) return getRandomItem(['H≈±v√∂s, kab√°tos id≈ë.', 'Bek√∂sz√∂nt√∂tt az ≈ësz, a levelek m√°r s√°rgulnak.', 'A nap s√ºt, de m√°r nem meleg√≠t igaz√°n.']);
                if (isNight) return getRandomItem(['Hideg √©jszaka v√°rhat√≥, a csillagok is f√©nyesebbek.', 'Jobb a meleg szob√°ban maradni, tal√°n egy el≈ëad√°s a M√≥ricz Zsigmond Sz√≠nh√°zban?', 'Bekapcsol a f≈±t√©s.']);
                return getRandomItem(['Cs√≠p≈ës, h≈±v√∂s id≈ë.', 'R√©teges √∂lt√∂zk√∂d√©s javasolt.']);
            }
            if (heatIndex <= 5) {
                if (isMorning) return getRandomItem(['Fagyos reggel, indul a j√©gkapar√°s.', 'J√≥l be kell √∂lt√∂zni a reggeli indul√°shoz. Sapka, s√°l, keszty≈±!', 'A forr√≥ k√°v√© most √©letet ment.']);
                if (isDay) return getRandomItem(['Nagyon hideg, cs√≠p≈ës t√©li id≈ë.', '√ñlt√∂zz fel vastagon, r√©tegesen!', 'A befagyott S√≥st√≥i-t√≥ l√°tv√°nya is hideget √°raszt.']);
                if (isNight) return getRandomItem(['Fagyos, metsz≈ë √©jszaka.', 'A forr√≥ tea most aranyat √©r.', 'Reggelre d√©r vagy z√∫zmara d√≠sz√≠theti a v√°rost.']);
                return getRandomItem(['Igazi t√©li hideg.', 'Zord id≈ë, maradj meleg helyen!']);
            }

            if (temp < 15 && diff < -3) return getRandomItem(['A sz√©l miatt j√≥val h≈±v√∂sebbnek √©rz≈ëdik.', 'A sz√©l belef√∫j a kab√°t al√°, a Kossuth t√©ren is s√ºv√≠t.', 'Csontig hatol√≥, kellemetlen sz√©l.']);
            if (diff < -2) return getRandomItem(['Cs√≠p≈ësebbnek √©rz≈ëdik a m√©rtn√©l.', 'Friss√≠t≈ëen h≈±v√∂snek hat a leveg≈ë.']);
            if (diff > 3) return getRandomItem(['F√ºlledt, ragacsos id≈ë.', 'Mintha egy √ºvegh√°zban lenn√©nk.', 'Szauna-hat√°s a szabadban.']);
            if (diff > 2) return getRandomItem(['Melegebbnek hat a leveg≈ë.', 'P√°r√°s, f√ºlledt √©rzet.']);

            return getRandomItem(['A h≈ëm√©r≈ë ma nem hazudik.', 'Nincs nagy meglepet√©s.', 'A val√≥s√°gnak megfelel≈ë √©rzet.']);
        }

        function getWindDescription(windSpeed, gustSpeed, context) {
            const { isRainingInRegion, isSummer, isAutumn, isDay, isEvening, isNight } = context;

             if (isRainingInRegion) {
                if (windSpeed > 30) {
                    if (isSummer) return getRandomItem(['Viharos sz√©l korb√°csolja a ny√°ri z√°port.', 'Zivatar csapott le, s√ºv√≠t a sz√©l a belv√°rosban.']);
                    if (isAutumn) return getRandomItem(['Zord, ≈ëszi sz√©l hajtja az es≈ët.', 'A sz√©l az arcunkba v√°gja az es≈ëcseppeket.']);
                    return getRandomItem(['Zord, szeles, es≈ës id≈ë.', 'Az eserny≈ëvel is neh√©z b√°nni.']);
                }
                if (isDay) return getRandomItem(['Az es≈ëvel egy√ºtt a sz√©l is megj√∂tt.', 'Sz√©llel b√©lelt es≈ë.', 'Friss√≠t≈ë, es≈ës fuvallat.']);
                if (isNight) return getRandomItem(['Az √©jszakai es≈ët halk sz√©l k√≠s√©ri.', 'A sz√©l susog√°sa keveredik az es≈ë hangj√°val.']);
                return getRandomItem(['Esik, √©s a sz√©l is f√∫j.']);
            }
            
            if (windSpeed == null) return 'n/a';

            if (windSpeed <= 2) {
                if (gustSpeed != null && gustSpeed > 7) return getRandomItem(['Alapvet≈ëen sz√©lcsendes, de l√∂k√©ses', 'Szinte semmi, azt√°n hirtelen egy l√∂k√©s', 'V√°ltoz√©kony, gyenge szell≈ë']);
                return getRandomItem(['Sz√©lcsend', 'Mozdulatlan leveg≈ë', 'Rezd√ºletlen, mint a Bujtosi t√≥ vize', 'Teljesen nyugodt']);
            }
            if (windSpeed <= 6) {
                if (isDay) return getRandomItem(['Gyenge fuvallat', 'L√°gy szell≈ë simogat', 'Finoman rezd√ºlnek a falevelek a S√≥st√≥i erd≈ëben']);
                else return getRandomItem(['Enyhe √©jszakai szell≈ë', 'Halk susog√°s', 'Alig √©rezhet≈ë l√©gmozg√°s']);
            }
            if (windSpeed <= 12) {
                if (isDay) return getRandomItem(['K√∂nny≈± szell≈ë', 'Friss√≠t≈ë l√©gmozg√°s', 'Kellemesen lengedez≈ë, pont j√≥ egy s√©t√°hoz']);
                else return getRandomItem(['M√©rs√©kelt esti szell≈ë', 'Friss√≠t≈ë √©jszakai l√©g√°ramlat', '√ârdemes kiszell≈ëztetni']);
            }
            if (windSpeed <= 20) return getRandomItem(['M√©rs√©kelt sz√©l', '√ârezhet≈ëen f√∫j', 'Lengenek az √°gak a parkokban', 'K√≥colja a hajat']);
            if (windSpeed <= 30) return getRandomItem(['√âl√©nk sz√©l', 'Mark√°ns, friss√≠t≈ë', 'S√ºv√≠t a Korz√≥ √ºvegfolyos√≥j√°n', 'Er≈ës√∂d≈ë l√©gmozg√°s']);
            if (windSpeed <= 40) return getRandomItem(['Er≈ës sz√©l', 'Nehez√≠ti a gyalogl√°st', 'Z√∫gnak a f√°k a S√≥st√≥i erd≈ëben', 'Bar√°ts√°gtalan id≈ë']);
            if (windSpeed <= 50) return getRandomItem(['Nagyon er≈ës sz√©l', 'Viharos k√∂zeli', 'Let√∂rhet kisebb √°gakat', 'Jobb √≥vatosnak lenni']);
            return getRandomItem(['Viharos erej≈±', 'Vesz√©lyes sz√©l', 'K√°rokat okozhat', 'Maradj ink√°bb bent!']);
        }

        function getWindGustDescription(gustSpeed, windSpeed, context) {
            const { isRainingInRegion, isDay, isNight } = context;

             if (isRainingInRegion) {
                if (gustSpeed > 45) return getRandomItem(['Viharos l√∂k√©sek k√≠s√©rik a zivatart.', 'A sz√©l t√©pi a f√°kat az es≈ëben.']);
                if (gustSpeed > 30) return getRandomItem(['Er≈ës l√∂k√©sekkel √©rkezett a csapad√©k.', 'Hirtelen felt√°mad√≥ sz√©l az es≈ëvel.']);
                return getRandomItem(['Az es≈ët n√©ha √©l√©nkebb l√∂k√©sek k√≠s√©rik.', 'L√∂k√©ses sz√©l az es≈ëben.']);
            }
            
            if (gustSpeed == null || windSpeed == null || gustSpeed < windSpeed + 5) {
                return getRandomItem(['Egyenletes', 'Nincsenek kiugr√≥ l√∂k√©sek', 'L√©nyeg√©ben l√∂k√©smentes', 'Nyugodt a l√©gmozg√°s']);
            }
            if (gustSpeed < 15) return getRandomItem(['Jelent√©ktelen l√∂k√©sek', 'Alig √©rezhet≈ëek', 'N√©ha meg-meglibben valami', 'Gyenge l√∂k√©s']);
            if (gustSpeed < 30) {
                if (isDay) return getRandomItem(['M√©rs√©kelt l√∂k√©sek', 'Hirtelen meg√©l√©nk√ºl', 'Vigy√°zni kell a pap√≠rokkal', 'Egy-egy er≈ësebb fuvallat']);
                else return getRandomItem(['√âjszakai l√∂k√©sek', 'N√©ha hirtelen felt√°mad', 'Hallani, ahogy megcsapja a h√°z fal√°t']);
            }
            if (gustSpeed < 45) {
                if (isDay) return getRandomItem(['√âl√©nk l√∂k√©sek', 'Vigy√°zz a kalapodra a Kossuth t√©ren!', 'Hirtelen, er≈ës sz√©ll√∂k√©sek', 'Meg-megingat']);
                else return getRandomItem(['Er≈ës √©jszakai l√∂k√©sek', 'Z√∂rgeti a red≈ënyt', 'Fel lehet r√° √©bredni', 'S√ºv√≠t a k√©m√©nyekben']);
            }
            if (gustSpeed < 60) return getRandomItem(['Er≈ës, viharos l√∂k√©sek', 'Megingatja az embert', 'Z√∂r√∂gnek a cserepek', 'Kapaszkodj!']);
            if (gustSpeed < 80) return getRandomItem(['Nagyon er≈ës, viharos l√∂k√©sek', 'Biztons√°gosabb fed√©l alatt', 'Gallyakat t√∂rhet le', 'Vesz√©lyes lehet']);
            return getRandomItem(['Ork√°n erej≈± l√∂k√©sek', 'Vesz√©lyes!', 'Puszt√≠t√≥ erej≈± l√∂k√©sek', 'Maradj biztons√°gos helyen!']);
        }
        
        function getUVDescription(uvIndex) {
            if (uvIndex == null) return '';
            if (uvIndex <= 2) return '(Alacsony)';
            if (uvIndex <= 5) return '(M√©rs√©kelt)';
            if (uvIndex <= 7) return '(Magas)';
            if (uvIndex <= 10) return '(Nagyon magas)';
            return '(Extr√©m)';
        }

        function degreesToCompass(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["√©szaki", "√©szak-√©szakkeleti", "√©szakkeleti", "kelet-√©szakkeleti", "keleti", "kelet-d√©lkeleti", "d√©lkeleti", "d√©l-d√©lkeleti", "d√©li", "d√©l-d√©lnyugati", "d√©lnyugati", "nyugat-d√©lnyugati", "nyugati", "nyugat-√©szaknyugati", "√©szaknyugati", "√©szak-√©szaknyugati"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function degreesToCompassAbbreviated(degrees) { if (degrees === null || typeof degrees === 'undefined') return '-'; degrees = (parseFloat(degrees) % 360 + 360) % 360; const directions = ["√â", "√â√âK", "√âK", "K√âK", "K", "KDK", "DK", "DDK", "D", "DDNY", "DNY", "NYDNY", "NY", "NY√âNY", "√âNY", "√â√âNY"]; return directions[Math.round(degrees / 22.5) % 16]; }
        function formatCountdown(ms) { if (ms < 0) ms = 0; const totalSeconds = Math.floor(ms / 1000); const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; }
        
        function updateThemeAndSky(currentTime, sunriseTimeIso, sunsetTimeIso) {
            const fallbackTheme = (new Date().getHours() >= 7 && new Date().getHours() < 18) ? 'day' : 'night';
            let theme = fallbackTheme;
            if (sunriseTimeIso && sunsetTimeIso) {
                try {
                    const nowMs = currentTime.getTime();
                    const sunriseDate = new Date(sunriseTimeIso); const sunsetDate = new Date(sunsetTimeIso);
                    if (isNaN(sunriseDate.getTime()) || isNaN(sunsetDate.getTime())) throw new Error("Invalid sunrise/sunset date");
                    const EARLY_DAWN_DURATION = 30 * 60 * 1000, BLUE_HOUR_DAWN_DURATION = 30 * 60 * 1000, DAWN_DURATION = 25 * 60 * 1000, SUNRISE_EVENT_DURATION = 15 * 60 * 1000, GOLDEN_HOUR_RISE_DURATION = 45 * 60 * 1000;
                    const GOLDEN_HOUR_SET_DURATION = 45 * 60 * 1000, SUNSET_EVENT_DURATION = 15 * 60 * 1000, DUSK_DURATION = 25 * 60 * 1000, BLUE_HOUR_DUSK_DURATION = 30 * 60 * 1000, LATE_DUSK_DURATION = 30 * 60 * 1000;
                    const sunriseMs = sunriseDate.getTime(), sunsetMs = sunsetDate.getTime();
                    const earlyDawnStart = sunriseMs - DAWN_DURATION - BLUE_HOUR_DAWN_DURATION - EARLY_DAWN_DURATION, blueHourDawnStart = sunriseMs - DAWN_DURATION - BLUE_HOUR_DAWN_DURATION, dawnStart = sunriseMs - DAWN_DURATION;
                    const sunriseEnd = sunriseMs + SUNRISE_EVENT_DURATION, goldenHourRiseEnd = sunriseEnd + GOLDEN_HOUR_RISE_DURATION;
                    const goldenHourSetStart = sunsetMs - GOLDEN_HOUR_SET_DURATION, sunsetEnd = sunsetMs + SUNSET_EVENT_DURATION, duskEnd = sunsetEnd + DUSK_DURATION;
                    const blueHourDuskEnd = duskEnd + BLUE_HOUR_DUSK_DURATION, lateDuskEnd = blueHourDuskEnd + LATE_DUSK_DURATION;
                    if (nowMs >= earlyDawnStart && nowMs < blueHourDawnStart) { theme = 'early_dawn'; }
                    else if (nowMs >= blueHourDawnStart && nowMs < dawnStart) { theme = 'blue_hour_dawn'; }
                    else if (nowMs >= dawnStart && nowMs < sunriseMs) { theme = 'dawn'; }
                    else if (nowMs >= sunriseMs && nowMs < sunriseEnd) { theme = 'sunrise'; }
                    else if (nowMs >= sunriseEnd && nowMs < goldenHourRiseEnd) { theme = 'golden_hour_rise'; }
                    else if (nowMs >= goldenHourRiseEnd && nowMs < goldenHourSetStart) { theme = 'day'; }
                    else if (nowMs >= goldenHourSetStart && nowMs < sunsetMs) { theme = 'golden_hour_set'; }
                    else if (nowMs >= sunsetMs && nowMs < sunsetEnd) { theme = 'sunset'; }
                    else if (nowMs >= sunsetEnd && nowMs < duskEnd) { theme = 'dusk'; }
                    else if (nowMs >= duskEnd && nowMs < blueHourDuskEnd) { theme = 'blue_hour_dusk'; }
                    else if (nowMs >= blueHourDuskEnd && nowMs < lateDuskEnd) { theme = 'late_dusk'; }
                    else { theme = 'night'; }
                } catch (e) { theme = fallbackTheme; }
            }
            if (document.body.dataset.theme !== theme) document.body.dataset.theme = theme;
        }

        function getComprehensiveMoonData(lat, lon) {
            const now = new Date(); const moonPos = SunCalc.getMoonPosition(now, lat, lon); const isActuallyUp = moonPos.altitude > 0;
            const days = [ new Date(new Date().setDate(now.getDate() - 1)), now, new Date(new Date().setDate(now.getDate() + 1)) ];
            let events = [];
            days.forEach(day => {
                const moonTimes = SunCalc.getMoonTimes(day, lat, lon, true);
                if (moonTimes.rise && !isNaN(moonTimes.rise.getTime())) events.push({ time: moonTimes.rise, type: 'rise' });
                if (moonTimes.set && !isNaN(moonTimes.set.getTime())) events.push({ time: moonTimes.set, type: 'set' });
            });
            if (events.length === 0) return { isUp: isActuallyUp, pathRise: null, pathSet: null, nextRise: null, nextSet: null, moonAltitude: moonPos.altitude * 180 / Math.PI };
            events.sort((a, b) => a.time - b.time);
            let pathRise = null, pathSet = null;
            if (isActuallyUp) {
                const lastRiseEvent = events.filter(e => e.type === 'rise' && e.time < now).pop();
                if (lastRiseEvent) { pathRise = lastRiseEvent.time; pathSet = events.find(e => e.type === 'set' && e.time > pathRise)?.time || null; }
            }
            const nextRise = events.find(e => e.type === 'rise' && e.time > now)?.time || null;
            const nextSet = events.find(e => e.type === 'set' && e.time > now)?.time || null;
            return { isUp: isActuallyUp, pathRise: pathRise, pathSet: pathSet, nextRise: nextRise, nextSet: nextSet, moonAltitude: moonPos.altitude * 180 / Math.PI };
        }

        async function fetchAdvancedSunCalcData(lat, lon) {
            const now = new Date(); const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const sunTimesToday = SunCalc.getTimes(now, lat, lon); const sunTimesYesterday = SunCalc.getTimes(yesterday, lat, lon);
            const sunriseDate = sunTimesToday.sunrise, sunsetDate = sunTimesToday.sunset, solarNoonDate = sunTimesToday.solarNoon;
            const sunPos = SunCalc.getPosition(now, lat, lon);
            const sunAltitude = sunPos.altitude * 180 / Math.PI; const sunAzimuthDegrees = (sunPos.azimuth * 180 / Math.PI + 180) % 360; const sunAzimuthCompass = degreesToCompass(sunAzimuthDegrees);
            const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000); const pastSunPos = SunCalc.getPosition(tenMinutesAgo, lat, lon);
            let sunTrend = sunPos.altitude > 0 ? (sunPos.altitude > pastSunPos.altitude ? 'Emelkedik' : 'S√ºllyed') : null;
            let sunStatus = '';
            if (sunriseDate && sunsetDate && !isNaN(sunriseDate.getTime()) && !isNaN(sunsetDate.getTime())) { if (now < sunriseDate) { sunStatus = 'Napkelte el≈ëtt'; } else if (now >= sunriseDate && now < solarNoonDate) { sunStatus = 'D√©l fel√© tart'; } else if (now >= solarNoonDate && now < sunsetDate) { sunStatus = 'D√©l ut√°n'; } else { sunStatus = 'Lenyugodott'; } }
            let remainingDaylightText = 'N/A';
            if (sunriseDate && sunsetDate && !isNaN(sunriseDate.getTime()) && !isNaN(sunsetDate.getTime())) {
                if (now > sunriseDate && now < sunsetDate) {
                    const diffMs = sunsetDate.getTime() - now.getTime();
                    const hours = Math.floor(diffMs / 3600000); const minutes = Math.floor((diffMs % 3600000) / 60000);
                    remainingDaylightText = `M√©g ${hours} √≥ra ${minutes} perc`;
                } else if (now <= sunriseDate) { remainingDaylightText = `Napkelte ${formatTime(sunriseDate)}-kor`; } else { remainingDaylightText = 'A nap m√°r lenyugodott'; }
            }
            const moonPos = SunCalc.getMoonPosition(now, lat, lon); const pastMoonPos = SunCalc.getMoonPosition(tenMinutesAgo, lat, lon);
            const moonIllumination = SunCalc.getMoonIllumination(now);
            const comprehensiveMoonData = getComprehensiveMoonData(lat, lon);
            let moonTrend = moonPos.altitude > 0 ? (moonPos.altitude > pastMoonPos.altitude ? 'Emelkedik' : 'S√ºllyed') : null; let moonStatus = comprehensiveMoonData.isUp ? '√âgen van' : 'Horizont alatt';
            let phaseName = 'N/A'; const phase = moonIllumination.phase;
            if (phase >= 0 && phase < 0.03) phaseName = '√öjhold'; else if (phase >= 0.03 && phase < 0.22) phaseName = 'N√∂vekv≈ë sarl√≥'; else if (phase >= 0.22 && phase < 0.28) phaseName = 'Els≈ë negyed'; else if (phase >= 0.28 && phase < 0.47) phaseName = 'N√∂vekv≈ë hold'; else if (phase >= 0.47 && phase < 0.53) phaseName = 'Telihold'; else if (phase >= 0.53 && phase < 0.72) phaseName = 'Fogy√≥ hold'; else if (phase >= 0.72 && phase < 0.78) phaseName = 'Utols√≥ negyed'; else if (phase >= 0.78 && phase < 0.97) phaseName = 'Fogy√≥ sarl√≥'; else if (phase >= 0.97 && phase <= 1) phaseName = '√öjholdhoz k√∂zeli';
            
            return {
                sunrise: formatTime(sunriseDate), sunset: formatTime(sunsetDate), solarNoon: formatTime(solarNoonDate), sunriseDateForPath: sunriseDate, sunsetDateForPath: sunsetDate, solarNoonDate: solarNoonDate,
                sunAltitude: sunAltitude, sunAzimuthDegrees: sunAzimuthDegrees, sunAzimuthCompass: sunAzimuthCompass, sunTrend: sunTrend, sunStatus: sunStatus, remainingDaylight: remainingDaylightText,
                isUp: comprehensiveMoonData.isUp, moonrise: formatTime(comprehensiveMoonData.nextRise), moonset: formatTime(comprehensiveMoonData.nextSet), moonRiseDateForPath: comprehensiveMoonData.pathRise, moonSetDateForPath: comprehensiveMoonData.pathSet,
                moonAltitude: comprehensiveMoonData.moonAltitude, moonTrend: moonTrend, moonStatus: moonStatus, phaseValue: (moonIllumination.fraction * 100), phaseName: phaseName, moonPhaseRaw: moonIllumination.phase, moonDistance: moonPos.distance,
                astronomicalTwilightStart: sunTimesToday.nightEnd, astronomicalTwilightEnd: sunTimesYesterday.night,
            };
        }
        
        function updateNightSkyDisplay() {
            if (!el_nightSkyInfoSection) return;
            const now = Date.now();
            for (const [id, timestamp] of recentlyShownSkyObjects.entries()) { if (now - timestamp > NIGHT_SKY_OBJECT_COOLDOWN_MS) { recentlyShownSkyObjects.delete(id); } }
            el_nightSkyInfoSection.classList.add('is-fading');
            setTimeout(() => {
                const currentMonth = new Date().getMonth() + 1, currentHour = new Date().getHours();
                let visibleObjects = NIGHT_SKY_OBJECTS.filter(obj => obj.visibilityCheck(currentMonth, currentHour));
                let eligibleObjects = visibleObjects.filter(obj => !recentlyShownSkyObjects.has(obj.id));
                if (eligibleObjects.length === 0) { recentlyShownSkyObjects.clear(); eligibleObjects = visibleObjects; }
                if (ENABLE_ISS_TRACKING && cachedData.issPasses && cachedData.issPasses.length > 0) {
                    const nextPass = cachedData.issPasses[0];
                    if (!recentlyShownSkyObjects.has('iss') && (nextPass.startUTC.getTime() - now < 6 * 60 * 60 * 1000)) { eligibleObjects.unshift({ id: 'iss', type: 'iss', passData: nextPass }); }
                }
                if (eligibleObjects.length === 0) eligibleObjects.push(NIGHT_SKY_OBJECTS.find(o => o.id === 'ursa_major'));
                const objectToDisplay = eligibleObjects[Math.floor(Math.random() * eligibleObjects.length)];
                recentlyShownSkyObjects.set(objectToDisplay.id, now);
                if(el_issInfo) el_issInfo.classList.add('is-hidden'); if(el_planetInfo) el_planetInfo.classList.add('is-hidden'); if(el_constellationInfo) el_constellationInfo.classList.add('is-hidden');
                const sunCalcData = cachedData.sunCalc; let astroDarknessText = null;
                if (sunCalcData && sunCalcData.astronomicalTwilightStart && sunCalcData.astronomicalTwilightEnd) {
                     const nowMs = now; const astroNightStartObj = new Date(sunCalcData.astronomicalTwilightEnd); const astroNightEndObj = new Date(sunCalcData.astronomicalTwilightStart);
                     if (!isNaN(astroNightStartObj.getTime()) && !isNaN(astroNightEndObj.getTime())) { if (nowMs > astroNightStartObj.getTime() || nowMs < astroNightEndObj.getTime()) { astroDarknessText = `${formatTime(astroNightStartObj)} - ${formatTime(astroNightEndObj)}`; } }
                }
                const displaySection = (sectionEl, astroItemEl, astroTextEl) => {
                    const labelEl = astroItemEl ? astroItemEl.querySelector('.night-sky-detail-label') : null;
                    if (astroDarknessText && astroItemEl && astroTextEl && labelEl) { labelEl.innerHTML = '<i class="far fa-moon"></i>Csillag√°szati s√∂t√©ts√©g:'; astroTextEl.textContent = astroDarknessText; astroItemEl.classList.remove('is-hidden'); } 
                    else if (astroItemEl) { astroItemEl.classList.add('is-hidden'); }
                    sectionEl.classList.remove('is-hidden');
                };
                switch(objectToDisplay.type) {
                    case 'iss':
                        if(el_issInfo) {
                            const nextPass = objectToDisplay.passData;
                            if(el_issVisualIcon) el_issVisualIcon.className = 'fas fa-satellite';
                            if(el_issNextPassTime) el_issNextPassTime.textContent = `${formatTime(nextPass.startUTC)} - ${formatTime(nextPass.endUTC)}`;
                            if(el_issMaxElevation) el_issMaxElevation.textContent = `${formatValue(nextPass.maxEl, '¬∞', 0)}`;
                            if(el_issDuration) el_issDuration.textContent = `${Math.round(nextPass.duration / 60)} perc`;
                            if(el_issBrightness) el_issBrightness.textContent = `${formatValue(nextPass.mag, ' mag')}`;
                            if(el_issPathDetails) el_issPathDetails.textContent = `Indul: ${nextPass.startAzCompass}, Max: ${nextPass.maxAzCompass}, V√©ge: ${nextPass.endAzCompass}`;
                            el_issInfo.classList.remove('is-hidden');
                        }
                        break;
                    case 'meteor_shower': case 'deep_sky_object': case 'planet': case 'star': case 'info':
                        if(el_planetInfo) {
                            if(el_nightSkyVisualIcon) el_nightSkyVisualIcon.className = objectToDisplay.icon;
                            if(el_nightSkyObjectName) el_nightSkyObjectName.textContent = objectToDisplay.name;
                            if(el_nightSkyObjectStatus) el_nightSkyObjectStatus.textContent = objectToDisplay.status;
                            if(el_nightSkyObjectDetails) el_nightSkyObjectDetails.textContent = objectToDisplay.details || '';
                            displaySection(el_planetInfo, el_nightSkyAstroDarknessItemPlanet, el_nightSkyAstroDarknessPlanet);
                        }
                        break;
                    case 'constellation':
                         if(el_constellationInfo) {
                            if(el_constellationSvgContainer) el_constellationSvgContainer.innerHTML = objectToDisplay.svg || '';
                            if(el_constellationName) el_constellationName.textContent = objectToDisplay.name;
                            if(el_constellationDetails) el_constellationDetails.textContent = objectToDisplay.details || '';
                            displaySection(el_constellationInfo, el_constellationAstroDarknessItemConst, el_constellationAstroDarknessConst);
                        }
                        break;
                }
                el_nightSkyInfoSection.classList.remove('is-fading');
            }, 400);
        }

        function startNightSkyRotation() { if (nightSkyRotationInterval) return; updateNightSkyDisplay(); nightSkyRotationInterval = setInterval(updateNightSkyDisplay, NIGHT_SKY_ROTATION_INTERVAL_MS); }
        function stopNightSkyRotation() { if (nightSkyRotationInterval) { clearInterval(nightSkyRotationInterval); nightSkyRotationInterval = null; recentlyShownSkyObjects.clear(); } }

        async function fetchIssPasses(apiKey, lat, lon, alt, noradId, days = 3, minElevation = 15) {
            if (!ENABLE_ISS_TRACKING || apiKey === 'YOUR_N2YO_API_KEY' || !apiKey) { cachedData.issPasses = []; return []; }
            const url = `https://api.n2yo.com/rest/v1/satellite/visualpasses/${noradId}/${lat}/${lon}/${alt}/${days}/${minElevation}/&apiKey=${apiKey}`;
            try {
                const response = await fetch(url);
                if (!response.ok) { if (response.status === 401) { console.error(`ISS API Hiba: Helytelen API kulcs...`); } else { console.error(`ISS API Hiba: ${response.status}`); } throw new Error(`ISS API Hiba: ${response.status}`); }
                const data = await response.json();
                if (data && data.info && data.info.passescount > 0 && data.passes) {
                    const now = new Date().getTime() / 1000;
                    const validPasses = data.passes.filter(pass => pass.startUTC > now && pass.maxEl >= minElevation).map(pass => ({ startAz: pass.startAz, startAzCompass: pass.startAzCompass, startEl: pass.startEl, startUTC: new Date(pass.startUTC * 1000), maxAz: pass.maxAz, maxAzCompass: pass.maxAzCompass, maxEl: pass.maxEl, maxUTC: new Date(pass.maxUTC * 1000), endAz: pass.endAz, endAzCompass: pass.endAzCompass, endEl: pass.endEl, endUTC: new Date(pass.endUTC * 1000), mag: pass.mag, duration: pass.duration })).sort((a, b) => a.startUTC - b.startUTC);
                    return validPasses;
                }
                return [];
            } catch (error) { cachedData.issPasses = []; return []; }
        }

        async function fetchAirQualityData(lat, lon) {
            const params = `latitude=${lat}&longitude=${lon}&current=european_aqi,pm10,pm2_5,ozone,ragweed_pollen,grass_pollen,birch_pollen&domains=cams_europe`; const url = `https://air-quality-api.open-meteo.com/v1/air-quality?${params}`;
            try { const response = await fetch(url); if (!response.ok) throw new Error(`Leveg≈ëmin≈ës√©g API Hiba: ${response.status}`); const data = await response.json(); lastApiCallTimes.airQuality = Date.now(); if (data && data.current) return data.current; else throw new Error('Hi√°nyos leveg≈ëmin≈ës√©g adat.'); } catch (error) { console.warn(`Hiba a leveg≈ëmin≈ës√©g adatok lek√©r√©sekor: ${error.message}`); return null; }
        }
        
        async function fetchPwsStationData(stationKey) {
            const stationConfig = STATIONS[stationKey]; const url = `https://api.weather.com/v2/pws/observations/current?apiKey=${weatherComApiKey}&stationId=${stationConfig.id}&numericPrecision=decimal&format=json&units=m`;
            try { 
                const currentData = stationConfig.data;
                if (currentData && typeof currentData.metric?.temp === 'number') {
                    cachedData.previousTemperatures[stationKey] = currentData.metric.temp;
                }

                const response = await fetch(url); if (!response.ok) throw new Error(`PWS API Hiba: ${response.status}`); 
                const data = await response.json(); if (!data.observations || data.observations.length === 0) throw new Error(`Nincs PWS adat.`); 
                stationConfig.isOnline = true; stationConfig.data = data.observations[0]; 
                updateStationStatusUI(stationKey, 'online'); 
            } catch (error) { 
                stationConfig.isOnline = false; updateStationStatusUI(stationKey, 'offline'); throw error; 
            }
        }

        async function fetchGeneralConditionsData(lat, lon) { const lang = 'hu-HU'; const url = `https://api.weather.com/v3/wx/observations/current?geocode=${lat},${lon}&language=${lang}&format=json&apiKey=${weatherComApiKey}&units=m`; const response = await fetch(url); if (!response.ok) { throw new Error(`API hiba (√Ålt. id≈ëj√°r√°s): ${response.status}`); } const data = await response.json(); lastApiCallTimes.generalConditions = Date.now(); return { skyCoverPhrase: data.cloudCoverPhrase || data.wxPhraseLong || null, pressureAltimeter: data.pressureAltimeter ?? data.pressureMeanSeaLevel, visibility: data.visibility, dayOrNight: data.dayOrNight, pressureTendencyCode: data.pressureTendencyCode ?? (data.pressureChange !== null && typeof data.pressureChange !== 'undefined' ? (data.pressureChange > 0 ? 0 : (data.pressureChange < 0 ? 1 : 2)) : null), uvDescription: data.uvDescription || null, sunriseTimeLocal: data.sunriseTimeLocal, sunsetTimeLocal: data.sunsetTimeLocal }; }
        
        async function fetchHourlyForecastData(lat, lon) {
            const url = `https://api.weather.com/v3/wx/forecast/hourly/3day?geocode=${lat},${lon}&format=json&units=m&language=hu-HU&apiKey=${weatherComApiKey}`;
            try { const response = await fetch(url); if (!response.ok) throw new Error(`√ìr√°s el≈ërejelz√©s API hiba: ${response.status}`); const data = await response.json(); if (!data || !data.validTimeLocal) { throw new Error('Hi√°nyos √≥r√°s el≈ërejelz√©si adatok.'); }
                const hourlyForecasts = []; const now = new Date();
                let startIndex = data.validTimeLocal.findIndex(timeStr => new Date(timeStr) > now);
                if (startIndex === -1) { startIndex = data.validTimeLocal.length > 0 ? data.validTimeLocal.length -1 : 0; } else if (startIndex > 0) { const prevTime = new Date(data.validTimeLocal[startIndex-1]); if (now.getTime() - prevTime.getTime() < 30 * 60 * 1000) { startIndex--; } }
                for (let i = startIndex; i < startIndex + 12 && i < data.validTimeLocal.length; i++) { hourlyForecasts.push({ time: data.validTimeLocal[i], temp: data.temperature[i], iconCode: data.iconCode[i], precipChance: data.precipChance[i], dayOrNight: data.dayOrNight[i], windSpeed: data.windSpeed[i], windDirection: data.windDirection[i], humidity: data.relativeHumidity[i], uvIndex: data.uvIndex[i], wxPhraseShort: data.wxPhraseShort[i] }); }
                lastApiCallTimes.forecast = Date.now();
                return hourlyForecasts;
            } catch (error) { throw error; }
        }

        function initializeWeatherDisplayDOM() {
            const tooltipContent = `<strong>Panel Inform√°ci√≥</strong>
            <p>Ez a fel√ºlet egy szem√©lyes projekt, melyet Robi k√©sz√≠tett AI seg√≠ts√©g√©vel azzal a c√©llal, hogy egy modern √©s r√©szletes id≈ëj√°r√°s-megjelen√≠t≈ët hozzon l√©tre Ny√≠regyh√°za sz√°m√°ra.</p>
            <strong>Hogyan M≈±k√∂dik?</strong>
            <p>Az oldal egy dinamikus, egyoldalas alkalmaz√°s (SPA), ami azt jelenti, hogy a tartalom friss√ºl an√©lk√ºl, hogy az eg√©sz oldalt √∫jra kellene t√∂lteni. K√ºl√∂nb√∂z≈ë internetes szolg√°ltat√°sokt√≥l (API-kt√≥l) k√©r le adatokat, √©s ezek alapj√°n √©p√≠ti fel a megjelen√≠tett paneleket.</p>
            <strong>Adatforr√°sok R√©szletesen:</strong>
            <ul>
                <li><b>Helyi adatok:</b> A Weather.com szem√©lyes id≈ëj√°r√°s-√°llom√°s (PWS) h√°l√≥zat√°b√≥l sz√°rmaznak. Ezek a Ny√≠regyh√°z√°n √©s k√∂rny√©k√©n tal√°lhat√≥ amat≈ër meteorol√≥giai √°llom√°sok (pl. a Ny√≠regyh√°zi √∫ton vagy a Honv√©d utc√°n) √°ltal m√©rt, szinte √©l≈ë adatok (h≈ëm√©rs√©klet, csapad√©k, sz√©l stb.).</li>
                <li><b>El≈ërejelz√©s:</b> Az √≥r√°s el≈ërejelz√©st a Weather.com szolg√°ltatja.</li>
                <li><b>Leveg≈ë & Pollen:</b> Az Open-Meteo API-b√≥l √©rkeznek a leveg≈ëmin≈ës√©gi (PM10, PM2.5), √≥zon- √©s pollenterhel√©si (parlagf≈±, f≈±f√©l√©k) adatok.</li>
                <li><b>Csillag√°szat:</b> A Nap √©s a Hold pontos helyzet√©t, a kel√©si √©s nyugv√°si id≈ëket, valamint a holdf√°zist a b√∂ng√©sz≈ë helyben, a <i>SunCalc.js</i> k√∂nyvt√°r seg√≠ts√©g√©vel sz√°molja ki a f√∂ldrajzi koordin√°t√°k √©s a pontos id≈ë alapj√°n.</li>
                <li><b>≈∞r√°llom√°s (ISS):</b> Ha enged√©lyezve van, a N2YO.com API-n kereszt√ºl k√©rdezi le a Nemzetk√∂zi ≈∞r√°llom√°s k√∂vetkez≈ë, Ny√≠regyh√°za felett l√°that√≥ √°thalad√°sainak idej√©t √©s p√°ly√°j√°t.</li>
            </ul>
            <strong>Dinamikus Fel√ºlet:</strong>
            <ul>
                <li><b>Napszak-k√∂vet√©s:</b> A h√°tt√©r √©s a sz√≠nek egy 12 f√°zis√∫ ciklus szerint v√°ltoznak, k√∂vetve a nap √∫tj√°t a hajnali k√©k √≥r√°t√≥l az arany√≥r√°n √©s a d√©li ragyog√°son √°t az alkonyatig √©s a csillagos √©jszak√°ig.</li>
                <li><b>Intelligens Panelek:</b> A f≈ë inform√°ci√≥s panel (a h≈ëm√©rs√©klet alatt) a napszaknak megfelel≈ëen v√°ltozik: nappal a Nap, √©jjel a Hold adatait mutatja. Ha mindkett≈ë a horizont alatt van, felv√°ltva jelen√≠t meg √©rdekess√©geket az aktu√°lis √©jszakai √©gboltr√≥l (bolyg√≥k, csillagk√©pek, ISS) √©s a leveg≈ëmin≈ës√©gi adatokat.</li>
            </ul>
            <strong>Friss√≠t√©si Id≈ëk:</strong>
            <ul>
                <li>M√©r≈ë√°llom√°sok: ${REFRESH_INTERVAL_PWS / 1000} m√°sodpercenk√©nt</li>
                <li>√ìr√°s el≈ërejelz√©s: ${REFRESH_INTERVAL_FORECAST / 60000} percenk√©nt</li>
                <li>Leveg≈ë & Pollen: ${REFRESH_INTERVAL_AIR_QUALITY / 60000} percenk√©nt</li>
            </ul>
            <p>A projekt c√©lja egy informat√≠v, m√©gis eszt√©tikus √©s sz√≥rakoztat√≥ fel√ºlet l√©trehoz√°sa volt. ¬© 2025 Copyright by: Robi</p>`;
            const celestialArcPathV2 = "M 30 125 A 110 110 0 0 1 250 125";
            
            weatherDisplayEl.innerHTML = `<div class="widget-header">
                <div class="header-container"><div class="location-title" id="location-title-text">Ny√≠regyh√°za</div><div class="station-subtitle" id="station-subtitle-text">√Ållom√°s kiv√°laszt√°sa...</div></div>
                <div class="timestamp-container"><span class="timestamp" id="timestamp-text">Megfigyel√©s: --:--:--</span><div class="info-tooltip-container"><i class="fas fa-info-circle"></i><div class="info-tooltip-content">${tooltipContent}</div></div></div>
                <div class="copyright-notice">Az id≈ëj√°r√°s monitort k√©sz√≠tette: Robi  ¬© 2025 Copyright by: Robi</div>
            </div>
            <div class="station-status-container">
                 <div class="station-selector" id="nyiregyhazi-ut-selector-container"><label for="station-select-nyiregyhazi-ut"><input type="radio" name="station-select" id="station-select-nyiregyhazi-ut" value="NYIREGYHAZI_UT"><span class="station-name">${STATIONS.NYIREGYHAZI_UT.displayName}</span><div id="nyiregyhazi-ut-status-text" class="station-status-text">√°llapot ?</div></label></div>
                 <div class="station-selector" id="kossuth-selector-container"><label for="station-select-kossuth"><input type="radio" name="station-select" id="station-select-kossuth" value="KOSSUTH"><span class="station-name">${STATIONS.KOSSUTH.displayName}</span><div id="kossuth-status-text" class="station-status-text">√°llapot ?</div></label></div>
                 <div class="station-selector" id="honved-selector-container"><label for="station-select-honved"><input type="radio" name="station-select" id="station-select-honved" value="HONVED"><span class="station-name">${STATIONS.HONVED.displayName}</span><div id="honved-status-text" class="station-status-text">√°llapot ?</div></label></div>
            </div>
            
            <div class="top-info-cards-container">
                <div class="info-card temp-card">
                    <div class="card-label">
                        <span>Jelenleg</span>
                        <span id="current-temp-status-dot" class="status-dot"></span>
                        <span id="current-temp-live-tag" class="live-tag is-hidden">√âL≈ê</span>
                    </div>
                    <div class="card-main-value">
                        <span id="top-temp-card-value" class="flippable-value">--</span><span id="top-temp-trend-arrow" class="temp-trend-arrow"></span>¬∞C<span id="top-temp-precip-icon" class="precip-icon"></span>
                    </div>
                </div>
                <div class="info-card sensation-card">
                    <div class="sensation-list">
                        <div class="sensation-item">
                            <i class="icon fas fa-temperature-half"></i>
                            <div class="text-content">
                                <span class="label">H≈ë√©rzet:</span>
                                <span id="card-heat-index-value" class="value">--¬∞C</span>
                                <span id="card-heat-index-desc" class="description">--</span>
                            </div>
                        </div>
                        <div class="sensation-item">
                            <i class="icon fas fa-wind"></i>
                            <div class="text-content">
                                <span class="label">Sz√©l:</span>
                                <span id="card-wind-value" class="value">-- km/h</span>
                                <span id="card-wind-desc" class="description">--</span>
                            </div>
                        </div>
                        <div class="sensation-item">
                            <i class="icon fas fa-burst"></i>
                            <div class="text-content">
                                <span class="label">Sz√©ll√∂k√©s:</span>
                                <span id="card-gust-value" class="value">-- km/h</span>
                                <span id="card-gust-desc" class="description">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="main-info-wrapper">
                <div class="sun-info-section is-hidden" id="sun-info-section">
                    <div class="celestial-path-visual-v2" id="sun-path-visual">
                        <svg class="celestial-path-svg-v2" viewBox="0 0 280 165">
                            <defs><linearGradient id="sun-arc-gradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#F97316;stop-opacity:1" /><stop offset="50%" style="stop-color:#FBBF24;stop-opacity:1" /><stop offset="100%" style="stop-color:#F97316;stop-opacity:1" /></linearGradient></defs>
                            <path class="path-arc-bg-v2" d="${celestialArcPathV2}"></path><path id="sun-path-arc-main" class="path-arc-main-v2" d="${celestialArcPathV2}" stroke="url(#sun-arc-gradient)"></path>
                        </svg>
                        <div class="path-ground-v2"><div class="path-label-v2 sunrise-label"><span>Napkelte</span><div id="sun-path-sunrise-time" class="path-time-v2">--:--</div></div><div class="path-label-v2 sunset-label"><span>Napnyugta</span><div id="sun-path-sunset-time" class="path-time-v2">--:--</div></div></div>
                        <div id="sun-path-icon-v2" class="celestial-body-icon-v2"></div>
                        <div class="celestial-event-container-v2 is-hidden" id="sun-event-container"><div class="celestial-event-message-v2" id="sun-event-message"></div><div class="celestial-event-countdown-v2" id="sun-event-countdown"></div></div>
                    </div>
                    <div class="sun-text-details">
                        <div class="sun-detail-item"><span class="sun-detail-label"><i class="fas fa-ruler-vertical"></i>Magass√°g</span><span id="sun-info-altitude" class="sun-detail-value">--¬∞<span id="sun-info-trend" class="sun-trend-text"></span><i id="sun-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Poz√≠ci√≥ friss√≠t√©se"></i></span></div>
                        <div class="sun-detail-item"><span class="sun-detail-label"><i class="far fa-compass"></i>Ir√°ny</span><span id="sun-info-azimuth" class="sun-detail-value">--</span></div>
                        <div class="sun-detail-item"><span class="sun-detail-label"><i class="fas fa-clock"></i>Delel√©s</span><span id="sun-info-noon" class="sun-detail-value">--:--</span></div>
                        <div class="sun-detail-item"><span class="sun-detail-label"><i class="fas fa-hourglass-half"></i>Napf√©ny</span><span id="sun-info-remaining" class="sun-detail-value">--</span></div>
                    </div>
                </div>
                <div class="moon-info-section is-hidden" id="moon-info-section">
                    <div class="celestial-path-visual-v2" id="moon-path-visual">
                         <svg class="celestial-path-svg-v2" viewBox="0 0 280 165"><path class="path-arc-bg-v2" d="${celestialArcPathV2}"></path><path id="moon-path-arc-main" class="path-arc-main-v2" d="${celestialArcPathV2}" stroke="var(--text-secondary-night)"></path></svg>
                        <div class="path-ground-v2"><div class="path-label-v2 sunrise-label"><span>Holdkelte</span><div id="moonrise-time-label" class="path-time-v2">--:--</div></div><div class="path-label-v2 sunset-label"><span>Holdnyugta</span><div id="moonset-time-label" class="path-time-v2">--:--</div></div></div>
                        <div class="celestial-body-icon-v2" id="moon-path-icon-v2"></div>
                        <div class="celestial-event-container-v2 is-hidden" id="moon-event-container"><div class="celestial-event-message-v2" id="moon-event-message"></div><div class="celestial-event-countdown-v2" id="moon-event-countdown"></div></div>
                    </div>
                    <div class="moon-text-details"><div class="moon-detail-item"><span class="moon-detail-label"><i class="fas fa-ruler-vertical"></i>Magass√°g</span><span id="moon-info-altitude" class="sun-detail-value">--¬∞<span id="moon-info-trend" class="sun-trend-text"></span><i id="moon-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Poz√≠ci√≥ friss√≠t√©se"></i></span></div><div class="moon-detail-item"><span class="moon-detail-label"><i class="fas fa-circle-half-stroke"></i>F√°zis</span><span id="moon-info-phasename" class="moon-detail-value">--</span></div><div class="moon-detail-item"><span class="moon-detail-label"><i class="fas fa-lightbulb"></i>Megvil√°g√≠t√°s</span><span id="moon-info-illumination" class="moon-detail-value">--%</span></div></div>
                </div>
                <div class="night-sky-info-section is-hidden" id="night-sky-info-section">
                    <div id="iss-info" class="is-hidden" style="display: flex; align-items: center; gap: 20px;"><div class="night-sky-visual"><i id="iss-visual-icon" class="fas fa-satellite"></i></div><div class="night-sky-text-details"><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-rocket"></i>Objektum</span><span class="night-sky-detail-value">Nemzetk√∂zi ≈∞r√°llom√°s</span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-stopwatch"></i>K√∂vetkez≈ë</span><span class="night-sky-detail-value" id="iss-next-pass-time">--:--</span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-sort-amount-up-alt"></i>Max. magass√°g</span><span class="night-sky-detail-value" id="iss-max-elevation">--¬∞</span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="far fa-lightbulb"></i>F√©nyess√©g</span><span class="night-sky-detail-value" id="iss-brightness">-- mag</span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-hourglass-half"></i>L√°that√≥s√°g</span><span class="night-sky-detail-value" id="iss-duration">-- perc</span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-route"></i>√ötvonal</span><span class="night-sky-detail-value long-text" id="iss-path-details">--</span></div></div></div>
                    <div id="planet-info" class="is-hidden" style="display: flex; align-items: center; gap: 20px;"><div class="night-sky-visual"><i id="night-sky-visual-icon" class=""></i></div><div class="night-sky-text-details"><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-satellite-dish"></i>Objektum</span><span class="night-sky-detail-value" id="night-sky-object-name"></span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-eye"></i></span><span class="night-sky-detail-value long-text" id="night-sky-object-status"></span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-info-circle"></i></span><span class="night-sky-detail-value long-text" id="night-sky-object-details"></span></div><div class="night-sky-detail-item is-hidden" id="night-sky-astro-darkness-item-planet"><span class="night-sky-detail-label"></span><span class="night-sky-detail-value long-text" id="night-sky-astro-darkness-planet"></span></div></div></div>
                    <div id="constellation-info" class="is-hidden" style="display: flex; align-items: center; gap: 20px;"><div id="constellation-svg-container" style="flex-shrink: 0;"></div><div class="night-sky-text-details"><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-star"></i>Csillagk√©p</span><span class="night-sky-detail-value" id="constellation-name"></span></div><div class="night-sky-detail-item"><span class="night-sky-detail-label"><i class="fas fa-info-circle"></i></span><span class="night-sky-detail-value long-text" id="constellation-details"></span></div><div class="night-sky-detail-item is-hidden" id="constellation-astro-darkness-item-const"><span class="night-sky-detail-label"></span><span class="night-sky-detail-value long-text" id="constellation-astro-darkness-const"></span></div></div></div>
                </div>
                <div class="air-quality-info-section is-hidden" id="air-quality-info-section">
                    <div class="air-quality-title">Pollen √©s Leveg≈ëmin≈ës√©g</div><div class="air-quality-grid"><div class="air-quality-item"><span class="air-quality-label"><i class="fas fa-wind"></i>Leveg≈ëmin. Index</span><div class="air-quality-value-container"><span id="aqi-value" class="air-quality-value">--</span></div><span id="aqi-description" class="air-quality-description">--</span></div><div class="air-quality-item"><span class="air-quality-label"><i class="fas fa-smog"></i>Sz√°ll√≥ por (PM10)</span><div class="air-quality-value-container"><span id="pm10-value" class="air-quality-value">--</span><span class="air-quality-value-unit">¬µg/m¬≥</span></div></div><div class="air-quality-item"><span class="air-quality-label"><i class="fas fa-smog"></i>Sz√°ll√≥ por (PM2.5)</span><div class="air-quality-value-container"><span id="pm25-value" class="air-quality-value">--</span><span class="air-quality-value-unit">¬µg/m¬≥</span></div></div><div class="air-quality-item"><span class="air-quality-label"><i class="fas fa-sun-haze"></i>√ìzon (O‚ÇÉ)</span><div class="air-quality-value-container"><span id="ozone-value" class="air-quality-value">--</span><span class="air-quality-value-unit">¬µg/m¬≥</span></div></div><div class="air-quality-item"><span class="air-quality-label"><i class="fas fa-leaf"></i>Parlagf≈± Pollen</span><div class="air-quality-value-container"><span id="ragweed-pollen-value" class="air-quality-value">--</span></div><span id="ragweed-pollen-description" class="air-quality-description">--</span></div><div class="air-quality-item"><span class="air-quality-label"><i class="fas fa-leaf"></i>F≈± Pollen</span><div class="air-quality-value-container"><span id="grass-pollen-value" class="air-quality-value">--</span></div><span id="grass-pollen-description" class="air-quality-description">--</span></div></div>
                </div>
            </div>
            
            <div class="regional-precip-section" id="regional-precip-section">
                <h3><i class="fas fa-map-marked-alt"></i>Region√°lis Csapad√©k Adatok</h3>
                <div class="regional-precip-grid" id="regional-precip-grid"></div>
            </div>

            <div class="weather-details-grid"><div class="detail-item"><span class="label"><i class="fas fa-tint"></i>Harmatpont:</span><span class="value"><span id="dewpoint-value" class="flippable-value">--</span>¬∞C</span></div><div class="detail-item"><span class="label"><i class="fas fa-percentage"></i>P√°ratartalom:</span><span class="value"><span id="humidity-value" class="flippable-value">--</span>%</span></div><div class="detail-item"><span class="label"><i class="fas fa-ruler-combined"></i>L√©gnyom√°s:</span><span class="value"><span id="pressure-value" class="flippable-value">--</span> hPa<span class="pressure-trend-icon" id="pressure-trend-icon"></span></span></div><div class="detail-item"><span class="label"><i class="fas fa-eye"></i>L√°t√≥t√°vols√°g:</span><span class="value"><span id="visibility-value" class="flippable-value">--</span> km</span></div><div class="detail-item"><span class="label"><i class="fas fa-sun"></i>Napsug√°rz√°s:</span><span class="value"><span id="solar-radiation-value" class="flippable-value">--</span> W/m¬≤</span></div><div class="detail-item"><span class="label"><i class="fas fa-umbrella-beach"></i>UV Index:</span><span class="value"><span id="uv-index-value" class="flippable-value">--</span><span class="uv-description-text" id="uv-description"></span></span></div><div class="detail-item" id="grid-sunrise-item"><span class="label"><i class="fas fa-sun"></i>Napkelte:</span><span class="value" id="details-sunrise-value"></span></div><div class="detail-item" id="grid-sunset-item"><span class="label"><i class="fas fa-sun"></i>Napnyugta:</span><span class="value" id="details-sunset-value"></span></div><div class="detail-item" id="grid-moonrise-item"><span class="label"><i class="fas fa-moon"></i>Holdkelte:</span><span class="value" id="moonrise-value"></span></div><div class="detail-item" id="grid-moonset-item"><span class="label"><i class="fas fa-moon"></i>Holdnyugta:</span><span class="value" id="moonset-value"></span></div></div>`;
            
            el_stationSubtitleText = document.getElementById('station-subtitle-text');
            el_timestampText = document.getElementById('timestamp-text');
            el_sunInfoSection = document.getElementById('sun-info-section');
            el_moonInfoSection = document.getElementById('moon-info-section');
            el_nightSkyInfoSection = document.getElementById('night-sky-info-section');
            el_airQualityInfoSection = document.getElementById('air-quality-info-section');
            el_gridSunriseItem = document.getElementById('grid-sunrise-item');
            el_gridSunsetItem = document.getElementById('grid-sunset-item');
            el_gridMoonriseItem = document.getElementById('grid-moonrise-item');
            el_gridMoonsetItem = document.getElementById('grid-moonset-item');
            
            el_regionalPrecipGrid = document.getElementById('regional-precip-grid');

            el_sunPathVisual = document.getElementById('sun-path-visual');
            el_sunPathIcon = document.getElementById('sun-path-icon-v2');
            el_sunPathArcMain = document.getElementById('sun-path-arc-main');
            el_sunInfoAltitude = document.getElementById('sun-info-altitude');
            el_sunInfoAzimuth = document.getElementById('sun-info-azimuth');
            el_sunInfoTrend = document.getElementById('sun-info-trend');
            el_sunInfoNoon = document.getElementById('sun-info-noon');
            el_sunInfoRemaining = document.getElementById('sun-info-remaining');
            el_sunPathSunriseTime = document.getElementById('sun-path-sunrise-time');
            el_sunPathSunsetTime = document.getElementById('sun-path-sunset-time');
            el_sunPathRefreshBtn = document.getElementById('sun-path-refresh-btn');
            
            el_moonPathVisual = document.getElementById('moon-path-visual');
            el_moonPathIcon = document.getElementById('moon-path-icon-v2');
            el_moonPathArcMain = document.getElementById('moon-path-arc-main');
            el_moonriseTimeLabel = document.getElementById('moonrise-time-label');
            el_moonsetTimeLabel = document.getElementById('moonset-time-label');
            el_moonInfoAltitude = document.getElementById('moon-info-altitude');
            el_moonInfoTrend = document.getElementById('moon-info-trend');
            el_moonInfoPhasename = document.getElementById('moon-info-phasename');
            el_moonInfoIllumination = document.getElementById('moon-info-illumination');
            el_moonPathRefreshBtn = document.getElementById('moon-path-refresh-btn');
            
            el_sunEventContainer = document.getElementById('sun-event-container');
            el_sunEventMessage = document.getElementById('sun-event-message');
            el_sunEventCountdown = document.getElementById('sun-event-countdown');

            el_moonEventContainer = document.getElementById('moon-event-container');
            el_moonEventMessage = document.getElementById('moon-event-message');
            el_moonEventCountdown = document.getElementById('moon-event-countdown');

            el_issInfo = document.getElementById('iss-info'); el_planetInfo = document.getElementById('planet-info'); el_constellationInfo = document.getElementById('constellation-info');
            el_issVisualIcon = document.getElementById('iss-visual-icon'); el_issNextPassTime = document.getElementById('iss-next-pass-time'); el_issMaxElevation = document.getElementById('iss-max-elevation'); el_issDuration = document.getElementById('iss-duration'); el_issBrightness = document.getElementById('iss-brightness'); el_issPathDetails = document.getElementById('iss-path-details');
            el_nightSkyVisualIcon = document.getElementById('night-sky-visual-icon'); el_nightSkyObjectName = document.getElementById('night-sky-object-name'); el_nightSkyObjectStatus = document.getElementById('night-sky-object-status'); el_nightSkyObjectDetails = document.getElementById('night-sky-object-details'); el_nightSkyAstroDarknessItemPlanet = document.getElementById('night-sky-astro-darkness-item-planet'); el_nightSkyAstroDarknessPlanet = document.getElementById('night-sky-astro-darkness-planet');
            el_constellationSvgContainer = document.getElementById('constellation-svg-container'); el_constellationName = document.getElementById('constellation-name'); el_constellationDetails = document.getElementById('constellation-details'); el_constellationAstroDarknessItemConst = document.getElementById('constellation-astro-darkness-item-const'); el_constellationAstroDarknessConst = document.getElementById('constellation-astro-darkness-const');
            
            el_topTempCardValue = document.getElementById('top-temp-card-value');

            el_currentTempStatusDot = document.getElementById('current-temp-status-dot');
            el_currentTempLiveTag = document.getElementById('current-temp-live-tag');
            el_topTempTrendArrow = document.getElementById('top-temp-trend-arrow');
            el_topTempPrecipIcon = document.getElementById('top-temp-precip-icon');

            el_cardHeatIndexValue = document.getElementById('card-heat-index-value');
            el_cardHeatIndexDesc = document.getElementById('card-heat-index-desc');
            el_cardWindValue = document.getElementById('card-wind-value');
            el_cardWindDesc = document.getElementById('card-wind-desc');
            el_cardGustValue = document.getElementById('card-gust-value');
            el_cardGustDesc = document.getElementById('card-gust-desc');
            
            el_dewpointValue = document.getElementById('dewpoint-value'); el_humidityValue = document.getElementById('humidity-value'); el_pressureValue = document.getElementById('pressure-value'); el_pressureTrendIcon = document.getElementById('pressure-trend-icon');
            el_visibilityValue = document.getElementById('visibility-value'); el_solarRadiationValue = document.getElementById('solar-radiation-value'); el_uvIndexValue = document.getElementById('uv-index-value'); el_uvDescription = document.getElementById('uv-description');
            el_detailsSunriseValue = document.getElementById('details-sunrise-value'); el_detailsSunsetValue = document.getElementById('details-sunset-value'); el_moonriseValue = document.getElementById('moonrise-value'); el_moonsetValue = document.getElementById('moonset-value');
            
            el_aqiValue = document.getElementById('aqi-value'); el_aqiDescription = document.getElementById('aqi-description'); el_pm10Value = document.getElementById('pm10-value'); el_pm25Value = document.getElementById('pm25-value'); el_ozoneValue = document.getElementById('ozone-value');
            el_ragweedPollenValue = document.getElementById('ragweed-pollen-value'); el_grassPollenValue = document.getElementById('grass-pollen-value');
            el_ragweedPollenDescription = document.getElementById('ragweed-pollen-description'); el_grassPollenDescription = document.getElementById('grass-pollen-description');
            
            addStationChangeListeners();
            isWeatherDisplayInitialized = true;
        }

        function updateStationStatusUI(stationKey, status = 'unknown') {
            const stationConfig = STATIONS[stationKey]; if (!stationConfig) return;
            const lowerCaseKey = stationKey.toLowerCase().replace(/_/g, '-');
            const textEl = document.getElementById(`${lowerCaseKey}-status-text`);
            const radioEl = document.getElementById(`station-select-${lowerCaseKey}`);
            const selectorContainerEl = document.getElementById(`${lowerCaseKey}-selector-container`);
            
            if (!textEl || !radioEl || !selectorContainerEl) return;
            
            if (status === 'online') textEl.textContent = '√ºzemel'; else if (status === 'offline') textEl.textContent = 'nem √ºzemel'; else textEl.textContent = '√°llapot ?';
            radioEl.checked = (stationKey === activeDisplayStationKey); radioEl.disabled = !stationConfig.isOnline; selectorContainerEl.classList.toggle('disabled', !stationConfig.isOnline);
        }

        function addStationChangeListeners() { document.querySelectorAll('input[name="station-select"]').forEach(radio => radio.addEventListener('change', handleStationChange)); }
        function handleStationChange(event) {
            const selectedStationKey = event.target.value; if (STATIONS[selectedStationKey].isOnline && selectedStationKey !== activeDisplayStationKey) { activeDisplayStationKey = selectedStationKey; fetchPwsStationData(activeDisplayStationKey).finally(compileAndRenderDisplayData); } else if (!STATIONS[selectedStationKey].isOnline) { event.target.checked = false; document.querySelector(`input[value="${activeDisplayStationKey}"]`).checked = true; }
        }

        function getPreferredStationData(dataType) {
            const priorityOrder = { precip: ['KOSSUTH', 'NYIREGYHAZI_UT'], wind: ['KOSSUTH', 'HONVED'] };
            const order = priorityOrder[dataType];
            if (!order) return null;
            for (const stationKey of order) {
                const station = STATIONS[stationKey];
                if (station && station.isOnline && station.provides.includes(dataType) && station.data) return station.data;
            } return null;
        }

        function checkRegionalRain() {
            const regionalStations = ['KOSSUTH', 'NYIREGYHAZI_UT', 'ALLATPARK', 'SOSTOHEGY'];
            let isRaining = false;
            const now = Date.now();

            for (const stationKey of regionalStations) {
                const station = STATIONS[stationKey];
                if (station && station.isOnline && station.data && (now - new Date(station.data.obsTimeLocal).getTime() < STALE_DATA_THRESHOLD_MS)) {
                    if (station.data.metric && station.data.metric.precipRate > 0) {
                        isRaining = true;
                        break; 
                    }
                }
            }
            return isRaining;
        }

        function compileAndRenderDisplayData() {
            const activeStationConfig = STATIONS[activeDisplayStationKey];
            if (!activeStationConfig.data) { if (weatherDisplayEl) weatherDisplayEl.innerHTML = `<div class="loading" style="padding: 20px; text-align: center; color: var(--current-text-color);">‚ö†Ô∏è Az akt√≠v √°llom√°s (${activeStationConfig.displayName}) adatai nem √©rhet≈ëk el.</div>`; return; }
            cachedData.displayPws = { ...activeStationConfig.data.metric, ...activeStationConfig.data };
            const precipDataSource = getPreferredStationData('precip'); const windDataSource = getPreferredStationData('wind');
            if (precipDataSource) { cachedData.displayPws.precipTotal = precipDataSource.metric.precipTotal; cachedData.displayPws.precipRate = precipDataSource.metric.precipRate; }
            if (windDataSource) { cachedData.displayPws.windSpeed = windDataSource.metric.windSpeed; cachedData.displayPws.windGust = windDataSource.metric.windGust; cachedData.displayPws.winddir = windDataSource.winddir; }
            renderWeatherData();
            renderHourlyForecastData();
            renderAirQualityData();
            renderRegionalPrecipitation();
        }

        function updateAnimatedValue(element, newValue) {
            if (!element) return;
            if (element.textContent.trim() !== newValue.trim()) { 
                if (!element.classList.contains('is-flipping')) { 
                    element.classList.add('is-flipping'); 
                    setTimeout(() => { element.textContent = newValue; element.classList.remove('is-flipping'); }, 300); 
                } 
            }
        }
        
        function getAqiDescription(aqi) { if (aqi == null) return { text: '--', className: '' }; if (aqi <= 20) return { text: 'Kiv√°l√≥', className: 'level-good' }; if (aqi <= 40) return { text: 'J√≥', className: 'level-good' }; if (aqi <= 60) return { text: 'M√©rs√©kelt', className: 'level-moderate' }; if (aqi <= 80) return { text: 'Gyenge', className: 'level-unhealthy-sensitive' }; if (aqi <= 100) return { text: 'Eg√©szs√©gtelen', className: 'level-unhealthy' }; return { text: 'Nagyon rossz', className: 'level-very-unhealthy' }; }
        function getPollenLevel(pollenValue) { if (pollenValue == null) return { text: '--', className: '' }; if (pollenValue < 1) return { text: 'Nincs', className: 'level-good' }; if (pollenValue < 5) return { text: 'Alacsony', className: 'level-good' }; if (pollenValue < 20) return { text: 'M√©rs√©kelt', className: 'level-moderate' }; if (pollenValue < 50) return { text: 'Magas', className: 'level-high' }; return { text: 'Nagyon magas', className: 'level-very-high' }; }

        function renderAirQualityData() {
            const aqData = cachedData.airQuality; if (!aqData || !el_airQualityInfoSection) return;
            const aqiInfo = getAqiDescription(aqData.european_aqi); el_aqiValue.textContent = formatValue(aqData.european_aqi, '', 0, '--'); el_aqiDescription.textContent = aqiInfo.text; el_aqiDescription.className = `air-quality-description ${aqiInfo.className}`;
            const ragweedInfo = getPollenLevel(aqData.ragweed_pollen); el_ragweedPollenValue.textContent = formatValue(aqData.ragweed_pollen, '', 1, '--'); el_ragweedPollenDescription.textContent = ragweedInfo.text; el_ragweedPollenDescription.className = `air-quality-description ${ragweedInfo.className}`;
            const grassInfo = getPollenLevel(aqData.grass_pollen); el_grassPollenValue.textContent = formatValue(aqData.grass_pollen, '', 1, '--'); el_grassPollenDescription.textContent = grassInfo.text; el_grassPollenDescription.className = `air-quality-description ${grassInfo.className}`;
            el_pm10Value.textContent = formatValue(aqData.pm10, '', 1, '--'); el_pm25Value.textContent = formatValue(aqData.pm2_5, '', 1, '--'); el_ozoneValue.textContent = formatValue(aqData.ozone, '', 1, '--');
        }

        function getPrecipIntensityDescription(rate) {
            if (rate == null || rate <= 0) return 'Nem esik';
            if (rate > 0 && rate <= 0.2) return 'Szit√°l√°s';
            if (rate > 0.2 && rate <= 1.0) return 'Gyenge es≈ë';
            if (rate > 1.0 && rate <= 4.0) return 'M√©rs√©kelt es≈ë';
            if (rate > 4.0 && rate <= 8.0) return 'Intenz√≠v es≈ë';
            if (rate > 8.0 && rate <= 16.0) return 'Z√°por';
            if (rate > 16.0 && rate <= 50.0) return 'Heves z√°por';
            return 'Felh≈ëszakad√°s';
        }

        function renderRegionalPrecipitation() {
            if (!el_regionalPrecipGrid) return;
            
            const PREFERRED_ORDER = ['KOSSUTH', 'NYIREGYHAZI_UT', 'ALLATPARK', 'SOSTOHEGY'];
            const now = Date.now();

            const visibleStations = Object.entries(STATIONS)
                .map(([key, station]) => ({ key, ...station }))
                .filter(station => station.provides.includes('precip') && station.isOnline && station.data && (now - new Date(station.data.obsTimeLocal).getTime() < STALE_DATA_THRESHOLD_MS));
            
            const orderedPart = [];
            const otherPart = [];

            visibleStations.forEach(station => {
                const orderIndex = PREFERRED_ORDER.indexOf(station.key);
                if (orderIndex !== -1) {
                    orderedPart[orderIndex] = station;
                } else {
                    otherPart.push(station);
                }
            });

            const sortedStations = [
                ...orderedPart.filter(Boolean), 
                ...otherPart.sort((a, b) => a.displayName.localeCompare(b.displayName, 'hu'))
            ];

            let gridHTML = '';
            if (sortedStations.length > 0) {
                sortedStations.forEach(station => {
                    let itemClass = "precip-station-item";
                    let intensityClass = "station-data intensity";
                    let intensityHTML, totalHTML;

                    const precipRate = station.data.metric?.precipRate;
                    const precipTotal = station.data.metric?.precipTotal;
                    const isRaining = precipRate > 0;
                    
                    if (isRaining) {
                        itemClass += " is-raining-highlight";
                        intensityClass += " is-raining";
                        const intensityDescription = getPrecipIntensityDescription(precipRate);
                        intensityHTML = `<span class="${intensityClass}">${intensityDescription}</span>`;
                    } else {
                        intensityHTML = `<span class="${intensityClass}">Nem esik</span>`;
                    }

                    totalHTML = `<span class="station-data total">Ma eddig: <strong>${formatValue(precipTotal, ' mm', 1)}</strong></span>`;
                    const displayName = station.key === 'KOSSUTH' ? 'Ny√≠regyh√°za Kossuth √∫t 50' : station.displayName;

                    gridHTML += `<div class="${itemClass}">
                                    <span class="station-name">${displayName}</span>
                                    <div class="station-data-wrapper">${intensityHTML}${totalHTML}</div>
                                 </div>`;
                });
            } else {
                gridHTML = '<div style="color: var(--current-text-muted-color);">Nincs el√©rhet≈ë, friss adattal rendelkez≈ë csapad√©km√©r≈ë √°llom√°s a k√∂rny√©ken.</div>';
            }
            el_regionalPrecipGrid.innerHTML = gridHTML;
        }

        function renderWeatherData() {
            const obs = cachedData.displayPws; const general = cachedData.generalConditions; const sunCalcData = cachedData.sunCalc; if (!obs || !general || !sunCalcData) return;
            
            const isRainingInRegion = checkRegionalRain();
            const now = new Date(obs.obsTimeLocal);
            const hour = now.getHours();
            const month = now.getMonth() + 1;

            const context = {
                isRainingInRegion: isRainingInRegion,
                isWinter: [12, 1, 2].includes(month),
                isSpring: [3, 4, 5].includes(month),
                isSummer: [6, 7, 8].includes(month),
                isAutumn: [9, 10, 11].includes(month),
                isDay: general.dayOrNight === 'D',
                hour: hour,
                isMorning: hour >= 6 && hour < 11,
                isLunchTime: hour >= 11 && hour < 13,
                isLateLunchTime: hour >=13 && hour < 15,
                isAfternoon: hour >= 15 && hour < 18,
                isEvening: hour >= 18 && hour < 22,
                isNight: hour >= 22 || hour < 6,
                isNearSunrise: sunCalcData.sunriseDateForPath ? Math.abs(now.getTime() - sunCalcData.sunriseDateForPath.getTime()) < 60 * 60 * 1000 : false,
                isNearSunset: sunCalcData.sunsetDateForPath ? Math.abs(now.getTime() - sunCalcData.sunsetDateForPath.getTime()) < 60 * 60 * 1000 : false,
            };
            
            if (el_stationSubtitleText) el_stationSubtitleText.textContent = `√°llom√°s: ${STATIONS[activeDisplayStationKey].displayName}`; if (el_timestampText) el_timestampText.textContent = `Megfigyel√©s: ${formatTime(obs.obsTimeLocal, true)}`;
            
            if(el_topTempCardValue) {
                updateAnimatedValue(el_topTempCardValue, formatValue(obs.temp, '', 1));
                el_topTempCardValue.closest('.temp-card').style.setProperty('--current-temp-bg-color', getTemperatureColorVar(obs.temp));

                const obsTime = new Date(obs.obsTimeLocal).getTime();
                const ageInSeconds = (Date.now() - obsTime) / 1000;
                const FRESH_THRESHOLD_S = 90;
                const STALE_THRESHOLD_S = 180;
                el_currentTempStatusDot.classList.remove('fresh', 'stale', 'offline');
                if (ageInSeconds < FRESH_THRESHOLD_S) {
                    el_currentTempStatusDot.classList.add('fresh');
                    el_currentTempLiveTag.classList.remove('is-hidden');
                } else if (ageInSeconds < STALE_THRESHOLD_S) {
                    el_currentTempStatusDot.classList.add('stale');
                    el_currentTempLiveTag.classList.add('is-hidden');
                } else {
                    el_currentTempStatusDot.classList.add('offline');
                    el_currentTempLiveTag.classList.add('is-hidden');
                }

                const previousTemp = cachedData.previousTemperatures[activeDisplayStationKey];
                let trendArrow = '';
                if (typeof previousTemp === 'number' && typeof obs.temp === 'number') {
                    const diff = obs.temp - previousTemp;
                    if (diff > 0.05) trendArrow = '‚Üë';
                    else if (diff < -0.05) trendArrow = '‚Üì';
                    else trendArrow = '‚Üí';
                }
                el_topTempTrendArrow.textContent = trendArrow;

                const isRaining = obs.precipRate > 0;
                const isSnowing = isRaining && obs.temp < 1;
                el_topTempPrecipIcon.textContent = isRaining ? (isSnowing ? '‚ùÑÔ∏è' : 'üíß') : '';
            }
            
            if(el_cardHeatIndexValue) el_cardHeatIndexValue.textContent = formatValue(obs.heatIndex, '¬∞C', 1);
            if(el_cardHeatIndexDesc) el_cardHeatIndexDesc.textContent = getHeatIndexDescription(obs.heatIndex, obs.temp, context);
            
            if(el_cardWindValue) el_cardWindValue.textContent = formatValue(obs.windSpeed, ' km/h', 1);
            if(el_cardWindDesc) {
                const windDesc = getWindDescription(obs.windSpeed, obs.windGust, context);
                const windDir = degreesToCompass(obs.winddir);
                if (windDir !== '-' && !isRainingInRegion) {
                    el_cardWindDesc.textContent = `${windDir.charAt(0).toUpperCase() + windDir.slice(1)}, ${windDesc.toLowerCase()}`;
                } else {
                    el_cardWindDesc.textContent = windDesc;
                }
            }

            if(el_cardGustValue) el_cardGustValue.textContent = formatValue(obs.windGust, ' km/h', 1);
            if(el_cardGustDesc) el_cardGustDesc.textContent = getWindGustDescription(obs.windGust, obs.windSpeed, context);
            
            el_sunInfoSection.classList.add('is-hidden');
            el_moonInfoSection.classList.add('is-hidden');
            el_nightSkyInfoSection.classList.add('is-hidden');
            el_airQualityInfoSection.classList.add('is-hidden');
            stopNightSkyRotation(); 
            
            const sunState = celestialBodyStates.sun.currentState;
            const moonState = celestialBodyStates.moon.currentState;

            if (sunState !== 'BELOW_HORIZON') { el_sunInfoSection.classList.remove('is-hidden'); } 
            else if (moonState !== 'BELOW_HORIZON') { el_moonInfoSection.classList.remove('is-hidden'); } 
            else {
                const currentHour = new Date().getHours();
                if (currentHour >= 18 && currentHour < 22) { el_airQualityInfoSection.classList.remove('is-hidden'); } 
                else { el_nightSkyInfoSection.classList.remove('is-hidden'); startNightSkyRotation(); }
            }
            
            if (el_sunInfoAltitude) el_sunInfoAltitude.innerHTML = `${formatValue(sunCalcData.sunAltitude, '¬∞', 1)}<span id="sun-info-trend" class="sun-trend-text">(${sunCalcData.sunTrend || sunCalcData.sunStatus})</span><i id="sun-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Poz√≠ci√≥ friss√≠t√©se"></i>`;
            if (el_sunInfoAzimuth) el_sunInfoAzimuth.textContent = `${sunCalcData.sunAzimuthCompass} (${formatValue(sunCalcData.sunAzimuthDegrees, '¬∞', 0)})`; 
            if (el_sunInfoNoon) el_sunInfoNoon.textContent = sunCalcData.solarNoon; 
            if (el_sunInfoRemaining) el_sunInfoRemaining.textContent = sunCalcData.remainingDaylight; 
            if (el_sunPathSunriseTime) el_sunPathSunriseTime.textContent = sunCalcData.sunrise; 
            if (el_sunPathSunsetTime) el_sunPathSunsetTime.textContent = sunCalcData.sunset; 
            if (document.getElementById('sun-path-refresh-btn')) document.getElementById('sun-path-refresh-btn').onclick = () => { document.getElementById('sun-path-refresh-btn').classList.add('is-refreshing'); setTimeout(() => document.getElementById('sun-path-refresh-btn').classList.remove('is-refreshing'), 800); };
            
            if (el_moonriseTimeLabel) el_moonriseTimeLabel.textContent = formatTime(sunCalcData.moonRiseDateForPath); 
            if (el_moonsetTimeLabel) el_moonsetTimeLabel.textContent = formatTime(sunCalcData.moonSetDateForPath); 
            if (el_moonInfoAltitude) el_moonInfoAltitude.innerHTML = `${formatValue(sunCalcData.moonAltitude, '¬∞', 1)}<span id="moon-info-trend" class="sun-trend-text">(${sunCalcData.moonTrend || sunCalcData.moonStatus})</span><i id="moon-path-refresh-btn" class="fas fa-sync-alt path-refresh-btn" title="Poz√≠ci√≥ friss√≠t√©se"></i>`;
            if (el_moonInfoPhasename) el_moonInfoPhasename.textContent = sunCalcData.phaseName || NO_DATA_STRING; 
            if (el_moonInfoIllumination) el_moonInfoIllumination.textContent = formatValue(sunCalcData.phaseValue, '%', 1); 
            
            if (el_moonPathIcon && sunCalcData && typeof sunCalcData.moonPhaseRaw === 'number') {
                el_moonPathIcon.textContent = getMoonPhaseIcon(sunCalcData.moonPhaseRaw);
                const minOpacity = 0.3, maxOpacity = 1.0;
                el_moonPathIcon.style.opacity = (minOpacity + (sunCalcData.phaseValue / 100) * (maxOpacity - minOpacity)).toFixed(2);
            }
            
            if (document.getElementById('moon-path-refresh-btn')) document.getElementById('moon-path-refresh-btn').onclick = () => { document.getElementById('moon-path-refresh-btn').classList.add('is-refreshing'); setTimeout(() => document.getElementById('moon-path-refresh-btn').classList.remove('is-refreshing'), 800); };

            if(el_gridSunriseItem) el_gridSunriseItem.classList.toggle('is-hidden', !el_sunInfoSection.classList.contains('is-hidden')); 
            if(el_gridSunsetItem) el_gridSunsetItem.classList.toggle('is-hidden', !el_sunInfoSection.classList.contains('is-hidden'));
            if(el_gridMoonriseItem) el_gridMoonriseItem.classList.toggle('is-hidden', !el_moonInfoSection.classList.contains('is-hidden')); 
            if(el_gridMoonsetItem) el_gridMoonsetItem.classList.toggle('is-hidden', !el_moonInfoSection.classList.contains('is-hidden'));
            
            updateAnimatedValue(el_dewpointValue, formatValue(obs.dewpt, '', 1)); 
            updateAnimatedValue(el_humidityValue, formatValue(obs.humidity, '', 0)); 
            updateAnimatedValue(el_pressureValue, formatValue(general.pressureAltimeter || obs.pressure, '', 0));
            const trendCode = general.pressureTendencyCode; let trendSymbol = ''; if (trendCode === 0) trendSymbol = '‚Üë'; else if (trendCode === 1) trendSymbol = '‚Üì'; else if (trendCode === 2) trendSymbol = '‚Üí'; if(el_pressureTrendIcon) el_pressureTrendIcon.textContent = trendSymbol;
            updateAnimatedValue(el_visibilityValue, formatValue(general.visibility, '', 1)); 
            updateAnimatedValue(el_solarRadiationValue, formatValue(obs.solarRadiation, '', 0)); 
            updateAnimatedValue(el_uvIndexValue, formatValue(obs.uv, '', 1));
            
            if(el_uvDescription) el_uvDescription.textContent = getUVDescription(obs.uv);
            if(el_detailsSunriseValue) el_detailsSunriseValue.textContent = sunCalcData.sunrise; if(el_detailsSunsetValue) el_detailsSunsetValue.textContent = sunCalcData.sunset;
            if(el_moonriseValue) el_moonriseValue.textContent = sunCalcData.moonrise || '--'; if(el_moonsetValue) el_moonsetValue.textContent = sunCalcData.moonset || '--';
        }
        
        function getTemperatureColorVar(temp) { if (temp === null || isNaN(temp)) return 'var(--mild)'; if (temp >= 35) return 'var(--hot)'; if (temp >= 25) return 'var(--warm)'; if (temp >= 10) return 'var(--mild)'; if (temp >= 0) return 'var(--cool)'; return 'var(--cold)'; }
        
        function mapTwcIconToFontAwesome(iconCode, dayOrNight) { const isDay = dayOrNight === 'D'; const iconMap = { 32: 'fas fa-sun', 36: 'fas fa-sun', 31: 'fas fa-moon', 33: 'fas fa-moon', 34: isDay ? 'fas fa-sun' : 'fas fa-cloud-moon', 29: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 30: isDay ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon', 27: 'fas fa-cloud', 28: 'fas fa-cloud', 26: 'fas fa-cloud', 11: 'fas fa-cloud-showers-heavy', 12: 'fas fa-cloud-showers-heavy', 40: 'fas fa-cloud-showers-heavy', 39: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 45: isDay ? 'fas fa-cloud-sun-rain' : 'fas fa-cloud-moon-rain', 3: 'fas fa-cloud-bolt', 4: 'fas fa-cloud-bolt', 37: 'fas fa-cloud-bolt', 38: 'fas fa-cloud-bolt', 47: 'fas fa-cloud-bolt', 5: 'fas fa-snowflake', 6: 'fas fa-snowflake', 7: 'fas fa-snowflake', 8: 'fas fa-snowflake', 10: 'fas fa-cloud-sleet', 18: 'fas fa-smog', 13: 'fas fa-snowflake', 14: 'fas fa-snowflake', 15: 'fas fa-snowflake', 16: 'fas fa-snowflake', 41: 'fas fa-snowflake', 42: 'fas fa-snowflake', 43: 'fas fa-snowflake', 46: 'fas fa-snowflake', 9: 'fas fa-cloud-rain', 19: 'fas fa-smog', 20: 'fas fa-smog', 21: 'fas fa-smog', 22: 'fas fa-smog', 23: 'fas fa-wind', 24: 'fas fa-wind' }; return iconMap[iconCode] || 'fas fa-question-circle'; }
        function mapIconCodeToHungarianText(iconCode, dayOrNight) { const isDay = dayOrNight === 'D'; const textMap = { 32: 'Napos', 36: 'Napos', 31: 'Tiszta √©g', 33: 'Tiszta √©g', 34: isDay ? 'R√©szben napos' : 'R√©szben felh≈ës', 29: isDay ? 'R√©szben napos' : 'R√©szben felh≈ës', 30: isDay ? 'R√©szben napos' : 'R√©szben felh≈ës', 27: 'Felh≈ës', 28: 'Felh≈ës', 26: 'Borult', 11: 'Z√°por', 12: 'Z√°por', 40: 'Z√°por', 39: isDay ? 'Z√°por' : '√âjjeli z√°por', 45: isDay ? 'Z√°por' : '√âjjeli z√°por', 3: 'Zivatar', 4: 'Zivatar', 37: 'Zivatar', 38: 'Zivatar', 47: 'Zivatar', 5: 'Havas es≈ë', 6: '√ìnos es≈ë', 7: 'Havas es≈ë', 8: '√ìnos es≈ë', 10: '√ìnos es≈ë', 18: 'Havas es≈ë', 13: 'H√≥z√°por', 14: 'H√≥z√°por', 15: 'H√≥f√∫v√°s', 16: 'Havaz√°s', 41: 'Havaz√°s', 42: 'Havaz√°s', 43: 'H√≥f√∫v√°s', 46: 'H√≥z√°por', 9: 'Es≈ë', 19: 'P√°r√°s', 20: 'K√∂d√∂s', 21: 'P√°r√°s', 22: 'F√ºst√∂s', 23: 'Szeles', 24: 'Szeles' }; return textMap[iconCode] || 'Ismeretlen'; }

        function renderHourlyForecastData() {
            const hourlyDataFull = cachedData.hourlyForecast; if (!hourlyDataFull || hourlyDataFull.length === 0) { if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.add('is-hidden'); if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.add('is-hidden'); return; }
            let forecastHTML = '';
            hourlyDataFull.forEach(hour => {
                let conditionText = hour.wxPhraseShort || mapIconCodeToHungarianText(hour.iconCode, hour.dayOrNight);
                forecastHTML += `<div class="hourly-forecast-card"><div class="hourly-primary-info"><div class="hourly-time">${formatTime(hour.time)}</div><div class="hourly-icon-and-condition"><i class="hourly-icon ${mapTwcIconToFontAwesome(hour.iconCode, hour.dayOrNight)}"></i><div class="hourly-condition-text">${conditionText}</div></div><div class="hourly-temp">${formatValue(hour.temp, '¬∞', 0, '--')}</div></div><div class="hourly-secondary-details"><div class="hourly-detail-row"><span><i class="fas fa-tint"></i> Csapad√©k</span><strong>${formatValue(hour.precipChance, '%', 0, '--')}</strong></div><div class="hourly-detail-row"><span><i class="fas fa-wind"></i> Sz√©l</span><strong title="Sz√©l">${degreesToCompassAbbreviated(hour.windDirection)} ${formatValue(hour.windSpeed, 'km/h', 0)}</strong></div><div class="hourly-detail-row"><span><i class="fas fa-hand-holding-water"></i> P√°ra</span><strong>${formatValue(hour.humidity, '%', 0)}</strong></div></div></div>`;
            });
            if(hourlyForecastContainerEl) hourlyForecastContainerEl.innerHTML = forecastHTML; if(hourlyForecastContainerEl) hourlyForecastContainerEl.classList.remove('is-hidden'); if(hourlyForecastTitleEl) hourlyForecastTitleEl.classList.remove('is-hidden');
        }

        async function fetchAllDataAndUpdateDisplay(isInitialLoad = false) {
            const now = Date.now();
            await Promise.allSettled(Object.keys(STATIONS).map(key => fetchPwsStationData(key)));
            if (!STATIONS[activeDisplayStationKey].isOnline) { const onlineStations = Object.keys(STATIONS).filter(k => STATIONS[k].isOnline && ['NYIREGYHAZI_UT', 'KOSSUTH', 'HONVED'].includes(k)); if(onlineStations.length > 0) activeDisplayStationKey = onlineStations[0]; }
            
            const independentPromises = [];
            if (isInitialLoad || now - lastApiCallTimes.generalConditions > REFRESH_INTERVAL_GENERAL_CONDITIONS) independentPromises.push(fetchGeneralConditionsData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if (data) Object.assign(cachedData.generalConditions, data); }).catch(e => {console.warn("√Ålt. adatok lek√©r√©se sikertelen", e)}));
            if (isInitialLoad || now - lastApiCallTimes.airQuality > REFRESH_INTERVAL_AIR_QUALITY) independentPromises.push(fetchAirQualityData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { cachedData.airQuality = data; }).catch(e => {console.warn("Leveg≈ëmin≈ës√©g adatok lek√©r√©se sikertelen", e)}));
            if (isInitialLoad || now - lastApiCallTimes.forecast > REFRESH_INTERVAL_FORECAST) independentPromises.push(fetchHourlyForecastData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon).then(data => { if(data) cachedData.hourlyForecast = data}));
            if (ENABLE_ISS_TRACKING && (isInitialLoad || now - (lastApiCallTimes.issPasses || 0) > REFRESH_INTERVAL_ISS)) { independentPromises.push( fetchIssPasses(N2YO_API_KEY, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon, OBSERVER_ALTITUDE, ISS_NORAD_ID, 3, 15).then(passes => { cachedData.issPasses = passes; lastApiCallTimes.issPasses = Date.now(); }).catch(e => {}) ); }
            
            await Promise.allSettled(independentPromises);

            try { const sunCalcResult = await fetchAdvancedSunCalcData(NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon); cachedData.sunCalc = sunCalcResult; if (sunCalcResult.sunriseDateForPath) cachedData.generalConditions.sunriseTimeLocal = sunCalcResult.sunriseDateForPath.toISOString(); if (sunCalcResult.sunsetDateForPath) cachedData.generalConditions.sunsetTimeLocal = sunCalcResult.sunsetDateForPath.toISOString(); } catch (e) { cachedData.sunCalc = null; console.warn("SunCalc adatok lek√©r√©se sikertelen", e); }
            updateThemeAndSky(new Date(), cachedData.generalConditions.sunriseTimeLocal, cachedData.generalConditions.sunsetTimeLocal);
            
            const isDataReady = STATIONS[activeDisplayStationKey]?.isOnline && STATIONS[activeDisplayStationKey]?.data && cachedData.generalConditions?.skyCoverPhrase !== null && cachedData.sunCalc;

            if (isDataReady) { 
                compileAndRenderDisplayData(); 
            } else { 
                let errorMessage = "‚ö†Ô∏è "; 
                const anyStationOnline = Object.values(STATIONS).some(s => s.isOnline);
                if (!anyStationOnline) { errorMessage += "Egyik m√©r≈ë√°llom√°s sem el√©rhet≈ë. "; } 
                else if (!STATIONS[activeDisplayStationKey]?.isOnline) { errorMessage += `Az akt√≠v √°llom√°s (${STATIONS[activeDisplayStationKey].displayName}) nem el√©rhet≈ë. `; } 
                else { errorMessage += "Az adatok bet√∂lt√©se folyamatban... "; }
                errorMessage += "K√©rj√ºk, pr√≥b√°lja k√©s≈ëbb, vagy v√°lasszon m√°sik √°llom√°st."; 
                if (weatherDisplayEl) weatherDisplayEl.innerHTML = `<div class="loading" style="padding: 20px; text-align: center; color: var(--current-text-color);">${errorMessage}</div>`; 
                if (hourlyForecastContainerEl) hourlyForecastContainerEl.classList.add('is-hidden'); 
                if (hourlyForecastTitleEl) hourlyForecastTitleEl.classList.add('is-hidden'); 
            }
        }
        
        function checkMidnight() {
             const newDay = new Date().getDate(); 
             if (newDay !== currentDay) { 
                currentDay = newDay; 
                const updatePromises = []; 
                if (ENABLE_ISS_TRACKING) updatePromises.push( fetchIssPasses(N2YO_API_KEY, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon, OBSERVER_ALTITUDE, ISS_NORAD_ID, 3, 15).then(passes => { cachedData.issPasses = passes; lastApiCallTimes.issPasses = Date.now(); }) ); 
                Promise.all(updatePromises).finally(() => { if (cachedData.displayPws) renderWeatherData(); }); 
            }
        }

        function determineCelestialState(nowMs, riseTime, setTime, altitude, noonTime = null) {
            if (altitude > CELESTIAL_RISE_TRANSITION_ALTITUDE) return 'ON_PATH';
            if (altitude < CELESTIAL_SET_TRANSITION_ALTITUDE) return 'BELOW_HORIZON';
            const riseMs = riseTime ? riseTime.getTime() : NaN;
            const setMs = setTime ? setTime.getTime() : NaN;
            if (!isNaN(riseMs) || !isNaN(setMs)) {
                const timeToRise = !isNaN(riseMs) ? Math.abs(nowMs - riseMs) : Infinity;
                const timeToSet = !isNaN(setMs) ? Math.abs(nowMs - setMs) : Infinity;
                if (timeToRise < timeToSet && timeToRise < CELESTIAL_EVENT_DURATION_MS) return 'RISING';
                if (timeToSet < timeToRise && timeToSet < CELESTIAL_EVENT_DURATION_MS) return 'SETTING';
            }
            if (noonTime && !isNaN(noonTime.getTime())) { return nowMs < noonTime.getTime() ? 'RISING' : 'SETTING'; } 
            else { 
                const pathMidpointMs = (!isNaN(riseMs) && !isNaN(setMs) && setMs > riseMs) ? riseMs + (setMs - riseMs) / 2 : NaN;
                if (!isNaN(pathMidpointMs)) return nowMs < pathMidpointMs ? 'RISING' : 'SETTING';
            }
            return 'ON_PATH';
        }

        function animateIconOnHorizon(iconEl, altitude) {
            if (!iconEl) return; const visualContainer = iconEl.parentElement; if (!visualContainer) return;
            const HORIZON_Y_POS_FROM_BOTTOM = 40; const VISUAL_HEIGHT = visualContainer.offsetHeight; const ICON_HEIGHT = iconEl.offsetHeight || (iconEl.id.includes('sun') ? 22 : 20);
            const progress = (altitude - CELESTIAL_SET_TRANSITION_ALTITUDE) / (CELESTIAL_RISE_TRANSITION_ALTITUDE - CELESTIAL_SET_TRANSITION_ALTITUDE);
            const clampedProgress = Math.max(0, Math.min(1, progress)); const yPos = (VISUAL_HEIGHT - HORIZON_Y_POS_FROM_BOTTOM) - (clampedProgress * ICON_HEIGHT);
            iconEl.style.transform = `translate(-50%, ${yPos}px)`; iconEl.style.left = `${(visualContainer.offsetWidth / 2)}px`; iconEl.style.transition = 'none';
        }
        
        function renderCelestialState(bodyName, previousState, currentState, elements) {
            const { visualEl, textDetailsEl, iconEl, arcEl, eventContainerEl, eventMessageEl, eventCountdownEl, altitude, otherBodyState } = elements;
            const isEventActive = ['RISING', 'SETTING'].includes(currentState);
            visualEl.classList.toggle('is-event-active', isEventActive); textDetailsEl.style.opacity = isEventActive ? '0.3' : '1'; eventContainerEl.classList.toggle('is-hidden', !isEventActive);
            iconEl.style.opacity = 1;
            switch (currentState) {
                case 'RISING': eventMessageEl.textContent = (bodyName === 'sun') ? 'Felkel√©s folyamatban...' : 'Holdkelte folyamatban...'; animateIconOnHorizon(iconEl, altitude); break;
                case 'SETTING': eventMessageEl.textContent = (bodyName === 'sun') ? 'Lenyugv√°s folyamatban...' : 'Holdnyugta folyamatban...'; animateIconOnHorizon(iconEl, altitude); break;
                case 'ON_PATH': visualEl.classList.remove('is-event-active'); iconEl.style.transition = 'transform 0.2s linear, opacity 0.5s ease-in-out'; updatePathVisuals(elements.pathStartTime, elements.pathEndTime, { iconEl, mainArcEl: arcEl }, true); break;
                case 'BELOW_HORIZON':
                    visualEl.classList.remove('is-event-active'); iconEl.style.opacity = 0;
                    if(previousState === 'SETTING') {
                        let settingMessage = (bodyName === 'sun') ? (otherBodyState && ['ON_PATH', 'RISING'].includes(otherBodyState) ? 'Lenyugodtam. Most j√∂n a Hold!' : 'Lenyugodtam, most j√∂nnek a csillagok!') : 'Lenyugodtam.';
                        eventMessageEl.textContent = settingMessage; eventContainerEl.classList.remove('is-hidden'); setTimeout(() => eventContainerEl.classList.add('is-hidden'), 3000);
                    }
                    updatePathVisuals(elements.pathStartTime, elements.pathEndTime, { iconEl, mainArcEl: arcEl }, false);
                    break;
            }
        }

        function updatePathVisuals(startTime, endTime, elements, isVisible = true) {
            const { iconEl, mainArcEl } = elements;
             if (!isVisible || !startTime || !endTime || isNaN(startTime.getTime()) || isNaN(endTime.getTime()) || !iconEl || !mainArcEl) {
                if(mainArcEl && mainArcEl.style) mainArcEl.style.strokeDashoffset = mainArcEl.getTotalLength ? mainArcEl.getTotalLength() : '999';
                if(iconEl && iconEl.style) iconEl.style.transform = 'translate(-50%, -150px)';
                return;
            }
            
            const now = new Date();
            const totalTimeInSky = endTime.getTime() - startTime.getTime();
            let percentageOfPath = 0;
            if (totalTimeInSky > 0) { const elapsedTime = now.getTime() - startTime.getTime(); percentageOfPath = Math.max(0, Math.min(1, elapsedTime / totalTimeInSky)); }
            
            const arcLength = mainArcEl.getTotalLength();
            if (arcLength === 0 || !isFinite(arcLength)) { requestAnimationFrame(() => updatePathVisuals(startTime, endTime, elements, isVisible)); return; };
            if (mainArcEl.style) { mainArcEl.style.strokeDasharray = arcLength; mainArcEl.style.strokeDashoffset = arcLength * (1 - percentageOfPath); }
            
            const point = mainArcEl.getPointAtLength(arcLength * percentageOfPath);
            iconEl.style.transform = `translate(-50%, -50%) translate(${point.x}px, ${point.y}px)`;
        }
        
        function masterAnimationLoop() {
            if (!cachedData.sunCalc || !isWeatherDisplayInitialized) { animationFrameId = requestAnimationFrame(masterAnimationLoop); return; }
            const now = new Date(), nowMs = now.getTime();
            const sunPos = SunCalc.getPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
            const moonPos = SunCalc.getMoonPosition(now, NYIREGYHAZA_COORDS.lat, NYIREGYHAZA_COORDS.lon);
            const sunAltitude = sunPos.altitude * 180 / Math.PI, moonAltitude = moonPos.altitude * 180 / Math.PI;

            const sunIcon = document.getElementById('sun-path-icon-v2');
            if(sunIcon) {
                if (sunAltitude < 1.0) { // M√©lyen a horizonton, v√∂r√∂ses sz√≠n
                    sunIcon.style.backgroundColor = '#E4572E';
                    sunIcon.style.boxShadow = '0 0 12px 4px #E4572E, 0 0 20px 8px rgba(228, 87, 46, 0.5)';
                } else if (sunAltitude < 5.0) { // Napkelte/napnyugta, narancsos sz√≠n
                    sunIcon.style.backgroundColor = '#F97316';
                    sunIcon.style.boxShadow = '0 0 10px 3px #F97316, 0 0 18px 6px rgba(249, 115, 22, 0.45)';
                } else { // Magasan az √©gen, aranyl√≥ s√°rga
                    sunIcon.style.backgroundColor = '#FFD700';
                    sunIcon.style.boxShadow = '0 0 10px 3px gold, 0 0 18px 6px rgba(255, 215, 0, 0.45)';
                }
            }
            const moonIcon = document.getElementById('moon-path-icon-v2');
            if (moonIcon && cachedData.sunCalc) {
                const illumination = cachedData.sunCalc.phaseValue / 100;
                let color, shadowColor;

                if (moonAltitude < 4.0) {
                    color = '#F59E0B';
                    shadowColor = 'rgba(245, 158, 11, 0.6)';
                } else {
                    color = '#E8EAF6';
                    shadowColor = 'rgba(200, 200, 255, 0.7)';
                }
                
                const glowIntensity = Math.pow(illumination, 1.5);
                const brightBlur = Math.round(5 + 15 * glowIntensity);
                const brightSpread = Math.round(2 + 8 * glowIntensity);

                moonIcon.style.color = color;
                moonIcon.style.textShadow = `0 0 2px ${color}, 0 0 ${brightBlur}px ${shadowColor}, 0 0 ${brightSpread}px ${shadowColor}`;
            }
            
            const sunState = determineCelestialState(nowMs, cachedData.sunCalc.sunriseDateForPath, cachedData.sunCalc.sunsetDateForPath, sunAltitude, cachedData.sunCalc.solarNoonDate);
            const moonState = determineCelestialState(nowMs, cachedData.sunCalc.moonRiseDateForPath, cachedData.sunCalc.moonSetDateForPath, moonAltitude);
            if (celestialBodyStates.sun.currentState !== sunState) { celestialBodyStates.sun.previousState = celestialBodyStates.sun.currentState; celestialBodyStates.sun.currentState = sunState; if(cachedData.displayPws) renderWeatherData(); }
            if (celestialBodyStates.moon.currentState !== moonState) { celestialBodyStates.moon.previousState = celestialBodyStates.moon.currentState; celestialBodyStates.moon.currentState = moonState; if(cachedData.displayPws) renderWeatherData(); }

            const sunElements = { bodyName: 'sun', visualEl: el_sunPathVisual, textDetailsEl: el_sunInfoSection.querySelector('.sun-text-details'), iconEl: el_sunPathIcon, arcEl: el_sunPathArcMain, eventContainerEl: el_sunEventContainer, eventMessageEl: el_sunEventMessage, eventCountdownEl: el_sunEventCountdown, altitude: sunAltitude, pathStartTime: cachedData.sunCalc.sunriseDateForPath, pathEndTime: cachedData.sunCalc.sunsetDateForPath, otherBodyState: moonState };
            const moonElements = { bodyName: 'moon', visualEl: el_moonPathVisual, textDetailsEl: el_moonInfoSection.querySelector('.moon-text-details'), iconEl: el_moonPathIcon, arcEl: el_moonPathArcMain, eventContainerEl: el_moonEventContainer, eventMessageEl: el_moonEventMessage, eventCountdownEl: el_moonEventCountdown, altitude: moonAltitude, pathStartTime: cachedData.sunCalc.moonRiseDateForPath, pathEndTime: cachedData.sunCalc.moonSetDateForPath, otherBodyState: sunState };
            
            if(el_sunInfoSection && !el_sunInfoSection.classList.contains('is-hidden')) renderCelestialState('sun', celestialBodyStates.sun.previousState, sunState, sunElements);
            if(el_moonInfoSection && !el_moonInfoSection.classList.contains('is-hidden')) renderCelestialState('moon', celestialBodyStates.moon.previousState, moonState, moonElements);
            animationFrameId = requestAnimationFrame(masterAnimationLoop);
        }
        
        function startMasterLoop() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            masterAnimationLoop();
            
            const PWS_INTERVAL_S = REFRESH_INTERVAL_PWS / 1000;
            const SKY_UPDATE_S = SKY_COLOR_UPDATE_INTERVAL / 1000;
            const MIDNIGHT_CHECK_S = 30;
            
            setInterval(() => {
                masterTickCounter++;
                if (masterTickCounter % PWS_INTERVAL_S === 0) {
                    fetchAllDataAndUpdateDisplay(false);
                }
                if (masterTickCounter % SKY_UPDATE_S === 0) {
                    if (cachedData.generalConditions?.sunriseTimeLocal && cachedData.generalConditions?.sunsetTimeLocal) {
                        updateThemeAndSky(new Date(), cachedData.generalConditions.sunriseTimeLocal, cachedData.generalConditions.sunsetTimeLocal);
                    }
                }
                if (masterTickCounter % MIDNIGHT_CHECK_S === 0) {
                    checkMidnight();
                }
            }, 1000);
        }
        
        function initApp() {
            weatherDisplayEl = document.getElementById('weather-display');
            hourlyForecastContainerEl = document.getElementById('hourly-forecast-container');
            hourlyForecastTitleEl = document.getElementById('hourly-forecast-title');
            
            initializeWeatherDisplayDOM();
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    fetchAllDataAndUpdateDisplay(true);
                }
            });
            
            window.addEventListener('resize', () => { if (cachedData.displayPws) renderWeatherData(); });
            
            fetchAllDataAndUpdateDisplay(true).finally(() => { 
                startMasterLoop(); 
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
